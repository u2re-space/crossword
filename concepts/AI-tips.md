# Общий план

## Разделы

Отлично, у вас уже вырисовывается информационная архитектура. Давайте превратим это в чёткое ядро MVP: единая лента времени и места, куда стекаются задачи, события, погода, акции/промокоды, специалисты и места.

Общая идея (ядро ценности)

- Один экран «Timeline», который отвечает на вопросы: что, где и когда рядом со мной, и что я могу с этим сделать.
- Всё остальное — источники данных и карточки сущностей, которые лента объединяет по времени и локации.

Слои системы

- Источники (внешние): погода, события/афиша, промокоды/акции, каталоги мест, новости, карты/геокодер, календари.
- Исходники (внутренние/пользовательские): ваши вручную добавленные списки, задачи, привязки к местам/людям, админская редактура, импорт из Google/Apple календаря.
- Базы данных (нормализованное хранилище): единая схема сущностей с привязкой ко времени и месту.

Сущности (минимально необходимые поля)

- Place/Место: id, название, тип (кафе/клиника/зал), координаты, часы работы, контакты.
- Event/Событие: id, place_id, название, период (начало/конец), цена/статус, ссылка.
- Task/Задача: id, пользователь, заголовок, период/дедлайн, optional: place_id/entity_ref, метка/приоритет.
- Specialist/Специалист: id, имя, специализация, контакты, place_id, слоты/расписание (опционально).
- Service/Услуга: id, название, provider_ref (place_id или specialist_id), длительность, цена.
- Product/Товар: id, название, категория, place_id (или магазин), цена.
- Offer/Промо/Акция: id, тип (промокод/скидка/акция), описание, продукт/категория/place_id, период действия, источники/условия, код.
- News/Новость: id, заголовок, источник, метки, период актуальности.
- Weather/Погода: id, локация, таймслоты (почас/день), температура, явления.

Связи:

- события происходят в местах;
- специалист работает в месте и оказывает услуги;
- задача может ссылаться на любую сущность;
- промо привязано к товарам/местам/категориям;
- всё имеет время и/или диапазон времени.

MVP-скоуп (3–5 экранов)

- 1) Timeline (день/неделя) с контекстом места
  - Полоса погоды (сверху), карточки задач/событий по времени, пометки промо/акций релевантных месту и времени, индикатор «рядом» по геолокации. Переключатель «Карта».
    Критерии приемки:
  - Я вижу задачи и события, отсортированные по времени; вижу погоду полосой; по клику открывается карточка; есть фильтры: тип (задачи/события/акции), радиус, день.

- 2) Поиск/Обзор
  - Поиск по местам/событиям/специалистам/акциям; фильтры: дата, расстояние, категория.
    Критерии: автодополнение; результаты сгруппированы; по клику — карточка.

- 3) Универсальная карточка сущности
  - Единый шаблон для Place/Event/Specialist/Offer: фото/иконка, описание, время, карта, контакты, действия: добавить в задачи, проложить маршрут, позвонить/написать, «скопировать промокод».
    Критерии: карточка открывается из ленты и поиска; действие «добавить в таймлайн» создаёт задачу с привязкой.

- 4) Список задач / Планировщик
  - CRUD задач, привязка к месту/сущности, напоминания (локальные).
    Критерии: создать/редактировать/удалить; отметить выполненной; отразить на таймлайне.

- 5) Настройки/Источники
  - Выбор города/радиуса, подключение календаря, включение/отключение типов источников.
    Критерии: выбранный город влияет на ленту; включение источника показывает/скрывает блоки.

Что оставить «вне скопа» пока

- Полный каталог «Товары» и e-commerce.
- Полноценные расписания специалистов с онлайн-записью.
- Сложная новостная лента (оставить 1–2 проверенных RSS).
- Массовые парсеры акций — начать с ручного листа и пары API.

Источники данных для MVP (простые и бесплатные)

- Погода: Open‑Meteo или OpenWeather (бесплатные тарифы).
- Места/карта: OpenStreetMap + MapTiler/MapLibre; геокодер — Nominatim.
- События/досуг: 1–2 открытых городских источника или curated Google Sheet, куда вы руками добавляете ключевые события.
- Акции/промокоды: Google Sheet как «реестр», возможно 1 публичный API промо (если найдёте), остальное вручную.
- Специалисты/услуги: небольшой curated список (10–30), через Sheet.
- Новости: 1 RSS из локального медиа.
- Задачи/календарь: локально + опциональная интеграция с Google Calendar (только чтение на MVP).

Как собрать данные без тяжёлого бэкенда

- Админ‑Google Sheet -> nightly build скрипт -> JSON в репозиторий/облако.
- Внешние API дергать на клиенте или через лёгкие serverless‑прокси (Next.js API routes).
- Нормализация схемы одна на все сущности: `type, time_start/end, place_ref, geo, actions`.

Алгоритм формирования Timeline

- Собрать все элементы с полем времени в выбранном диапазоне (задачи, события, погода/time slots, актуальные офферы с временем).
- Отфильтровать по радиусу/городу, типам источников.
- Сортировать: сначала фиксированные времена, затем дедлайны, потом «в любое время сегодня».
- Обогатить: добавить бейджи погоды на соответствующие часы; рядом с местом событию показать активные офферы в этом месте/категории.
- Вывести как вертикальную ленту + свернутые группировки по часу.

Мини‑схема данных (JSON-профиль сущности)

- Общие поля: `id, type, title, subtitle, time_start, time_end, place: {id, name, lat, lon}, tags: [], source, url, actions: [{type, payload}]`
- Пример actions: `add_to_tasks, copy_promo, call, navigate, open_url`.

Юзер‑стори (MVP)

- Как пользователь, я выбираю город и вижу на сегодня задачи, события и погоду в одном месте.
- Я ищу «стоматолог» и нахожу специалиста рядом, открываю карточку, добавляю задачу «Записаться завтра 12:00».
- Я открываю карточку места и вижу активный промокод, копирую его.
- Я переключаюсь в «Карту» и вижу пины мест из ленты.

Метрики и 30‑дневный kill‑switch

- Активация: ≥30 уникальных пользователей добавили ≥1 задачу или открыли ≥5 карточек.
- Retention D7: ≥20% вернулись хотя бы раз.
- PMF‑сигнал: ≥10 пользователей сохраняют в «избранное» ≥3 места/события или подключают календарь.
- Если ниже двух из трёх — пауза/пересмотр ценности. Если выше — расширяем источники.

Стек (предложение)

- Frontend: Next.js + React, Tailwind, Zustand/Redux по минимуму.
- Карта: MapLibre GL + тайлы MapTiler/OSM.
- Данные: Supabase/Postgres или SQLite (для MVP можно JSON на CDN).
- Аутентификация: анонимный гость + магия по e‑mail позже.
- Аналитика/события: PostHog/Umami.
- Дизайн: Figma, единая карточка-сущность + дизайн‑система на 10–12 компонентов.

План на 4–6 недель

- Неделя 1: Видение v0.1, карта сущностей, Figma 5 экранов, Google Sheets шаблоны, выбор города.
- Неделя 2: Поиск/карточка/база данных сущностей, импорт из Sheets, погода.
- Неделя 3: Таймлайн (день/неделя), фильтры, карта, действия карточек.
- Неделя 4: Список задач + привязка к сущностям, настройки/источники.
- Неделя 5: Полировка, аналитика, демо 10 пользователям, сбор обратной связи.
- Неделя 6: Поправки, микродеплой, сайт-лендинг.

Как двигаться дальше уже сегодня

- Утвердим первичный город/район и самый узкий кейс (например: «личный планировщик выходных в моём городе»).
- Я превращу ваш список в 1‑страничное ТЗ (видение + сущности + экраны) и шаблоны Google Sheets под Offers/Events/Places/Experts.
- Создайте репозиторий и зафиксируйте «Видение v0.1» — это формально закрепит авторство и курс.

Ответьте коротко:

- 1) Какой город/район и самый узкий сценарий (например: «план дня с событиями и погодой для фрилансера»)?
- 2) Какие три типы данных для старта обязательны (выберите 3 из: события, задачи, погода, места, специалисты, акции, новости)?
- 3) Готовы ли начать с Google Sheets как единого «источника правды» под события/акции/специалистов?

Готов на базе вашего списка собрать черновик ТЗ и макеты 5 экранов с критериями приемки.

---

## Инструментарий

Это отличное направление: «любую инфу — в один клик в таймлайн», где ИИ превращает сырой ввод (URL, выделение, скрин, голос) в структурированные сущности. Ниже — компактный план архитектуры и MVP по сбору/преобразованию + голосовые команды.

Архитектура (слои)

- Capture (сбор):
  - API‑коннекторы: погода, календарь, афиша/события, карты/геокодер.
  - Browser extension: контекстное меню «Добавить в таймлайн», отправка URL + выделенного текста + микроданных + опционально скриншота блока.
  - In‑app HTML‑выборка: «режим выделения» на странице (DOM‑пипетка).
  - Скриншоты/изображения: постеры, чеки → OCR.
  - Голос: STT + команды/заметки.
- AI‑Normalize (преобразование):
  - Классификация входа → тип сущности (`event/task/offer/place/specialist`).
  - Извлечение полей → нормализация даты/времени/валют, георезолвинг.
  - Дедупликация и связывание с Places.
  - Оценка уверенности + карточка‑подтверждение пользователю.
- Storage:
  - Unified Entities Store (Postgres/Supabase или JSON на старте).
  - Source registry и provenance: `source_url, captured_at, method, hash`.
- UI:
  - Timeline/Карта + Поиск + Универсальная карточка сущности.
- Governance:
  - Политики: robots.txt/ToS, приватность, экспорт данных.

Схема сущности (единый профиль)

- Общие поля: `id, type, title, subtitle, time_start, time_end, tz, place: {id|null, name?, lat?, lon?, address?}, tags[], price?, url?, source: {url, method, captured_at, hash}, confidence, actions[]`.
- Доп. для offer: `code, valid_from/to, product/category, terms`.
- Доп. для `specialist/service: contacts, schedule_slots[]`.

Пайплайн ИИ (на одном запросе)

- 1) Detect: какой тип и есть ли время/место.
- 2) Extract: JSON со всеми полями по единой схеме.
- 3) Validate/Enrich: парсинг дат (natty/chrono), геокодер, нормализация валют.
- 4) Dedup: ключ = norm_title + place + time_window (fuzzy match).
- 5) Confirm: показать превью, «Сохранить/Править».

Голосовые команды (интенты и слоты)

- Интенты:
  - `create_task(title, date|time, place?, duration?, tags?)`
  - `create_event(title, date|time, place, price?)`
  - `plan_day(date, preferences?, radius?)`
  - `find_offers(category|place, date?)`
  - `reschedule(item_id|title, new_date|time)`
- Примеры:
  - «Добавь встречу со стоматологом завтра в 12 на Ленина 10»
  - «Спланируй субботу: хобби, бюджет до 1500, рядом»
  - «Промокоды на кофе рядом сегодня»
- Диалог:
  - Слот‑филлинг с уточнениями: «Уточни время?» → подтверждение → запись.
- Технологии:
  - STT: Web Speech API, Whisper, Vosk.
  - NLU: лёгкий классификатор intents или LLM с function‑calling.
  - Безопасность: повтор подтверждения перед созданием/переносом.

Chrome‑расширение (MVP)

- Возможности:
  - Контекстное меню «Добавить в таймлайн».
  - Отправка: `url, title, selectionText, мета (og:*, schema.org JSON‑LD), screenshot области (optional)`.
  - Кнопка «Проверить» → превью карточки → «Сохранить».
- Manifest (фрагмент)

```json
  {
    "manifest_version": 3,
    "name": "Add to Timeline",
    "permissions": ["contextMenus", "scripting", "activeTab", "storage"],
    "host_permissions": ["https://*/", "http://*/"],
    "background": {"service_worker": "background.js"},
    "actions": {"default_title": "Add to Timeline"}
  }
```

- Поток:
  - content.js собирает выделение + метаданные → background → ваш API /extract.
  - /extract вызывает LLM для структурирования → /upsert сущности → возвращает превью.

Пример контракта LLM‑экстракции (function calling)

- Input: `{raw_text, html_snippet?, url?, selection?, locale, now, fallback_city}`
- Output (JSON): `{type, title, time_start, time_end, place:{name,address,lat,lon}, price, url, offer:{code,valid_to}, tags[], confidence, notes}`
- Подсказка модели:
  - «Определи тип: event|offer|place|task. Верни ISO8601, валюта в RUB, город по умолчанию — … Если не хватает данных — оставь null и задай followup_questions[].»

Пример Intent JSON (голос)

```json
{
  "intent": "create_event",
  "slots": {
    "title": "стоматолог",
    "date": "2025-09-02",
    "time": "12:00",
    "place": "ул. Ленина, 10",
    "duration_min": 30
  },
  "confirmation_prompt": "Создать событие «стоматолог» завтра 12:00 на ул. Ленина, 10?"
}
```

Право и приватность

- Соблюдать ToS источников, robots.txt; не обходить paywall/защиту.
- Личные данные специалистов — только из публичных источников с атрибуцией; по запросу удалить.
- Скриншоты/изображения — хранить локально/опционально, отключаемо.
- Логи AI — обезличенные, с выключателем «не отправлять контент в облако».

MVP без кредита: что сделать за 4 недели
Неделя 1

- Утвердить единую схему сущностей и intent‑модель.
- Figma: 4 экрана (Timeline, Поиск, Карточка, Добавление).
- Бэкенд: Next.js API routes /extract, /upsert, /search; Supabase/SQLite; интеграции: погода + геокодер.
Неделя 2
- Chrome‑расширение (контекстное меню, выделение, метаданные).
- LLM‑экстракция с валидацией; карточка‑подтверждение в вебе.
Неделя 3
- Дедуп + привязка к Places; простая афиша из Google Sheet; офферы из Sheets.
- Timeline + фильтры + мини‑погода.
Неделя 4
- Голос: STT + intents через LLM function‑calling; «подтвердить перед сохранением».
- Аналитика событий, ошибка/успех, ретрай; тест с 10 пользователями.

Критерии приёмки MVP

- Из браузера: выделил текст с афиши → «Добавить» → вижу событие на таймлайне с правильной датой и местом за ≤10 секунд.
- Голосом: «Добавь встречу завтра в 10 в МФЦ на Советской» → подтверждение → событие создано.
- Дедуп: повторное добавление того же события не создаёт дубль.
- Источники: погода и 1 календарь подключаются и влияют на ленту.

Выбор узкого скоупа на старт

- Каналы ввода: выберите 3 из 5 — 1) Расширение, 2) Голос, 3) Погода API, 4) Google Calendar (read‑only), 5) Google Sheet «Афиша/Акции».
- Язык распознавания голоса: RU/EN?
- Где хранить: Supabase (облако) или локально (SQLite + файлы)?

Готов подготовить:

- Чёткую JSON‑схему сущностей и intents.
- Промпт и функцию для LLM‑экстракции.
- ТЗ на расширение (потоки, экраны, события).
- Чек‑лист правовых ограничений для парсинга.

Скажите:

- 1) Какие 3 канала ввода берём в MVP?
- 2) В каком городе тестируем?
- 3) Нужна ли офлайн‑работа/локальное хранение на старте?

---

## Части возможного проекта

Отлично. Предлагаю компактную архитектуру “local‑first с облачной синхронизацией” и минимальный протокол, чтобы все ваши inputs (расширение, скриншоты, HTML‑выборка, голос) складывались в единый формат и попадали в таймлайн.

- 1) Общая структура приложения (3 части)
  - Inputs (сбор)
    - Chrome‑расширение (URL, выделение, микроданные, скрин области)
    - HTML‑пипетка внутри фронта
    - Скриншот/изображение → OCR
    - Голос (STT) → intents
    - API‑коннекторы (погода, календари, афиши)
  - Core/API (обращения, обработка)
    - /ingest: прием сырых данных
    - Нормализация ИИ → единые сущности
    - Дедуп/обогащение (геокодер, даты)
    - Хранилище и синхронизация
  - Frontend (оболочка)
    - Таймлайн/Карта, Поиск, Карточка, Список задач, Настройки
    - Режим “Добавить” из любого источника
    - Работает офлайн, синхронизируется при сети
- 2) Хранилища: уровни и выбор
  - Клиент (по умолчанию)
    - OPFS для файлов (скрины, вложения), IndexedDB для индексов/кэшей
    - Локальное шифрование (WebCrypto, ключ на устройстве)
    - Плюсы: приватность, офлайн; Минусы: нужен механизм синка
  - Облако (опционально)
    - DB: Postgres (Supabase) для сущностей и индексов
    - Blob: S3‑совместимый стор (MinIO/S3) для медиа
    - Очередь/джобы: Redis + воркер для ИИ‑экстракции
  - Режимы
    - Local‑only: ничего не уходит в облако (полный офлайн)
    - Local‑first + sync: локально всегда, при включенном синке — репликация
  - Рекомендация: начать с Local‑first + optional sync, чтобы не блокировать офлайн и приватность.
- 3) Единая модель данных
  - Три типа объектов:
    - Entity (JSON): `task/event/place/specialist/offer/news/weather_slot`
    - Source (provenance): откуда взято, когда, как
    - Blob (media): `content‑addressable` хэш файла
  - Общая схема Entity

    ```json
      {
        "id": "ulid",
        "schema_version": 1,
        "type": "event|task|place|specialist|offer|news|weather",
        "title": "string",
        "subtitle": "string|null",
        "time_start": "ISO8601|null",
        "time_end": "ISO8601|null",
        "tz": "Europe/Moscow",
        "place": {"id": "string|null", "name": "string|null", "lat": 55.75, "lon": 37.61, "address": "string|null"},
        "price": {"amount": 500, "currency": "RUB"}|null,
        "tags": ["string"],
        "url": "https://…",
        "offer": {"code": "COFFEE50", "valid_from": "…", "valid_to": "…"}|null,
        "contacts": {"phone": "…", "tg": "…"}|null,
        "source": {"url": "…", "method": "extension|api|voice|html|screenshot", "captured_at": "ISO", "hash": "sha256", "connector": "…"},
        "confidence": 0.86,
        "created_at": "ISO",
        "updated_at": "ISO",
        "deleted": false
      }
    ```

- 4) OPFS и клиентская структура
  - Дерево OPFS
    - `/entities/{type}/{id}.json`
    - `/blobs/{sha256}.{ext}`
    - `/queues/pending.jsonl` (батч операций на синк)
    - `/indexes/places.idx` (быстрый поиск)
  - IndexedDB
    - Индекс по времени/месту/типу
    - Журнал изменений (опкоды) для синка
  - Конфликты
    - LWW (last write wins) по updated_at для простоты
    - Для задач/заметок — опционально CRDT (yjs) позже
  - Псевдокод сохранения
    - Сырые входные → normalize() → entity
    - writeFile(`/entities/${type}/${id}.json`, JSON)
    - append `/queues/pending.jsonl` операцию upsert
    - обновить IndexedDB индексы
- 5) Мини‑протокол/REST API v1
  - Аутентификация
    - Magic link + device token
    - Для расширения — короткоживущий Capture Token (revocable)
  - Ingest/нормализация
    - `POST /v1/ingest`
      - `body: CapturePayload` (см. ниже)
      - `resp: {job_id, draft_entity?}`
    - `GET /v1/jobs/{job_id}`
      - `resp: {status: queued|processing|done|error, entity?}`
  - Сущности
    - `GET /v1/entities?type=event&since=ISO`
    - `GET /v1/entities/{id}`
    - `PATCH /v1/entities/{id}`  (JSON Patch RFC 6902)
    - `POST /v1/entities/batch_upsert`
  - Блоб‑загрузка
    - `POST /v1/blobs/init → {upload_url, blob_id}`
    - `PUT upload_url`  (прямо в S3)
  - Таймлайн
    - `GET /v1/timeline?date=2025-09-01&radius_km=5&lat=…&lon=…&types=task,event,offer`
  - Синхронизация (офлайн)
    - `POST /v1/sync/push  [{op: "upsert|delete", entity, client_ts}]`
    - `POST /v1/sync/pull  {since: ISO, types?: []} → {entities: [], tombstones: []}`
- 6) CapturePayload (универсальный вход)
  - Идея: любой инструмент приводит к одному контракту

    ```json
    {
      "kind": "url|selection|html|image|audio|voice_intent|api_event",
      "url": "https://…",                      // когда есть
      "title": "Заголовок страницы",
      "selection_text": "…",                   // выделение
      "html_snippet": "<article>…</article>",  // по возможности
      "metadata": {"og:title": "…", "ld+json": "{…}"},
      "image_blob_id": "sha256:…",             // если скрин
      "locale": "ru-RU",
      "fallback_city": "Москва",
      "geo_hint": {"lat": 55.75, "lon": 37.61},
      "captured_at": "ISO",
      "voice": { "transcript": "добавь…", "nlu": { "intent": "create_event", "slots": {…} } },
      "client": { "device": "chrome-ext 0.1", "app_version": "…"}
    }
    ```

  - Сервер/воркер:
    - detect → extract → validate/enrich → dedup → draft entity
    - если уверенность < threshold — пометить как draft и запросить подтверждение
- 7) Голосовые команды (интенты)
  - create_task, create_event, plan_day, find_offers, reschedule
  - Поток: STT → NLU (LLM function calling) → slots → подтверждение → запись
  - Безопасность: перед изменением существующего — обязательное подтверждение
- 8) Backend: минимальный набор сервисов
  - Monolith на старте (FastAPI/Express/Nest) + воркер
    - API: аутентификация, entities, timeline, sync, ingest
    - Воркер: очередь jobs (BullMQ/RQ), LLM‑экстракция, геокодинг, дедуп
  - Хранилище
    - Postgres: entities (jsonb), places, links, users, devices, jobs
    - S3: blobs
    - Redis: очередь
  - Реал‑тайм
    - WebSocket/SSE для пуша обновлений таймлайна
  - Нормализация дат/мест
    - chrono‑node/natty‑ru, Nominatim/Geocoding API
- 9) Безопасность и приватность
  - Режимы приватности per‑entity: local_only | synced_private | shared
  - E2E‑шифрование (опционально): приватные поля entity.data зашифрованы на клиенте
  - Политики источников: уважать robots.txt; не обходить paywalls
  - Удаление: “right to delete” на уровне сущности и исходника (provenance)
- 10) MVP‑рамка на 4–6 недель
  - Нед 1
    - Утвердить JSON‑схему Entity/CapturePayload
    - OPFS + IndexedDB: сохранение/поиск, очередь синка
    - Figma: 4 экрана (Таймлайн/Карта/Карточка/Добавить)
  - Нед 2
    - REST v1: /ingest, /entities, /timeline, /sync
    - Воркер: LLM‑экстракция из url|selection|html
    - Интеграции: погода + геокодер
  - Нед 3
    - Chrome‑расширение: контекстное меню, выделение, превью
    - Дедуп, связка с Places
  - Нед 4
    - Голос: STT + intents + подтверждение
    - Аналитика событий, логирование, метрики качества экстракции
  - Нед 5–6
    - Полировка UX, офлайн‑кэш таймлайна, баг‑фиксы, тест с 10–20 пользователями
- 11) Решения по умолчанию (можно править)
  - Протокол: REST + SSE, без GraphQL на старте (проще дебажить)
  - Синк: батчи изменений (push/pull), LWW
  - ID: ULID (времясортируемые, офлайн удобнее)
  - Блобы: content‑addressable (sha256), дубли не грузим
  - Версионирование: schema_version в каждой сущности; миграции в воркере
  - Лицензирование кода/спеки: вы — владелец IP, спецификацию можно опубликовать под CC BY (если захотите)

Короткие вопросы, чтобы я прислал черновик спецификации и эндпоинтов под вас:

- 1) Режим по умолчанию: Local‑only или Local‑first + sync?
- 2) Выбираем REST+SSE как базовый протокол?
- 3) Нужна ли E2E‑шифрация приватных полей на MVP?
- 4) Какие 2–3 канала ввода в первый релиз: расширение, HTML‑пипетка, голос, API‑коннекторы (погода/календарь)?
- 5) На каком стеке хотите сервер: Node (Nest/Fastify) или Python (FastAPI)?
