// Viewer Components - Refactored and Optimized
// Unified with design system variables and mixins

@use "veela-lib" as *;
@use "../../library/mixins" as ui;

// =============================================================================
// Loading State Animations
// =============================================================================

@keyframes viewer-spinner {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes viewer-pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 0.8; }
}

@keyframes viewer-slide-in {
    from {
        opacity: 0;
        transform: translateY(8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes viewer-fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes viewer-skeleton-shimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

@layer rs-viewers {
    // ==========================================================================
    // Loading Indicator Component
    // ==========================================================================

    .viewer-loading-indicator {
        position: absolute;
        inset-block-start: var(--padding-md);
        inset-inline-end: var(--padding-md);
        display: flex;
        align-items: center;
        gap: var(--gap-sm);
        padding: var(--padding-xs) var(--padding-sm);
        border-radius: var(--radius-md);
        background-color: oklch(from var(--surface-container-high) l c h / 0.9);
        backdrop-filter: blur(8px);
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-4px);
        transition:
            opacity var(--transition-fast),
            transform var(--transition-fast);

        &[data-state="loading"] {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .loading-spinner {
            inline-size: 1rem;
            block-size: 1rem;
            border: 2px solid oklch(from var(--primary) l c h / 0.2);
            border-block-start-color: var(--primary);
            border-radius: var(--radius-full);
            animation: viewer-spinner 0.8s linear infinite;
        }

        .loading-text {
            @include ui.text-label("label-small");
            color: var(--on-surface-variant);
        }
    }

    // ==========================================================================
    // Section Loading States
    // ==========================================================================

    .viewer-section {
        position: relative;

        &[data-loading-state="loading"] {
            &::before {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    oklch(from var(--primary) l c h / 0.05) 50%,
                    transparent 100%
                );
                background-size: 200% 100%;
                animation: viewer-skeleton-shimmer 1.5s ease-in-out infinite;
                pointer-events: none;
                z-index: 1;
                border-radius: inherit;
            }
        }

        &[data-loading-state="loaded"] {
            .viewer-tab-content-body {
                animation: viewer-fade-in 0.3s ease-out;
            }
        }

        &[data-loading-state="error"] {
            &::after {
                content: attr(data-error);
                position: absolute;
                inset-block-end: var(--padding-md);
                inset-inline: var(--padding-md);
                padding: var(--padding-sm) var(--padding-md);
                background-color: oklch(from var(--error) l c h / 0.1);
                color: var(--error);
                border-radius: var(--radius-md);
                @include ui.text-label("label-medium");
                text-align: center;
                z-index: 100;
            }
        }
    }

    // ==========================================================================
    // Content Visibility Optimization
    // ==========================================================================

    [data-type="tasks"],
    [data-type="contacts"],
    [data-type="bonuses"],
    [data-type="services"] {
        grid-auto-rows: minmax(0px, max-content);
        grid-auto-flow: row;
        column-fill: balance;
        align-items: start;

        //
        @include grid-auto-fill(260px);
        @include scrollable("y");

        //
        perspective: 1000;
        transform: translateZ(0px);
        content-visibility: auto;
        contain: strict;
        inline-size: stretch;
        max-inline-size: stretch;

        // Progressive content reveal
        & > * {
            animation: viewer-slide-in 0.25s ease-out backwards;

            @for $i from 1 through 12 {
                &:nth-child(#{$i}) {
                    animation-delay: #{$i * 30}ms;
                }
            }
        }
    }

    //
    .view-box {
        grid-row: content-row;
        grid-column: 1 / -1;
        inline-size: stretch;
        block-size: stretch;
        contain: strict;
        content-visibility: auto;

        //
        max-block-size: stretch;
        max-inline-size: stretch;
        min-inline-size: 0px;
        min-block-size: 0px;

        //
        grid-template-columns: minmax(0px, 1fr);
        grid-template-rows: [toolbar] minmax(0px, max-content) [content] minmax(0px, 1fr);
        display: grid;
        box-shadow: none;
    }

    //
    .view-box > * > section,
    .view-box > section {
        pointer-events: auto;
        touch-action: manipulation;

        //
        margin-inline: 0px;
        margin-block-start: var(--padding-sm);
        grid-row: content;
        box-shadow: none;

        //
        display: grid;
        grid-template-columns: minmax(0px, 1fr);
        grid-template-rows: minmax(0px, 1fr);
        inline-size: stretch;
        block-size: stretch;
        gap: var(--gap-xs);
        flex-grow: 1;

        //
        @include scrollable("y");
        @include ui.tonal-surface(surface-container-low, var(--surface-opacity-subtle), var(--radius-lg), null, 1);
        @include container-clamped(stretch, stretch);

        //
        perspective: 1000;
        transform: translateZ(0px);
        content-visibility: auto;
        contain: strict;

        //
        min-inline-size: 0px;
        max-inline-size: stretch;

        //
        &.viewer-section {
            background-color: transparent;
        }

        & {
            border-radius: var(--radius-lg);
            clip-path: inset(0px round var(--radius-lg));
        }
    }

    //
    header {
        min-block-size: max-content;
        block-size: max-content;
        line-height: normal;
        touch-action: manipulation;
        pointer-events: auto;

        * { pointer-events: none; }
    }

    //
    .view {
        display: block;
        padding: 0;
        border-radius: var(--radius-sm);

        //
        min-inline-size: 0px;
        max-inline-size: stretch;

        & > h2 {
            letter-spacing: 0.01em;

            @include ui.text-heading("title-medium");
        }
    }

    //
    ui-tabbed-box {
        inline-size: stretch;
        block-size: stretch;

        //
        gap: 0px;
        grid-column: 1 / -1;
        grid-row: 1 / -1;

        //
        @include container("lg") {
            order: 3;
            grid-column: 1 / -1;
        }

        // Loading state for tabbed box
        &[data-loading="loading"] {
            .viewer-tab-content {
                opacity: 0.7;
                pointer-events: none;
            }
        }

        .viewer-tab-content {
            @include ui.vstack(var(--gap-xs));
            @include ui.tonal-surface(surface-container, var(--surface-opacity-subtle), var(--radius-lg), var(--padding-sm), 1);
            @include scrollable("y");

            //
            & {
                box-shadow: none;
                perspective: 1000;
                transform: translateZ(0px);
                content-visibility: auto;
                contain: strict;

                //
                overflow-x: hidden;
                scrollbar-gutter: auto;
                touch-action: manipulation;
                pointer-events: auto;
                align-content: start;

                //
                inline-size: stretch;
                max-inline-size: stretch !important;
                min-inline-size: none;

                //
                overflow-wrap: break-word;
                text-overflow: ellipsis;

                // Smooth transitions for content changes
                transition: opacity var(--transition-normal);
            }

            // Empty state styling
            &:empty::after {
                content: "No items to display";
                display: flex;
                place-content: center;
                place-items: center;
                min-block-size: 120px;
                color: var(--on-surface-variant);
                @include ui.text-label("label-large");
                opacity: 0.6;
            }

            .viewer-tab-content-header {
                @include ui.text-heading("title-large", center);
                color: color-mix(in oklch, var(--on-surface, currentColor) var(--surface-opacity-muted, 8%), transparent);
                padding: var(--padding-xs);
                border-radius: var(--radius-sm);
                background-color: transparent;
                pointer-events: none;
            }

            .viewer-tab-content-body {
                @include ui.vstack(var(--gap-xs));
                pointer-events: none;
                block-size: max-content;

                //
                min-inline-size: 0px;
                max-inline-size: stretch;
                min-block-size: 0px;
                max-block-size: none;
                inline-size: stretch;

                //
                box-shadow: none;
                perspective: 1000;
                transform: translateZ(0px);
                content-visibility: auto;

                // Progressive reveal for body content
                & > * {
                    animation: viewer-slide-in 0.2s ease-out backwards;

                    @for $i from 1 through 8 {
                        &:nth-child(#{$i}) {
                            animation-delay: #{$i * 40}ms;
                        }
                    }
                }

                // Empty body state
                &:empty {
                    min-block-size: 80px;
                    display: grid;
                    place-content: center;

                    &::after {
                        content: "";
                        inline-size: 32px;
                        block-size: 32px;
                        border: 2px solid oklch(from var(--primary) l c h / 0.2);
                        border-block-start-color: var(--primary);
                        border-radius: var(--radius-full);
                        animation: viewer-spinner 0.8s linear infinite;
                    }
                }
            }
        }
    }

    //
    .subgroup {
        @include ui.vstack(var(--gap-xs));
        pointer-events: none;

        // Subgroup entry animation
        animation: viewer-slide-in 0.25s ease-out backwards;

        .subgroup-items {
            @include ui.vstack(var(--gap-xs));
            padding: var(--padding-xs);
            pointer-events: none;

            // Progressive card reveal within subgroup
            & > * {
                animation: viewer-slide-in 0.2s ease-out backwards;

                @for $i from 1 through 12 {
                    &:nth-child(#{$i}) {
                        animation-delay: #{$i * 25}ms;
                    }
                }
            }

            // Loading placeholder for items
            &:empty {
                min-block-size: 60px;
                background: linear-gradient(
                    90deg,
                    oklch(from var(--surface-container) l c h / 0.5) 0%,
                    oklch(from var(--surface-container-high) l c h / 0.5) 50%,
                    oklch(from var(--surface-container) l c h / 0.5) 100%
                );
                background-size: 200% 100%;
                animation: viewer-skeleton-shimmer 1.5s ease-in-out infinite;
                border-radius: var(--radius-md);
            }
        }

        .subgroup-header {
            @include ui.text-label("title-small", true);
            color: color-mix(in oklch, var(--on-surface, currentColor) var(--text-tint-primary, 92%), transparent);
            text-align: center;
            padding: var(--padding-xs);
            border-radius: var(--radius-sm);
            @include ui.tonal-surface(surface, var(--surface-opacity-emphasis), var(--radius-sm));
            background-color: transparent;
            pointer-events: none;

            // Sticky header behavior for long lists
            position: sticky;
            inset-block-start: 0;
            z-index: 10;
            backdrop-filter: blur(8px);
        }

        // Collapsed state for performance optimization
        &[data-collapsed="true"] {
            .subgroup-items {
                display: none;
                content-visibility: hidden;
            }
        }
    }

    // ==========================================================================
    // Scroll Performance Optimizations
    // ==========================================================================

    .viewer-section,
    .viewer-tab-content,
    .viewer-tab-content-body {
        // Optimize scrolling performance
        scroll-behavior: smooth;

        @media (prefers-reduced-motion: reduce) {
            scroll-behavior: auto;

            // Disable animations for reduced motion preference
            & *,
            & *::before,
            & *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    }

    // Intersection observer hint for lazy loading
    .viewer-tab-content-body > * {
        content-visibility: auto;
        contain-intrinsic-size: auto 80px;
    }

    // Speed Dial (Home) Styles
    .speed-dial-root {
        display: grid;
        grid-template-columns: minmax(0px, 1fr);
        grid-template-rows: minmax(0px, 1fr);
        pointer-events: auto;
        inline-size: 100%;
        block-size: 100%;
        inset: 0;
        position: fixed;
        background-color: transparent;
        overflow: hidden;
    }

    .speed-dial-grid {
        // Grid layout from data attributes - using CSS custom properties set by attr()
        // Modern approach: use registered @property with attr() fallback
        --grid-cols: 4;
        --grid-rows: 8;

        display: grid;
        gap: 0;
        padding: var(--padding-lg);

        // Grid columns via data attribute
        &[data-grid-columns="4"] { --grid-cols: 4; }
        &[data-grid-columns="5"] { --grid-cols: 5; }
        &[data-grid-columns="6"] { --grid-cols: 6; }

        // Grid rows via data attribute
        &[data-grid-rows="6"] { --grid-rows: 6; }
        &[data-grid-rows="7"] { --grid-rows: 7; }
        &[data-grid-rows="8"] { --grid-rows: 8; }
        &[data-grid-rows="9"] { --grid-rows: 9; }
        &[data-grid-rows="10"] { --grid-rows: 10; }
        &[data-grid-rows="11"] { --grid-rows: 11; }
        &[data-grid-rows="12"] { --grid-rows: 12; }

        //
        --layout-c: var(--grid-cols, 4);
        --layout-r: var(--grid-rows, 8);

        grid-template-columns: repeat(var(--cs-layout-c, 4), minmax(0px, 1fr));
        grid-template-rows: repeat(var(--cs-layout-r, 8), minmax(0px, 1fr));

        inline-size: 100%;
        block-size: 100%;
        pointer-events: none; // Background click should go through if needed, but items are auto

        place-content: center;
        place-items: center;

        // Items
        .ui-ws-item {
            background-color: transparent;
            pointer-events: none;
            display: grid;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            position: relative;

            text-align: center;
            place-content: center;
            place-items: center;
            place-self: center;

            grid-template-columns: minmax(0px, 1fr);
            grid-template-rows: minmax(0px, 1fr);

            box-shadow: none;
            filter: drop-shadow(0px 0px 0.25rem #0004) !important;

            // Visuals
            transition: transform var(--transition-fast) var(--ease-out);
            contain: none;
            overflow: visible;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;

            &:hover {
                transform: scale(1.05);

                .ui-ws-item-icon {
                    @include ui.tonal-surface(surface-container-high, var(--surface-opacity-default), var(--radius-lg), null, 2);
                }
            }

            &:active {
                transform: scale(0.95);
            }

            .ui-ws-item-icon {
                display: grid;
                /*border-radius: var(--radius-lg);*/
                transition: background-color var(--transition-colors), box-shadow var(--transition-colors), clip-path var(--transition-fast); /*, border-radius var(--transition-fast);*/
                grid-column: 1 / -1;
                grid-row: 1 / -1;
                aspect-ratio: 1 / 1;

                pointer-events: auto;
                position: relative;
                text-align: center;
                place-content: center;
                place-items: center;
                line-height: 0;
                overflow: hidden;
                contain: strict;
                cursor: pointer;

                inline-size: stretch;
                block-size: stretch;
                min-inline-size: fit-content;
                min-block-size: fit-content;
                max-inline-size: stretch;
                max-block-size: stretch;
                padding: 1rem;

                box-shadow: none;
                filter: none;

                // Default tonal surface background
                @include ui.tonal-surface(surface-container, var(--surface-opacity-default), var(--border-radius), null, 1);

                &, &:hover, &:active {
                    border-radius: var(--border-radius);
                }

                ui-icon {
                    --icon-size: clamp(2rem, 100%, 3rem);
                    color: var(--on-surface-variant, var(--on-surface-color, currentColor));
                    aspect-ratio: 1 / 1;
                    max-inline-size: var(--icon-size, 2rem);
                    max-block-size: var(--icon-size, 2rem);
                    min-inline-size: fit-content;
                    min-block-size: fit-content;
                    inline-size: var(--icon-size, 2rem);
                    block-size: var(--icon-size, 2rem);
                    object-fit: contain;
                    object-position: center;
                    line-height: 0;
                    z-index: 2;

                    filter: drop-shadow(0px 0px 0.25rem oklch(from var(--on-surface-variant, var(--on-surface-color, currentColor)) l c h / 0.4));
                }
            }

            .ui-ws-item-label {
                @include solid-colorize("&");

                position: absolute;
                inset: 0;
                pointer-events: none;
                text-align: center;
                place-content: center;
                place-items: center;
                grid-column: 1 / -1;
                grid-row: 1 / -1;
                perspective: 1000;
                backface-visibility: hidden;
                transform: translateY(calc(50% + 0.75rem)) translateZ(0px);
                color: var(--on-surface-color, currentColor);
                background-color: transparent;
                background-image: none;
                white-space: nowrap;
                aspect-ratio: auto;

                inline-size: 100%;
                min-inline-size: 0px;
                min-block-size: 1px;
                block-size: 100%;
                line-height: 0;
                overflow: visible;
                display: grid;
                filter: none;

                span {
                    display: flex;
                    place-content: center;
                    place-items: center;

                    @include ui.text-label("label-medium");
                    color: var(--on-surface-color, currentColor);
                    background-color: transparent;
                    background-image: none;

                    // Truncate
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    padding-inline: var(--padding-xs);
                    background: rgba(0,0,0,0.2); // Subtle backdrop for readability
                    border-radius: var(--radius-sm);
                    pointer-events: none;
                    text-align: center;
                    line-height: 0;
                    inline-size: stretch;

                    min-block-size: 1px;
                    block-size: fit-content;
                    max-block-size: fit-content;
                    overflow: visible;
                    max-inline-size: stretch;
                    min-inline-size: 1px;

                    text-shadow: 0px 0px 0.25rem #0004;
                }
            }

            &:active {
                will-change: transform;
            }

            &[data-dragging] {
                will-change: transform;
                cursor: grabbing;

                .ui-ws-item-label {
                    opacity: 0.0;
                    pointer-events: none;
                }
            }

            &[data-layer="labels"] {
                z-index: 0;
                filter: none;
            }

            &[data-layer="icons"] {
                z-index: 99;
                filter: none;
            }
        }
    }
}
