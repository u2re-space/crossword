// Viewer Components - Refactored and Optimized
// Unified with design system variables and mixins

@use "veela-lib" as *;
@use "../../library/mixins" as ui;

@layer rs-viewers {
    [data-type="tasks"],
    [data-type="contacts"],
    [data-type="bonuses"],
    [data-type="services"] {
        grid-auto-rows: minmax(0px, max-content);
        grid-auto-flow: row;
        column-fill: balance;
        align-items: start;

        //
        @include grid-auto-fill(260px);
        @include scrollable("y");

        //
        perspective: 1000;
        transform: translateZ(0px);
        content-visibility: auto;
        contain: strict;
        inline-size: stretch;
        max-inline-size: stretch;
    }

    //
    .view-box {
        grid-row: content-row;
        grid-column: 1 / -1;
        inline-size: stretch;
        block-size: stretch;
        contain: strict;
        content-visibility: auto;

        //
        max-block-size: stretch;
        max-inline-size: stretch;
        min-inline-size: 0px;
        min-block-size: 0px;

        //
        grid-template-columns: minmax(0px, 1fr);
        grid-template-rows: [toolbar] minmax(0px, max-content) [content] minmax(0px, 1fr);
        display: grid;
        box-shadow: none;
    }

    //
    .view-box > * > section,
    .view-box > section {
        pointer-events: auto;
        touch-action: manipulation;

        //
        margin-inline: 0px;
        margin-block-start: var(--padding-sm);
        grid-row: content;
        box-shadow: none;

        //
        display: grid;
        grid-template-columns: minmax(0px, 1fr);
        grid-template-rows: minmax(0px, 1fr);
        inline-size: stretch;
        block-size: stretch;
        gap: var(--gap-xs);
        flex-grow: 1;

        //
        @include scrollable("y");
        @include ui.tonal-surface(surface-container-low, var(--surface-opacity-subtle), var(--radius-lg), null, 1);
        @include container-clamped(stretch, stretch);

        //
        perspective: 1000;
        transform: translateZ(0px);
        content-visibility: auto;
        contain: strict;

        //
        min-inline-size: 0px;
        max-inline-size: stretch;

        //
        &.viewer-section {
            background-color: transparent;
        }

        & {
            border-radius: var(--radius-lg);
            clip-path: inset(0px round var(--radius-lg));
        }
    }

    //
    header {
        min-block-size: max-content;
        block-size: max-content;
        line-height: normal;
        touch-action: manipulation;
        pointer-events: auto;

        * { pointer-events: none; }
    }

    //
    .view {
        display: block;
        padding: 0;
        border-radius: var(--radius-sm);

        //
        min-inline-size: 0px;
        max-inline-size: stretch;

        & > h2 {
            letter-spacing: 0.01em;

            @include ui.text-heading("title-medium");
        }
    }

    //
    ui-tabbed-box {
        inline-size: stretch;
        block-size: stretch;

        //
        gap: 0px;
        grid-column: 1 / -1;
        grid-row: 1 / -1;

        //
        @include container("lg") {
            order: 3;
            grid-column: 1 / -1;
        }

        .viewer-tab-content {
            @include ui.vstack(var(--gap-xs));
            @include ui.tonal-surface(surface-container, var(--surface-opacity-subtle), var(--radius-lg), var(--padding-sm), 1);
            @include scrollable("y");

            //
            & {
                box-shadow: none;
                perspective: 1000;
                transform: translateZ(0px);
                content-visibility: auto;
                contain: strict;

                //
                overflow-x: hidden;
                scrollbar-gutter: auto;
                touch-action: manipulation;
                pointer-events: auto;
                align-content: start;

                //
                inline-size: stretch;
                max-inline-size: stretch !important;
                min-inline-size: none;

                //
                overflow-wrap: break-word;
                text-overflow: ellipsis;
            }

            .viewer-tab-content-header {
                @include ui.text-heading("title-large", center);
                color: color-mix(in oklch, var(--on-surface, currentColor) var(--surface-opacity-muted, 8%), transparent);
                padding: var(--padding-xs);
                border-radius: var(--radius-sm);
                background-color: transparent;
                pointer-events: none;
            }

            .viewer-tab-content-body {
                @include ui.vstack(var(--gap-xs));
                pointer-events: none;
                block-size: max-content;

                //
                min-inline-size: 0px;
                max-inline-size: stretch;
                min-block-size: 0px;
                max-block-size: none;
                inline-size: stretch;

                //
                box-shadow: none;
                perspective: 1000;
                transform: translateZ(0px);
                content-visibility: auto;
            }
        }
    }

    //
    .subgroup {
        @include ui.vstack(var(--gap-xs));
        pointer-events: none;

        .subgroup-items {
            @include ui.vstack(var(--gap-xs));
            padding: var(--padding-xs);
            pointer-events: none;
        }

        .subgroup-header {
            @include ui.text-label("title-small", true);
            color: color-mix(in oklch, var(--on-surface, currentColor) var(--text-tint-primary, 92%), transparent);
            text-align: center;
            padding: var(--padding-xs);
            border-radius: var(--radius-sm);
            @include ui.tonal-surface(surface, var(--surface-opacity-emphasis), var(--radius-sm));
            background-color: transparent;
            pointer-events: none;
        }
    }

    // Speed Dial (Home) Styles
    .speed-dial-root {
        inline-size: 100%;
        block-size: 100%;
        overflow: hidden;
    }

    .speed-dial-grid {
        // This depends on ui-gridbox mixin behaving as a grid
        display: grid;
        // Default layout if mixin fails or is overridden
        /*grid-template-columns: repeat(var(--layout-c, 4), 1fr);
        grid-template-rows: repeat(var(--layout-r, 8), 1fr);*/
        gap: 0; // Gap handled by grid placement logic usually, or padding in items
        padding: var(--padding-lg);

        inline-size: 100%;
        block-size: 100%;
        pointer-events: none; // Background click should go through if needed, but items are auto

        place-content: center;
        place-items: center;

        // Items
        .ui-ws-item {
            background-color: transparent;
            pointer-events: auto;
            display: grid;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            overflow: visible;
            position: relative;

            text-align: center;
            place-content: center;
            place-items: center;
            place-self: center;

            grid-template-columns: minmax(0px, 1fr);
            grid-template-rows: minmax(0px, 1fr);

            // Visuals
            transition: transform var(--transition-fast) var(--ease-out);
            cursor: pointer;

            &:hover {
                transform: scale(1.05);

                .ui-ws-item-icon {
                    @include ui.tonal-surface(surface-container-high, var(--surface-opacity-default), var(--radius-lg), null, 2);
                }
            }

            &:active {
                transform: scale(0.95);
            }

            .ui-ws-item-icon {
                display: grid;
                border-radius: var(--radius-lg);
                /*background: color-mix(in oklch, var(--surface-container-low, #fff) 80%, transparent);*/
                /*box-shadow: var(--shadow-md);*/
                transition: background-color var(--transition-colors), box-shadow var(--transition-colors);
                grid-column: 1 / -1;
                grid-row: 1 / -1;
                aspect-ratio: 1 / 1;

                position: relative;
                text-align: center;
                place-content: center;
                place-items: center;
                line-height: 0;

                inline-size: stretch;
                block-size: stretch;
                min-inline-size: fit-content;
                min-block-size: fit-content;
                max-inline-size: stretch;
                max-block-size: stretch;
                padding: 1rem;

                ui-icon {
                    --icon-size: clamp(2rem, 100%, 3rem);
                    color: var(--on-surface-variant);
                    aspect-ratio: 1 / 1;
                    max-inline-size: var(--icon-size, 2rem);
                    max-block-size: var(--icon-size, 2rem);
                    min-inline-size: fit-content;
                    min-block-size: fit-content;
                    inline-size: var(--icon-size, 2rem);
                    block-size: var(--icon-size, 2rem);
                    object-fit: contain;
                    object-position: center;
                    line-height: 0;
                }
            }

            .ui-ws-item-label {
                position: absolute;
                inset: 0;
                background-color: transparent;
                pointer-events: none;
                text-align: center;
                place-content: center;
                place-items: center;
                grid-column: 1 / -1;
                grid-row: 1 / -1;
                transform: translateY(calc(50% + 0.75rem)) translateZ(0px);
                white-space: nowrap;
                aspect-ratio: auto;

                inline-size: 100%;
                min-inline-size: 0px;
                min-block-size: 1px;
                block-size: 100%;
                line-height: 0;
                overflow: visible;
                display: grid;

                span {
                    display: flex;
                    place-content: center;
                    place-items: center;

                    @include ui.text-label("label-medium");
                    color: var(--speed-dial-label-color);
                    /*text-shadow: var(--speed-dial-label-shadow);*/

                    // Truncate
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    padding-inline: var(--padding-xs);
                    background: rgba(0,0,0,0.2); // Subtle backdrop for readability
                    border-radius: var(--radius-sm);
                    pointer-events: none;
                    text-align: center;
                    line-height: 0;
                    inline-size: stretch;

                    min-block-size: 1px;
                    block-size: fit-content;
                    max-block-size: fit-content;
                    overflow: visible;
                    max-inline-size: stretch;
                    min-inline-size: 1px;
                }
            }

            &:active {
                will-change: transform;
            }

            &[data-dragging] {
                will-change: transform;
                cursor: grabbing;

                .ui-ws-item-label {
                    opacity: 0.0;
                    pointer-events: none;
                }
            }

            &[data-layer="labels"] {
                z-index: 0;
            }

            &[data-layer="icons"] {
                z-index: 99;
            }
        }
    }
}
