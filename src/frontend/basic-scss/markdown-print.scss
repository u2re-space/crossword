@use "./lib/config" as config;
@use "./lib/mixins" as mixins;
@use "./lib/tokens" as tokens;

// === Main page styles ===
@page {
    size: A4;
    margin: config("page", "margin");

    @bottom-center {
        content: counter(page);
        font-family: config("typography", "font-family", "sans");
        font-size: config("typography", "font-size", "base");
        line-height: tokens.$line-height-base;
    }

    @top-right {
        content: "UC";
        font-family: config("typography", "font-family", "sans");
        font-size: config("typography", "font-size", "base");
    }
}

// === Main layer for printing ===
@layer markdown-print {
    // Font smoothing
    @media print {
        *, *::before, *::after {
            scrollbar-width: none;
            scrollbar-color: transparent transparent;
            overflow: visible;
            box-sizing: border-box;

            //
            @include mixins.md-font-smoothing(never);
        }

        math {
            math-style: compact;
            math-shift: compact;
            math-depth: auto-add;
        }

        :where(html, body) {
            background-color: white;
            max-inline-size: 100dvi;
            overflow-inline: hidden;
            border: none 0px transparent;
            outline: none 0px transparent;
            padding: 0px;
            margin: 0px;
        }

        :host {
            background-color: transparent;
            max-inline-size: stretch;
            overflow-inline: hidden;
            scrollbar-width: none;
            scrollbar-color: transparent transparent;
            border: none 0px transparent;
            outline: none 0px transparent;
            padding: 0px;
            margin: 0px;
        }

        :host,
        :scope,
        :root,
        .markdown-body,
        #markdown,
        md-view {
            & > * {
                max-inline-size: 100cqi;
                max-inline-size: stretch;
            }
        }

        :where(html, body, :host) {
            font-family: config("typography", "font-family", "sans");
            font-size: config("typography", "font-size", "base");
            line-height: tokens.$line-height-base;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: auto;
        }

        @scope (:where(body, :host) :not([data-print])) to (:has(> [data-print])) {
            :scope > :where(div, img, canvas, :not(:defined)):not([data-print]):not([data-print-pass]) {
                display: none !important;
                visibility: collapse !important;
            }
        }

        :where(*:not(:defined), style, script, link) {
            display: none !important;
            visibility: collapse !important;
        }

        :where(p, span, a, ul, ol, li, strong, h1, h2) {
            filter: grayscale(100%);
        }

        :where(blockquote, blockquote p) {
            filter: none;
        }

        :where([data-print]) {
            :where(li, ul, ol) {
                text-align: start;
            }

            :where(hr) {
                background-color: transparent;
                border-color: #666;
            }

            // Enhanced print typography
            h1, h2, h3, h4, h5, h6 {
                color: black !important;
                page-break-after: avoid;
                break-after: avoid;
            }

            p, li, dd {
                color: black !important;
                orphans: 3;
                widows: 3;
            }

            blockquote {
                background: #f9f9f9 !important;
                border-left-color: #666 !important;
                color: black !important;
                break-inside: avoid;
            }

            pre {
                background: #f5f5f5 !important;
                border: 1px solid #ccc !important;
                color: black !important;
                break-inside: avoid;
                white-space: pre-wrap;
            }

            code:not(pre code) {
                background: #f0f0f0 !important;
                border: 1px solid #ddd !important;
                color: black !important;
            }

            table {
                border: 1px solid #666 !important;
                break-inside: avoid;

                th, td {
                    border: 1px solid #666 !important;
                    color: black !important;
                }

                th {
                    background: #f0f0f0 !important;
                }
            }

            img {
                max-width: 100% !important;
                break-inside: avoid;
            }

            a {
                color: black !important;
                text-decoration: underline !important;
            }

            .katex {
                color: black !important;
            }
        }

        :where([data-print-pass]) {
            display: contents !important;
            visibility: visible;
        }

        hr:only-child {
            display: none !important;
        }
    }
}

// === Page breaks ===
@layer page-breaks {
    @media print {
        :where(h1:first-child, h2) {
            break-before: auto;
        }

        h2:has(+h3) {
            break-before: recto;
        }

        h1:not(:first-child) {
            @include mixins.md-break(recto, auto, auto);
        }

        *:has(+h1) {
            break-after: auto;
        }

        h1 ~ h2:first-of-type {
            break-before: auto;
        }

        :where(table) + h2 {
            break-before: recto;
        }

        hr:has(+h1, +h2, +h3, +h4, +h5, +h6) {
            break-after: verso;
        }

        :where(table, pre, code, p, ul, ol, li) {
            @include mixins.md-break(auto, avoid-page, auto);
        }

        :where(hr, p, ol, li, table, blockquote, pre, code, strong) {
            & + :where(h1, h2, h3, h4, h5, h6) {
                break-before: recto;
            }

            &:has(+h1, +h2, +h3, +h4, +h5, +h6) {
                break-after: auto;
            }

            &:not(hr):has(+h2) {
                break-after: recto;
            }

            &:has(+p, +pre, +code, +ol, +li, +table, +blockquote, +strong) {
                break-after: avoid-page;
            }

            & + :where(p, ol, li, table, blockquote, strong) {
                break-before: avoid-page;
            }

            & + hr + :where(h1, h2):has(+:where(p, ol, ul, blockquote)) {
                break-before: recto;
            }
        }

        :where(.pb, .np, .pagebreak, .newpage, .page-break, .new-page) {
            background-color: transparent;
            page-break-after: always;
            @include mixins.md-break(auto, auto, page);
        }

        :where(h1, h2, h3, h4, h5, h6) {
            &:has(+:where(hr, p, ul, ol, li, table, blockquote, pre, code)) {
                break-before: auto;
                break-after: avoid-page;
            }
        }

        :where(h1, h2) {
            &:has(+:where(p, table, hr)) {
                break-before: recto;
            }
        }
    }
}
