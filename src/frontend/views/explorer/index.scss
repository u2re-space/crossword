@layer view.explorer {
    @mixin spinner($size, $border, $accent, $duration: 0.8s) {
        inline-size: $size;
        block-size: $size;
        border: $border solid var(--view-border, rgba(128, 128, 128, 0.2));
        border-block-start-color: $accent;
        border-radius: 50%;
        animation: rs-spin $duration linear infinite;
    }

    @layer tokens {
        :root:has([data-view="explorer"]),
        html:has([data-view="explorer"]) {
            --view-layout: "flex";
            --view-content-max-width: none;
        }

        :host:has(.view-explorer) {
            /* Typography */
            --view-font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            --view-font-size: 0.875rem;
            --view-line-height: 1.5;
        }
    }

    @layer base {
        :host:has(.view-explorer) {
            /* Layout */
            display: flex;
            flex-direction: column;
            contain: layout style;
            block-size: 100%;
            min-block-size: 300px;

            /* Typography usage */
            font-family: var(--view-font-family);
            font-size: var(--view-font-size);
            line-height: var(--view-line-height);
            color: var(--view-fg);
            background: var(--view-bg);
        }

        .view-explorer {
            display: flex;
            flex-direction: column;
            block-size: 100%;
            background-color: var(--view-bg, var(--color-surface, #ffffff));
            color: var(--view-fg, var(--color-on-surface, #1a1a1a));
        }

        .view-explorer__content {
            flex: 1;
            overflow: hidden;
            block-size: stretch;
            inline-size: stretch;
            max-inline-size: stretch;
            max-block-size: stretch;
            min-inline-size: 0;
            min-block-size: 0;
            box-sizing: border-box;
            padding: 0;
            margin: 0;
            border: none;
            border-radius: 0;
            outline: none;
            background: transparent;
            color: inherit;

            & > ui-file-manager {
                block-size: 100%;
                inline-size: 100%;
            }
        }

        .view-explorer__loading,
        .view-explorer__error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            block-size: 100%;
        }

        .view-explorer__loading {
            color: var(--view-fg);
            opacity: 0.6;
        }

        .view-explorer__spinner {
            @include spinner(32px, 3px, var(--color-primary, var(--color-primary, #007acc)));
        }

        .view-explorer__error {
            p {
                margin: 0;
                color: var(--color-error, #d32f2f);
            }

            button {
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 6px;
                background-color: var(--color-primary, var(--color-primary, #007acc));
                color: white;
                cursor: pointer;

                &:hover {
                    filter: brightness(1.1);
                }
            }
        }
    }

    @layer components {
        .rs-explorer {
            display: flex;
            flex-direction: column;
            block-size: 100%;
            background: var(--view-bg);
            border: 1px solid var(--view-border);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .rs-explorer__toolbar,
        .rs-explorer__status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--view-bg-secondary);
            flex-shrink: 0;
        }

        .rs-explorer__toolbar {
            padding: 0.5rem;
            border-block-end: 1px solid var(--view-border);
        }

        .rs-explorer__status {
            gap: 1rem;
            padding: 0.375rem 0.75rem;
            border-block-start: 1px solid var(--view-border);
            font-size: 0.75rem;
            color: var(--view-fg-muted);
        }

        .rs-explorer__nav,
        .rs-explorer__actions {
            display: flex;
            gap: 0.125rem;
        }

        .rs-explorer__breadcrumb {
            flex: 1;
            min-inline-size: 0;
            padding: 0 0.5rem;
        }

        .rs-explorer__path {
            display: block;
            font-size: 0.8125rem;
            color: var(--view-fg-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rs-explorer__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.375rem;
            font-family: inherit;
            font-size: inherit;
            color: var(--view-fg-muted);
            background: transparent;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.15s ease, color 0.15s ease;

            &:hover:not(:disabled) {
                color: var(--view-fg);
                background: var(--view-hover-bg);
            }

            &:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            ui-icon {
                font-size: 1.125rem;
            }
        }

        .rs-explorer__btn--primary {
            padding: 0.5rem 1rem;
            color: white;
            background: var(--view-accent);

            &:hover:not(:disabled) {
                background: var(--view-accent-hover);
                color: white;
            }
        }

        .rs-explorer__content {
            flex: 1;
            min-block-size: 0;
            overflow: hidden;
        }

        .rs-explorer__list {
            block-size: 100%;
            overflow-y: auto;
            outline: none;
            scroll-behavior: smooth;
            overscroll-behavior: contain;

            &:focus-visible {
                outline: 2px solid var(--view-accent);
                outline-offset: -2px;
            }
        }

        .rs-explorer__loading,
        .rs-explorer__empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            color: var(--view-fg-muted);
            text-align: center;
        }

        .rs-explorer__loading {
            padding: 2rem;
        }

        .rs-explorer__empty {
            gap: 1rem;
            padding: 3rem 2rem;

            ui-icon {
                font-size: 3rem;
                opacity: 0.5;
            }

            p {
                margin: 0;
            }
        }

        .rs-explorer__spinner {
            @include spinner(1.5rem, 2px, var(--view-accent));
        }

        .rs-explorer__item {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.1s ease;

            &:hover {
                background: var(--view-hover-bg);
            }

            &[aria-selected="true"] {
                background: var(--view-selected-bg);

                &::before {
                    content: "";
                    position: absolute;
                    inset-inline-start: 0;
                    inset-block: 0;
                    inline-size: 3px;
                    background: var(--view-selected-border);
                }
            }

            &:focus-visible {
                outline: 2px solid var(--view-accent);
                outline-offset: -2px;
            }
        }

        .rs-explorer__item-icon {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;

            ui-icon {
                font-size: 1.5rem;
            }

            [data-kind="directory"] & {
                color: var(--view-icon-folder);
            }

            [data-kind="file"] & {
                color: var(--view-icon-file);
            }
        }

        .rs-explorer__item-info {
            flex: 1;
            min-inline-size: 0;
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }

        .rs-explorer__item-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rs-explorer__item-meta {
            font-size: 0.75rem;
            color: var(--view-fg-muted);
        }

        .rs-explorer__selected-count:not(:empty)::before {
            content: "â€¢";
            margin-inline-end: 1rem;
        }
    }

    @layer states {
        :host([loading]) .rs-explorer__list > :not(.rs-explorer__loading) {
            display: none;
        }

        :host(:not([loading])) .rs-explorer__loading {
            display: none;
        }

        :host(.dragover) {
            .rs-explorer__content {
                background: var(--view-selected-bg);
                border: 2px dashed var(--view-selected-border);
            }
        }

        .rs-explorer[data-view-mode="grid"] {
            .rs-explorer__list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 0.5rem;
                padding: 0.75rem;
            }

            .rs-explorer__item {
                flex-direction: column;
                padding: 0.75rem;
                text-align: center;
                border-radius: 0.375rem;
                border: 1px solid transparent;

                &[aria-selected="true"] {
                    border-color: var(--view-selected-border);

                    &::before {
                        display: none;
                    }
                }
            }

            .rs-explorer__item-icon ui-icon {
                font-size: 2.5rem;
            }

            .rs-explorer__item-info {
                align-items: center;
            }

            .rs-explorer__item-name {
                font-size: 0.8125rem;
                max-inline-size: 100%;
            }

            .rs-explorer__item-meta {
                font-size: 0.6875rem;
            }

            .rs-explorer__empty,
            .rs-explorer__loading {
                grid-column: 1 / -1;
            }
        }
    }

    @layer media {
        @media (max-width: 480px) {
            .rs-explorer__toolbar {
                flex-wrap: wrap;
            }

            .rs-explorer__breadcrumb {
                order: 3;
                inline-size: 100%;
                padding: 0.25rem 0 0;
            }

            .rs-explorer[data-view-mode="grid"] .rs-explorer__list {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }
    }

    @layer animations {
        @keyframes rs-spin {
            to {
                transform: rotate(360deg);
            }
        }
    }
}