@use "veela-lib" as *;
@use "../../library/mixins" as ui;

//
@layer rs-viewers {
    // ==========================================================================
    // Loading Indicator Component
    // ==========================================================================

    .viewer-loading-indicator {
        position: absolute;
        inset-block-start: var(--padding-md);
        inset-inline-end: var(--padding-md);
        display: flex;
        align-items: center;
        gap: var(--gap-sm);
        padding: var(--padding-xs) var(--padding-sm);
        border-radius: var(--radius-md);
        background-color: oklch(from var(--surface-container-high) l c h / 0.9);
        backdrop-filter: blur(8px);
        z-index: 100;
        opacity: 0;
        pointer-events: none;
        transform: translateY(-4px);
        transition:
            opacity var(--transition-fast),
            transform var(--transition-fast);

        &[data-state="loading"] {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .loading-spinner {
            inline-size: 1rem;
            block-size: 1rem;
            border: 2px solid oklch(from var(--primary) l c h / 0.2);
            border-block-start-color: var(--primary);
            border-radius: var(--radius-full);
            animation: viewer-spinner 0.8s linear infinite;
        }

        .loading-text {
            @include ui.text-label("label-small");
            color: var(--on-surface-variant);
        }
    }

    // ==========================================================================
    // Section Loading States
    // ==========================================================================

    .viewer-section {
        position: relative;

        &[data-loading-state="loading"] {
            &::before {
                content: "";
                position: absolute;
                inset: 0;
                background: linear-gradient(
                    90deg,
                    transparent 0%,
                    oklch(from var(--primary) l c h / 0.05) 50%,
                    transparent 100%
                );
                background-size: 200% 100%;
                animation: viewer-skeleton-shimmer 1.5s ease-in-out infinite;
                pointer-events: none;
                z-index: 1;
                border-radius: inherit;
            }
        }

        &[data-loading-state="loaded"] {
            .viewer-tab-content-body {
                animation: viewer-fade-in 0.3s ease-out;
            }
        }

        &[data-loading-state="error"] {
            &::after {
                content: attr(data-error);
                position: absolute;
                inset-block-end: var(--padding-md);
                inset-inline: var(--padding-md);
                padding: var(--padding-sm) var(--padding-md);
                background-color: oklch(from var(--error) l c h / 0.1);
                color: var(--error);
                border-radius: var(--radius-md);
                @include ui.text-label("label-medium");
                text-align: center;
                z-index: 100;
            }
        }
    }

    // ==========================================================================
    // Content Visibility Optimization
    // ==========================================================================

    [data-type="tasks"],
    [data-type="contacts"],
    [data-type="bonuses"],
    [data-type="services"] {
        grid-auto-rows: minmax(0px, max-content);
        grid-auto-flow: row;
        column-fill: balance;
        align-items: start;

        //
        @include grid-auto-fill(260px);
        @include scrollable("y");

        //
        perspective: 1000;
        transform: translateZ(0px);
        content-visibility: auto;
        contain: strict;
        inline-size: stretch;
        max-inline-size: stretch;

        // Progressive content reveal
        & > * {
            animation: viewer-slide-in 0.25s ease-out backwards;

            @for $i from 1 through 12 {
                &:nth-child(#{$i}) {
                    animation-delay: #{$i * 30}ms;
                }
            }
        }
    }

    section {
        background-color: transparent;
    }

    ui-file-manager {
        background-color: oklch(from --c2-surface(0.15, var(--current, currentColor)) l c h / 0.9);
        backdrop-filter: blur(1rem);
    }

    //
    ui-tabbed-box {
        inline-size: stretch;
        block-size: stretch;

        //
        gap: 0px;
        grid-column: 1 / -1;
        grid-row: 1 / -1;

        //
        @include container("lg") {
            order: 3;
            grid-column: 1 / -1;
        }

        // Loading state for tabbed box
        &[data-loading="loading"] {
            .viewer-tab-content {
                opacity: 0.7;
                pointer-events: none;
            }
        }

        .viewer-tab-content {
            @include ui.vstack(var(--gap-xs));
            @include ui.tonal-surface(surface-container, var(--surface-opacity-subtle), 0px, var(--padding-sm), 1);
            @include scrollable("y");

            //
            & {
                min-inline-size: 0px;
                min-block-size: 0px;
                max-inline-size: stretch;
                max-block-size: stretch;
                inline-size: stretch;
                block-size: stretch;
                box-sizing: border-box;

                //
                box-shadow: none;
                perspective: 1000;
                transform: translateZ(0px);
                content-visibility: auto;
                contain: strict;

                //
                overflow-x: hidden;
                scrollbar-gutter: auto;
                touch-action: manipulation;
                pointer-events: auto;
                align-content: start;

                //
                overflow-wrap: break-word;
                text-overflow: ellipsis;

                // Smooth transitions for content changes
                transition: opacity var(--transition-normal);

                //
                background-color: oklch(from --c2-surface(0.15, var(--current, currentColor)) l c h / 0.9);
                backdrop-filter: blur(1rem);
            }

            // Empty state styling
            &:empty::after {
                content: "No items to display";
                display: flex;
                place-content: center;
                place-items: center;
                min-block-size: 120px;
                color: var(--on-surface-variant);
                @include ui.text-label("label-large");
                opacity: 0.6;
            }

            .viewer-tab-content-header {
                @include ui.text-heading("title-large", center);
                color: color-mix(in oklch, var(--on-surface, currentColor) var(--surface-opacity-muted, 8%), transparent);
                padding: var(--padding-xs);
                border-radius: var(--radius-sm);
                background-color: transparent;
                pointer-events: none;
            }

            .viewer-tab-content-body {
                @include ui.vstack(var(--gap-xs));
                pointer-events: none;
                block-size: max-content;

                //
                min-inline-size: 0px;
                max-inline-size: stretch;
                min-block-size: 0px;
                max-block-size: none;
                inline-size: stretch;

                //
                box-shadow: none;
                perspective: 1000;
                transform: translateZ(0px);
                content-visibility: auto;

                // Progressive reveal for body content
                & > * {
                    animation: viewer-slide-in 0.2s ease-out backwards;

                    @for $i from 1 through 8 {
                        &:nth-child(#{$i}) {
                            animation-delay: #{$i * 40}ms;
                        }
                    }
                }

                // Loading state - show spinner only when actively loading
                &[data-load-state="loading"]:empty {
                    min-block-size: 80px;
                    display: grid;
                    place-content: center;

                    &::after {
                        content: "";
                        inline-size: 32px;
                        block-size: 32px;
                        border: 2px solid oklch(from var(--primary) l c h / 0.2);
                        border-block-start-color: var(--primary);
                        border-radius: var(--radius-full);
                        animation: viewer-spinner 0.8s linear infinite;
                    }
                }

                // Empty state after load completed - show "No items" message
                &[data-load-state="empty"]:empty,
                &[data-load-state="loaded"]:empty {
                    min-block-size: 80px;
                    display: grid;
                    place-content: center;

                    &::after {
                        content: "No items to display";
                        color: var(--on-surface-variant);
                        @include ui.text-label("label-medium");
                        opacity: 0.6;
                        animation: viewer-fade-in 0.3s ease-out;
                    }
                }

                // Pending state (initial, before load starts) - subtle placeholder
                &[data-load-state="pending"]:empty {
                    min-block-size: 40px;
                    display: grid;
                    place-content: center;
                    opacity: 0.4;
                }
            }
        }
    }

    //
    .subgroup {
        @include ui.vstack(var(--gap-xs));
        pointer-events: none;
        text-align: center;

        // Subgroup entry animation
        animation: viewer-slide-in 0.25s ease-out backwards;

        .subgroup-items {
            @include ui.vstack(var(--gap-xs));
            padding: var(--padding-xs);
            pointer-events: none;

            // Progressive card reveal within subgroup
            & > * {
                animation: viewer-slide-in 0.2s ease-out backwards;

                @for $i from 1 through 12 {
                    &:nth-child(#{$i}) {
                        animation-delay: #{$i * 25}ms;
                    }
                }
            }

            // Empty subgroup items - hide entire subgroup when empty
            &:empty {
                display: none;
            }
        }

        .subgroup-header {
            @include ui.text-label("title-small", true);
            color: color-mix(in oklch, var(--on-surface, currentColor) var(--text-tint-primary, 92%), transparent);
            text-align: center;
            padding: var(--padding-xs);
            border-radius: var(--radius-sm);
            @include ui.tonal-surface(surface, 0, var(--radius-sm));

            background-color: oklch(from var(--surface-color) l c h / 0.6);
            pointer-events: none;
            inline-size: fit-content;
            justify-self: center;

            // Sticky header behavior for long lists
            position: sticky;
            inset-block-start: 0;
            z-index: 10;
            backdrop-filter: blur(2px);
        }

        // Collapsed state for performance optimization
        &[data-collapsed="true"] {
            .subgroup-items {
                display: none;
                content-visibility: hidden;
            }
        }
    }

    // ==========================================================================
    // Scroll Performance Optimizations
    // ==========================================================================

    .viewer-section,
    .viewer-tab-content,
    .viewer-tab-content-body {
        // Optimize scrolling performance
        scroll-behavior: smooth;

        @media (prefers-reduced-motion: reduce) {
            scroll-behavior: auto;

            // Disable animations for reduced motion preference
            & *,
            & *::before,
            & *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    }

    // Intersection observer hint for lazy loading
    .viewer-tab-content-body > * {
        content-visibility: auto;
        contain-intrinsic-size: auto 80px;
    }

}
