import{toText as t}from"./Clipboard.js";const e=t=>{if(null==t)return"";if("string"==typeof t){const o=(t=>{const e=t.trim();if(!e)return null;if(!e.startsWith("{")&&!e.startsWith("["))return null;try{return JSON.parse(e)}catch{return null}})(t);if(null!=o){const t=e(o);if(t)return t}return t}if("object"==typeof t){const o=t,r=o?.choices?.[0],n=r?.message?.content??r?.delta?.content??r?.text;if("string"==typeof n&&n.trim())return n;const i=o?.output_text;if("string"==typeof i&&i.trim())return i;const a=o?.output?.[0],s=a?.content?.find?.(t=>"string"==typeof t?.text)?.text??a?.content?.[0]?.text??a?.content?.[0]?.content??a?.text;if("string"==typeof s&&s.trim())return s;const c=o?.message?.content;if("string"==typeof c&&c.trim())return c;if("string"==typeof o?.content&&o.content.trim())return o.content;if(null!=o?.result){const t=e(o.result);if(t)return t}}return""},o=()=>{try{if("undefined"!=typeof location&&location.href.includes("offscreen"))return"offscreen";if("undefined"!=typeof document&&document.body)return"content"}catch{}return"unknown"},r=(t,e)=>{e?e(t):console.log("[Clipboard]",t)},n=async(n,i={})=>{const a=(e(n)||t(n)).trim(),{maxRetries:s=3}=i;if(!a)return{ok:!1,error:"Empty content"};console.log(`[Clipboard] Attempting to copy ${a.length} characters (${o()})`);const c=await(async(t,e=3)=>{const r=t.trim();if(!r)return{ok:!1,error:"Empty content"};for(let i=0;i<e;i++)try{const t=await new Promise(t=>{("undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setTimeout?t=>setTimeout(t,0):t=>t())(()=>{if("content"===o()&&"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus())try{globalThis?.focus?.()}catch{}const n=async()=>{try{if("undefined"!=typeof navigator&&navigator.clipboard?.writeText)return await navigator.clipboard.writeText(r),t({ok:!0,method:"clipboard-api"})}catch(a){console.warn(`[Clipboard] Direct write failed (attempt ${i+1}):`,a)}try{if("undefined"!=typeof navigator&&navigator.permissions){const e=await navigator.permissions.query({name:"clipboard-write"});if("granted"===e.state||"prompt"===e.state)return await navigator.clipboard.writeText(r),t({ok:!0,method:"clipboard-api-permission"})}}catch(a){console.warn(`[Clipboard] Permission check failed (attempt ${i+1}):`,a)}try{if("content"===o()&&"undefined"!=typeof document){const e=document.createElement("textarea");e.value=r,e.style.cssText="position:fixed;left:-9999px;top:-9999px;opacity:0;pointer-events:none;z-index:-1;",document.body.appendChild(e),e.select(),e.focus();const o=document.execCommand("copy");if(e.remove(),o)return t({ok:!0,method:"legacy-execCommand"})}}catch(a){console.warn(`[Clipboard] Legacy execCommand failed (attempt ${i+1}):`,a)}i<e-1?setTimeout(()=>n(),100):t({ok:!1,error:"All clipboard methods failed"})};n()})});if(t.ok)return t;i<e-1&&await new Promise(t=>setTimeout(t,200*(i+1)))}catch(n){console.warn(`[Clipboard] Attempt ${i+1} completely failed:`,n),i<e-1&&await new Promise(t=>setTimeout(t,200*(i+1)))}return{ok:!1,error:`Failed after ${e} attempts`}})(a,s);return console.log("[Clipboard] Copy result:",c),i.showFeedback&&"content"===o()&&(c.ok?r("Copied to clipboard",i.toastFn):r(i.errorMessage||c.error||"Failed to copy",i.toastFn)),{ok:c.ok,data:a,method:c.method||o(),error:c.error}};let i=!1;const a=(t={})=>{if(i)return;i=!0;const e=o(),{targetFilter:r,showFeedback:a="content"===e,toastFn:s}=t;chrome.runtime.onMessage.addListener((t,e,o)=>(console.log("[Clipboard] Received message:",t,"from:",e),r&&t?.target!==r?(console.log("[Clipboard] Message filtered out by target:",t?.target,"expected:",r),!1):"COPY_HACK"===t?.type&&(console.log("[Clipboard] Processing COPY_HACK message with data:",t?.data?.substring?.(0,50)+"..."),n(t?.data,{showFeedback:a,errorMessage:t?.error,toastFn:s}).then(t=>{console.log("[Clipboard] COPY_HACK response:",t),o(t)}).catch(t=>{console.error("[Clipboard] COPY_HACK error:",t),o({ok:!1,error:String(t)})}),!0))),console.log(`[Clipboard] Handler initialized (${e})`)};export{a as initClipboardHandler};
