const e=e=>{if(null==e)return"";if("string"==typeof e)return e;try{return JSON.stringify(e,null,2)}catch{return String(e)}},t=async t=>{const a=e(t).trim();return a?new Promise(e=>{requestAnimationFrame(()=>{"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus()&&globalThis?.focus?.();(async()=>{try{if("undefined"!=typeof navigator&&navigator.clipboard?.writeText)return await navigator.clipboard.writeText(a),e({ok:!0,data:a,method:"clipboard-api"})}catch(t){console.warn("[Clipboard] Direct write failed:",t)}try{if("undefined"!=typeof navigator&&navigator.permissions){const t=await navigator.permissions.query({name:"clipboard-write"});if("granted"===t.state||"prompt"===t.state)return await navigator.clipboard.writeText(a),e({ok:!0,data:a,method:"clipboard-api"})}}catch(t){console.warn("[Clipboard] Permission check failed:",t)}try{if("undefined"!=typeof document){const t=document.createElement("textarea");t.value=a,t.style.cssText="position:fixed;left:-9999px;top:-9999px;opacity:0;pointer-events:none;",document.body.appendChild(t),t.select();const o=document.execCommand("copy");if(t.remove(),o)return e({ok:!0,data:a,method:"legacy"})}}catch(t){console.warn("[Clipboard] Legacy execCommand failed:",t)}e({ok:!1,error:"All clipboard methods failed"})})()})}):{ok:!1,error:"Empty content"}},a=async(e,a)=>{const o=e.trim(),n=(a??o).trim();return o?new Promise(e=>{requestAnimationFrame(()=>{"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus()&&globalThis?.focus?.();(async()=>{try{if("undefined"!=typeof navigator&&navigator.clipboard?.write){const t=new Blob([o],{type:"text/html"}),a=new Blob([n],{type:"text/plain"});return await navigator.clipboard.write([new ClipboardItem({"text/html":t,"text/plain":a})]),e({ok:!0,data:o,method:"clipboard-api"})}}catch(r){console.warn("[Clipboard] HTML write failed:",r)}const a=await t(n);e(a)})()})}):{ok:!1,error:"Empty content"}},o=async e=>new Promise(t=>{requestAnimationFrame(async()=>{"undefined"!=typeof document&&document.hasFocus&&!document.hasFocus()&&globalThis?.focus?.();try{let a;if("string"==typeof e)if(e.startsWith("data:")){const t=await fetch(e);a=await t.blob()}else{const t=await fetch(e);a=await t.blob()}else a=e;if("undefined"!=typeof navigator&&navigator.clipboard?.write){const e="image/png"===a.type?a:await n(a);return await navigator.clipboard.write([new ClipboardItem({[e.type]:e})]),void t({ok:!0,method:"clipboard-api"})}}catch(a){console.warn("[Clipboard] Image write failed:",a)}t({ok:!1,error:"Image clipboard not supported"})})}),n=async e=>new Promise((t,a)=>{if("undefined"==typeof document)return void a(new Error("No document context"));const o=new Image,n=URL.createObjectURL(e);o.onload=()=>{const e=document.createElement("canvas");e.width=o.naturalWidth,e.height=o.naturalHeight;const r=e.getContext("2d");if(!r)return URL.revokeObjectURL(n),void a(new Error("Canvas context failed"));r.drawImage(o,0,0),e.toBlob(e=>{URL.revokeObjectURL(n),e?t(e):a(new Error("PNG conversion failed"))},"image/png")},o.onerror=()=>{URL.revokeObjectURL(n),a(new Error("Image load failed"))},o.src=n}),r=e=>{try{const t=new BroadcastChannel("rs-toast");t.postMessage({type:"show-toast",options:{message:e.ok?"Copied to clipboard":e.error||"Copy failed",kind:e.ok?"success":"error",duration:2e3}}),t.close()}catch(t){console.warn("[Clipboard] Feedback broadcast failed:",t)}},i=()=>{if("undefined"==typeof BroadcastChannel)return()=>{};const n=new BroadcastChannel("rs-clipboard"),i=async n=>{if("copy"===n.data?.type){const i=n.data.options||{};await(async(n,i={})=>{const{type:s,showFeedback:c=!1,silentOnError:d=!1}=i;return new Promise(i=>{requestAnimationFrame(async()=>{let l;if(n instanceof Blob)if(n.type.startsWith("image/"))l=await o(n);else{const e=await n.text();l=await t(e)}else l="html"===s||"string"==typeof n&&n.trim().startsWith("<")?await a(String(n)):"image"===s?await o(n):await t(e(n));!c||!l.ok&&d||r(l),i(l)})})})(n.data.data,{...i,showFeedback:!1!==i.showFeedback,silentOnError:!0===i.silentOnError})}};return n.addEventListener("message",i),()=>{n.removeEventListener("message",i),n.close()}},s=()=>i();export{s as initClipboardReceiver,e as toText,a as writeHTML,t as writeText};
