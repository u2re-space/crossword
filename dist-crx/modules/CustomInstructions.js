import{loadSettings as t,saveSettings as n}from"./Settings.js";import{DEFAULT_INSTRUCTION_TEMPLATES as e}from"./templates.js";const a=(t,n)=>n?.trim()?`${t}\n\n---\n\nUSER CUSTOM INSTRUCTIONS:\n${n.trim()}\n\n---\n\nApply the user's custom instructions above when processing the data. Prioritize user instructions when they conflict with default behavior.\n`:t,s='\n---\n\nGRAPHICS GENERATION (when applicable):\nWhen the problem involves functions, graphs, geometric shapes, diagrams, or data that can be visualized:\n\nGenerate inline SVG as Markdown image with data URI:\n![<title>](data:image/svg+xml,<encodeURIComponent_encoded_svg>)\n\nSVG Requirements:\n- Use encodeURIComponent() encoding for the entire SVG string\n- viewBox="0 0 400 300" (or appropriate dimensions)\n- Colors: #3b82f6 (blue), #10b981 (green), #f59e0b (orange), #ef4444 (red)\n- Include axis labels, tick marks, and legends\n- Use <text> elements for annotations\n- Keep SVG minimal but informative\n\nApply to:\n• Function graphs: f(x), parametric, polar\n• Geometric constructions and proofs\n• Data visualizations and charts\n• Diagrams and flowcharts\n• Coordinate systems and number lines\n\nAlways include both the mathematical solution AND the visualization.\n',i={auto:"",en:"\n\nIMPORTANT: Respond in English. All explanations, answers, and comments must be in English.",ru:"\n\nВАЖНО: Отвечай на русском языке. Все объяснения, ответы и комментарии должны быть на русском языке."},r="\n\nAdditionally, translate the recognized content to the response language if it differs from the source.";function o(t){if("auto"===t||void 0===t)return"";return{auto:"",markdown:"\n\nOutput the result in GitHub-compatible Markdown.\n\nMarkdown structure:\n- Use headings for structure:\n  - Main sections: start from ### (H3) minimum\n  - Subsections: #### / ##### when needed\n- Avoid long paragraphs: prefer lists and sub-lists.\n\nKaTeX / math:\n- Prefer inline formulas: $...$\n- Avoid $$...$$ blocks; only use block math if strictly necessary.\n  - Prefer block math as \\[ ... \\] instead of $$...$$.\n- Inside KaTeX, write a vertical bar as \\| (example: $A \\| B$).\n\nTables:\n- Use strict GitHub Markdown table syntax.\n- Inside table cells:\n  - Use <br> for line breaks (no real newlines inside cells).\n  - If source data uses ';' as a separator, replace ';' with <br>.\n\nColon formatting:\n- For \"key: value\" style lines, make the part before ':' bold:\n  - **Key**: value",html:"\n\nOutput the result in HTML format.",json:"\n\nOutput the result as valid JSON.",text:"\n\nOutput the result as plain text.",typescript:"\n\nOutput the result as TypeScript code.",javascript:"\n\nOutput the result as JavaScript code.",python:"\n\nOutput the result as Python code.",java:"\n\nOutput the result as Java code.",cpp:"\n\nOutput the result as C++ code.",csharp:"\n\nOutput the result as C# code.",php:"\n\nOutput the result as PHP code.",ruby:"\n\nOutput the result as Ruby code.",go:"\n\nOutput the result as Go code.",rust:"\n\nOutput the result as Rust code.",xml:"\n\nOutput the result as XML.",yaml:"\n\nOutput the result as YAML.",css:"\n\nOutput the result as CSS.",scss:"\n\nOutput the result as SCSS.","most-suitable":"\n\nChoose the most suitable output format for the content and task.","most-optimized":"\n\nChoose the most optimized output format for clarity and usability.","most-legibility":"\n\nChoose the most legible output format for human readability."}[t]||""}function u(t){const n="Extract all readable text, equations, and data from this image. Focus on accuracy and completeness.";return"markdown"===t?n+" Format the extracted content as clean Markdown.":"html"===t?n+" Format the extracted content as semantic HTML.":"text"===t?n+" Extract as plain text only.":"most-suitable"===t?"Analyze this image and extract all readable content in the most appropriate format for further processing.":"most-optimized"===t?"Extract content from this image in the most efficient format for token usage and processing.":"most-legibility"===t?"Extract content from this image with maximum legibility and human readability.":n+" Format appropriately for the content type."}const c=()=>`ci_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,l=(t,n)=>{const e=Number.isFinite(t.order)?t.order:Number.MAX_SAFE_INTEGER,a=Number.isFinite(n.order)?n.order:Number.MAX_SAFE_INTEGER;return e!==a?e-a:(t.label||"").localeCompare(n.label||"")},d=async()=>{const n=await t(),e=(a=n?.ai?.customInstructions,[...a||[]].sort(l));var a;const s=((t,n)=>n&&t.find(t=>t.id===n)||null)(e,n?.ai?.activeInstructionId);return{instructions:e,activeId:s?.id||"",activeInstruction:s}},m=async()=>(await d()).instructions,p=async()=>{try{const t=await d();return t.activeId?(t.activeInstruction||console.warn("[CustomInstructions] activeInstructionId not found:",t.activeId),t.activeInstruction):null}catch(t){return console.error("[CustomInstructions] Error in getActiveInstruction:",t),null}},h=async e=>{const a=await t(),s={...a,ai:{...a.ai,activeInstructionId:e||""}};await n(s)},b=async(e,a)=>{const s=await t(),i=s?.ai?.customInstructions||[],r={id:c(),label:e.trim()||"Untitled",instruction:a.trim(),enabled:!0,order:i.length},o={...s,ai:{...s.ai,customInstructions:[...i,r]}};return await n(o),r},f=async e=>{if(!e.length)return[];const a=await t(),s=a?.ai?.customInstructions||[],i=e.map((t,n)=>({id:c(),label:t.label.trim()||"Untitled",instruction:t.instruction.trim(),enabled:t.enabled??!0,order:s.length+n})),r={...a,ai:{...a.ai,customInstructions:[...s,...i]}};return await n(r),i},I=async(e,a)=>{const s=await t(),i=s?.ai?.customInstructions||[],r=i.findIndex(t=>t.id===e);if(-1===r)return!1;i[r]={...i[r],...a};const o={...s,ai:{...s.ai,customInstructions:i}};return await n(o),!0},g=async e=>{const a=await t(),s=a?.ai?.customInstructions||[],i=s.filter(t=>t.id!==e);if(i.length===s.length)return!1;const r=a.ai?.activeInstructionId===e?"":a.ai?.activeInstructionId||"",o={...a,ai:{...a.ai,customInstructions:i,activeInstructionId:r}};return await n(o),!0},y=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_INSTRUCTION_TEMPLATES:e,addInstruction:b,addInstructions:f,buildInstructionPrompt:a,deleteInstruction:g,getActiveInstruction:p,getActiveInstructionText:async()=>{const t=await p();return t?.instruction||""},getCustomInstructions:m,getInstructionRegistry:d,setActiveInstruction:h,updateInstruction:I},Symbol.toStringTag,{value:"Module"}));export{y as CustomInstructions,i as LANGUAGE_INSTRUCTIONS,s as SVG_GRAPHICS_ADDON,r as TRANSLATE_INSTRUCTION,b as addInstruction,f as addInstructions,a as buildInstructionPrompt,g as deleteInstruction,m as getCustomInstructions,d as getInstructionRegistry,u as getIntermediateRecognitionInstruction,o as getOutputFormatInstruction,h as setActiveInstruction,I as updateInstruction};
