import{detectExecutionContext as e}from"./Env.js";import{createQueuedOptimizedWorkerChannel as t,createChromeExtensionBroadcast as r}from"./Settings.js";var n;const a=(n=import.meta.url,function(e={}){var t,r,a=e,o=new Promise((e,n)=>{t=e,r=n});const i=void 0!==globalThis.ServiceWorkerGlobalScope&&"undefined"!=typeof self&&globalThis.caches&&void 0!==globalThis.caches.default,s="object"==typeof process&&process.release&&"node"===process.release.name;(i||s)&&(globalThis.ImageData||(globalThis.ImageData=class{constructor(e,t,r){this.data=e,this.width=t,this.height=r}}),void 0===import.meta.url&&(import.meta.url="https://localhost"),"undefined"!=typeof self&&void 0===self.location&&(self.location={href:""}));var c=Object.assign({},a),u="./this.program",l=(e,t)=>{throw t},h="object"==typeof window,d="function"==typeof importScripts;"object"==typeof process&&"object"==typeof process.versions&&process.versions.node;var f,m="";(h||d)&&(d?m=self.location.href:"undefined"!=typeof document&&document.currentScript&&(m=document.currentScript.src),n&&(m=n),m=m.startsWith("blob:")?"":m.substr(0,m.replace(/[?#].*/,"").lastIndexOf("/")+1),d&&(f=e=>{var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}));var g,p,v=a.print||console.log.bind(console),y=a.printErr||console.error.bind(console);Object.assign(a,c),c=null,a.arguments&&a.arguments,a.thisProgram&&(u=a.thisProgram),a.quit&&(l=a.quit),a.wasmBinary&&(g=a.wasmBinary);var b,w,C,$,x,T,A,E,_=!1;function P(){var e=p.buffer;a.HEAP8=b=new Int8Array(e),a.HEAP16=C=new Int16Array(e),a.HEAPU8=w=new Uint8Array(e),a.HEAPU16=$=new Uint16Array(e),a.HEAP32=x=new Int32Array(e),a.HEAPU32=T=new Uint32Array(e),a.HEAPF32=A=new Float32Array(e),a.HEAPF64=E=new Float64Array(e)}var R=[],W=[],S=[];function k(e){R.unshift(e)}function I(e){S.unshift(e)}var j=0,F=null,M=null;function U(e){a.onAbort?.(e),y(e="Aborted("+e+")"),_=!0,e+=". Build with -sASSERTIONS for more info.";var t=new WebAssembly.RuntimeError(e);throw r(t),t}var q,H,D=e=>e.startsWith("data:application/octet-stream;base64,");function O(e){if(e==q&&g)return new Uint8Array(g);if(f)return f(e);throw"both async and sync fetching of the wasm failed"}function B(e,t,r){return function(e){return g||!h&&!d||"function"!=typeof fetch?Promise.resolve().then(()=>O(e)):fetch(e,{credentials:"same-origin"}).then(t=>{if(!t.ok)throw`failed to load wasm binary file at '${e}'`;return t.arrayBuffer()}).catch(()=>O(e))}(e).then(e=>WebAssembly.instantiate(e,t)).then(r,e=>{y(`failed to asynchronously prepare wasm: ${e}`),U(e)})}function z(e){this.name="ExitStatus",this.message=`Program terminated with exit(${e})`,this.status=e}a.locateFile?D(q="mozjpeg_enc.wasm")||(H=q,q=a.locateFile?a.locateFile(H,m):m+H):q=new URL(""+new URL("../assets/mozjpeg_enc.wasm",import.meta.url).href,import.meta.url).href;var V=e=>{for(;e.length>0;)e.shift()(a)},G=a.noExitRuntime||!0;class L{constructor(e){this.excPtr=e,this.ptr=e-24}set_type(e){T[this.ptr+4>>2]=e}get_type(){return T[this.ptr+4>>2]}set_destructor(e){T[this.ptr+8>>2]=e}get_destructor(){return T[this.ptr+8>>2]}set_caught(e){e=e?1:0,b[this.ptr+12]=e}get_caught(){return 0!=b[this.ptr+12]}set_rethrown(e){e=e?1:0,b[this.ptr+13]=e}get_rethrown(){return 0!=b[this.ptr+13]}init(e,t){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(t)}set_adjusted_ptr(e){T[this.ptr+16>>2]=e}get_adjusted_ptr(){return T[this.ptr+16>>2]}get_exception_ptr(){if(tt(this.get_type()))return T[this.excPtr>>2];var e=this.get_adjusted_ptr();return 0!==e?e:this.excPtr}}var N={},X=e=>{for(;e.length;){var t=e.pop();e.pop()(t)}};function J(e){return this.fromWireType(T[e>>2])}var Q,K,Y,Z={},ee={},te={},re=e=>{throw new Q(e)},ne=(e,t,r)=>{function n(t){var n=r(t);n.length!==e.length&&re("Mismatched type converter count");for(var a=0;a<e.length;++a)ie(e[a],n[a])}e.forEach(function(e){te[e]=t});var a=new Array(t.length),o=[],i=0;t.forEach((e,t)=>{ee.hasOwnProperty(e)?a[t]=ee[e]:(o.push(e),Z.hasOwnProperty(e)||(Z[e]=[]),Z[e].push(()=>{a[t]=ee[e],++i===o.length&&n(a)}))}),0===o.length&&n(a)},ae=e=>{for(var t="",r=e;w[r];)t+=K[w[r++]];return t},oe=e=>{throw new Y(e)};function ie(e,t,r={}){if(!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");return function(e,t,r={}){var n=t.name;if(e||oe(`type "${n}" must have a positive integer typeid pointer`),ee.hasOwnProperty(e)){if(r.ignoreDuplicateRegistrations)return;oe(`Cannot register type '${n}' twice`)}if(ee[e]=t,delete te[e],Z.hasOwnProperty(e)){var a=Z[e];delete Z[e],a.forEach(e=>e())}}(e,t,r)}var se,ce,ue,le,he,de=8,fe=[],me=[],ge=e=>{e>9&&0===--me[e+1]&&(me[e]=void 0,fe.push(e))},pe=()=>me.length/2-5-fe.length,ve=e=>(e||oe("Cannot use deleted val. handle = "+e),me[e]),ye=e=>{switch(e){case void 0:return 2;case null:return 4;case!0:return 6;case!1:return 8;default:{const t=fe.pop()||me.length;return me[t]=e,me[t+1]=1,t}}},be={name:"emscripten::val",fromWireType:e=>{var t=ve(e);return ge(e),t},toWireType:(e,t)=>ye(t),argPackAdvance:de,readValueFromPointer:J,destructorFunction:null},we=(e,t)=>{switch(t){case 4:return function(e){return this.fromWireType(A[e>>2])};case 8:return function(e){return this.fromWireType(E[e>>3])};default:throw new TypeError(`invalid float width (${t}): ${e}`)}},Ce=(e,t)=>Object.defineProperty(t,"name",{value:e}),$e=(e,t,r)=>{if(void 0===e[t].overloadTable){var n=e[t];e[t]=function(...n){return e[t].overloadTable.hasOwnProperty(n.length)||oe(`Function '${r}' called with an invalid number of arguments (${n.length}) - expects one of (${e[t].overloadTable})!`),e[t].overloadTable[n.length].apply(this,n)},e[t].overloadTable=[],e[t].overloadTable[n.argCount]=n}},xe=[],Te=e=>{var t=xe[e];return t||(e>=xe.length&&(xe.length=e+1),xe[e]=t=se.get(e)),t},Ae=(e,t,r=[])=>e.includes("j")?((e,t,r)=>(e=e.replace(/p/g,"i"),(0,a["dynCall_"+e])(t,...r)))(e,t,r):Te(t)(...r),Ee=(e,t)=>{var r,n,a=(e=ae(e)).includes("j")?(r=e,n=t,(...e)=>Ae(r,n,e)):Te(t);return"function"!=typeof a&&oe(`unknown function pointer with signature ${e}: ${t}`),a},_e=e=>{var t=Ye(e),r=ae(t);return et(t),r},Pe=(e,t,r)=>{switch(t){case 1:return r?e=>b[e]:e=>w[e];case 2:return r?e=>C[e>>1]:e=>$[e>>1];case 4:return r?e=>x[e>>2]:e=>T[e>>2];default:throw new TypeError(`invalid integer width (${t}): ${e}`)}},Re=(e,t,r)=>{for(var n=t+r,a="";!(t>=n);){var o=e[t++];if(!o)return a;if(128&o){var i=63&e[t++];if(192!=(224&o)){var s=63&e[t++];if((o=224==(240&o)?(15&o)<<12|i<<6|s:(7&o)<<18|i<<12|s<<6|63&e[t++])<65536)a+=String.fromCharCode(o);else{var c=o-65536;a+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else a+=String.fromCharCode((31&o)<<6|i)}else a+=String.fromCharCode(o)}return a},We=(e,t)=>e?Re(w,e,t):"",Se=(e,t)=>{for(var r="",n=0;!(n>=t/2);++n){var a=C[e+2*n>>1];if(0==a)break;r+=String.fromCharCode(a)}return r},ke=(e,t,r)=>{if(r??=2147483647,r<2)return 0;for(var n=t,a=(r-=2)<2*e.length?r/2:e.length,o=0;o<a;++o){var i=e.charCodeAt(o);C[t>>1]=i,t+=2}return C[t>>1]=0,t-n},Ie=e=>2*e.length,je=(e,t)=>{for(var r=0,n="";!(r>=t/4);){var a=x[e+4*r>>2];if(0==a)break;if(++r,a>=65536){var o=a-65536;n+=String.fromCharCode(55296|o>>10,56320|1023&o)}else n+=String.fromCharCode(a)}return n},Fe=(e,t,r)=>{if(r??=2147483647,r<4)return 0;for(var n=t,a=n+r-4,o=0;o<e.length;++o){var i=e.charCodeAt(o);if(i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++o)),x[t>>2]=i,(t+=4)+4>a)break}return x[t>>2]=0,t-n},Me=e=>{for(var t=0,r=0;r<e.length;++r){var n=e.charCodeAt(r);n>=55296&&n<=57343&&++r,t+=4}return t},Ue=[],qe={},He=()=>{if("object"==typeof globalThis)return globalThis;function e(e){e.$$$embind_global$$$=e;var t="object"==typeof $$$embind_global$$$&&e.$$$embind_global$$$==e;return t||delete e.$$$embind_global$$$,t}if("object"==typeof $$$embind_global$$$)return $$$embind_global$$$;if("object"==typeof global&&e(global)?$$$embind_global$$$=global:"object"==typeof self&&e(self)&&($$$embind_global$$$=self),"object"==typeof $$$embind_global$$$)return $$$embind_global$$$;throw Error("unable to get global object.")},De=(e,t)=>{var r=ee[e];return void 0===r&&oe(`${t} has unknown type ${_e(e)}`),r},Oe=Reflect.construct,Be=e=>{var t=(e-p.buffer.byteLength+65535)/65536;try{return p.grow(t),P(),1}catch(r){}},ze={},Ve=()=>{if(!Ve.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:u||"./this.program"};for(var t in ze)void 0===ze[t]?delete e[t]:e[t]=ze[t];var r=[];for(var t in e)r.push(`${t}=${e[t]}`);Ve.strings=r}return Ve.strings},Ge=e=>{G||(a.onExit?.(e),_=!0),l(e,new z(e))},Le=(e,t)=>{Ge(e)},Ne=[null,[],[]],Xe=(e,t)=>{var r=Ne[e];0===t||10===t?((1===e?v:y)(Re(r,0)),r.length=0):r.push(t)};Q=a.InternalError=class extends Error{constructor(e){super(e),this.name="InternalError"}},(()=>{for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);K=e})(),Y=a.BindingError=class extends Error{constructor(e){super(e),this.name="BindingError"}},me.push(0,1,void 0,1,null,1,!0,1,!1,1),a.count_emval_handles=pe,ce=a.UnboundTypeError=(ue=Error,(he=Ce(le="UnboundTypeError",function(e){this.name=le,this.message=e;var t=new Error(e).stack;void 0!==t&&(this.stack=this.toString()+"\n"+t.replace(/^Error(:[^\n]*)?\n/,""))})).prototype=Object.create(ue.prototype),he.prototype.constructor=he,he.prototype.toString=function(){return void 0===this.message?this.name:`${this.name}: ${this.message}`},he);var Je,Qe={j:(e,t,r)=>{throw new L(e).init(t,r),e},k:e=>{var t=N[e];delete N[e];var r=t.rawConstructor,n=t.rawDestructor,a=t.fields,o=a.map(e=>e.getterReturnType).concat(a.map(e=>e.setterArgumentType));ne([e],o,e=>{var o={};return a.forEach((t,r)=>{var n=t.fieldName,i=e[r],s=t.getter,c=t.getterContext,u=e[r+a.length],l=t.setter,h=t.setterContext;o[n]={read:e=>i.fromWireType(s(c,e)),write:(e,t)=>{var r=[];l(h,e,u.toWireType(r,t)),X(r)}}}),[{name:t.name,fromWireType:e=>{var t={};for(var r in o)t[r]=o[r].read(e);return n(e),t},toWireType:(e,t)=>{for(var a in o)if(!(a in t))throw new TypeError(`Missing field: "${a}"`);var i=r();for(a in o)o[a].write(i,t[a]);return null!==e&&e.push(n,i),i},argPackAdvance:de,readValueFromPointer:J,destructorFunction:n}]})},n:(e,t,r,n,a)=>{},h:(e,t,r,n)=>{ie(e,{name:t=ae(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:n},argPackAdvance:de,readValueFromPointer:function(e){return this.fromWireType(w[e])},destructorFunction:null})},z:e=>ie(e,be),f:(e,t,r)=>{ie(e,{name:t=ae(t),fromWireType:e=>e,toWireType:(e,t)=>t,argPackAdvance:de,readValueFromPointer:we(t,r),destructorFunction:null})},e:(e,t,r,n,o,i,s)=>{var c=((e,t)=>{for(var r=[],n=0;n<e;n++)r.push(T[t+4*n>>2]);return r})(t,r);e=(e=>{const t=(e=e.trim()).indexOf("(");return-1!==t?e.substr(0,t):e})(e=ae(e)),o=Ee(n,o),((e,t,r)=>{a.hasOwnProperty(e)?((void 0===r||void 0!==a[e].overloadTable&&void 0!==a[e].overloadTable[r])&&oe(`Cannot register public name '${e}' twice`),$e(a,e,e),a.hasOwnProperty(r)&&oe(`Cannot register multiple overloads of a function with the same number of arguments (${r})!`),a[e].overloadTable[r]=t):(a[e]=t,void 0!==r&&(a[e].numArguments=r))})(e,function(){((e,t)=>{var r=[],n={};throw t.forEach(function e(t){n[t]||ee[t]||(te[t]?te[t].forEach(e):(r.push(t),n[t]=!0))}),new ce(`${e}: `+r.map(_e).join([", "]))})(`Cannot call ${e} due to unbound types`,c)},t-1),ne([],c,r=>{var n=[r[0],null].concat(r.slice(1));return((e,t,r)=>{a.hasOwnProperty(e)||re("Replacing nonexistent public symbol"),void 0!==a[e].overloadTable&&void 0!==r?a[e].overloadTable[r]=t:(a[e]=t,a[e].argCount=r)})(e,function(e,t,r,n,a){var o=t.length;o<2&&oe("argTypes array size mismatch! Must at least get return value and 'this' types!");var i=null!==t[1]&&null!==r,s=function(e){for(var t=1;t<e.length;++t)if(null!==e[t]&&void 0===e[t].destructorFunction)return!0;return!1}(t),c="void"!==t[0].name,u=o-2,l=new Array(u),h=[],d=[];return Ce(e,function(...r){var o;r.length!==u&&oe(`function ${e} called with ${r.length} arguments, expected ${u}`),d.length=0,h.length=i?2:1,h[0]=a,i&&(o=t[1].toWireType(d,this),h[1]=o);for(var f=0;f<u;++f)l[f]=t[f+2].toWireType(d,r[f]),h.push(l[f]);return function(e){if(s)X(d);else for(var r=i?1:2;r<t.length;r++){var n=1===r?o:l[r-2];null!==t[r].destructorFunction&&t[r].destructorFunction(n)}if(c)return t[0].fromWireType(e)}(n(...h))})}(e,n,null,o,i),t-1),[]})},c:(e,t,r,n,a)=>{t=ae(t);var o=e=>e;if(0===n){var i=32-8*r;o=e=>e<<i>>>i}var s=t.includes("unsigned");ie(e,{name:t,fromWireType:o,toWireType:s?function(e,t){return this.name,t>>>0}:function(e,t){return this.name,t},argPackAdvance:de,readValueFromPointer:Pe(t,r,0!==n),destructorFunction:null})},a:(e,t,r)=>{var n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function a(e){var t=T[e>>2],r=T[e+4>>2];return new n(b.buffer,r,t)}ie(e,{name:r=ae(r),fromWireType:a,argPackAdvance:de,readValueFromPointer:a},{ignoreDuplicateRegistrations:!0})},g:(e,t)=>{var r="std::string"===(t=ae(t));ie(e,{name:t,fromWireType(e){var t,n=T[e>>2],a=e+4;if(r)for(var o=a,i=0;i<=n;++i){var s=a+i;if(i==n||0==w[s]){var c=We(o,s-o);void 0===t?t=c:(t+=String.fromCharCode(0),t+=c),o=s+1}}else{var u=new Array(n);for(i=0;i<n;++i)u[i]=String.fromCharCode(w[a+i]);t=u.join("")}return et(e),t},toWireType(e,t){var n;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var a="string"==typeof t;a||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||oe("Cannot pass non-string to std::string"),n=r&&a?(e=>{for(var t=0,r=0;r<e.length;++r){var n=e.charCodeAt(r);n<=127?t++:n<=2047?t+=2:n>=55296&&n<=57343?(t+=4,++r):t+=3}return t})(t):t.length;var o=Ze(4+n+1),i=o+4;if(T[o>>2]=n,r&&a)((e,t,r,n)=>{if(!(n>0))return 0;for(var a=r+n-1,o=0;o<e.length;++o){var i=e.charCodeAt(o);if(i>=55296&&i<=57343&&(i=65536+((1023&i)<<10)|1023&e.charCodeAt(++o)),i<=127){if(r>=a)break;t[r++]=i}else if(i<=2047){if(r+1>=a)break;t[r++]=192|i>>6,t[r++]=128|63&i}else if(i<=65535){if(r+2>=a)break;t[r++]=224|i>>12,t[r++]=128|i>>6&63,t[r++]=128|63&i}else{if(r+3>=a)break;t[r++]=240|i>>18,t[r++]=128|i>>12&63,t[r++]=128|i>>6&63,t[r++]=128|63&i}}t[r]=0})(t,w,i,n+1);else if(a)for(var s=0;s<n;++s){var c=t.charCodeAt(s);c>255&&(et(i),oe("String has UTF-16 code units that do not fit in 8 bits")),w[i+s]=c}else for(s=0;s<n;++s)w[i+s]=t[s];return null!==e&&e.push(et,o),o},argPackAdvance:de,readValueFromPointer:J,destructorFunction(e){et(e)}})},d:(e,t,r)=>{var n,a,o,i;r=ae(r),2===t?(n=Se,a=ke,i=Ie,o=e=>$[e>>1]):4===t&&(n=je,a=Fe,i=Me,o=e=>T[e>>2]),ie(e,{name:r,fromWireType:e=>{for(var r,a=T[e>>2],i=e+4,s=0;s<=a;++s){var c=e+4+s*t;if(s==a||0==o(c)){var u=n(i,c-i);void 0===r?r=u:(r+=String.fromCharCode(0),r+=u),i=c+t}}return et(e),r},toWireType:(e,n)=>{"string"!=typeof n&&oe(`Cannot pass non-string to C++ string type ${r}`);var o=i(n),s=Ze(4+o+t);return T[s>>2]=o/t,a(n,s+4,o+t),null!==e&&e.push(et,s),s},argPackAdvance:de,readValueFromPointer:J,destructorFunction(e){et(e)}})},l:(e,t,r,n,a,o)=>{N[e]={name:ae(t),rawConstructor:Ee(r,n),rawDestructor:Ee(a,o),fields:[]}},b:(e,t,r,n,a,o,i,s,c,u)=>{N[e].fields.push({fieldName:ae(t),getterReturnType:r,getter:Ee(n,a),getterContext:o,setterArgumentType:i,setter:Ee(s,c),setterContext:u})},i:(e,t)=>{ie(e,{isVoid:!0,name:t=ae(t),argPackAdvance:0,fromWireType:()=>{},toWireType:(e,t)=>{}})},s:(e,t,r)=>w.copyWithin(e,t,t+r),y:(e,t,r,n)=>(e=Ue[e])(null,t=ve(t),r,n),u:ge,A:e=>{return 0===e?ye(He()):(e=void 0===(r=qe[t=e])?ae(t):r,ye(He()[e]));var t,r},x:(e,t,r)=>{var n=((e,t)=>{for(var r=new Array(e),n=0;n<e;++n)r[n]=De(T[t+4*n>>2],"parameter "+n);return r})(e,t),a=n.shift();e--;var o,i,s=new Array(e),c=`methodCaller<(${n.map(e=>e.name).join(", ")}) => ${a.name}>`;return o=Ce(c,(t,o,i,c)=>{for(var u=0,l=0;l<e;++l)s[l]=n[l].readValueFromPointer(c+u),u+=n[l].argPackAdvance;var h=1===r?Oe(o,s):o.apply(t,s);return((e,t,r)=>{var n=[],a=e.toWireType(n,r);return n.length&&(T[t>>2]=ye(n)),a})(a,i,h)}),i=Ue.length,Ue.push(o),i},w:e=>{var t=ve(e);X(t),ge(e)},o:()=>{U("")},p:e=>{var t=w.length,r=2147483648;if((e>>>=0)>r)return!1;for(var n=(e,t)=>e+(t-e%t)%t,a=1;a<=4;a*=2){var o=t*(1+.2/a);o=Math.min(o,e+100663296);var i=Math.min(r,n(Math.max(e,o),65536));if(Be(i))return!0}return!1},q:(e,t)=>{var r=0;return Ve().forEach((n,a)=>{var o=t+r;T[e+4*a>>2]=o,((e,t)=>{for(var r=0;r<e.length;++r)b[t++]=e.charCodeAt(r);b[t]=0})(n,o),r+=n.length+1}),0},r:(e,t)=>{var r=Ve();T[e>>2]=r.length;var n=0;return r.forEach(e=>n+=e.length+1),T[t>>2]=n,0},B:Le,t:e=>52,m:function(e,t,r,n,a){return 70},v:(e,t,r,n)=>{for(var a=0,o=0;o<r;o++){var i=T[t>>2],s=T[t+4>>2];t+=8;for(var c=0;c<s;c++)Xe(e,w[i+c]);a+=s}return T[n>>2]=a,0}},Ke=function(){var e,t,n,o,i={a:Qe};function s(e,t){var r;return Ke=e.exports,p=Ke.C,P(),se=Ke.H,r=Ke.D,W.unshift(r),function(){if(j--,a.monitorRunDependencies?.(j),0==j&&(null!==F&&(clearInterval(F),F=null),M)){var e=M;M=null,e()}}(),Ke}if(j++,a.monitorRunDependencies?.(j),a.instantiateWasm)try{return a.instantiateWasm(i,s)}catch(c){y(`Module.instantiateWasm callback failed with error: ${c}`),r(c)}return(e=g,t=q,n=i,o=function(e){s(e.instance)},e||"function"!=typeof WebAssembly.instantiateStreaming||D(t)||"function"!=typeof fetch?B(t,n,o):fetch(t,{credentials:"same-origin"}).then(e=>WebAssembly.instantiateStreaming(e,n).then(o,function(e){return y(`wasm streaming compile failed: ${e}`),y("falling back to ArrayBuffer instantiation"),B(t,n,o)}))).catch(r),{}}(),Ye=e=>(Ye=Ke.E)(e),Ze=e=>(Ze=Ke.F)(e),et=e=>(et=Ke.G)(e),tt=e=>(tt=Ke.I)(e);function rt(){function e(){Je||(Je=!0,a.calledRun=!0,_||(V(W),t(a),a.onRuntimeInitialized&&a.onRuntimeInitialized(),function(){if(a.postRun)for("function"==typeof a.postRun&&(a.postRun=[a.postRun]);a.postRun.length;)I(a.postRun.shift());V(S)}()))}j>0||(function(){if(a.preRun)for("function"==typeof a.preRun&&(a.preRun=[a.preRun]);a.preRun.length;)k(a.preRun.shift());V(R)}(),j>0||(a.setStatus?(a.setStatus("Running..."),setTimeout(function(){setTimeout(function(){a.setStatus("")},1),e()},1)):e()))}if(a.dynCall_jiji=(e,t,r,n,o)=>(a.dynCall_jiji=Ke.J)(e,t,r,n,o),M=function e(){Je||rt(),Je||(M=e)},a.preInit)for("function"==typeof a.preInit&&(a.preInit=[a.preInit]);a.preInit.length>0;)a.preInit.pop()();return rt(),o}),o={quality:75,baseline:!1,arithmetic:!1,progressive:!0,optimize_coding:!0,smoothing:0,color_space:3,quant_table:3,trellis_multipass:!1,trellis_opt_zero:!1,trellis_opt_table:!1,trellis_loops:1,auto_subsample:!0,chroma_subsample:2,separate_chroma_quality:!1,chroma_quality:75};let i;async function s(e,t){let r=e,n=t;1!==arguments.length||e instanceof WebAssembly.Module||(r=void 0,n=e),i=function(e,t,r={}){let n;return t&&(n=(e,r)=>{const n=new WebAssembly.Instance(t,e);return r(n),n.exports}),e({noInitialRun:!0,instantiateWasm:n,...r})}(a,r,n)}async function c(e,t={}){i||s();const r=await i,n={...o,...t};return r.encode(e.data,e.width,e.height,n).buffer}const u={quality:90,progressive:!1,color_space:2,optimize_coding:!0,auto_subsample:!0,baseline:!0},l=e=>e?.replace?.("data:image/png;base64,","")?.replace?.(/data:image\/jpeg;base64,/,""),h=l,d=e=>e?.match?.(/data:image\/(.*);base64,/)?.[1]||"image/png",f=async e=>{const t=await(createImageBitmap(new Blob([Uint8Array.fromBase64(l(e),{alphabet:"base64"})],{type:d(e)}))?.catch?.(e=>(console.warn(e),null)));return t?.width>0&&t?.height>0},m=async e=>{const t=new Image;t.crossOrigin="Anonymous",t.decoding="async",t.src=e,await t.decode();const r=new OffscreenCanvas(t.naturalWidth,t.naturalHeight),n=r.getContext("2d");n.fillStyle="white",n?.fillRect(0,0,r.width,r.height),n?.drawImage(t,0,0);const a=n?.getImageData(0,0,r.width,r.height),o=await g(a);return o?`data:image/jpeg;base64,${new Uint8Array(o)?.toBase64?.({alphabet:"base64"})}`:null},g=async(e,t)=>{if(!e)return null;const r={colorSpace:"srgb"};if(t??={x:0,y:0,width:e?.width||e?.codedWidth||0,height:e?.height||e?.codedHeight||0},e instanceof ImageData)return c(e,u);if(!(e instanceof ImageBitmap)){const a=new ImageData(t.codedWidth,t.codedHeight,r);try{e?.copyTo?.(a.data,{format:"RGBA",rect:t})}catch(n){console.warn(n)}return c(a,u)}{const n=new OffscreenCanvas(t.width,t.height).getContext("2d");n?.drawImage?.(e,t.x,t.y,t.width,t.height,0,0,t.width,t.height);const a=n?.getImageData?.(0,0,t.width,t.height,r);if(a)return c(a,u)}},p=()=>"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id?"undefined"!=typeof document&&document.contentType?"content-script":void 0!==chrome.runtime.getBackgroundPage?"background":void 0!==chrome.offscreen?"offscreen":"undefined"!=typeof ServiceWorkerGlobalScope&&self instanceof ServiceWorkerGlobalScope?"service-worker":"popup":"content-script",v=()=>"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id;class y{constructor(t){this.target=t,this.context=p(),this.isCrxEnv=v(),this.isCrxEnv&&(this.broadcastChannel=r(t||"background")),this.festUniformChannel=((t,r={})=>{const n=e();return"chrome-extension"!==n?{async request(e){throw new Error(`Chrome extension messaging not available in ${n}`)},close(){}}:{request:async(e,a=[])=>new Promise((o,i)=>{try{chrome.runtime.sendMessage({id:`crx_${Date.now()}_${Math.random().toString(36).slice(2)}`,type:e,source:n,target:t,data:1===a?.length?a[0]:a,metadata:{timestamp:Date.now(),...r?.metadata??{}}},e=>{chrome.runtime.lastError?i(new Error(chrome.runtime.lastError.message)):o(e)})}catch(s){i(s)}}),close(){}}})(t||"background"),this.setupMessageForwarding()}festUniformChannel;broadcastChannel;listeners=new Map;pendingRequests=new Map;context;isCrxEnv;setupMessageForwarding(){this.isCrxEnv&&this.broadcastChannel?this.broadcastChannel.addEventListener("message",e=>{const t=e.data,r=e.source||{};return this.handleIncomingMessage(t,r,e=>{this.broadcastChannel?.postMessage({id:t.id,type:"response",result:e,source:this.context})}),!0}):!this.isCrxEnv&&chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener((e,t,r)=>(this.handleIncomingMessage(e,t,r),!0))}handleIncomingMessage(e,t,r){if(!this.isCrxEnv)return console.log("[CrxRuntimeChannel] Not in CRX environment, rejecting message"),void r({success:!1,error:"Not in Chrome extension environment",source:this.context});try{if(e&&"object"==typeof e&&e.id&&e.type){const t=e;if(t.target&&t.target!==this.context)r({id:t.id,type:"response:not-targeted",success:!1,error:"Message not targeted at this context",source:this.context});else if(t.type.startsWith("request:")){const e=t.type.replace("request:",""),n=this.listeners.get(e);n?n(t.data)?.then(n=>{r({id:t.id,type:`response:${e}`,success:!0,result:n,source:this.context})})?.catch(n=>{r({id:t.id,type:`response:${e}`,success:!1,error:n instanceof Error?n.message:String(n),source:this.context})}):r({id:t.id,type:`response:${t.type}`,success:!1,error:`No handler for type: ${e}`,source:this.context})}}else r({success:!1,error:"Invalid message format",source:this.context})}catch(n){console.error("[CrxRuntimeChannel] Error handling message:",n),r({success:!1,error:n instanceof Error?n.message:String(n),source:this.context})}}async request(e,t=[],r){if(!this.isCrxEnv)throw new Error("CrxRuntimeChannel: Chrome extension messaging is only available in Chrome extension context. Current context: "+this.context);const n=r?.timeout||3e4,a=`crx_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;return new Promise((r,o)=>{const i=setTimeout(()=>{this.pendingRequests.delete(a),o(new Error(`Request timeout: ${e}`))},n);this.pendingRequests.set(a,{resolve:r,reject:o,timeout:i});const s={id:a,type:`request:${e}`,source:this.context,target:this.target,data:1===t.length?t[0]:t,metadata:{timestamp:Date.now()}};chrome.runtime.sendMessage(s,e=>{if(chrome.runtime.lastError)return clearTimeout(i),this.pendingRequests.delete(a),void o(new Error(chrome.runtime.lastError.message));e&&e.id===a?(clearTimeout(i),this.pendingRequests.delete(a),e.success?r(e.result):o(new Error(e.error||"Request failed"))):console.warn("[CrxRuntimeChannel] Unexpected response format:",e)})})}registerHandler(e,t){this.listeners.set(e,t)}unregisterHandler(e){this.listeners.delete(e)}close(){this.listeners.clear(),this.festUniformChannel?.close();for(const[e,t]of this.pendingRequests)clearTimeout(t.timeout),t.reject(new Error("Channel closed"));this.pendingRequests.clear()}getQueueStatus(){return{registeredHandlers:this.listeners.size,pendingRequests:this.pendingRequests.size,festUniformStatus:this.festUniformChannel?"active":"inactive"}}}class b{static instance;runtimeChannel;workerChannels=new Map;context;isCrxEnv;constructor(){this.context=p(),this.isCrxEnv=v(),this.runtimeChannel=new y}static getInstance(){return b.instance||(b.instance=new b),b.instance}async sendRuntimeMessage(e){const t={id:`crx_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,source:this.context,...e};return this.runtimeChannel?.request?.("sendMessage",[t])}registerRuntimeHandler(e,t){this.runtimeChannel?.registerHandler(e,t)}createWorkerChannel(e,r){if(this.workerChannels.has(e))return this.workerChannels.get(e);const n=t({name:e,script:r,context:"chrome-extension"},{timeout:3e4,retries:2,batching:!0,compression:!1});return this.workerChannels.set(e,n),n}getWorkerChannel(e){return this.workerChannels.get(e)||null}async sendToTab(e,t){return this.isCrxEnv?new Promise((r,n)=>{chrome.tabs.sendMessage(e,{...t,id:`crx_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,source:this.context,tabId:e},e=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):r(e)})}):(console.warn("CrxUnifiedMessaging: Tab messaging not available - not in Chrome extension context"),Promise.reject(new Error("Tab messaging is not available in this context")))}async broadcastToTabs(e){return this.isCrxEnv?new Promise(t=>{chrome.tabs.query({},r=>{const n=r.map(t=>t.id?this.sendToTab(t.id,e).catch(()=>null):Promise.resolve(null));Promise.all(n).then(t)})}):(console.warn("CrxUnifiedMessaging: Tab broadcasting not available - not in Chrome extension context"),Promise.resolve([]))}getContext(){return this.context}isCrxEnvironment(){return this.isCrxEnv}}const w=b.getInstance();function C(e,t){w.registerRuntimeHandler(e,t)}function $(e){return w.broadcastToTabs(e)}export{f as ableToShowImage,$ as broadcastToCrxTabs,w as crxMessaging,m as deAlphaChannel,g as encodeWithJSquash,C as registerCrxHandler,h as removeAnyPrefix};
