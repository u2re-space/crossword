var e=(e=>(e.GET="get",e.SET="set",e.CALL="call",e.APPLY="apply",e.CONSTRUCT="construct",e.DELETE="delete",e.DELETE_PROPERTY="deleteProperty",e.HAS="has",e.OWN_KEYS="ownKeys",e.GET_OWN_PROPERTY_DESCRIPTOR="getOwnPropertyDescriptor",e.GET_PROPERTY_DESCRIPTOR="getPropertyDescriptor",e.GET_PROTOTYPE_OF="getPrototypeOf",e.SET_PROTOTYPE_OF="setPrototypeOf",e.IS_EXTENSIBLE="isExtensible",e.PREVENT_EXTENSIONS="preventExtensions",e.TRANSFER="transfer",e.IMPORT="import",e.DISPOSE="dispose",e))(e||{});"undefined"!=typeof Promise&&"function"!=typeof Promise.try&&(Promise.try=function(e,...t){try{return"function"==typeof e?Promise.resolve(e(...t)):Promise.resolve(e)}catch(n){return Promise.reject(n)}}),WeakMap.prototype.getOrInsert??=function(e,t){return this.has(e)||this.set(e,t),this.get(e)},WeakMap.prototype.getOrInsertComputed??=function(e,t){return this.has(e)||this.set(e,t(e)),this.get(e)},Map.prototype.getOrInsert??=function(e,t){return this.has(e)||this.set(e,t),this.get(e)},Map.prototype.getOrInsertComputed??=function(e,t){return this.has(e)||this.set(e,t(e)),this.get(e)};const t=Symbol.for("@fix"),n=e=>Array.isArray(e)||e instanceof Set||e instanceof Map,s=e=>"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"bigint"==typeof e||void 0===e||null==e,r=(e,t)=>s(e)?"number"==t?Number(e)||0:"string"==t?String(e)||"":"boolean"==t?!!e:e:null,o=(e,t="value")=>("object"==typeof e||"function"==typeof e)&&null!=e&&(t in e||null!=e?.[t]),i=e=>o(e,"value"),a=e=>s(e)?e:i(e)?e?.value:e,c=(e,n)=>e?.[t]??n??e,l=e=>null==e||"object"!=typeof e&&"function"!=typeof e||!(e instanceof WeakRef||"function"==typeof e?.deref)?e:l(e?.deref?.()),h=(e,t,n)=>null==(e=l(e))||"object"!=typeof e&&"function"!=typeof e?e:e[t]=a(n=l(n)),u=(e,t,n)=>Math.max(e,Math.min(t,n)),d=()=>crypto?.randomUUID?crypto?.randomUUID?.():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>{return(+e^(t=new Uint8Array(1),crypto?.getRandomValues?crypto?.getRandomValues?.(t):(()=>{const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=Math.floor(256*Math.random());return e})())?.[0]&15>>+e/4).toString(16);var t}),p=e=>e?e?.replace?.(/([a-z])([A-Z])/g,"$1-$2").toLowerCase():e,f=e=>e?e?.replace?.(/-([a-z])/g,(e,t)=>t.toUpperCase()):e,m=e=>"undefined"!=typeof CSSStyleValue&&e instanceof CSSStyleValue,y=e=>null!=e&&("boolean"!=typeof e||!1!==e)&&"object"!=typeof e&&"function"!=typeof e,_=e=>"boolean"==typeof e?e?"":null:"number"==typeof e?String(e):e,g=Symbol.for("@trigger-lock"),b=(e,t,n="value")=>{let s;o(e,n)&&(e[g]=!0);try{s=t?.()}finally{o(e,n)&&delete e[g]}return s},w=e=>{if("string"!=typeof e)return null;const t=[...e?.matchAll?.(/^\d+(\.\d+)?$/g)];if(1!=t?.length)return null;const n=parseFloat(t[0][0]);return!Number.isNaN(n)&&Number.isFinite(n)?n:null},C=/^\d+$/g,k=e=>"string"==typeof e?null!=(e=>{if("string"!=typeof e)return null;if(e=e?.trim?.(),""==e||null==e)return null;const t=[...e?.matchAll?.(C)];if(1!=t?.length)return null;const n=parseInt(t[0][0]);return!Number.isNaN(n)&&Number.isInteger(n)?n:null})(e):"number"==typeof e&&Number.isInteger(e)&&e>=0,S=e=>Array.isArray(e)||null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.iterator],v=(e,t,n)=>{e=e instanceof WeakRef?e.deref():e;const s=[...Object.entries(n)]?.map?.(([n,s])=>e?.[t]?.call?.(e,n,s));return()=>{s?.forEach?.(e=>e?.())}},x=e=>e instanceof WeakRef||"function"==typeof e?.deref,P=e=>x(e)?l(e):e,T=e=>null!=e?x(e)?e:"function"==typeof e||"object"==typeof e?new WeakRef(e):e:e,E=e=>("object"==typeof e||"function"==typeof e)&&(null!=e?.value||null!=e&&"value"in e),R=e=>null!=e&&("object"==typeof e||"function"==typeof e),O=e=>i(e)?e?.value:e,A=(e,t)=>e instanceof Promise||"function"==typeof e?.then?e?.then?.(t):t?.(e),M=(e,t)=>e instanceof Promise||"function"==typeof e?.then?e?.then?.(t):t?.(e),I=function(e){return t=>{let n;e[g]=!0;try{n=t?.()}finally{e[g]=!1}return n}},D=e=>Array.isArray(e)?e?.flatMap?.(e=>Array.isArray(e)?D(e):e):e,j=e=>D(e)?.every?.(N),N=e=>s(e)||"function"==typeof SharedArrayBuffer&&e instanceof SharedArrayBuffer||W(e)||Array.isArray(e)&&j(e),W=e=>ArrayBuffer.isView(e)&&!(e instanceof DataView),L=e=>s(e)||"function"==typeof ArrayBuffer&&e instanceof ArrayBuffer||"function"==typeof MessagePort&&e instanceof MessagePort||"function"==typeof ReadableStream&&e instanceof ReadableStream||"function"==typeof WritableStream&&e instanceof WritableStream||"function"==typeof TransformStream&&e instanceof TransformStream||"function"==typeof ImageBitmap&&e instanceof ImageBitmap||"function"==typeof VideoFrame&&e instanceof VideoFrame||"function"==typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"function"==typeof RTCDataChannel&&e instanceof RTCDataChannel||"function"==typeof AudioData&&e instanceof AudioData||"function"==typeof WebTransportReceiveStream&&e instanceof WebTransportReceiveStream||"function"==typeof WebTransportSendStream&&e instanceof WebTransportSendStream||"function"==typeof WebTransportReceiveStream&&e instanceof WebTransportReceiveStream,q=e=>{switch(typeof e){case"number":return 0;case"string":return"";case"boolean":return!1;case"object":case"function":case"symbol":return null;case"bigint":return 0n}},B=e=>"function"==typeof e?.[Symbol.iterator],U=e=>["symbol","string","number"].indexOf(typeof e)>=0,$=(e,t,n=null,s=!0,r="id")=>{const o=null==n||"object"!=typeof e&&"function"!=typeof e?e:e?.[n]??e;let i=null;if(s&&((e,t,n=null)=>{const s=null==n||"object"!=typeof e&&"function"!=typeof e?e:e?.[n]??e;let r=[];t instanceof Set||t instanceof Map||Array.isArray(t)||B(t)?r=(s instanceof Set||s instanceof WeakSet?t?.values?.():t?.entries?.())||(Array.isArray(t)||B(t)?t:[]):"object"!=typeof t&&"function"!=typeof t||(r=s instanceof Set||s instanceof WeakSet?Object.values(t):Object.entries(t));let o=[];Array.isArray(s)?o=s.entries():s instanceof Map||s instanceof WeakMap?o=s?.entries?.():s instanceof Set||s instanceof WeakSet?o=s?.values?.():"object"!=typeof s&&"function"!=typeof s||(o=Object.entries(s));const i=new Set(Array.from(r).map(e=>e?.[0])),a=new Set(Array.from(o).map(e=>e?.[0])),c=i?.difference?.(a);if(Array.isArray(s)){const e=s.filter((e,t)=>!c.has(t));s.splice(0,s.length),s.push(...e)}else if(s instanceof Map||s instanceof Set||s instanceof WeakMap||s instanceof WeakSet)for(const l of c)s.delete(l);else if("function"==typeof s||"object"==typeof s)for(const l of c)delete s[l]})(o,t),t instanceof Set||t instanceof Map||Array.isArray(t)||B(t)?i=(o instanceof Set||o instanceof WeakSet?t?.values?.():t?.entries?.())||(Array.isArray(t)||B(t)?t:[]):"object"!=typeof t&&"function"!=typeof t||(i=o instanceof Set||o instanceof WeakSet?Object.values(t):Object.entries(t)),o&&i&&("object"==typeof i||"function"==typeof i)){if(o instanceof Map||o instanceof WeakMap){for(const e of i)o.set(...e);return o}if(o instanceof Set||o instanceof WeakSet){for(const e of i){const t=e?.[r]?Array.from(o?.values?.()||[]).find(t=>!Y?.(t?.[r],e?.[r])):null;null!=t?$(t,e,null,s,r):o.add(e)}return o}if("object"==typeof o||"function"==typeof o){if(Array.isArray(o)||B(o)){let e=0;for(const t of i)e<o.length?o[e++]=t?.[1]:o?.push?.(t?.[1]);return o}return Object.assign(o,Object.fromEntries([...i||[]].filter(e=>"symbol"!=typeof e)))}}return null!=n?(Reflect.set(e,n,t),e):"object"==typeof t||"function"==typeof t?Object.assign(e,t):t},F=(e,t)=>("function"==typeof t?((e,t)=>K.getOrInsert(e,new WeakMap).getOrInsert(t,t?.bind?.(e)))(e,t):t)??t,z=(e,t,n,s)=>{if(t==Symbol.iterator)return G(e,n);if(null==t||"symbol"==typeof t||"object"==typeof t||"function"==typeof t)return;const r=(e,...t)=>{if(null!=e)return n?.(e,...t)};if(e instanceof Map||e instanceof WeakMap){if(e.has(t))return r?.(e.get(t),t,null,"@set")}else if(e instanceof Set||e instanceof WeakSet){if(e.has(t))return r?.(t,t,null,"@add")}else{if(Array.isArray(e)&&"string"==typeof t&&1==[...t?.matchAll?.(/^\d+$/g)]?.length&&Number.isInteger("string"==typeof t?parseInt(t):t)){const n="string"==typeof t?parseInt(t):t;return r?.(e?.[n],n,null,"@add")}if("function"==typeof e||"object"==typeof e)return r?.(e?.[t],t,null,"@set")}},G=(e,t,n)=>{if(null==e)return;let s=[];return e instanceof Set||e instanceof Map||"function"==typeof e?.keys?[...e?.keys?.()||s]?.forEach?.(n=>z(e,n,t)):Array.isArray(e)||B(e)?[...e]?.forEach?.((n,s)=>z(e,s,t)):"object"==typeof e||"function"==typeof e?[...Object.keys(e)||s]?.forEach?.(n=>z(e,n,t)):void 0},Y=(e,t)=>(null!=e||null!=t)&&(null==e||null==t||("boolean"==typeof e&&"boolean"==typeof t?e!=t:"number"==typeof e&&"number"==typeof t?!(e==t||Math.abs(e-t)<1e-9):"string"==typeof e&&"string"==typeof t?""!=e&&""!=t&&e!=t||e!==t:typeof e!=typeof t?e!==t:e&&t&&e!=t||e!==t)),K=new WeakMap,V=(e,t)=>{const n=null==e||e<0||"number"!=typeof e||e==Symbol.iterator||null!=t&&e>=(t?.length||0);return null!=t&&(Array.isArray(t)&&n)},H=new WeakMap,X=(e,t)=>"function"==typeof e?.[t]?e?.[t]?.bind?.(e):e?.[t],J=(e,t,n)=>{if(Array.isArray(e))return e.every(N)?e.map(t):e.map((n,s)=>J(n,t,[e,s]));if(e instanceof Map){const n=Array.from(e.entries());return n.map(([e,t])=>t).every(N)?new Map(n.map(([n,s])=>[n,t(s,n,e)])):new Map(n.map(([n,s])=>[n,J(s,t,[e,n])]))}if(e instanceof Set){const n=Array.from(e.entries()),s=n.map(([e,t])=>t);return n.every(N)?new Set(s.map(t)):new Set(s.map(n=>J(n,t,[e,n])))}if("object"==typeof e&&e?.constructor==Object&&"[object Object]"==Object.prototype.toString.call(e)){const n=Array.from(Object.entries(e));return n.map(([e,t])=>t).every(N)?Object.fromEntries(n.map(([n,s])=>[n,t(s,n,e)])):Object.fromEntries(n.map(([n,s])=>[n,J(s,t,[e,n])]))}return t(e,n?.[1]??"",n?.[0]??null)},Z=new WeakMap,Q=new WeakMap,ee=(e,t)=>e instanceof Promise||"function"==typeof e?.then?Z?.has?.(e)?t(Z?.get?.(e)):Promise.try?.(async()=>{const t=await e;return Z?.set?.(e,t),t})?.then?.(t):t(e);class te{#e;#t;constructor(e,t){this.#e=e,this.#t=t}defineProperty(e,t,n){return c(e)instanceof Promise?Reflect.defineProperty(e,t,n):ee(c(e),e=>Reflect.defineProperty(e,t,n))}deleteProperty(e,t){return c(e)instanceof Promise?Reflect.deleteProperty(e,t):ee(c(e),e=>Reflect.deleteProperty(e,t))}getPrototypeOf(e){return c(e)instanceof Promise?Reflect.getPrototypeOf(e):ee(c(e),e=>Reflect.getPrototypeOf(e))}setPrototypeOf(e,t){return c(e)instanceof Promise?Reflect.setPrototypeOf(e,t):ee(c(e),e=>Reflect.setPrototypeOf(e,t))}isExtensible(e){return c(e)instanceof Promise?Reflect.isExtensible(e):ee(c(e),e=>Reflect.isExtensible(e))}preventExtensions(e){return c(e)instanceof Promise?Reflect.ownKeys(e):ee(c(e),e=>Reflect.preventExtensions(e))}ownKeys(e){const t=c(e);if(t instanceof Promise)return Object.keys(t);return ee(t,e=>"object"!=typeof e&&"function"!=typeof e||null==e?[]:Object.keys(e))??[]}getOwnPropertyDescriptor(e,t){return c(e)instanceof Promise?Reflect.getOwnPropertyDescriptor(e,t):ee(c(e),e=>Reflect.getOwnPropertyDescriptor(e,t))}construct(e,t,n){return ee(c(e),e=>Reflect.construct(e,t,n))}has(e,t){return c(e)instanceof Promise?Reflect.has(e,t):ee(c(e),e=>Reflect.has(e,t))}get(e,t,n){if(e=c(e),"promise"==t)return e;if("resolve"==t&&this.#e)return(...e)=>{const t=this.#e?.(...e);return this.#e=null,t};if("reject"==t&&this.#t)return(...e)=>{const t=this.#t?.(...e);return this.#t=null,t};if("then"==t||"catch"==t||"finally"==t){if(e instanceof Promise)return e?.[t]?.bind?.(e);{const n=Promise.try(()=>e);return n?.[t]?.bind?.(n)}}const o=ne(ee(e,async r=>{if(c(r)instanceof Promise)return Reflect.get(r,t,n);if(s(r))return t==Symbol.toPrimitive||t==Symbol.toStringTag?r:void 0;let o;try{o=Reflect.get(r,t,n)}catch(i){o=e?.[t]}return"function"==typeof o?o?.bind?.(r):o}));return t==Symbol.toStringTag?s(o)?String(o??"")||"":o?.[Symbol.toStringTag]?.()||String(o??"")||"":t==Symbol.toPrimitive?e=>s(o)?r(o,e):null:o}set(e,t,n){return ee(c(e),e=>Reflect.set(e,t,n))}apply(e,t,n){if(this.#e){const e=this.#e?.(...n);return this.#e=null,e}return ee(c(e,this.#e),e=>{if("function"==typeof e)return c(e),Reflect.apply(e,t,n)})}}function ne(e,n,s){return e instanceof Promise||"function"==typeof e?.then?Z?.has?.(e)?Z?.get?.(e):(Q?.has?.(e)||e?.then?.(t=>Z?.set?.(e,t)),Q?.getOrInsertComputed?.(e,()=>new Proxy((e=>{if("function"==typeof e||null==e)return e;const n=function(){};return n[t]=e,n})(e),new te(n,s)))):e}class se{constructor(e){this._unsubscribe=e}_closed=!1;get closed(){return this._closed}unsubscribe(){this._closed||(this._closed=!0,this._unsubscribe())}}class re{constructor(e){this._producer=e}subscribe(e,t){const n="function"==typeof e?{next:e}:e??{},s=new AbortController;t?.signal?.addEventListener("abort",()=>s.abort());let r,o=!0;const i=()=>{o=!1,s.abort(),r?.()},a={next:e=>o&&n.next?.(e),error:e=>{o&&(n.error?.(e),i())},complete:()=>{o&&(n.complete?.(),i())},signal:s.signal,get active(){return o&&!s.signal.aborted}};try{r=this._producer(a)}catch(c){a.error(c)}return new se(i)}pipe(...e){return e.reduce((e,t)=>t(e),this)}}class oe{_subs=new Set;_buffer=[];_maxBuffer;_replay;constructor(e={}){this._maxBuffer=e.bufferSize??0,this._replay=e.replayOnSubscribe??!1}next(e){this._maxBuffer>0&&(this._buffer.push(e),this._buffer.length>this._maxBuffer&&this._buffer.shift());for(const n of this._subs)try{n.next?.(e)}catch(t){n.error?.(t)}}error(e){for(const t of this._subs)t.error?.(e)}complete(){for(const e of this._subs)e.complete?.();this._subs.clear()}subscribe(e){const t="function"==typeof e?{next:e}:e;if(this._subs.add(t),this._replay)for(const s of this._buffer)try{t.next?.(s)}catch(n){t.error?.(n)}return new se(()=>{this._subs.delete(t)})}getValue(){return this._buffer.at(-1)}getBuffer(){return[...this._buffer]}get subscriberCount(){return this._subs.size}}function ie(){if(void 0!==globalThis.Deno)return"deno";if(void 0!==globalThis.process&&globalThis.process?.versions?.node)return"node";if("undefined"!=typeof ServiceWorkerGlobalScope&&self instanceof ServiceWorkerGlobalScope)return"service-worker";if("undefined"!=typeof SharedWorkerGlobalScope&&self instanceof SharedWorkerGlobalScope)return"shared-worker";if("undefined"!=typeof DedicatedWorkerGlobalScope&&self instanceof DedicatedWorkerGlobalScope)return"worker";if("undefined"!=typeof chrome&&chrome.runtime?.id){if("function"==typeof chrome.runtime.getBackgroundPage||chrome.runtime.getManifest?.()?.background?.service_worker)return"chrome-background";if(void 0!==chrome.devtools)return"chrome-devtools";if("undefined"!=typeof document&&"chrome-extension:"===globalThis?.location?.protocol){if((chrome.extension?.getViews?.({type:"popup"})??[]).includes(globalThis))return"chrome-popup"}if("undefined"!=typeof document&&"chrome-extension:"!==globalThis?.location?.protocol)return"chrome-content"}return"undefined"!=typeof globalThis&&"undefined"!=typeof document?"window":"unknown"}function ae(e){return e?"undefined"!=typeof Worker&&e instanceof Worker?"worker":"undefined"!=typeof SharedWorker&&e instanceof SharedWorker?"shared-worker":"undefined"!=typeof MessagePort&&e instanceof MessagePort?"message-port":"undefined"!=typeof BroadcastChannel&&e instanceof BroadcastChannel?"broadcast":"undefined"!=typeof WebSocket&&e instanceof WebSocket?"websocket":"undefined"!=typeof RTCDataChannel&&e instanceof RTCDataChannel?"rtc-data":"chrome-runtime"===e||"chrome-tabs"===e||"chrome-port"===e||"chrome-external"===e?e:"undefined"!=typeof chrome&&e&&"object"==typeof e&&"function"==typeof e.postMessage&&e.onMessage?.addListener?"chrome-port":e===self||e===globalThis||"self"===e?"self":"internal":"internal"}function ce(e){if(!e)return"unknown";if(e.contextType)return e.contextType;const t=e.sender??"";return t.includes("worker")?"worker":t.includes("sw")||t.includes("service")?"service-worker":t.includes("chrome")||t.includes("crx")?"chrome-content":t.includes("background")?"chrome-background":"unknown"}const le={get:(e,t)=>Reflect.get(e,t),set:(e,t,n)=>Reflect.set(e,t,n),has:(e,t)=>Reflect.has(e,t),apply:(e,t,n)=>Reflect.apply(e,t,n),construct:(e,t)=>Reflect.construct(e,t),deleteProperty:(e,t)=>Reflect.deleteProperty(e,t),ownKeys:e=>Reflect.ownKeys(e),getOwnPropertyDescriptor:(e,t)=>Reflect.getOwnPropertyDescriptor(e,t),getPrototypeOf:e=>Reflect.getPrototypeOf(e),setPrototypeOf:(e,t)=>Reflect.setPrototypeOf(e,t),isExtensible:e=>Reflect.isExtensible(e),preventExtensions:e=>Reflect.preventExtensions(e)},he=Symbol.for("uniform.proxy"),ue=Symbol.for("uniform.proxy.internals");class de{constructor(e,t){this._invoker=e,this._config={channel:t.channel,basePath:t.basePath??[],invoker:e,cache:t.cache??!0,timeout:t.timeout??3e4}}_config;_childCache=new Map;get(e,t,n){const s=String(t);if(t===he)return!0;if(t===ue)return this._config;if(t===Me)return!0;if(t===Ie)return this._getDescriptor();if("then"===t||"catch"===t||"finally"===t)return;if("symbol"==typeof t)return;if("$path"===t)return this._config.basePath;if("$channel"===t)return this._config.channel;if("$descriptor"===t)return this._getDescriptor();if("$invoke"===t)return this._invoker;const r=[...this._config.basePath,s];if(this._config.cache&&this._childCache.has(s))return this._childCache.get(s);const o=pe(this._invoker,{...this._config,basePath:r});return this._config.cache&&this._childCache.set(s,o),o}set(t,n,s,r){return"symbol"==typeof n||this._invoker(e.SET,[...this._config.basePath,String(n)],[s]),!0}apply(t,n,s){return this._invoker(e.APPLY,this._config.basePath,[s])}construct(t,n,s){return this._invoker(e.CONSTRUCT,this._config.basePath,[n])}has(t,n){return"symbol"!=typeof n&&this._invoker(e.HAS,this._config.basePath,[n])}deleteProperty(t,n){return"symbol"==typeof n||this._invoker(e.DELETE_PROPERTY,[...this._config.basePath,String(n)],[])}ownKeys(e){return[]}getOwnPropertyDescriptor(e,t){return{configurable:!0,enumerable:!0,writable:!0}}getPrototypeOf(e){return Function.prototype}setPrototypeOf(t,n){return this._invoker(e.SET_PROTOTYPE_OF,this._config.basePath,[n])}isExtensible(e){return!0}preventExtensions(t){return this._invoker(e.PREVENT_EXTENSIONS,this._config.basePath,[])}_getDescriptor(){return{path:this._config.basePath,channel:this._config.channel,primitive:!1}}}function pe(e,t){const n=new de(e,t);return new Proxy(function(){},n)}function fe(e,t,n){if(!e||"object"!=typeof e)return e;if(e.primitive)return e;const s=Oe.get(e);if(s)return s;const r=pe(t,{channel:n??e.channel??"unknown",basePath:e.path??[]});return Oe.set(e,r),Re.set(r,e),r}const me=fe;class ye{constructor(e,t){this._createId=e,this._emitEvent=t}_connections=new Map;register(e){const t=function(e){return[e.localChannel,e.remoteChannel,e.sender,e.transportType,e.direction].join("::")}(e),n=Date.now(),s=this._connections.get(t);if(s)return s.updatedAt=n,s.status="active",s.metadata={...s.metadata,...e.metadata},s;const r={id:this._createId(),localChannel:e.localChannel,remoteChannel:e.remoteChannel,sender:e.sender,transportType:e.transportType,direction:e.direction,status:"active",createdAt:n,updatedAt:n,metadata:e.metadata};return this._connections.set(t,r),this._emitEvent?.({type:"connected",connection:r,timestamp:n}),r}markNotified(e,t){const n=Date.now();e.lastNotifyAt=n,e.updatedAt=n,this._emitEvent?.({type:"notified",connection:e,timestamp:n,payload:t})}closeByChannel(e){const t=Date.now();for(const n of this._connections.values())n.localChannel!==e&&n.remoteChannel!==e||"closed"!==n.status&&(n.status="closed",n.updatedAt=t,this._emitEvent?.({type:"disconnected",connection:n,timestamp:t}))}closeAll(){const e=Date.now();for(const t of this._connections.values())"closed"!==t.status&&(t.status="closed",t.updatedAt=e,this._emitEvent?.({type:"disconnected",connection:t,timestamp:e}))}query(e={}){return function(e,t={}){const n=t.includeClosed??!1,s=t.status??(n?void 0:"active");return[...e].filter(e=>!(s&&e.status!==s||t.channel&&e.localChannel!==t.channel&&e.remoteChannel!==t.channel||t.localChannel&&e.localChannel!==t.localChannel||t.remoteChannel&&e.remoteChannel!==t.remoteChannel||t.sender&&e.sender!==t.sender||t.transportType&&e.transportType!==t.transportType||t.direction&&e.direction!==t.direction)).sort((e,t)=>t.updatedAt-e.updatedAt)}(this._connections.values(),e)}values(){return[...this._connections.values()]}clear(){this._connections.clear()}}class _e{_name;_contextType;_config;_transports=new Map;_defaultTransport=null;_connectionEvents=new oe({bufferSize:200});_connectionRegistry=new ye(()=>d(),e=>this._connectionEvents.next(e));_pending=new Map;_subscriptions=[];_inbound=new oe({bufferSize:100});_outbound=new oe({bufferSize:100});_invocations=new oe({bufferSize:100});_responses=new oe({bufferSize:100});_exposed=new Map;_proxyCache=new WeakMap;__getPrivate(e){return this[e]}__setPrivate(e,t){this[e]=t}constructor(e){const t="string"==typeof e?{name:e}:e;this._name=t.name,this._contextType=!1!==t.autoDetect?ie():"unknown",this._config={name:t.name,autoDetect:t.autoDetect??!0,timeout:t.timeout??3e4,reflect:t.reflect??le,bufferSize:t.bufferSize??100,autoListen:t.autoListen??!0},this._config.autoListen&&this._isWorkerContext()&&this.listen(self)}connect(e,t={}){const n=ae(e),s=t.targetChannel??this._inferTargetChannel(e,n),r=this._createTransportBinding(e,n,s,t);this._transports.set(s,r),this._defaultTransport||(this._defaultTransport=r);const o=this._registerConnection({localChannel:this._name,remoteChannel:s,sender:this._name,transportType:n,direction:"outgoing",metadata:{phase:"connect"}});return this._emitConnectionSignal(r,"connect",{connectionId:o.id,from:this._name,to:s}),this}listen(e,t={}){const n=ae(e),s=t.targetChannel??this._inferTargetChannel(e,n),r=e=>this._handleIncoming(e),o=this._registerConnection({localChannel:this._name,remoteChannel:s,sender:s,transportType:n,direction:"incoming",metadata:{phase:"listen"}});switch(n){case"worker":case"message-port":case"broadcast":!1!==t.autoStart&&e.start&&e.start(),e.addEventListener?.("message",e=>r(e.data));break;case"websocket":e.addEventListener?.("message",e=>{try{r(JSON.parse(e.data))}catch{}});break;case"chrome-runtime":chrome.runtime.onMessage?.addListener?.((e,t,n)=>(r(e),!0));break;case"chrome-tabs":chrome.runtime.onMessage?.addListener?.((e,n)=>(null==t.tabId||n?.tab?.id===t.tabId)&&(r(e),!0));break;case"chrome-port":e?.onMessage?.addListener?.(e=>{r(e)});break;case"chrome-external":chrome.runtime.onMessageExternal?.addListener?.(e=>(r(e),!0));break;case"self":addEventListener?.("message",e=>r(e.data));break;default:t.onMessage&&t.onMessage(r)}return this._sendSignalToTarget(e,n,{connectionId:o.id,from:this._name,to:s,tabId:t.tabId,externalId:t.externalId},"notify"),this}attach(e,t={}){return this.connect(e,t)}expose(e,t){const n=[e];return qe(n,t),this._exposed.set(e,{name:e,obj:t,path:n}),this}exposeAll(e){for(const[t,n]of Object.entries(e))this.expose(t,n);return this}async import(t,n){return this.invoke(n??this._getDefaultTarget(),e.IMPORT,[],[t])}invoke(e,t,n,s=[]){const r=d(),o=Promise.withResolvers();this._pending.set(r,o);const i=setTimeout(()=>{this._pending.has(r)&&(this._pending.delete(r),o.reject(new Error(`Request timeout: ${t} on ${n.join(".")}`)))},this._config.timeout),a={id:r,channel:e,sender:this._name,type:"request",payload:{channel:e,sender:this._name,action:t,path:n,args:s},timestamp:Date.now()};return this._send(e,a),this._outbound.next(a),o.promise.finally(()=>clearTimeout(i))}get(t,n,s){return this.invoke(t,e.GET,n,[s])}set(t,n,s,r){return this.invoke(t,e.SET,n,[s,r])}call(t,n,s=[]){return this.invoke(t,e.APPLY,n,[s])}construct(t,n,s=[]){return this.invoke(t,e.CONSTRUCT,n,[s])}proxy(e,t=[]){const n=e??this._getDefaultTarget();return this._createProxy(n,t)}remote(e,t){return this.proxy(t,[e])}wrapDescriptor(e,t){return fe(e,(n,s,r)=>{const o=t??e?.channel??this._getDefaultTarget();return this.invoke(o,n,s,r)},t??e?.channel??this._getDefaultTarget())}subscribe(e){return this._inbound.subscribe(e)}next(e){this._send(e.channel,e),this._outbound.next(e)}emit(e,t,n){const s={id:d(),channel:e,sender:this._name,type:"event",payload:{type:t,data:n},timestamp:Date.now()};this.next(s)}notify(e,t={},n="notify"){const s=this._transports.get(e);return!!s&&(this._emitConnectionSignal(s,n,{from:this._name,to:e,...t}),!0)}get onMessage(){return this._inbound}get onOutbound(){return this._outbound}get onInvocation(){return this._invocations}get onResponse(){return this._responses}get onConnection(){return this._connectionEvents}subscribeConnections(e){return this._connectionEvents.subscribe(e)}queryConnections(e={}){return this._connectionRegistry.query(e)}notifyConnections(e={},t={}){let n=0;const s=this.queryConnections({...t,status:"active",includeClosed:!1});for(const r of s){const t=this._transports.get(r.remoteChannel);t&&(this._emitConnectionSignal(t,"notify",{connectionId:r.id,from:this._name,to:r.remoteChannel,...e}),n++)}return n}get name(){return this._name}get contextType(){return this._contextType}get config(){return this._config}get connectedChannels(){return[...this._transports.keys()]}get exposedModules(){return[...this._exposed.keys()]}close(){this._subscriptions.forEach(e=>e.unsubscribe()),this._subscriptions=[],this._pending.clear(),this._markAllConnectionsClosed();for(const e of this._transports.values()){try{e.cleanup?.()}catch{}if("message-port"===e.transportType||"broadcast"===e.transportType)try{e.target?.close?.()}catch{}}this._transports.clear(),this._defaultTransport=null,this._connectionRegistry.clear(),this._inbound.complete(),this._outbound.complete(),this._invocations.complete(),this._responses.complete(),this._connectionEvents.complete()}_handleIncoming(e){if(e&&"object"==typeof e)switch(this._inbound.next(e),e.type){case"request":e.channel===this._name&&this._handleRequest(e);break;case"response":this._handleResponse(e);break;case"event":break;case"signal":this._handleSignal(e)}}_handleResponse(e){const t=e.reqId??e.id,n=this._pending.get(t);if(n){if(this._pending.delete(t),e.payload?.error)n.reject(new Error(e.payload.error));else{const t=e.payload?.result,s=e.payload?.descriptor;null!=t?n.resolve(t):s?n.resolve(this.wrapDescriptor(s,e.sender)):n.resolve(void 0)}this._responses.next({id:t,channel:e.channel,sender:e.sender,result:e.payload?.result,descriptor:e.payload?.descriptor,timestamp:Date.now()})}}async _handleRequest(e){const t=e.payload;if(!t)return;const{action:n,path:s,args:r,sender:o}=t,i=e.reqId??e.id;this._invocations.next({id:i,channel:this._name,sender:o,action:n,path:s,args:r??[],timestamp:Date.now(),contextType:ce(e)});const{result:a,toTransfer:c,newPath:l}=await this._executeAction(n,s,r??[],o);await this._sendResponse(i,n,o,l,a,c)}async _executeAction(e,t,n,s){const{result:r,toTransfer:o,path:i}=Ge(e,t,n,{channel:this._name,sender:s,reflect:this._config.reflect});return{result:await r,toTransfer:o,newPath:i}}async _sendResponse(e,t,n,s,r,o){const{response:i,transfer:a}=await Ye(e,t,this._name,n,s,r,o),c={id:e,...i,timestamp:Date.now(),transferable:a};this._send(n,c,a)}_handleSignal(e){const t=e?.payload??{},n=t.from??e.sender??"unknown",s=e.transportType??this._transports.get(e.channel)?.transportType??"internal",r=this._registerConnection({localChannel:this._name,remoteChannel:n,sender:e.sender??n,transportType:s,direction:"incoming"});this._markConnectionNotified(r,t)}_registerConnection(e){return this._connectionRegistry.register(e)}_markConnectionNotified(e,t){this._connectionRegistry.markNotified(e,t)}_emitConnectionSignal(e,t,n={}){const s={id:d(),type:"signal",channel:e.targetChannel,sender:this._name,transportType:e.transportType,payload:{type:t,from:this._name,to:e.targetChannel,...n},timestamp:Date.now()};(e?.sender??e?.postMessage)?.call(e,s);const r=this._registerConnection({localChannel:this._name,remoteChannel:e.targetChannel,sender:this._name,transportType:e.transportType,direction:"outgoing"});this._markConnectionNotified(r,s.payload)}_sendSignalToTarget(e,t,n,s){const r={id:d(),type:"signal",channel:n.to??this._name,sender:this._name,transportType:t,payload:{type:s,...n},timestamp:Date.now()};try{if("websocket"===t)return void e?.send?.(JSON.stringify(r));if("chrome-runtime"===t)return void chrome.runtime?.sendMessage?.(r);if("chrome-tabs"===t){const e=n.tabId;return void(null!=e&&chrome.tabs?.sendMessage?.(e,r))}if("chrome-port"===t)return void e?.postMessage?.(r);if("chrome-external"===t)return void(n.externalId&&chrome.runtime?.sendMessage?.(n.externalId,r));e?.postMessage?.(r,{transfer:[]})}catch{}}_markAllConnectionsClosed(){this._connectionRegistry.closeAll()}_createTransportBinding(e,t,n,s){let r,o;switch(t){case"worker":case"message-port":case"broadcast":!1!==s.autoStart&&e.start&&e.start(),r=(t,n)=>e.postMessage(t,{transfer:n});{const t=e=>this._handleIncoming(e.data);e.addEventListener?.("message",t),o=()=>e.removeEventListener?.("message",t)}break;case"websocket":r=t=>e.send(JSON.stringify(t));{const t=e=>{try{this._handleIncoming(JSON.parse(e.data))}catch{}};e.addEventListener?.("message",t),o=()=>e.removeEventListener?.("message",t)}break;case"chrome-runtime":r=e=>chrome.runtime.sendMessage(e);{const e=e=>this._handleIncoming(e);chrome.runtime.onMessage?.addListener?.(e),o=()=>chrome.runtime.onMessage?.removeListener?.(e)}break;case"chrome-tabs":r=e=>{null!=s.tabId&&chrome.tabs?.sendMessage?.(s.tabId,e)};{const e=(e,t)=>(null==s.tabId||t?.tab?.id===s.tabId)&&(this._handleIncoming(e),!0);chrome.runtime.onMessage?.addListener?.(e),o=()=>chrome.runtime.onMessage?.removeListener?.(e)}break;case"chrome-port":if(e?.postMessage&&e?.onMessage?.addListener){r=t=>e.postMessage(t);const t=e=>this._handleIncoming(e);e.onMessage.addListener(t),o=()=>{try{e.onMessage.removeListener(t)}catch{}try{e.disconnect?.()}catch{}}}else{const e=s.portName??n,t=null!=s.tabId&&chrome.tabs?.connect?chrome.tabs.connect(s.tabId,{name:e}):chrome.runtime.connect({name:e});r=e=>t.postMessage(e);const i=e=>this._handleIncoming(e);t.onMessage.addListener(i),o=()=>{try{t.onMessage.removeListener(i)}catch{}try{t.disconnect()}catch{}}}break;case"chrome-external":r=e=>{s.externalId&&chrome.runtime.sendMessage(s.externalId,e)};{const e=e=>(this._handleIncoming(e),!0);chrome.runtime.onMessageExternal?.addListener?.(e),o=()=>chrome.runtime.onMessageExternal?.removeListener?.(e)}break;case"self":r=(e,t)=>postMessage(e,{transfer:t??[]});{const e=e=>this._handleIncoming(e.data);addEventListener?.("message",e),o=()=>removeEventListener?.("message",e)}break;default:s.onMessage&&(o=s.onMessage(e=>this._handleIncoming(e))),r=t=>e?.postMessage?.(t)}return{target:e,targetChannel:n,transportType:t,sender:r,cleanup:o,postMessage:(e,t)=>r?.(e,t),start:()=>e?.start?.(),close:()=>e?.close?.()}}_send(e,t,n){const s=this._transports.get(e)??this._defaultTransport;(s?.sender??s?.postMessage)?.call(s,t,n)}_getDefaultTarget(){return this._defaultTransport?this._defaultTransport.targetChannel:"worker"}_inferTargetChannel(e,t){return"worker"===t?"worker":"broadcast"===t&&e.name?e.name:"self"===t?"self":`${t}-${d().slice(0,8)}`}_createProxy(e,t){return pe((t,n,s)=>this.invoke(e,t,n,s),{channel:e,basePath:t,cache:!0,timeout:this._config.timeout})}_isWorkerContext(){return["worker","shared-worker","service-worker"].includes(this._contextType)}}function ge(e){return new _e(e)}let be=null;const we="undefined";[typeof ArrayBuffer!=we?ArrayBuffer:null,typeof MessagePort!=we?MessagePort:null,typeof ReadableStream!=we?ReadableStream:null,typeof WritableStream!=we?WritableStream:null,typeof TransformStream!=we?TransformStream:null,typeof WebTransportReceiveStream!=we?WebTransportReceiveStream:null,typeof WebTransportSendStream!=we?WebTransportSendStream:null,typeof AudioData!=we?AudioData:null,typeof ImageBitmap!=we?ImageBitmap:null,typeof VideoFrame!=we?VideoFrame:null,typeof OffscreenCanvas!=we?OffscreenCanvas:null,typeof RTCDataChannel!=we?RTCDataChannel:null].filter(e=>null!=e);const Ce={name:"unknown",instance:null},ke=new Map,Se=t=>[...Object.values(e)].includes(t);let ve=class{constructor(e,t={}){this.channelName=e,this.options=t,this._channel=function(){if(!be){const e=ie();be=["worker","shared-worker","service-worker"].includes(e)?ge({name:"worker",autoListen:!0}):ge({name:"host",autoListen:!1})}return be}()}_channel;request(e,t,n,s={}){return"string"==typeof e&&(e=[e]),Array.isArray(t)&&Se(e)&&(n=t,t=e,e=[]),this._channel.invoke(this.channelName,t,e,n)}doImportModule(e,t){return this._channel.import(e,this.channelName)}},xe=class{constructor(e,t={}){this.channel=e,this.options=t,this._unified=ge({name:e,autoListen:!1}),Ce.name=e,Ce.instance=this}_unified;broadcasts={};createRemoteChannel(e,t={},n){return n&&(this._unified.attach(n,{targetChannel:e}),this.broadcasts[e]=n),Promise.resolve(new ve(e,t))}getChannel(){return this.channel}request(e,t,n,s={},r="worker"){return"string"==typeof e&&(e=[e]),Array.isArray(t)&&Se(e)&&(r=s,s=n,n=t,t=e,e=[]),this._unified.invoke(r,t,e,n)}resolveResponse(e,t){return Promise.resolve(t)}async handleAndResponse(e,t,n){const s=await async function(e,t,n,s){const{channel:r,sender:o,path:i,action:a,args:c}=e;if(r!==n)return null;const{result:l,toTransfer:h,path:u}=Ge(a,i,c,{channel:r,sender:o,...s});return Ye(t,a,n,o,u,l,h)}(e,t,this.channel);s&&n?.(s.response,s.transfer)}close(){this._unified.close()}};const Pe=(e="$host$")=>((e="$host$")=>{if(Ce?.instance&&"$host$"===e)return Ce.instance;if(ke.has(e))return ke.get(e)??null;const t=new xe(e);return"$host$"===e&&(Ce.name=e,Ce.instance=t),ke.set(e,t),t})(e),Te=(e,t={},n=("undefined"!=typeof self?self:null))=>{const s=Pe(e??"$host$");return s?.createRemoteChannel?.(e,t,n)??s},Ee=new WeakMap,Re=new WeakMap,Oe=new WeakMap,Ae=(e,t=Ce?.name,n)=>"object"==typeof e&&null!=e||"function"==typeof e&&null!=e?Re.has(e)?Re.get(e):Ee.has(e)?Ee.get(e):j(e)||n?.includes?.(e)||t==Ce?.name?e:{$isDescriptor:!0,path:Ne.get(e)??(()=>{const t=[d()];return qe(t,e),t})(),owner:Ce?.name,channel:t,primitive:s(e),writable:!0,enumerable:!0,configurable:!0,argumentCount:e instanceof Function?e.length:-1}:N(e)?e:null,Me=Symbol.for("@requestHandler"),Ie=Symbol.for("@descriptor"),De=e=>N(e)||e?.[Ie]?e:e?.$isDescriptor?me(e,{}):j(e)?e:null,je=new Map,Ne=new WeakMap,We=(e,t)=>{if(null==t||Array.isArray(t)||(t=[t]),null==t||t?.length<1)return e;const n=e?.[Ie]??(e?.$isDescriptor?e:null);if(n&&n?.owner==Ce?.name&&(e=Le(n?.path)??e),s(e))return e;for(const s of t)if(e=e?.[s],null==e)return e;return e},Le=e=>{if(null==e||Array.isArray(e)||(e=[e]),null==e||e?.length<1)return null;const t=je?.get?.(e?.[0])??null;return null!=t?We(t,e?.slice?.(1)):null},qe=(e,t)=>{const n=t?.[Ie]??(t?.$isDescriptor?t:null);if(n&&n?.owner==Ce?.name&&(t=Le(n?.path)??t),null==e||Array.isArray(e)||(e=[e]),null==e||e?.length<1)return null;const s=je?.get?.(e?.[0])??null;return e?.length>1?We(s,e?.slice?.(1,-1))[e?.[e?.length-1]]=t:je?.set?.(e?.[0],t),"object"!=typeof t&&"function"!=typeof t||Ne?.set?.(t,e),t},Be=e=>{if(null==e||Array.isArray(e)||(e=[e]),null==e||e?.length<1)return!1;return!(je?.get?.(e?.[0])??null)&&e?.length<=1&&(je?.delete?.(e?.[0]),!0)},Ue=e=>{const t=e?.[Ie]??(e?.$isDescriptor?e:null);t&&t?.owner==Ce?.name&&(e=Le(t?.path)??e);const n=Ne?.get?.(e)??t?.path;return!(null==n||n?.length<1)&&(Be(n),"object"!=typeof e&&"function"!=typeof e||Ne?.delete?.(e),!0)},$e=e=>{const t=e?.[Ie]??(e?.$isDescriptor?e:null);return null==(Ne?.get?.(e)??t?.path)},Fe=e=>("object"==typeof e||"function"==typeof e)&&null!=e,ze={get:(e,t)=>e?.[t],set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>t in e,apply:(e,t,n)=>e.apply(t,n),construct:(e,t)=>new e(...t),deleteProperty:(e,t)=>delete e[t],ownKeys:e=>Object.keys(e),getOwnPropertyDescriptor:(e,t)=>Object.getOwnPropertyDescriptor(e,t),getPrototypeOf:e=>Object.getPrototypeOf(e),setPrototypeOf:(e,t)=>Object.setPrototypeOf(e,t),isExtensible:e=>Object.isExtensible(e),preventExtensions:e=>Object.preventExtensions(e)};function Ge(t,n,s,r={}){const{channel:o="",sender:i="",reflect:a=ze}=r,c=r.target??Le(n),l=[];let h=null,u=n;switch(String(t).toLowerCase()){case"import":case e.IMPORT:h=import(s?.[0]);break;case"transfer":case e.TRANSFER:L(c)&&o!==i&&l.push(c),h=c;break;case"get":case e.GET:{const e=s?.[0],t=a.get?.(c,e)??c?.[e];h="function"==typeof t&&null!=c?t.bind(c):t,u=[...n,String(e)];break}case"set":case e.SET:{const[e,t]=s,o=J(t,De);h=r.target?a.set?.(c,e,o)??(c[e]=o,!0):a.set?.(c,e,o)??qe([...n,String(e)],o);break}case"apply":case"call":case e.APPLY:case e.CALL:if("function"==typeof c){const e=r.context??(r.target?void 0:Le(n.slice(0,-1))),t=J(s?.[0]??s??[],De);h=a.apply?.(c,e,t)??c.apply(e,t),L(h)&&"transfer"===n?.at(-1)&&o!==i&&l.push(h)}break;case"construct":case e.CONSTRUCT:if("function"==typeof c){const e=J(s?.[0]??s??[],De);h=a.construct?.(c,e)??new c(...e)}break;case"delete":case"deleteproperty":case"dispose":case e.DELETE:case e.DELETE_PROPERTY:case e.DISPOSE:if(r.target){const e=n[n.length-1];h=a.deleteProperty?.(c,e)??delete c[e]}else h=n?.length>0?Be(n):Ue(c),h&&(u=Ne.get(c)??[]);break;case"has":case e.HAS:h=a.has?.(c,s?.[0])??(!!Fe(c)&&s?.[0]in c);break;case"ownkeys":case e.OWN_KEYS:h=a.ownKeys?.(c)??(Fe(c)?Object.keys(c):[]);break;case"getownpropertydescriptor":case"getpropertydescriptor":case e.GET_OWN_PROPERTY_DESCRIPTOR:case e.GET_PROPERTY_DESCRIPTOR:h=a.getOwnPropertyDescriptor?.(c,s?.[0]??n?.at(-1)??"")??(Fe(c)?Object.getOwnPropertyDescriptor(c,s?.[0]??n?.at(-1)??""):void 0);break;case"getprototypeof":case e.GET_PROTOTYPE_OF:h=a.getPrototypeOf?.(c)??(Fe(c)?Object.getPrototypeOf(c):null);break;case"setprototypeof":case e.SET_PROTOTYPE_OF:h=a.setPrototypeOf?.(c,s?.[0])??(!!Fe(c)&&Object.setPrototypeOf(c,s?.[0]));break;case"isextensible":case e.IS_EXTENSIBLE:h=a.isExtensible?.(c)??(!Fe(c)||Object.isExtensible(c));break;case"preventextensions":case e.PREVENT_EXTENSIONS:h=a.preventExtensions?.(c)??(!!Fe(c)&&Object.preventExtensions(c))}return{result:h,toTransfer:l,path:u}}async function Ye(t,n,r,o,i,a,c){const l=await a,h=L(l)&&c.includes(l)||N(l);let u=i;h||"get"===n||n===e.GET||"object"!=typeof l&&"function"!=typeof l||($e(l)?(u=[d()],qe(u,l)):u=Ne.get(l)??[]);const p=Le(u),f="get"===n||n===e.GET?u?.at(-1):void 0,m=Le(i),y=J(l,e=>Ae(e,r,c))??l;return{response:{channel:o,sender:r,reqId:t,action:n,type:"response",payload:{result:h?y:null,type:typeof l,channel:o,sender:r,descriptor:{$isDescriptor:!0,path:u,owner:r,channel:r,primitive:s(l),writable:!0,enumerable:!0,configurable:!0,argumentCount:m instanceof Function?m.length:-1,...Fe(p)&&null!=f?Object.getOwnPropertyDescriptor(p,f):{}}}},transfer:c}}class Ke{constructor(e,t="internal",n={}){this._name=e,this._transportType=t,this._opts={timeout:3e4,autoReconnect:!0,reconnectInterval:1e3,maxReconnectAttempts:5,bufferMessages:!0,bufferSize:1e3,metadata:{},...n},this._setupSubscriptions()}_id=d();_state="disconnected";_inbound=new oe({bufferSize:1e3});_outbound=new oe({bufferSize:1e3});_stateChanges=new oe;_connectedPeers=new Map;_subs=[];_stats={messagesSent:0,messagesReceived:0,bytesTransferred:0,latencyMs:0,uptime:0,reconnectCount:0};_startTime=0;_pending=new Map;_buffer=[];_opts;subscribe(e,t){var n;return(t?(n=e=>e.sender===t,e=>new re(t=>{const s=e.subscribe({next:e=>n(e)&&t.next(e),error:e=>t.error(e),complete:()=>t.complete()});return()=>s.unsubscribe()}))(this._inbound):this._inbound).subscribe("function"==typeof e?{next:e}:e)}next(e){"connected"===this._state?(this._outbound.next(e),this._stats.messagesSent++):this._opts.bufferMessages&&this._buffer.length<this._opts.bufferSize&&this._buffer.push(e)}async request(e,t,n={}){const s=d(),r=Promise.withResolvers();this._pending.set(s,r);const o=setTimeout(()=>{this._pending.has(s)&&(this._pending.delete(s),r.reject(new Error("Request timeout")))},n.timeout??this._opts.timeout);return this.next({id:d(),channel:e,sender:this._name,type:"request",reqId:s,payload:{...t,action:n.action,path:n.path},timestamp:Date.now()}),r.promise.finally(()=>clearTimeout(o))}respond(e,t){this.next({id:d(),channel:e.sender,sender:this._name,type:"response",reqId:e.reqId,payload:t,timestamp:Date.now()})}emit(e,t,n){this.next({id:d(),channel:e,sender:this._name,type:"event",payload:{type:t,data:n},timestamp:Date.now()})}subscribeOutbound(e){return this._outbound.subscribe("function"==typeof e?{next:e}:e)}pushInbound(e){if(this._stats.messagesReceived++,"response"===e.type&&e.reqId){const t=this._pending.get(e.reqId);if(t)return this._pending.delete(e.reqId),void t.resolve(e.payload)}this._inbound.next(e)}async connect(){"connected"!==this._state&&(this._setState("connecting"),this._startTime=Date.now(),this._setState("connected"),this._flushBuffer())}disconnect(){"disconnected"!==this._state&&"closed"!==this._state&&(this._setState("disconnected"),this._subs.forEach(e=>e.unsubscribe()),this._subs=[])}close(){this.disconnect(),this._setState("closed"),this._inbound.complete(),this._outbound.complete(),this._stateChanges.complete()}markConnected(){this._setState("connected"),this._flushBuffer()}markDisconnected(){this._setState("disconnected")}_setState(e){this._state!==e&&(this._state=e,this._stateChanges.next(e))}_flushBuffer(){for(const e of this._buffer)this._outbound.next(e);this._buffer=[]}_setupSubscriptions(){this._subs.push(this._inbound.subscribe({next:e=>{"signal"===e.type&&"connect"===e.payload?.type&&this._connectedPeers.set(e.sender,{name:e.sender,state:"connected",isHost:!1})}}))}get id(){return this._id}get name(){return this._name}get state(){return this._state}get transportType(){return this._transportType}get stats(){return{...this._stats,uptime:this._startTime?Date.now()-this._startTime:0}}get stateChanges(){return this._stateChanges}get connectedPeers(){return[...this._connectedPeers.keys()]}get meta(){return{id:this._id,name:this._name,state:this._state,isHost:!1,connectedChannels:new Set(this._connectedPeers.keys())}}}class Ve{_connections=new Map;static _instance=null;static getInstance(){return Ve._instance||(Ve._instance=new Ve),Ve._instance}getOrCreate(e,t="internal",n={}){return this._connections.has(e)||this._connections.set(e,new Ke(e,t,n)),this._connections.get(e)}get(e){return this._connections.get(e)}has(e){return this._connections.has(e)}delete(e){return this._connections.get(e)?.close(),this._connections.delete(e)}clear(){this._connections.forEach(e=>e.close()),this._connections.clear()}get size(){return this._connections.size}get names(){return[...this._connections.keys()]}}const He=()=>Ve.getInstance(),Xe="messages",Je="mailbox",Ze="pending",Qe="exchange",et="transactions";class tt{_db=null;_isOpen=!1;_openPromise=null;_channelName;_messageUpdates=new oe;_exchangeUpdates=new oe;constructor(e){this._channelName=e}async open(){return this._db&&this._isOpen?this._db:(this._openPromise||(this._openPromise=new Promise((e,t)=>{const n=indexedDB.open("uniform_channels",1);n.onerror=()=>{this._openPromise=null,t(new Error("Failed to open IndexedDB"))},n.onsuccess=()=>{this._db=n.result,this._isOpen=!0,this._openPromise=null,e(this._db)},n.onupgradeneeded=e=>{const t=e.target.result;this._createStores(t)}})),this._openPromise)}close(){this._db&&(this._db.close(),this._db=null,this._isOpen=!1)}_createStores(e){if(!e.objectStoreNames.contains(Xe)){const t=e.createObjectStore(Xe,{keyPath:"id"});t.createIndex("channel","channel",{unique:!1}),t.createIndex("status","status",{unique:!1}),t.createIndex("recipient","recipient",{unique:!1}),t.createIndex("createdAt","createdAt",{unique:!1}),t.createIndex("channel_status",["channel","status"],{unique:!1})}if(!e.objectStoreNames.contains(Je)){const t=e.createObjectStore(Je,{keyPath:"id"});t.createIndex("channel","channel",{unique:!1}),t.createIndex("priority","priority",{unique:!1}),t.createIndex("expiresAt","expiresAt",{unique:!1})}if(!e.objectStoreNames.contains(Ze)){const t=e.createObjectStore(Ze,{keyPath:"id"});t.createIndex("channel","channel",{unique:!1}),t.createIndex("createdAt","createdAt",{unique:!1})}if(!e.objectStoreNames.contains(Qe)){const t=e.createObjectStore(Qe,{keyPath:"id"});t.createIndex("key","key",{unique:!0}),t.createIndex("owner","owner",{unique:!1})}if(!e.objectStoreNames.contains(et)){e.createObjectStore(et,{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})}}async defer(e,t={}){const n=await this.open(),s={id:d(),channel:e.channel,sender:e.sender??this._channelName,recipient:e.channel,type:e.type,payload:e.payload,status:"pending",priority:t.priority??0,createdAt:Date.now(),updatedAt:Date.now(),expiresAt:t.expiresIn?Date.now()+t.expiresIn:null,retryCount:0,maxRetries:t.maxRetries??3,metadata:t.metadata};return new Promise((e,t)=>{const r=n.transaction([Xe,Je],"readwrite"),o=r.objectStore(Xe),i=r.objectStore(Je);o.add(s),i.add(s),r.oncomplete=()=>{this._messageUpdates.next(s),e(s.id)},r.onerror=()=>t(new Error("Failed to defer message"))})}async getDeferredMessages(e,t={}){const n=await this.open();return new Promise((s,r)=>{const o=n.transaction(Xe,"readonly").objectStore(Xe),i=t.status?o.index("channel_status"):o.index("channel"),a=t.status?IDBKeyRange.only([e,t.status]):IDBKeyRange.only(e),c=i.getAll(a,t.limit);c.onsuccess=()=>{let e=c.result;t.offset&&(e=e.slice(t.offset)),s(e)},c.onerror=()=>r(new Error("Failed to get deferred messages"))})}async processNextPending(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Xe,"readwrite").objectStore(Xe).index("channel_status").openCursor(IDBKeyRange.only([e,"pending"]));r.onsuccess=()=>{const e=r.result;if(e){const t=e.value;t.status="processing",t.updatedAt=Date.now(),e.update(t),this._messageUpdates.next(t),n(t)}else n(null)},r.onerror=()=>s(new Error("Failed to process pending message"))})}async markDelivered(e){await this._updateMessageStatus(e,"delivered")}async markFailed(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Xe,"readwrite").objectStore(Xe),o=r.get(e);o.onsuccess=()=>{const e=o.result;e?(e.retryCount++,e.updatedAt=Date.now(),e.retryCount<e.maxRetries?e.status="pending":e.status="failed",r.put(e),this._messageUpdates.next(e),n("pending"===e.status)):n(!1)},o.onerror=()=>s(new Error("Failed to mark message as failed"))})}async _updateMessageStatus(e,t){const n=await this.open();return new Promise((s,r)=>{const o=n.transaction(Xe,"readwrite").objectStore(Xe),i=o.get(e);i.onsuccess=()=>{const e=i.result;e&&(e.status=t,e.updatedAt=Date.now(),o.put(e),this._messageUpdates.next(e)),s()},i.onerror=()=>r(new Error("Failed to update message status"))})}async getMailbox(e,t={}){const n=await this.open();return new Promise((s,r)=>{const o=n.transaction(Je,"readonly").objectStore(Je).index("channel").getAll(IDBKeyRange.only(e),t.limit);o.onsuccess=()=>{let e=o.result;"priority"===t.sortBy?e.sort((e,t)=>t.priority-e.priority):e.sort((e,t)=>t.createdAt-e.createdAt),s(e)},o.onerror=()=>r(new Error("Failed to get mailbox"))})}async getMailboxStats(e){const t=await this.getDeferredMessages(e),n={total:t.length,pending:0,processing:0,delivered:0,failed:0,expired:0},s=Date.now();for(const r of t)r.expiresAt&&r.expiresAt<s?n.expired++:n[r.status]++;return n}async clearMailbox(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Je,"readwrite"),o=r.objectStore(Je).index("channel");let i=0;const a=o.openCursor(IDBKeyRange.only(e));a.onsuccess=()=>{const e=a.result;e&&(e.delete(),i++,e.continue())},r.oncomplete=()=>n(i),r.onerror=()=>s(new Error("Failed to clear mailbox"))})}async registerPending(e){const t=await this.open(),n={id:d(),channel:this._channelName,type:e.type,data:e.data,metadata:e.metadata,createdAt:Date.now(),status:"pending"};return new Promise((e,s)=>{const r=t.transaction(Ze,"readwrite");r.objectStore(Ze).add(n),r.oncomplete=()=>e(n.id),r.onerror=()=>s(new Error("Failed to register pending operation"))})}async getPendingOperations(){const e=await this.open();return new Promise((t,n)=>{const s=e.transaction(Ze,"readonly").objectStore(Ze).index("channel").getAll(IDBKeyRange.only(this._channelName));s.onsuccess=()=>t(s.result),s.onerror=()=>n(new Error("Failed to get pending operations"))})}async completePending(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Ze,"readwrite");r.objectStore(Ze).delete(e),r.oncomplete=()=>n(),r.onerror=()=>s(new Error("Failed to complete pending operation"))})}async awaitPending(e,t={}){const n=t.timeout??3e4,s=t.pollInterval??100,r=Date.now();for(;Date.now()-r<n;){const t=await this._getPendingById(e);if(!t)return null;if("completed"===t.status)return await this.completePending(e),t.result;await new Promise(e=>setTimeout(e,s))}throw new Error(`Pending operation ${e} timed out`)}async _getPendingById(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Ze,"readonly").objectStore(Ze).get(e);r.onsuccess=()=>n(r.result??null),r.onerror=()=>s(new Error("Failed to get pending operation"))})}async exchangePut(e,t,n={}){const s=await this.open(),r={id:d(),key:e,value:t,owner:this._channelName,sharedWith:n.sharedWith??["*"],version:1,createdAt:Date.now(),updatedAt:Date.now()};return new Promise((t,n)=>{const o=s.transaction(Qe,"readwrite"),i=o.objectStore(Qe),a=i.index("key").get(e);a.onsuccess=()=>{const e=a.result;e&&(r.id=e.id,r.version=e.version+1,r.createdAt=e.createdAt),i.put(r)},o.oncomplete=()=>{this._exchangeUpdates.next(r),t(r.id)},o.onerror=()=>n(new Error("Failed to put exchange data"))})}async exchangeGet(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Qe,"readonly").objectStore(Qe).index("key").get(e);r.onsuccess=()=>{const e=r.result;e&&this._canAccessExchange(e)?n(e.value):n(null)},r.onerror=()=>s(new Error("Failed to get exchange data"))})}async exchangeDelete(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Qe,"readwrite"),o=r.objectStore(Qe),i=o.index("key").get(e);i.onsuccess=()=>{const e=i.result;e&&e.owner===this._channelName?o.delete(e.id):n(!1)},r.oncomplete=()=>n(!0),r.onerror=()=>s(new Error("Failed to delete exchange data"))})}async exchangeLock(e,t={}){const n=await this.open(),s=t.timeout??3e4;return new Promise((t,r)=>{const o=n.transaction(Qe,"readwrite"),i=o.objectStore(Qe),a=i.index("key").get(e);a.onsuccess=()=>{const e=a.result;e?e.lock&&e.lock.holder!==this._channelName&&e.lock.expiresAt>Date.now()?t(!1):(e.lock={holder:this._channelName,acquiredAt:Date.now(),expiresAt:Date.now()+s},e.updatedAt=Date.now(),i.put(e)):t(!1)},o.oncomplete=()=>t(!0),o.onerror=()=>r(new Error("Failed to acquire lock"))})}async exchangeUnlock(e){const t=await this.open();return new Promise((n,s)=>{const r=t.transaction(Qe,"readwrite"),o=r.objectStore(Qe),i=o.index("key").get(e);i.onsuccess=()=>{const e=i.result;e&&e.lock?.holder===this._channelName&&(delete e.lock,e.updatedAt=Date.now(),o.put(e))},r.oncomplete=()=>n(),r.onerror=()=>s(new Error("Failed to release lock"))})}_canAccessExchange(e){return e.owner===this._channelName||(!!e.sharedWith.includes("*")||e.sharedWith.includes(this._channelName))}async beginTransaction(){return new nt(this)}async executeTransaction(e){const t=await this.open(),n=new Set(e.map(e=>e.store));return new Promise((s,r)=>{const o=t.transaction(Array.from(n),"readwrite");for(const t of e){const e=o.objectStore(t.store);switch(t.type){case"put":void 0!==t.value&&e.put(t.value);break;case"delete":void 0!==t.key&&e.delete(t.key);break;case"update":if(void 0!==t.key){const n=e.get(t.key);n.onsuccess=()=>{n.result&&t.value&&e.put({...n.result,...t.value})}}}}o.oncomplete=()=>s(),o.onerror=()=>r(new Error("Transaction failed"))})}onMessageUpdate(e){return this._messageUpdates.subscribe({next:e})}onExchangeUpdate(e){return this._exchangeUpdates.subscribe({next:e})}async cleanupExpired(){const e=await this.open(),t=Date.now();return new Promise((n,s)=>{const r=e.transaction([Xe,Je],"readwrite"),o=r.objectStore(Xe),i=r.objectStore(Je);let a=0;const c=o.openCursor();c.onsuccess=()=>{const e=c.result;if(e){const n=e.value;n.expiresAt&&n.expiresAt<t&&(e.delete(),a++),e.continue()}};const l=i.openCursor();l.onsuccess=()=>{const e=l.result;if(e){const n=e.value;n.expiresAt&&n.expiresAt<t&&(e.delete(),a++),e.continue()}},r.oncomplete=()=>n(a),r.onerror=()=>s(new Error("Failed to cleanup expired"))})}}class nt{constructor(e){this._storage=e}_operations=[];_isCommitted=!1;_isRolledBack=!1;put(e,t){return this._checkState(),this._operations.push({id:d(),type:"put",store:e,value:t,timestamp:Date.now()}),this}delete(e,t){return this._checkState(),this._operations.push({id:d(),type:"delete",store:e,key:t,timestamp:Date.now()}),this}update(e,t,n){return this._checkState(),this._operations.push({id:d(),type:"update",store:e,key:t,value:n,timestamp:Date.now()}),this}async commit(){this._checkState(),0!==this._operations.length?(await this._storage.executeTransaction(this._operations),this._isCommitted=!0):this._isCommitted=!0}rollback(){this._operations=[],this._isRolledBack=!0}get operationCount(){return this._operations.length}_checkState(){if(this._isCommitted)throw new Error("Transaction already committed");if(this._isRolledBack)throw new Error("Transaction already rolled back")}}const st=new Map;const rt=new URL(""+new URL("../assets/Worker.ts",import.meta.url).href,import.meta.url);class ot{constructor(e,t,n={}){var s,r,o,i;this._channel=e,this._context=t,this._options=n,this._connection=(s=e,He().getOrCreate(s,r,o)),this._storage=(i=e,st.has(i)||st.set(i,new tt(i)),st.get(i))}_connection;_storage;async request(e,t,n,s={}){let r="string"==typeof e?[e]:e,o=t,i=n;Array.isArray(t)&&ct(e)&&(s=n,i=t,o=e,r=[]);const a=this._context.getHost();return a?.request(r,o,i,s,this._channel)}async doImportModule(t,n={}){return this.request([],e.IMPORT,[t],n)}async deferMessage(e,t={}){return this._storage.defer({channel:this._channel,sender:this._context.hostName,type:"request",payload:e},t)}async getPendingMessages(){return this._storage.getDeferredMessages(this._channel,{status:"pending"})}get connection(){return this._connection}get channelName(){return this._channel}get context(){return this._context}}class it{constructor(e,t,n={}){this._channel=e,this._context=t,this._options=n,this._connection=He().getOrCreate(e,"internal",n),this._unified=new _e({name:e,autoListen:!1,timeout:n?.timeout})}_connection;_unified;get _forResolves(){return this._unified.__getPrivate("_pending")}get _subscriptions(){return this._unified.__getPrivate("_subscriptions")}get _broadcasts(){return this._unified.__getPrivate("_transports")}createRemoteChannel(e,t={},n){const s=function(e){if(!e)return null;if(lt(e))return e;const t=e;return{target:t,postMessage:(e,n)=>{t.postMessage?.(e,n)},addEventListener:t.addEventListener?.bind(t),removeEventListener:t.removeEventListener?.bind(t),start:t.start?.bind(t),close:t.close?.bind(t)}}(n??this._context.$createOrUseExistingRemote(e,t,n??null)?.messageChannel?.port1),r=function(e){const t=lt(e)?e.target:e;return t?"chrome-runtime"===t?"chrome-runtime":"chrome-tabs"===t?"chrome-tabs":"chrome-port"===t?"chrome-port":"chrome-external"===t?"chrome-external":"undefined"!=typeof MessagePort&&t instanceof MessagePort?"message-port":"undefined"!=typeof BroadcastChannel&&t instanceof BroadcastChannel?"broadcast":"undefined"!=typeof Worker&&t instanceof Worker?"worker":"undefined"!=typeof WebSocket&&t instanceof WebSocket?"websocket":"undefined"!=typeof chrome&&"object"==typeof t&&t&&"function"==typeof t.postMessage&&t.onMessage?.addListener?"chrome-port":"undefined"!=typeof self&&t===self?"self":"internal":"internal"}(s?.target??s);if(this._unified.listen(s?.target,{targetChannel:e}),s){this._broadcasts?.set?.(e,s);!("self"===r&&"undefined"==typeof postMessage)&&this._unified.connect(s,{targetChannel:e}),this._context.$registerConnection({localChannel:this._channel,remoteChannel:e,sender:this._channel,direction:"outgoing",transportType:r}),this.notifyChannel(e,{contextId:this._context.id,contextName:this._context.hostName},"connect")}return new ot(e,this._context,t)}getChannel(){return this._channel}get connection(){return this._connection}request(e,t,n,s={},r="worker"){let o="string"==typeof e?[e]:e,i=n;return Array.isArray(t)&&ct(e)&&(r=s,s=n,i=t,t=e,o=[]),this._unified.invoke(r,t,o??[],Array.isArray(i)?i:[i])}resolveResponse(e,t){this._forResolves.get(e)?.resolve?.(t);const n=this._forResolves.get(e)?.promise;return this._forResolves.delete(e),n}async handleAndResponse(e,t,n){}notifyChannel(e,t={},n="notify"){return this._unified.notify(e,{...t,from:this._channel,to:e},n)}getConnectedChannels(){return this._unified.connectedChannels}close(){this._subscriptions.forEach(e=>e.unsubscribe()),this._forResolves.clear(),this._broadcasts?.values?.()?.forEach(e=>e.close?.()),this._broadcasts?.clear?.(),this._unified.close()}get unified(){return this._unified}}class at{constructor(e={}){this._options=e,this._hostName=e.name??`ctx-${this._id.slice(0,8)}`,!1!==e.useGlobalSelf&&(this._globalSelf="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:null)}_id=d();_hostName;_host=null;_endpoints=new Map;_unifiedByChannel=new Map;_unifiedConnectionSubs=new Map;_remoteChannels=new Map;_deferredChannels=new Map;_connectionEvents=new oe({bufferSize:200});_connectionRegistry=new ye(()=>d(),e=>this._emitConnectionEvent(e));_closed=!1;_globalSelf=null;initHost(e){if(this._host&&!e)return this._host;const t=e??this._hostName;if(this._hostName=t,this._endpoints.has(t))return this._host=this._endpoints.get(t).handler,this._host;this._host=new it(t,this,this._options.defaultOptions);const n={name:t,handler:this._host,connection:this._host.connection,subscriptions:[],ready:Promise.resolve(null),unified:this._host.unified};return this._endpoints.set(t,n),this._registerUnifiedChannel(t,this._host.unified),this._host}getHost(){return this._host??this.initHost()}get hostName(){return this._hostName}get id(){return this._id}get onConnection(){return this._connectionEvents}subscribeConnections(e){return this._connectionEvents.subscribe(e)}notifyConnections(e={},t={}){let n=0;for(const s of this._endpoints.values()){const r=s.handler.getConnectedChannels();for(const o of r){if(t.localChannel&&t.localChannel!==s.name)continue;if(t.remoteChannel&&t.remoteChannel!==o)continue;const r=this.queryConnections({localChannel:s.name,remoteChannel:o,status:"active"})[0];t.sender&&r?.sender!==t.sender||(t.transportType&&r?.transportType!==t.transportType||t.channel&&t.channel!==s.name&&t.channel!==o||s.handler.notifyChannel(o,e,"notify")&&n++)}}return n}queryConnections(e={}){return this._connectionRegistry.query(e).map(e=>({...e,contextId:this._id}))}createChannel(e,t={}){if(this._endpoints.has(e))return this._endpoints.get(e);const n=new it(e,this,{...this._options.defaultOptions,...t}),s={name:e,handler:n,connection:n.connection,subscriptions:[],ready:Promise.resolve(null),unified:n.unified};return this._endpoints.set(e,s),this._registerUnifiedChannel(e,n.unified),s}createChannels(e,t={}){const n=new Map;for(const s of e)n.set(s,this.createChannel(s,t));return n}getChannel(e){return this._endpoints.get(e)}getOrCreateChannel(e,t={}){return this._endpoints.get(e)??this.createChannel(e,t)}hasChannel(e){return this._endpoints.has(e)}getChannelNames(){return[...this._endpoints.keys()]}get size(){return this._endpoints.size}defer(e,t){this._deferredChannels.set(e,t)}async initDeferred(e){const t=this._deferredChannels.get(e);if(!t)return null;const n=await t();return this._endpoints.set(e,n),this._deferredChannels.delete(e),n}isDeferred(e){return this._deferredChannels.has(e)}async getChannelAsync(e){return this._endpoints.has(e)?this._endpoints.get(e):this._deferredChannels.has(e)?this.initDeferred(e):null}async addWorker(e,t,n={}){const s=ht(t);if(!s)throw new Error(`Failed to create worker for channel: ${e}`);const r=new it(e,this,{...this._options.defaultOptions,...n}),o=r.createRemoteChannel(e,n,s),i={name:e,handler:r,connection:r.connection,subscriptions:[],transportType:"worker",ready:Promise.resolve(o),unified:r.unified};return this._endpoints.set(e,i),this._registerUnifiedChannel(e,r.unified),this._remoteChannels.set(e,{channel:e,context:this,remote:Promise.resolve(o),transport:s,transportType:"worker"}),i}async addPort(e,t,n={}){const s=new it(e,this,{...this._options.defaultOptions,...n});t.start?.();const r=s.createRemoteChannel(e,n,t),o={name:e,handler:s,connection:s.connection,subscriptions:[],transportType:"message-port",ready:Promise.resolve(r),unified:s.unified};return this._endpoints.set(e,o),this._registerUnifiedChannel(e,s.unified),this._remoteChannels.set(e,{channel:e,context:this,remote:Promise.resolve(r),transport:t,transportType:"message-port"}),o}async addBroadcast(e,t,n={}){const s=new BroadcastChannel(t??e),r=new it(e,this,{...this._options.defaultOptions,...n}),o=r.createRemoteChannel(e,n,s),i={name:e,handler:r,connection:r.connection,subscriptions:[],transportType:"broadcast",ready:Promise.resolve(o),unified:r.unified};return this._endpoints.set(e,i),this._registerUnifiedChannel(e,r.unified),this._remoteChannels.set(e,{channel:e,context:this,remote:Promise.resolve(o),transport:s,transportType:"broadcast"}),i}addSelfChannel(e,t={}){const n=new it(e,this,{...this._options.defaultOptions,...t}),s=this._globalSelf??("undefined"!=typeof self?self:null),r={name:e,handler:n,connection:n.connection,subscriptions:[],transportType:"self",ready:Promise.resolve(s?n.createRemoteChannel(e,t,s):null),unified:n.unified};return this._endpoints.set(e,r),this._registerUnifiedChannel(e,n.unified),r}async addTransport(e,t){const n=t.options??{};switch(t.type){case"worker":if(!t.worker)throw new Error("Worker required for worker transport");return this.addWorker(e,t.worker,n);case"message-port":if(!t.port)throw new Error("Port required for message-port transport");return this.addPort(e,t.port,n);case"broadcast":const s="string"==typeof t.broadcast?t.broadcast:void 0;return this.addBroadcast(e,s,n);case"self":return this.addSelfChannel(e,n);default:return this.createChannel(e,n)}}createChannelPair(e,t,n={}){const s=new MessageChannel,r=new it(e,this,{...this._options.defaultOptions,...n}),o=new it(t,this,{...this._options.defaultOptions,...n});s.port1.start(),s.port2.start();const i=r.createRemoteChannel(t,n,s.port1),a=o.createRemoteChannel(e,n,s.port2),c={name:e,handler:r,connection:r.connection,subscriptions:[],transportType:"message-port",ready:i,unified:r.unified},l={name:t,handler:o,connection:o.connection,subscriptions:[],transportType:"message-port",ready:a,unified:o.unified};return this._endpoints.set(e,c),this._endpoints.set(t,l),this._registerUnifiedChannel(e,r.unified),this._registerUnifiedChannel(t,o.unified),{channel1:c,channel2:l,messageChannel:s}}get globalSelf(){return this._globalSelf}async connectRemote(e,t={},n){return this.initHost(),this._host.createRemoteChannel(e,t,n)}async importModuleInChannel(e,t,n={},s){const r=await this.connectRemote(e,n.channelOptions,s);return r?.doImportModule?.(t,n.importOptions)}$createOrUseExistingRemote(e,t={},n){if(null==e||n)return null;if(this._remoteChannels.has(e))return this._remoteChannels.get(e);const s=new MessageChannel,r=ne(new Promise(n=>{const r=ht(rt);r?.addEventListener?.("message",e=>{"channelCreated"===e.data.type&&(s.port1?.start?.(),n(new ot(e.data.channel,this,t)))}),r?.postMessage?.({type:"createChannel",channel:e,sender:this._hostName,options:t,messagePort:s.port2},{transfer:[s.port2]})})),o={channel:e,context:this,messageChannel:s,remote:r};return this._remoteChannels.set(e,o),o}$registerConnection(e){return{...this._connectionRegistry.register(e),contextId:this._id}}$markNotified(e){const t=this._connectionRegistry.register({localChannel:e.localChannel,remoteChannel:e.remoteChannel,sender:e.sender,direction:e.direction,transportType:e.transportType});this._connectionRegistry.markNotified(t,e.payload)}$observeSignal(e){e.payload;this.$markNotified({localChannel:e.localChannel,remoteChannel:e.remoteChannel,sender:e.sender,direction:"incoming",transportType:e.transportType,payload:e.payload})}$forwardUnifiedConnectionEvent(e,t){const n=t.connection.transportType??"internal",s=this._connectionRegistry.register({localChannel:t.connection.localChannel||e,remoteChannel:t.connection.remoteChannel,sender:t.connection.sender,direction:t.connection.direction,transportType:n,metadata:t.connection.metadata});"notified"===t.type?this._connectionRegistry.markNotified(s,t.payload):"disconnected"===t.type&&this._connectionRegistry.closeByChannel(t.connection.localChannel)}closeChannel(e){const t=this._endpoints.get(e);return!!t&&(t.subscriptions.forEach(e=>e.unsubscribe()),t.handler.close(),t.transport?.detach(),this._unifiedConnectionSubs.get(e)?.unsubscribe(),this._unifiedConnectionSubs.delete(e),this._unifiedByChannel.delete(e),this._endpoints.delete(e),e===this._hostName&&(this._host=null),this._connectionRegistry.closeByChannel(e),!0)}close(){if(!this._closed){this._closed=!0;for(const[e]of this._endpoints)this.closeChannel(e);this._remoteChannels.clear(),this._host=null,this._unifiedConnectionSubs.forEach(e=>e.unsubscribe()),this._unifiedConnectionSubs.clear(),this._unifiedByChannel.clear(),this._connectionRegistry.clear(),this._connectionEvents.complete()}}get closed(){return this._closed}_registerUnifiedChannel(e,t){this._unifiedByChannel.set(e,t),this._unifiedConnectionSubs.get(e)?.unsubscribe();const n=t.subscribeConnections(t=>{this.$forwardUnifiedConnectionEvent(e,t)});this._unifiedConnectionSubs.set(e,n)}_emitConnectionEvent(e){this._connectionEvents.next({...e,connection:{...e.connection,contextId:this._id}})}}function ct(t){return[...Object.values(e)].includes(t)}function lt(e){return!!e&&"object"==typeof e&&"target"in e&&"function"==typeof e.postMessage}function ht(e){if(e instanceof Worker)return e;if(e instanceof URL)return new Worker(e.href,{type:"module"});if("function"==typeof e)try{return new e({type:"module"})}catch{return e({type:"module"})}return"string"==typeof e?e.startsWith("/")?new Worker(new URL(e.replace(/^\//,"./"),import.meta.url).href,{type:"module"}):URL.canParse(e)||e.startsWith("./")?new Worker(new URL(e,import.meta.url).href,{type:"module"}):new Worker(URL.createObjectURL(new Blob([e],{type:"application/javascript"})),{type:"module"}):e instanceof Blob||e instanceof File?new Worker(URL.createObjectURL(e),{type:"module"}):e??("undefined"!=typeof self?self:null)}const ut=new Map;class dt{_context;_config;_subscriptions=[];_incomingConnections=new oe({bufferSize:100});_channelCreated=new oe({bufferSize:100});_channelClosed=new oe;constructor(e={}){this._config={name:e.name??"worker",workerName:e.workerName??`worker-${d().slice(0,8)}`,autoAcceptChannels:e.autoAcceptChannels??!0,allowedChannels:e.allowedChannels??[],maxChannels:e.maxChannels??100,autoConnect:e.autoConnect??!0,useGlobalSelf:!0,defaultOptions:e.defaultOptions??{},isolatedStorage:e.isolatedStorage??!1,...e},this._context=function(e={}){const t=new at(e);return e.name&&ut.set(e.name,t),t}({name:this._config.name,useGlobalSelf:!0,defaultOptions:e.defaultOptions}),this._setupMessageListener()}get onConnection(){return this._incomingConnections}get onChannelCreated(){return this._channelCreated}get onChannelClosed(){return this._channelClosed}subscribeConnections(e){return this._incomingConnections.subscribe(e)}subscribeChannelCreated(e){return this._channelCreated.subscribe(e)}acceptConnection(e){if(!this._canAcceptChannel(e.channel))return null;const t=this._context.createChannel(e.channel,e.options);return e.port&&(e.port.start?.(),t.handler.createRemoteChannel(e.sender,e.options,e.port)),this._channelCreated.next({channel:e.channel,endpoint:t,sender:e.sender,timestamp:Date.now()}),this._postChannelCreated(e.channel,e.sender,e.id),t}createChannel(e,t){return this._context.createChannel(e,t)}getChannel(e){return this._context.getChannel(e)}hasChannel(e){return this._context.hasChannel(e)}getChannelNames(){return this._context.getChannelNames()}queryConnections(e={}){return this._context.queryConnections(e)}notifyConnections(e={},t={}){return this._context.notifyConnections(e,t)}closeChannel(e){const t=this._context.closeChannel(e);return t&&this._channelClosed.next({channel:e,timestamp:Date.now()}),t}get context(){return this._context}get config(){return this._config}_setupMessageListener(){addEventListener("message",e=>{this._handleIncomingMessage(e)})}_handleIncomingMessage(e){const t=e.data;if(t&&"object"==typeof t)switch(t.type){case"createChannel":this._handleCreateChannel(t);break;case"connectChannel":this._handleConnectChannel(t);break;case"addPort":this._handleAddPort(t);break;case"listChannels":this._handleListChannels(t);break;case"closeChannel":this._handleCloseChannel(t);break;case"ping":postMessage({type:"pong",id:t.id,timestamp:Date.now()});break;default:if(t.channel&&this._context.hasChannel(t.channel)){const e=this._context.getChannel(t.channel);e?.handler?.handleAndResponse?.(t.payload,t.reqId)}}}_handleCreateChannel(e){const t={id:e.reqId??d(),channel:e.channel,sender:e.sender??"unknown",type:"channel",port:e.messagePort,timestamp:Date.now(),options:e.options};this._incomingConnections.next(t),this._config.autoAcceptChannels&&this.acceptConnection(t)}_handleConnectChannel(e){const t={id:e.reqId??d(),channel:e.channel,sender:e.sender??"unknown",type:e.portType??"channel",port:e.port,timestamp:Date.now(),options:e.options};if(this._incomingConnections.next(t),this._config.autoAcceptChannels&&this._canAcceptChannel(e.channel)){const t=this._context.getOrCreateChannel(e.channel,e.options);e.port&&(e.port.start?.(),t.handler.createRemoteChannel(e.sender,e.options,e.port)),postMessage({type:"channelConnected",channel:e.channel,reqId:e.reqId})}}_handleAddPort(e){if(!e.port||!e.channel)return;const t={id:e.reqId??d(),channel:e.channel,sender:e.sender??"unknown",type:"port",port:e.port,timestamp:Date.now(),options:e.options};this._incomingConnections.next(t),this._config.autoAcceptChannels&&this.acceptConnection(t)}_handleListChannels(e){postMessage({type:"channelList",channels:this.getChannelNames(),reqId:e.reqId})}_handleCloseChannel(e){e.channel&&(this.closeChannel(e.channel),postMessage({type:"channelClosed",channel:e.channel,reqId:e.reqId}))}_canAcceptChannel(e){return!(this._context.size>=this._config.maxChannels)&&(!(this._config.allowedChannels.length>0)||this._config.allowedChannels.includes(e))}_postChannelCreated(e,t,n){postMessage({type:"channelCreated",channel:e,sender:t,reqId:n,timestamp:Date.now()})}close(){this._subscriptions.forEach(e=>e.unsubscribe()),this._subscriptions=[],this._incomingConnections.complete(),this._channelCreated.complete(),this._channelClosed.complete(),this._context.close()}}let pt=null;var ft;ft={name:"worker"},pt||(pt=new dt(ft));const mt=()=>{try{const e=globalThis?.ServiceWorkerGlobalScope;return void 0!==e&&globalThis instanceof e}catch{return!1}},yt=()=>{if((()=>{try{return"undefined"!=typeof chrome&&!!chrome?.runtime?.id}catch{return!1}})())return"chrome-extension";if(mt())return"service-worker";try{if("undefined"!=typeof document)return"main"}catch{}return"unknown"},_t=()=>{if(mt())return!1;try{return"undefined"!=typeof Worker}catch{return!1}};export{b as $avoidTrigger,a as $getValue,h as $set,g as $triggerLock,ne as Promised,d as UUIDv4,F as bindCtx,G as callByAllProp,z as callByProp,p as camelToKebab,k as canBeInteger,u as clamp,X as contextify,Te as createOrUseExistingChannel,q as defaultByType,l as deref,yt as detectExecutionContext,O as getValue,v as handleListeners,i as hasValue,H as inProxy,V as isArrayInvalidKey,S as isArrayOrIterable,U as isKeyType,Y as isNotEqual,R as isObject,n as isObservable,s as isPrimitive,y as isVal,E as isValueRef,m as isValueUnit,f as kebabToCamel,I as makeTriggerLess,_ as normalizePrimitive,$ as objectAssign,A as potentiallyAsync,M as potentiallyAsyncMap,_t as supportsDedicatedWorkers,T as toRef,r as tryParseByHint,w as tryStringAsNumber,P as unref};
