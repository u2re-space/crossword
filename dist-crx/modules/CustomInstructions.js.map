{"version":3,"file":"CustomInstructions.js","sources":["../../src/com/service/misc/CustomInstructions.ts"],"sourcesContent":["/*\n * Custom Instructions Service\n * Manages user-defined instructions for AI recognition operations\n */\n\nimport { loadSettings, saveSettings } from \"@rs-com/config/Settings\";\nimport type { AppSettings } from \"@rs-com/config/SettingsTypes\";\nimport {\n    generateInstructionId,\n    buildInstructionPrompt,\n    DEFAULT_INSTRUCTION_TEMPLATES,\n    type CustomInstruction\n} from \"./InstructionUtils\";\n\nexport type { CustomInstruction };\nexport { buildInstructionPrompt, DEFAULT_INSTRUCTION_TEMPLATES };\n\nconst generateId = generateInstructionId;\n\nexport type InstructionRegistrySnapshot = {\n    instructions: CustomInstruction[];\n    activeId: string;\n    activeInstruction: CustomInstruction | null;\n};\n\nconst byOrderAndLabel = (a: CustomInstruction, b: CustomInstruction): number => {\n    const ao = Number.isFinite(a.order as number) ? (a.order as number) : Number.MAX_SAFE_INTEGER;\n    const bo = Number.isFinite(b.order as number) ? (b.order as number) : Number.MAX_SAFE_INTEGER;\n    if (ao !== bo) return ao - bo;\n    return (a.label || \"\").localeCompare(b.label || \"\");\n};\n\nconst normalizeInstructions = (items: CustomInstruction[] | undefined | null): CustomInstruction[] =>\n    [...(items || [])].sort(byOrderAndLabel);\n\nconst pickActiveInstruction = (instructions: CustomInstruction[], activeId?: string): CustomInstruction | null => {\n    if (!activeId) return null;\n    return instructions.find(i => i.id === activeId) || null;\n};\n\nexport const getInstructionRegistry = async (): Promise<InstructionRegistrySnapshot> => {\n    const settings = await loadSettings();\n    const instructions = normalizeInstructions(settings?.ai?.customInstructions);\n    const activeInstruction = pickActiveInstruction(instructions, settings?.ai?.activeInstructionId);\n\n    return {\n        instructions,\n        activeId: activeInstruction?.id || \"\",\n        activeInstruction\n    };\n};\n\nexport const getCustomInstructions = async (): Promise<CustomInstruction[]> => {\n    const snapshot = await getInstructionRegistry();\n    return snapshot.instructions;\n};\n\nexport const getActiveInstruction = async (): Promise<CustomInstruction | null> => {\n    try {\n        const snapshot = await getInstructionRegistry();\n        if (!snapshot.activeId) return null;\n        if (!snapshot.activeInstruction) {\n            console.warn(\"[CustomInstructions] activeInstructionId not found:\", snapshot.activeId);\n        }\n        return snapshot.activeInstruction;\n    } catch (e) {\n        console.error(\"[CustomInstructions] Error in getActiveInstruction:\", e);\n        return null;\n    }\n};\n\nexport const getActiveInstructionText = async (): Promise<string> => {\n    const instruction = await getActiveInstruction();\n    return instruction?.instruction || \"\";\n};\n\nexport const setActiveInstruction = async (id: string | null): Promise<void> => {\n    const settings = await loadSettings();\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            activeInstructionId: id || \"\"\n        }\n    };\n    await saveSettings(updated);\n};\n\nexport const addInstruction = async (label: string, instruction: string): Promise<CustomInstruction> => {\n    const settings = await loadSettings();\n    const instructions = settings?.ai?.customInstructions || [];\n\n    const newInstruction: CustomInstruction = {\n        id: generateId(),\n        label: label.trim() || \"Untitled\",\n        instruction: instruction.trim(),\n        enabled: true,\n        order: instructions.length\n    };\n\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            customInstructions: [...instructions, newInstruction]\n        }\n    };\n\n    await saveSettings(updated);\n    return newInstruction;\n};\n\n/**\n * Add multiple instructions at once (avoids race conditions from parallel saves)\n */\nexport const addInstructions = async (\n    items: { label: string; instruction: string; enabled?: boolean }[]\n): Promise<CustomInstruction[]> => {\n    if (!items.length) return [];\n\n    const settings = await loadSettings();\n    const instructions = settings?.ai?.customInstructions || [];\n\n    const newInstructions: CustomInstruction[] = items.map((item, index) => ({\n        id: generateId(),\n        label: item.label.trim() || \"Untitled\",\n        instruction: item.instruction.trim(),\n        enabled: item.enabled ?? true,\n        order: instructions.length + index\n    }));\n\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            customInstructions: [...instructions, ...newInstructions]\n        }\n    };\n\n    await saveSettings(updated);\n    return newInstructions;\n};\n\nexport const updateInstruction = async (id: string, updates: Partial<Omit<CustomInstruction, \"id\">>): Promise<boolean> => {\n    const settings = await loadSettings();\n    const instructions = settings?.ai?.customInstructions || [];\n    const index = instructions.findIndex(i => i.id === id);\n\n    if (index === -1) return false;\n\n    instructions[index] = { ...instructions[index], ...updates };\n\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            customInstructions: instructions\n        }\n    };\n\n    await saveSettings(updated);\n    return true;\n};\n\nexport const deleteInstruction = async (id: string): Promise<boolean> => {\n    const settings = await loadSettings();\n    const instructions = settings?.ai?.customInstructions || [];\n    const filtered = instructions.filter(i => i.id !== id);\n\n    if (filtered.length === instructions.length) return false;\n\n    // If deleting the active instruction, clear activeInstructionId\n    const newActiveId = settings.ai?.activeInstructionId === id ? \"\" : (settings.ai?.activeInstructionId || \"\");\n\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            customInstructions: filtered,\n            activeInstructionId: newActiveId\n        }\n    };\n\n    await saveSettings(updated);\n    return true;\n};\n\nexport const reorderInstructions = async (orderedIds: string[]): Promise<void> => {\n    const settings = await loadSettings();\n    const instructions = settings?.ai?.customInstructions || [];\n\n    const reordered = orderedIds\n        .map((id, index) => {\n            const instr = instructions.find(i => i.id === id);\n            return instr ? { ...instr, order: index } : null;\n        })\n        .filter((i): i is CustomInstruction => i !== null && i !== undefined);\n\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            customInstructions: reordered\n        }\n    };\n\n    await saveSettings(updated);\n};\n\nexport const addDefaultTemplates = async (): Promise<CustomInstruction[]> => {\n    const settings = await loadSettings();\n    const existing = settings?.ai?.customInstructions || [];\n\n    if (existing.length > 0) return existing;\n\n    const newInstructions: CustomInstruction[] = DEFAULT_INSTRUCTION_TEMPLATES.map((template, index) => ({\n        ...template,\n        id: generateId(),\n        order: index\n    }));\n\n    const updated: AppSettings = {\n        ...settings,\n        ai: {\n            ...settings.ai,\n            customInstructions: newInstructions\n        }\n    };\n\n    await saveSettings(updated);\n    return newInstructions;\n};\n"],"names":[],"mappings":"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"}