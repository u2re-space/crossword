{"version":3,"file":"runtime.js","sources":["../../src/crx/shared/runtime.ts"],"sourcesContent":["import type { CrxRuntimeModule, WorkerChannel } from \"fest/uniform\";\nimport { detectExecutionContext } from \"fest/uniform\";\n\n/**\n * Create a chrome extension runtime messaging channel\n * Uses chrome.runtime.sendMessage instead of Web Workers\n */\nexport const createChromeExtensionRuntimeChannel = (channelName: string): WorkerChannel => {\n    const context = detectExecutionContext();\n    if (context != 'chrome-extension') {\n        // Return a no-op channel when not in CRX context instead of throwing\n        console.warn('Chrome extension runtime channels requested but not in chrome extension context. Returning no-op channel.');\n        return {\n            async request(method: string, args: any[] = []) {\n                console.warn(`CRX messaging not available: ${method}`, args);\n                throw new Error('Chrome extension messaging is not available in this context');\n            },\n            close() {\n                // No-op\n            }\n        };\n    }\n\n    // Create a simple CRX channel that directly uses chrome.runtime.sendMessage\n    return {\n        async request(method: string, args: any[] = []) {\n            // Prepare the message for CRX runtime messaging\n            const message = {\n                id: `crx_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n                type: method,\n                source: context,\n                target: channelName,\n                data: args.length === 1 ? args[0] : args,\n                metadata: { timestamp: Date.now() }\n            };\n\n            // Send via chrome runtime messaging with callback handling\n            return new Promise((resolve, reject) => {\n                try {\n                    console.log('[Runtime Channel] Sending message:', message);\n                    chrome.runtime.sendMessage(message, (response) => {\n                        if (chrome.runtime.lastError) {\n                            console.error('[Runtime Channel] Chrome runtime error:', chrome.runtime.lastError);\n                            reject(new Error(chrome.runtime.lastError.message));\n                            return;\n                        }\n\n                        console.log('[Runtime Channel] Received response for', method, ':', response);\n                        resolve(response);\n                    });\n                } catch (error) {\n                    console.error('[Runtime Channel] Failed to send message:', error);\n                    reject(error);\n                }\n            });\n        },\n\n        close() {\n            // CRX runtime channels don't need explicit closing\n        }\n    };\n};\n\n/**\n * Chrome Extension Runtime Channel Module\n * Creates a module-like interface for CRX functionality that can be used inline\n */\nexport const createRuntimeChannelModule = async (channelName: string, options?: {\n    context?: 'content-script' | 'popup' | 'background';\n    timeout?: number;\n}): Promise<CrxRuntimeModule> => {\n    const context = detectExecutionContext();\n    if (context !== 'chrome-extension') {\n        throw new Error('Runtime channel modules can only be created in chrome extension context');\n    }\n\n    // Create the underlying messaging channel\n    const messagingChannel = createChromeExtensionRuntimeChannel(channelName);\n\n    console.log('messagingChannel', messagingChannel);\n\n    // Create a module-like interface\n    const module: CrxRuntimeModule = {\n        // Screen capture functionality (capture + AI processing)\n        async capture(rect?: { x: number; y: number; width: number; height: number }, mode?: string) {\n            const result = await messagingChannel?.request?.('capture', [{\n                rect,\n                mode: mode || 'recognize'\n            }]);\n            return result;\n        },\n\n        // Just capture screenshot, return image data\n        async captureScreenshot(rect?: { x: number; y: number; width: number; height: number }) {\n            const result = await messagingChannel?.request?.('captureScreenshot', [{\n                rect\n            }]);\n            return result;\n        },\n\n        // Process captured image data with AI\n        async processImage(imageData: string | Blob, mode?: string) {\n            const result = await messagingChannel?.request?.('processImage', [{\n                imageData,\n                mode: mode || 'recognize'\n            }]);\n            return result;\n        },\n\n        // Text processing functionality\n        async processText(text: string, options?: { type?: string }) {\n            const result = await messagingChannel?.request?.('processText', [{\n                content: text,\n                contentType: options?.type || 'text'\n            }]);\n            return result;\n        },\n\n        // Copy to clipboard functionality\n        async doCopy(data: { text?: string; data?: any }, options?: { showToast?: boolean }) {\n            const result = await messagingChannel?.request?.('doCopy', [{\n                data,\n                showToast: options?.showToast !== false\n            }]);\n\n            // Show toast if requested and available\n            if (options?.showToast !== false && result?.success && typeof chrome !== 'undefined' && chrome.notifications) {\n                chrome.notifications.create({\n                    type: 'basic',\n                    iconUrl: 'icons/icon.png',\n                    title: 'CrossWord',\n                    message: 'Copied to clipboard!'\n                });\n            }\n\n            return result;\n        },\n\n        // Load markdown functionality\n        async loadMarkdown(src: string) {\n            const result = await messagingChannel?.request?.('loadMarkdown', [src]);\n            return result;\n        },\n\n        // Custom screen capture with rectangle selection\n        async captureWithRect(mode?: string) {\n            // This would trigger rectangle selection in content script\n            // and then capture the selected area\n            const result = await messagingChannel?.request?.('captureWithRect', [{\n                mode: mode || 'default'\n            }]);\n            return result;\n        },\n\n        // Get current tab information\n        async getCurrentTab() {\n            if (typeof chrome !== 'undefined' && chrome.tabs) {\n                const tabs = await chrome.tabs.query({ active: true, currentWindow: true });\n                return tabs[0];\n            }\n            return null;\n        },\n\n        // Send custom message\n        async sendMessage(type: string, data?: any) {\n            const result = await messagingChannel?.request?.(type, data ? [data] : []);\n            return result;\n        },\n\n        // Close the module/channel\n        close() {\n            messagingChannel?.close?.();\n        }\n    };\n\n    return module;\n};"],"names":["options"],"mappings":"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"}