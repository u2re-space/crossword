{"version":3,"file":"CrxMessaging.js","sources":["../../../../modules/projects/uniform.ts/src/newer/index.ts","../../src/com/core/CrxMessaging.ts"],"sourcesContent":["/**\n * Uniform.ts - Unified Channel Communication Library\n *\n * Provides a unified API for cross-context communication:\n * - Workers, SharedWorkers, ServiceWorkers\n * - BroadcastChannel, MessagePort, WebSocket\n * - Chrome Extension messaging\n * - SharedArrayBuffer + Atomics\n * - WebRTC DataChannel\n */\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\nexport type {\n    WReflectDescriptor, WReq, WResp, WError, WSuccess,\n    Observer, Subscription, Subscribable, Subscriber, Producer,\n    ChannelMessage, ChannelState, ChannelMeta,\n    TransportType, TransportTarget, ConnectionOptions,\n    ResponderFn, InvokerHandler, MessageHandler, SendFn, PendingRequest,\n    AtomicsConfig, RTCConfig, SharedWorkerConfig, PortConfig,\n    TransferableConfig, TransportCapabilities\n} from \"./next/types/Interface\";\n\nexport { WStatus, WType, WReflectAction } from \"./next/types/Interface\";\n\n// ============================================================================\n// CORE (Transport & Request Handling)\n// ============================================================================\n\nexport {\n    createTransportSender,\n    createTransportListener,\n    createChromeListener,\n    createChromeTabsListener,\n    createWebSocketTransport,\n    createBroadcastTransport,\n    detectTransportType,\n    getTransportMeta,\n    TransportCoreFactory,\n    type TransportMeta\n} from \"./core/TransportCore\";\n\nexport { executeAction, buildResponse, handleRequest } from \"./core/RequestHandler\";\n\n// ============================================================================\n// OBSERVABLE (Core)\n// ============================================================================\n\nexport {\n    // Core classes\n    Observable,\n    ChannelSubject,\n    ReplayChannelSubject,\n    ChannelObservable,\n    MessageObservable,\n\n    // Invoker factories\n    makeWorkerInvoker,\n    makeMessagePortInvoker,\n    makeBroadcastInvoker,\n    makeWebSocketInvoker,\n    makeChromeRuntimeInvoker,\n    makeServiceWorkerClientInvoker,\n    makeServiceWorkerHostInvoker,\n    makeSelfInvoker,\n\n    // Handlers\n    createInvokerObservable,\n    createReflectHandler,\n    createBidirectionalChannel,\n\n    // Operators\n    filter, map, take, takeUntil, debounce, throttle,\n\n    // Utilities\n    fromEvent, fromPromise, delay, interval, merge, when, createMessageId,\n\n    // Factory\n    ObservableFactory,\n\n    // Types\n    type BidirectionalChannel\n} from \"./next/observable/Observable\";\n\n// ============================================================================\n// UNIFIED CHANNEL (Primary API)\n// ============================================================================\n\nexport {\n    UnifiedChannel,\n    createUnifiedChannel,\n    setupUnifiedChannel,\n    createUnifiedChannelPair,\n    getUnifiedChannel,\n    getUnifiedChannelNames,\n    closeUnifiedChannel,\n    getWorkerChannel,\n    exposeFromUnified,\n    remoteFromUnified,\n    type UnifiedChannelConfig,\n    type ConnectOptions,\n    type UnifiedConnectionDirection,\n    type UnifiedConnectionStatus,\n    type UnifiedConnectionInfo,\n    type UnifiedConnectionEvent,\n    type UnifiedQueryConnectionsOptions\n} from \"./next/channel/UnifiedChannel\";\n\n// ============================================================================\n// INVOKER (Requestor/Responder Pattern)\n// ============================================================================\n\nexport {\n    Requestor,\n    Responder,\n    BidirectionalInvoker,\n    DefaultReflect,\n    createRequestor,\n    createResponder,\n    createInvoker,\n    setupInvoker,\n    autoInvoker,\n    detectContextType,\n    detectTransportType as detectTransport,\n    detectIncomingContextType,\n    type InvokerConfig,\n    type ReflectLike,\n    type InvocationResponse,\n    type ContextType,\n    type IncomingInvocation\n} from \"./next/proxy/Invoker\";\n\n// ============================================================================\n// MULTI-CHANNEL CONTEXT\n// ============================================================================\n// vNext note:\n// - UnifiedChannel is the canonical runtime engine.\n// - ChannelContext remains as orchestration facade for multi-channel workflows\n//   and compatibility with legacy endpoint-style APIs.\n\nexport {\n    ChannelContext,\n    createChannelContext,\n    getOrCreateContext,\n    getContext,\n    deleteContext,\n    getContextNames,\n    createChannelsInContext,\n    importModuleInContext,\n    getDefaultContext,\n    addWorkerChannel,\n    addPortChannel,\n    addBroadcastChannel,\n    addSelfChannelToDefault,\n    deferChannel,\n    initDeferredChannel,\n    getChannelFromDefault,\n    createDefaultChannelPair,\n    type ChannelContextOptions,\n    type ChannelEndpoint,\n    type RemoteChannelInfo,\n    type ContextConnectionDirection,\n    type ContextConnectionStatus,\n    type ContextConnectionInfo,\n    type ConnectionEvent,\n    type QueryConnectionsOptions,\n    type DynamicTransportType,\n    type DynamicTransportConfig\n} from \"./next/channel/ChannelContext\";\n\n// ============================================================================\n// CONNECTION\n// ============================================================================\n\nexport {\n    ChannelConnection,\n    ConnectionPool,\n    getConnection,\n    getHostConnection,\n    getConnectionPool\n} from \"./next/channel/Connection\";\n\n// ============================================================================\n// TRANSPORT ADAPTERS\n// ============================================================================\n\nexport {\n    TransportAdapter,\n    WorkerTransport,\n    MessagePortTransport,\n    BroadcastChannelTransport,\n    WebSocketTransport,\n    ChromeRuntimeTransport,\n    ChromeTabsTransport,\n    ChromePortTransport,\n    ChromeExternalTransport,\n    ServiceWorkerTransport,\n    SelfTransport,\n    TransportFactory,\n    createConnectionObserver,\n    type TransportIncomingConnection,\n    type AcceptConnectionCallback\n} from \"./next/transport/Transport\";\n\nexport {\n    TransportObservable,\n    WorkerObservable,\n    MessagePortObservable,\n    BroadcastChannelObservable,\n    WebSocketObservable,\n    ChromeRuntimeObservable as TransportChromeRuntimeObservable,\n    ChromeTabsObservable as TransportChromeTabsObservable,\n    ChromePortObservable as TransportChromePortObservable,\n    ServiceWorkerClientObservable,\n    ServiceWorkerHostObservable,\n    SelfObservable,\n    TransportObservableFactory,\n    createBidirectionalChannel as createBidirectionalTransport\n} from \"./next/transport/TransportObservable\";\n\n// ============================================================================\n// WORKER CONTEXT\n// ============================================================================\n\nexport {\n    WorkerContext,\n    getWorkerContext,\n    initWorkerContext,\n    onWorkerConnection,\n    onWorkerChannelCreated,\n    workerContext,\n    getWorkerResponder,\n    getWorkerInvoker,\n    exposeFromWorker,\n    onWorkerInvocation,\n    createHostProxy,\n    importInHost,\n    type IncomingConnection,\n    type ChannelCreatedEvent,\n    type WorkerContextConfig\n} from \"./next/transport/Worker\";\n\n// ============================================================================\n// CHROME EXTENSION\n// ============================================================================\n\nexport {\n    ChromeRuntimeObservable,\n    ChromeTabsObservable,\n    ChromePortObservable,\n    ChromeExternalObservable,\n    ChromeObservableFactory,\n    createChromeRequestHandler,\n    type ChromeMessage,\n    type PortInfo,\n    type ChromeObservableOptions\n} from \"./next/observable/ChromeObservable\";\n\n// ============================================================================\n// SOCKET.IO\n// ============================================================================\n\nexport {\n    SocketIOObservable,\n    SocketIORoomObservable,\n    SocketIOObservableFactory,\n    createSocketRequestHandler,\n    createSocketObservable,\n    type SocketIOLike,\n    type SocketMessage,\n    type SocketObservableOptions\n} from \"./next/observable/SocketIOObservable\";\n\n// ============================================================================\n// ADVANCED TRANSPORTS\n// ============================================================================\n\n// SharedWorker\nexport {\n    SharedWorkerClient,\n    SharedWorkerHost,\n    createSharedWorkerObservable,\n    createSharedWorkerHostObservable,\n    SharedWorkerObservableFactory,\n    type SharedWorkerMessage,\n    type SharedWorkerOptions,\n    type SharedWorkerPortInfo\n} from \"./next/transport/SharedWorkerTransport\";\n\n// Atomics (SharedArrayBuffer)\nexport {\n    AtomicsTransport,\n    AtomicsBuffer,\n    AtomicsRingBuffer,\n    createAtomicsChannelPair,\n    createWorkerAtomicsTransport,\n    AtomicsTransportFactory,\n    type AtomicsMessage,\n    type AtomicsTransportConfig,\n    type AtomicsChannelPair,\n    type RingBufferConfig\n} from \"./next/transport/AtomicsTransport\";\n\n// WebRTC DataChannel\nexport {\n    RTCPeerTransport,\n    RTCPeerManager,\n    createBroadcastSignaling,\n    RTCTransportFactory,\n    type RTCMessage,\n    type RTCTransportConfig,\n    type RTCSignaling,\n    type RTCSignalMessage,\n    type RTCPeerInfo\n} from \"./next/transport/RTCDataChannelTransport\";\n\n// MessagePort Enhanced\nexport {\n    PortTransport,\n    PortPool,\n    WindowPortConnector,\n    createChannelPair,\n    createFromPort,\n    createPortProxy,\n    exposeOverPort,\n    PortTransportFactory,\n    type PortMessage,\n    type PortTransportConfig,\n    type PortPair,\n    type WindowPortConnectorConfig,\n    type ProxyMethods\n} from \"./next/transport/PortTransport\";\n\n// Unified Transport Factory\nexport {\n    createTransport,\n    getTransportRegistry,\n    AbstractTransport,\n    UnifiedTransportFactory,\n    type UnifiedTransportConfig,\n    type TransportInstance,\n    type TransportFactoryOptions\n} from \"./next/transport/UnifiedTransport\";\n\n// ============================================================================\n// STORAGE\n// ============================================================================\n\nexport * from \"./next/storage/Storage\";\nexport * from \"./next/storage/TransferableStorage\";\nexport * from \"./next/storage/Queued\";\nexport * from \"./next/storage/DataBase\";\nexport * from \"./next/transport/ServiceWorkerHost\";\n\n// ============================================================================\n// MESSAGING (Cross-context communication)\n// ============================================================================\n\nexport * from \"./messaging\";\n\n// ============================================================================\n// UTILITIES\n// ============================================================================\n\nexport * from \"./next/utils/Env\";\nexport * from \"./next/utils/Utils\";\nexport * from \"./next/utils/Wrappers\";\n\n// ============================================================================\n// PROXY (Unified Proxy Creation)\n// ============================================================================\n\nexport {\n    // Types\n    type ProxyInvoker,\n    type ProxyDescriptor,\n    type ProxyConfig,\n    type ProxyMethods as ProxyMethodsType,\n    type RemoteProxy,\n    type ExposeHandler,\n    type ProxySender,\n\n    // Symbols\n    PROXY_MARKER,\n    PROXY_INTERNALS,\n\n    // Classes\n    RemoteProxyHandler,\n    DispatchProxyHandler as DispatchHandler,\n    ProxyBuilder,\n\n    // Factory functions\n    createRemoteProxy,\n    wrapDescriptor,\n    isRemoteProxy,\n    getProxyDescriptor,\n    getProxyInternals,\n    createExposeHandler,\n    createSenderProxy,\n    proxyBuilder\n} from \"./next/proxy/Proxy\";\n\n// ============================================================================\n// LEGACY (Backward Compatibility)\n// ============================================================================\n\nexport {\n    ChannelHandler,\n    RemoteChannelHelper,\n    SELF_CHANNEL,\n    CHANNEL_MAP,\n    RemoteChannels,\n    initChannelHandler,\n    loadWorker,\n    $createOrUseExistingChannel,\n    createHostChannel,\n    createOrUseExistingChannel\n} from \"./next/channel/Channels\";\n\nexport {\n    makeRequestProxy,\n    makeObservableRequestProxy,\n    wrapChannel,\n    wrapObservableChannel,\n    createObservableChannel,\n    DispatchProxyHandler\n} from \"./next/proxy/RequestProxy\";\n\nexport {\n    makeChannelMessageHandler,\n    ObservableRequestDispatcher,\n    ChannelMessageObservable,\n    createChannelRequestHandler\n} from \"./next/channel/ChannelMessageHandler\";\n\n// Aliases for legacy support\nexport { ChannelHandler as ObservableChannelHandler } from \"./next/channel/Channels\";\nexport { Observable as ChannelNativeObservable } from \"./next/observable/Observable\";\n\n// ============================================================================\n// HIGH-LEVEL API\n// ============================================================================\n\nimport { createOrUseExistingChannel, createHostChannel, SELF_CHANNEL } from \"./next/channel/Channels\";\nimport { wrapChannel } from \"./next/proxy/RequestProxy\";\nimport { createChannelContext, getOrCreateContext, createChannelsInContext, importModuleInContext } from \"./next/channel/ChannelContext\";\nimport { detectExecutionContext } from \"./next/utils/Env\";\nimport type { WorkerChannel } from \"./next/storage/Queued\";\n\nexport interface BroadcastLike {\n    addEventListener: (type: \"message\" | \"error\", listener: (...args: any[]) => any) => void;\n    removeEventListener?: (type: \"message\" | \"error\", listener: (...args: any[]) => any) => void;\n    postMessage: (message: any, transfer?: any) => void;\n    close?: () => void;\n    start?: () => void;\n}\n\n/** Sync with a remote channel */\nexport const sync = async (channel: string, options: any = {}, broadcast: BroadcastLike | Worker | BroadcastChannel | MessagePort | null = null) =>\n    createOrUseExistingChannel(channel, options, (broadcast ?? (typeof self !== \"undefined\" ? (self as any) : null)) as any);\n\n/** Import a module in a remote channel */\nexport const importModuleInChannel = async (\n    channel: string, url: string, options: any = {},\n    broadcast: BroadcastLike | Worker | BroadcastChannel | MessagePort | null = (typeof self !== \"undefined\" ? (self as any) : null)\n) => {\n    const remote = await createOrUseExistingChannel(channel, options?.channelOptions, broadcast as any);\n    return remote?.doImportModule?.(url, options?.importOptions);\n};\n\n/** Create a new isolated channel context */\nexport const createContext = createChannelContext;\n\n/** Get or create a shared context by name */\nexport const getSharedContext = getOrCreateContext;\n\n/** Create multiple channels in a new context */\nexport const createMultiChannel = createChannelsInContext;\n\n/** Import a module with its own isolated context */\nexport const importIsolatedModule = importModuleInContext;\n\n/** Connect to a channel as a module */\nexport const connectToChannelAsModule = async (\n    channel: string, options: any = {},\n    broadcast: BroadcastLike | Worker | BroadcastChannel | MessagePort | null = (typeof self !== \"undefined\" ? (self as any) : null),\n    hostChannel: string | null = \"$host$\"\n) => {\n    const host = createHostChannel(hostChannel ?? \"$host$\");\n    await host?.createRemoteChannel(channel, options, broadcast as any);\n    return wrapChannel(channel, host ?? SELF_CHANNEL?.instance);\n};\n\n/** Create Chrome extension runtime channel */\nexport const createChromeExtensionRuntimeChannel = (channelName: string, options: any = {}): WorkerChannel => {\n    const context = detectExecutionContext();\n    if (context !== \"chrome-extension\") {\n        return { async request(method: string) { throw new Error(`Chrome extension messaging not available in ${context}`); }, close() {} };\n    }\n    return {\n        async request(method: string, args: any[] = []) {\n            return new Promise((resolve, reject) => {\n                try {\n                    chrome.runtime.sendMessage({\n                        id: `crx_${Date.now()}_${Math.random().toString(36).slice(2)}`,\n                        type: method, source: context, target: channelName,\n                        data: args?.length === 1 ? args[0] : args,\n                        metadata: { timestamp: Date.now(), ...(options?.metadata ?? {}) }\n                    }, (response) => {\n                        if (chrome.runtime.lastError) reject(new Error(chrome.runtime.lastError.message));\n                        else resolve(response);\n                    });\n                } catch (error) { reject(error); }\n            });\n        },\n        close() {}\n    };\n};\n","/**\n * Chrome Extension Messaging Adapter\n * Integrates fest/uniform with Chrome extension messaging APIs\n * Provides unified messaging across content scripts, popup, background, and service worker\n */\n\nimport {\n    createWorkerChannel,\n    createQueuedOptimizedWorkerChannel,\n    OptimizedWorkerChannel,\n    detectExecutionContext,\n    supportsDedicatedWorkers,\n    QueuedWorkerChannel,\n    createChromeExtensionRuntimeChannel,\n    createChromeExtensionBroadcast\n} from 'fest/uniform';\n\nimport { createDeferred } from 'fest/core';\n\n// ============================================================================\n// CHROME EXTENSION MESSAGING INTERFACES\n// ============================================================================\n\nexport interface CrxMessage {\n    id: string;\n    type: string;\n    source: 'content-script' | 'popup' | 'background' | 'service-worker' | 'offscreen';\n    target?: 'content-script' | 'popup' | 'background' | 'service-worker' | 'offscreen';\n    tabId?: number;\n    frameId?: number;\n    data: any;\n    metadata?: {\n        timestamp?: number;\n        correlationId?: string;\n        priority?: 'low' | 'normal' | 'high';\n        [key: string]: any;\n    };\n}\n\n// ============================================================================\n// CHROME EXTENSION CONTEXT DETECTION\n// ============================================================================\n\nexport const getCrxContext = (): CrxMessage['source'] => {\n    // Detect execution context in Chrome extension\n    if (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) {\n        if (typeof document !== 'undefined' && document.contentType) {\n            return 'content-script';\n        }\n        if (typeof chrome.runtime.getBackgroundPage !== 'undefined') {\n            return 'background';\n        }\n        if (typeof chrome.offscreen !== 'undefined') {\n            return 'offscreen';\n        }\n        // Check for service worker\n        if (typeof ServiceWorkerGlobalScope !== 'undefined' &&\n            self instanceof ServiceWorkerGlobalScope) {\n            return 'service-worker';\n        }\n        // Default to popup/offscreen\n        return 'popup';\n    }\n    return 'content-script'; // fallback\n};\n\nexport const isCrxEnvironment = (): boolean => {\n    return typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id;\n};\n\n// ============================================================================\n// CHROME RUNTIME MESSAGING ADAPTER\n// ============================================================================\n\nexport class CrxRuntimeChannel implements OptimizedWorkerChannel {\n    public festUniformChannel?: ReturnType<typeof createChromeExtensionRuntimeChannel>;\n    public broadcastChannel?: BroadcastChannel;\n    public listeners = new Map<string, (message: any) => void>();\n    public pendingRequests = new Map<string, { resolve: (value: any) => void; reject: (error: any) => void; timeout: NodeJS.Timeout }>();\n    public context: CrxMessage['source'];\n    public isCrxEnv: boolean;\n\n    constructor(private target?: CrxMessage['target']) {\n        this.context = getCrxContext();\n        this.isCrxEnv = isCrxEnvironment();\n\n        if (this.isCrxEnv) {\n            // Create broadcast-like channel for chrome extension messaging\n            this.broadcastChannel = createChromeExtensionBroadcast(target || 'background');\n        }\n\n        // Always try to create the channel - it will return a no-op channel if not in CRX\n        this.festUniformChannel = createChromeExtensionRuntimeChannel(target || 'background');\n\n        // Set up message forwarding from fest/uniform to our listeners\n        this.setupMessageForwarding();\n    }\n\n    private setupMessageForwarding(): void {\n        if (this.isCrxEnv && this.broadcastChannel) {\n            // Use broadcast channel for CRX messaging\n            this.broadcastChannel.addEventListener('message', (event) => {\n                const message = event.data;\n                const sender = event.source || {};\n                const sendResponse = (response: any) => {\n                    // Send response back via broadcast channel\n                    this.broadcastChannel?.postMessage({\n                        id: message.id,\n                        type: 'response',\n                        result: response,\n                        source: this.context\n                    });\n                };\n\n                this.handleIncomingMessage(message, sender, sendResponse);\n                return true; // Indicate async response\n            });\n        } else if (!this.isCrxEnv && chrome.runtime && chrome.runtime.onMessage) {\n            // Fallback for non-CRX environments\n            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {\n                this.handleIncomingMessage(message, sender, sendResponse);\n                // Return true to indicate async response will be sent\n                return true;\n            });\n        }\n    }\n\n    private handleIncomingMessage(message: any, sender: chrome.runtime.MessageSender, sendResponse: (response: any) => void): void {\n\n        // Only handle messages if in CRX environment\n        if (!this.isCrxEnv) {\n            console.log('[CrxRuntimeChannel] Not in CRX environment, rejecting message');\n            sendResponse({\n                success: false,\n                error: 'Not in Chrome extension environment',\n                source: this.context\n            });\n            return;\n        }\n\n        try {\n            // Handle unified message format\n            if (message && typeof message === 'object' && message.id && message.type) {\n                const unifiedMessage: CrxMessage = message;\n\n                // Note: Response messages are handled via sendMessage callback, not here\n\n                // Check if this message is for us\n                if (!unifiedMessage.target || unifiedMessage.target === this.context) {\n                    // Handle request-response pattern\n                    if (unifiedMessage.type.startsWith('request:')) {\n                        const actualType = unifiedMessage.type.replace('request:', '');\n                        const listener = this.listeners.get(actualType);\n\n                        if (listener) {\n                            // Handle async listener with guaranteed sendResponse\n                            listener(unifiedMessage.data)\n                                ?.then(result => {\n                                    sendResponse({\n                                        id: unifiedMessage.id,\n                                        type: `response:${actualType}`,\n                                        success: true,\n                                        result,\n                                        source: this.context\n                                    });\n                                })\n                                ?.catch(error => {\n                                    sendResponse({\n                                        id: unifiedMessage.id,\n                                        type: `response:${actualType}`,\n                                        success: false,\n                                        error: error instanceof Error ? error.message : String(error),\n                                        source: this.context\n                                    });\n                                });\n                        } else {\n                            sendResponse({\n                                id: unifiedMessage.id,\n                                type: `response:${unifiedMessage.type}`,\n                                success: false,\n                                error: `No handler for type: ${actualType}`,\n                                source: this.context\n                            });\n                        }\n                    }\n                } else {\n                    // Message not for us, but we still need to respond to avoid the async error\n                    sendResponse({\n                        id: unifiedMessage.id,\n                        type: 'response:not-targeted',\n                        success: false,\n                        error: 'Message not targeted at this context',\n                        source: this.context\n                    });\n                }\n            } else {\n                // Not a unified message format\n                sendResponse({\n                    success: false,\n                    error: 'Invalid message format',\n                    source: this.context\n                });\n            }\n        } catch (error) {\n            console.error('[CrxRuntimeChannel] Error handling message:', error);\n            sendResponse({\n                success: false,\n                error: error instanceof Error ? error.message : String(error),\n                source: this.context\n            });\n        }\n    }\n\n    async request(method: string, args: any[] = [], options?: { timeout?: number }): Promise<any> {\n\n        if (!this.isCrxEnv) {\n            throw new Error('CrxRuntimeChannel: Chrome extension messaging is only available in Chrome extension context. Current context: ' + this.context);\n        }\n\n        const timeout = options?.timeout || 30000;\n        const messageId = `crx_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n\n        return new Promise((resolve, reject) => {\n            const timeoutHandle = setTimeout(() => {\n                this.pendingRequests.delete(messageId);\n                reject(new Error(`Request timeout: ${method}`));\n            }, timeout);\n\n            this.pendingRequests.set(messageId, { resolve, reject, timeout: timeoutHandle });\n\n            const message: CrxMessage = {\n                id: messageId,\n                type: `request:${method}`,\n                source: this.context,\n                target: this.target,\n                data: args.length === 1 ? args[0] : args,\n                metadata: { timestamp: Date.now() }\n            };\n\n            // Use callback version of sendMessage to properly handle responses\n            chrome.runtime.sendMessage(message, (response) => {\n\n                if (chrome.runtime.lastError) {\n                    clearTimeout(timeoutHandle);\n                    this.pendingRequests.delete(messageId);\n                    reject(new Error(chrome.runtime.lastError.message));\n                    return;\n                }\n\n                // Handle the direct response from sendMessage callback\n                if (response && response.id === messageId) {\n                    clearTimeout(timeoutHandle);\n                    this.pendingRequests.delete(messageId);\n                    if (response.success) {\n                        resolve(response.result);\n                    } else {\n                        reject(new Error(response.error || 'Request failed'));\n                    }\n                } else {\n                    console.warn('[CrxRuntimeChannel] Unexpected response format:', response);\n                }\n            });\n        });\n    }\n\n    registerHandler(type: string, handler: (message: any) => Promise<any> | any): void {\n        this.listeners.set(type, handler);\n    }\n\n    unregisterHandler(type: string): void {\n        this.listeners.delete(type);\n    }\n\n    close(): void {\n        this.listeners.clear();\n        this.festUniformChannel?.close();\n\n        // Clear all pending requests\n        for (const [id, pending] of this.pendingRequests) {\n            clearTimeout(pending.timeout);\n            pending.reject(new Error('Channel closed'));\n        }\n        this.pendingRequests.clear();\n    }\n\n    getQueueStatus(): any {\n        return {\n            registeredHandlers: this.listeners.size,\n            pendingRequests: this.pendingRequests.size,\n            festUniformStatus: this.festUniformChannel ? 'active' : 'inactive'\n        };\n    }\n}\n\n// ============================================================================\n// CRX UNIFIED MESSAGING MANAGER\n// ============================================================================\n\nexport class CrxUnifiedMessaging {\n    private static instance: CrxUnifiedMessaging;\n    private runtimeChannel?: CrxRuntimeChannel;\n    private workerChannels = new Map<string, QueuedWorkerChannel>();\n    private context: CrxMessage['source'];\n    private isCrxEnv: boolean;\n\n    constructor() {\n        this.context = getCrxContext();\n        this.isCrxEnv = isCrxEnvironment();\n\n        // Always create runtime channel - it will be a no-op channel if not in CRX\n        this.runtimeChannel = new CrxRuntimeChannel();\n    }\n\n    static getInstance(): CrxUnifiedMessaging {\n        if (!CrxUnifiedMessaging.instance) {\n            CrxUnifiedMessaging.instance = new CrxUnifiedMessaging();\n        }\n        return CrxUnifiedMessaging.instance;\n    }\n\n    /**\n     * Send message via Chrome runtime\n     */\n    async sendRuntimeMessage(message: Omit<CrxMessage, 'id' | 'source'>): Promise<any> {\n        const fullMessage: CrxMessage = {\n            id: `crx_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n            source: this.context,\n            ...message\n        };\n\n        return this.runtimeChannel?.request?.( 'sendMessage', [fullMessage]);\n    }\n\n    /**\n     * Register handler for runtime messages\n     */\n    registerRuntimeHandler(type: string, handler: (data: any) => Promise<any> | any): void {\n        this.runtimeChannel?.registerHandler(type, handler);\n    }\n\n    /**\n     * Create worker channel for background processing\n     */\n    createWorkerChannel(name: string, workerScript: string): QueuedWorkerChannel {\n        if (this.workerChannels.has(name)) {\n            return this.workerChannels.get(name)! as QueuedWorkerChannel;\n        }\n\n        const channel: QueuedWorkerChannel = createQueuedOptimizedWorkerChannel({\n            name,\n            script: workerScript,\n            context: 'chrome-extension'\n        }, {\n            timeout: 30000,\n            retries: 2,\n            batching: true,\n            compression: false\n        });\n\n        this.workerChannels.set(name, channel as QueuedWorkerChannel);\n        return channel as QueuedWorkerChannel;\n    }\n\n    /**\n     * Get worker channel\n     */\n    getWorkerChannel(name: string): QueuedWorkerChannel | null {\n        return this.workerChannels.get(name) || null;\n    }\n\n    /**\n     * Send message to specific tab\n     */\n    async sendToTab(tabId: number, message: Omit<CrxMessage, 'id' | 'source'>): Promise<any> {\n        if (!this.isCrxEnv) {\n            console.warn('CrxUnifiedMessaging: Tab messaging not available - not in Chrome extension context');\n            return Promise.reject(new Error('Tab messaging is not available in this context'));\n        }\n\n        return new Promise((resolve, reject) => {\n            chrome.tabs.sendMessage(tabId, {\n                ...message,\n                id: `crx_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n                source: this.context,\n                tabId\n            }, (response) => {\n                if (chrome.runtime.lastError) {\n                    reject(new Error(chrome.runtime.lastError.message));\n                } else {\n                    resolve(response);\n                }\n            });\n        });\n    }\n\n    /**\n     * Broadcast message to all tabs\n     */\n    async broadcastToTabs(message: Omit<CrxMessage, 'id' | 'source'>): Promise<any[]> {\n        if (!this.isCrxEnv) {\n            console.warn('CrxUnifiedMessaging: Tab broadcasting not available - not in Chrome extension context');\n            return Promise.resolve([]);\n        }\n\n        return new Promise((resolve) => {\n            chrome.tabs.query({}, (tabs) => {\n                const promises = tabs.map(tab => {\n                    if (tab.id) {\n                        return this.sendToTab(tab.id, message).catch(() => null); // Ignore errors\n                    }\n                    return Promise.resolve(null);\n                });\n\n                Promise.all(promises).then(resolve);\n            });\n        });\n    }\n\n    /**\n     * Get current context\n     */\n    getContext(): CrxMessage['source'] {\n        return this.context;\n    }\n\n    /**\n     * Check if running in CRX environment\n     */\n    isCrxEnvironment(): boolean {\n        return this.isCrxEnv;\n    }\n}\n\n// ============================================================================\n// CONVENIENCE FUNCTIONS\n// ============================================================================\n\n// Singleton instance\nexport const crxMessaging = CrxUnifiedMessaging.getInstance();\n\n// Convenience functions\nexport function sendCrxMessage(message: Omit<CrxMessage, 'id' | 'source'>): Promise<any> {\n    return crxMessaging.sendRuntimeMessage(message);\n}\n\nexport function registerCrxHandler(type: string, handler: (data: any) => Promise<any> | any): void {\n    crxMessaging.registerRuntimeHandler(type, handler);\n}\n\nexport function createCrxWorkerChannel(name: string, workerScript: string): QueuedWorkerChannel {\n    return crxMessaging.createWorkerChannel(name, workerScript);\n}\n\nexport function sendToCrxTab(tabId: number, message: Omit<CrxMessage, 'id' | 'source'>): Promise<any> {\n    return crxMessaging.sendToTab(tabId, message);\n}\n\nexport function broadcastToCrxTabs(message: Omit<CrxMessage, 'id' | 'source'>): Promise<any[]> {\n    return crxMessaging.broadcastToTabs(message);\n}"],"names":[],"mappings":"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"}