{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["../../src/frontend/views/viewer/index.ts"],"sourcesContent":["/**\n * Markdown Viewer View\n *\n * Shell-agnostic markdown viewer component.\n * Can be used in any shell to display markdown content.\n * Uses the <md-view> web component for encapsulated rendering.\n */\n\nimport { H } from \"fest/lure\";\nimport { ref, affected } from \"fest/object\";\nimport { loadAsAdopted, removeAdopted } from \"fest/dom\";\nimport DOMPurify from \"isomorphic-dompurify\";\nimport renderMathInElement from \"katex/dist/contrib/auto-render.mjs\";\nimport type { View, ViewOptions, ViewLifecycle, ShellContext } from \"../../shells/types\";\nimport type { BaseViewOptions } from \"../types\";\nimport { createViewState } from \"../types\";\n\n// Import the md-view web component from fl.ui\nimport \"fest/fl-ui/services/markdown-view/Markdown\";\n\n// @ts-ignore - SCSS import\nimport style from \"./index.scss?inline\";\n\nlet markedParserPromise: Promise<(markdown: string) => Promise<string>> | null = null;\n\nconst getMarkedParser = async (): Promise<(markdown: string) => Promise<string>> => {\n    if (markedParserPromise) return markedParserPromise;\n    markedParserPromise = (async () => {\n        const [{ marked }, { default: markedKatex }] = await Promise.all([\n            import(\"marked\"),\n            import(\"marked-katex-extension\"),\n        ]);\n        marked?.use?.(\n            markedKatex({\n                throwOnError: false,\n                nonStandard: true,\n                output: \"mathml\",\n                strict: false,\n            }) as any,\n            {\n                hooks: {\n                    preprocess: (markdown: string): string => {\n                        if (/\\\\(.*\\\\)|\\\\[.*\\\\]/.test(markdown)) {\n                            const katexNode = document.createElement(\"div\");\n                            katexNode.innerHTML = markdown;\n                            renderMathInElement(katexNode, {\n                                throwOnError: false,\n                                nonStandard: true,\n                                output: \"mathml\",\n                                strict: false,\n                                delimiters: [\n                                    { left: \"$$\", right: \"$$\", display: true },\n                                    { left: \"\\\\[\", right: \"\\\\]\", display: true },\n                                    { left: \"$\", right: \"$\", display: false },\n                                    { left: \"\\\\(\", right: \"\\\\)\", display: false },\n                                ],\n                            });\n                            return katexNode.innerHTML;\n                        }\n                        return markdown;\n                    },\n                },\n            }\n        );\n        return async (markdown: string) => {\n            return await marked.parse(markdown ?? \"\");\n        };\n    })();\n    return markedParserPromise;\n};\n\n// ============================================================================\n// VIEWER STATE\n// ============================================================================\n\ninterface ViewerState {\n    content: string;\n    filename?: string;\n    scrollPosition?: number;\n}\n\nconst STORAGE_KEY = \"rs-viewer-state\";\nconst DEFAULT_CONTENT = \"# CrossWord Viewer\\n\\nOpen a markdown file or paste content here.\";\n\n// ============================================================================\n// VIEWER OPTIONS\n// ============================================================================\n\nexport interface ViewerOptions extends BaseViewOptions {\n    /** Initial markdown content */\n    initialContent?: string;\n    /** Filename for display */\n    filename?: string;\n    /** Enable editing mode */\n    editable?: boolean;\n    /** Enable print view */\n    content?: string;\n    /** Title for display */\n    title?: string;\n    /** Callback when content changes */\n    onContentChange?: (content: string) => void;\n    /** Callback when copy action is triggered */\n    onCopy?: (content: string) => void;\n    /** Callback when download action is triggered */\n    onDownload?: (content: string, filename?: string) => void;\n    /** Callback to attach content to work center */\n    onAttachToWorkCenter?: (content: string) => void;\n    /** Callback to print content */\n    onPrint?: (content: string) => void;\n    /** Callback to open file */\n    onOpen?: () => void;\n}\n\n// ============================================================================\n// VIEWER VIEW IMPLEMENTATION\n// ============================================================================\n\nexport class ViewerView implements View {\n    id = \"viewer\" as const;\n    name = \"Viewer\";\n    icon = \"eye\";\n\n    private options: ViewerOptions;\n    private shellContext?: ShellContext;\n    private element: HTMLElement | null = null;\n    private contentRef = ref(\"\");\n    private stateManager = createViewState<ViewerState>(STORAGE_KEY);\n    private _sheet: CSSStyleSheet | null = null;\n\n    lifecycle: ViewLifecycle = {\n        onMount: () => this.onMount(),\n        onUnmount: () => this.onUnmount(),\n        onShow: () => this.onShow(),\n        onHide: () => this.onHide(),\n        onRefresh: () => this.onRefresh()\n    };\n\n    constructor(options: ViewerOptions = {}) {\n        this.options = options;\n        this.shellContext = options.shellContext;\n\n        // Load initial content\n        const savedState = this.stateManager.load();\n        this.contentRef.value = options.initialContent || savedState?.content || DEFAULT_CONTENT;\n    }\n\n    render(options?: ViewOptions): HTMLElement {\n        // Merge options\n        if (options) {\n            this.options = { ...this.options, ...options };\n            this.shellContext = options.shellContext || this.shellContext;\n        }\n\n        // Load styles (idempotent â€” returns cached sheet)\n        this._sheet = loadAsAdopted(style) as CSSStyleSheet;\n\n        // Create main element with md-view web component\n        this.element = H`\n            <div class=\"view-viewer\">\n                <div class=\"view-viewer__toolbar\" data-viewer-toolbar>\n                    <div class=\"view-viewer__toolbar-left\">\n                        <button class=\"view-viewer__btn\" data-action=\"open\" type=\"button\" title=\"Open file\">\n                            <ui-icon icon=\"folder-open\" icon-style=\"duotone\"></ui-icon>\n                            <span>Open</span>\n                        </button>\n                    </div>\n                    <div class=\"view-viewer__toolbar-right\">\n                        <button class=\"view-viewer__btn\" data-action=\"copy\" type=\"button\" title=\"Copy raw content\">\n                            <ui-icon icon=\"copy\" icon-style=\"duotone\"></ui-icon>\n                            <span>Copy</span>\n                        </button>\n                        <button class=\"view-viewer__btn\" data-action=\"toggle-raw\" type=\"button\" title=\"Toggle raw/rendered view\">\n                            <ui-icon icon=\"code\" icon-style=\"duotone\"></ui-icon>\n                            <span>Raw</span>\n                        </button>\n                        <button class=\"view-viewer__btn\" data-action=\"copy-rendered\" type=\"button\" title=\"Copy rendered text\">\n                            <ui-icon icon=\"text-t\" icon-style=\"duotone\"></ui-icon>\n                            <span>Copy text</span>\n                        </button>\n                        <button class=\"view-viewer__btn\" data-action=\"download\" type=\"button\" title=\"Download as markdown\">\n                            <ui-icon icon=\"download\" icon-style=\"duotone\"></ui-icon>\n                            <span>Download</span>\n                        </button>\n                        <button class=\"view-viewer__btn\" data-action=\"export-docx\" type=\"button\" title=\"Export as DOCX\">\n                            <ui-icon icon=\"file-doc\" icon-style=\"duotone\"></ui-icon>\n                            <span>DOCX</span>\n                        </button>\n                        <button class=\"view-viewer__btn\" data-action=\"print\" type=\"button\" title=\"Print content\">\n                            <ui-icon icon=\"printer\" icon-style=\"duotone\"></ui-icon>\n                            <span>Print</span>\n                        </button>\n                        <button class=\"view-viewer__btn\" data-action=\"attach\" type=\"button\" title=\"Attach to Work Center\">\n                            <ui-icon icon=\"lightning\" icon-style=\"duotone\"></ui-icon>\n                            <span>Attach</span>\n                        </button>\n                    </div>\n                </div>\n                <div class=\"view-viewer__content\" data-viewer-content>\n                    <div class=\"markdown-body markdown-viewer-content result-content\" data-render-target></div>\n                    <pre class=\"markdown-viewer-raw\" data-raw-target aria-label=\"Raw content\" hidden></pre>\n                </div>\n            </div>\n        ` as HTMLElement;\n\n        // Get references to render and raw targets\n        const renderTarget = this.element.querySelector(\"[data-render-target]\") as HTMLElement | null;\n        const rawTarget = this.element.querySelector(\"[data-raw-target]\") as HTMLPreElement | null;\n\n        // Setup event handlers\n        this.setupEventHandlers(rawTarget || undefined);\n\n        // Set initial content\n        if (renderTarget && rawTarget) {\n            this.renderMarkdown(this.contentRef.value, renderTarget, rawTarget);\n        }\n\n        // Setup reactive updates\n        affected(this.contentRef, () => {\n            if (renderTarget && rawTarget) {\n                this.renderMarkdown(this.contentRef.value, renderTarget, rawTarget);\n            }\n            this.saveState();\n        });\n\n        return this.element;\n    }\n\n    getToolbar(): HTMLElement | null {\n        // The viewer has its own embedded toolbar\n        // Return null to not use shell's toolbar slot\n        return null;\n    }\n\n    /**\n     * Update the displayed content\n     */\n    setContent(content: string, filename?: string): void {\n        this.contentRef.value = content;\n        if (filename) {\n            this.options.filename = filename;\n        }\n    }\n\n    /**\n     * Get current content\n     */\n    getContent(): string {\n        return this.contentRef.value;\n    }\n\n    // ========================================================================\n    // PRIVATE METHODS\n    // ========================================================================\n\n    private renderMarkdown(content: string, renderTarget: HTMLElement, rawTarget: HTMLPreElement): void {\n        if (!renderTarget) return;\n\n        const looksLikeHtmlDocument = (text: string): boolean => {\n            const t = (text || \"\").trimStart().toLowerCase();\n            if (t.startsWith(\"<!doctype html\")) return true;\n            if (t.startsWith(\"<html\")) return true;\n            if (t.startsWith(\"<head\")) return true;\n            if (t.startsWith(\"<body\")) return true;\n            if (t.startsWith(\"<?xml\") && t.includes(\"<html\")) return true;\n            return false;\n        };\n\n        // Update raw view\n        if (rawTarget) {\n            rawTarget.textContent = content || \"\";\n        }\n\n        // Auto-switch to raw if it looks like HTML\n        const container = this.element?.querySelector(\".view-viewer__content\");\n        if (container && looksLikeHtmlDocument(content || \"\")) {\n            container.toggleAttribute(\"data-raw\", true);\n            if (rawTarget) rawTarget.hidden = false;\n            renderTarget.hidden = true;\n            return;\n        }\n\n        // Render markdown via lazy parser.\n        try {\n            const handleParsed = (html: string) => {\n                const sanitized = DOMPurify?.sanitize?.((html || \"\")?.trim?.() || \"\") || \"\";\n                renderTarget.innerHTML = sanitized;\n                console.log('[ViewerView] Markdown rendered successfully');\n            };\n\n            const handleError = (error: unknown) => {\n                console.error('[ViewerView] Error rendering markdown:', error);\n                renderTarget.innerHTML = `<div style=\"color: red; padding: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 4px;\">Error parsing markdown: ${(error as any)?.message}</div>`;\n            };\n\n            getMarkedParser()\n                .then((parse) => parse((content || \"\")?.trim?.() || \"\"))\n                .then(handleParsed)\n                .catch(handleError);\n        } catch (error) {\n            console.error('[ViewerView] Error rendering markdown:', error);\n            renderTarget.innerHTML = `<div style=\"color: red; padding: 1rem; background: #fee; border: 1px solid #fcc; border-radius: 4px;\">Error parsing markdown: ${(error as any)?.message}</div>`;\n        }\n    }\n\n    private setupEventHandlers(rawElement?: HTMLPreElement): void {\n        if (!this.element) return;\n\n        const toolbar = this.element.querySelector(\"[data-viewer-toolbar]\");\n        const content = this.element.querySelector(\"[data-viewer-content]\");\n        const renderTarget = this.element.querySelector(\"[data-render-target]\") as HTMLElement | null;\n\n        let showRaw = false;\n\n        toolbar?.addEventListener(\"click\", (e) => {\n            const target = e.target as HTMLElement;\n            const button = target.closest(\"[data-action]\") as HTMLButtonElement | null;\n            if (!button) return;\n\n            const action = button.dataset.action;\n            switch (action) {\n                case \"open\":\n                    this.handleOpen();\n                    break;\n                case \"copy\":\n                    this.handleCopy();\n                    break;\n                case \"toggle-raw\":\n                    showRaw = !showRaw;\n                    if (renderTarget) renderTarget.hidden = showRaw;\n                    if (rawElement) rawElement.hidden = !showRaw;\n                    content?.toggleAttribute(\"data-raw\", showRaw);\n                    break;\n                case \"copy-rendered\":\n                    if (renderTarget) {\n                        this.handleCopyRendered(renderTarget);\n                    }\n                    break;\n                case \"download\":\n                    this.handleDownload();\n                    break;\n                case \"export-docx\":\n                    void this.handleExportDocx();\n                    break;\n                case \"print\":\n                    if (renderTarget) {\n                        this.handlePrint(renderTarget);\n                    }\n                    break;\n                case \"attach\":\n                    this.handleAttachToWorkCenter();\n                    break;\n            }\n        });\n\n        // Setup drag and drop\n        if (content) {\n            content.addEventListener(\"dragover\", (e) => {\n                e.preventDefault();\n                (e.currentTarget as HTMLElement).classList.add(\"dragover\");\n            });\n\n            content.addEventListener(\"dragleave\", () => {\n                (content as HTMLElement).classList.remove(\"dragover\");\n            });\n\n            content.addEventListener(\"drop\", (e) => {\n                e.preventDefault();\n                (content as HTMLElement).classList.remove(\"dragover\");\n                this.handleFileDrop(e as DragEvent);\n            });\n        }\n\n        // Setup paste handling\n        this.element.addEventListener(\"paste\", (e) => {\n            this.handlePaste(e as ClipboardEvent);\n        });\n    }\n\n    private handleOpen(): void {\n        const input = document.createElement(\"input\");\n        input.type = \"file\";\n        input.accept = \".md,.markdown,.txt,text/markdown,text/plain\";\n        input.onchange = async () => {\n            const file = input.files?.[0];\n            if (file) {\n                try {\n                    const content = await file.text();\n                    this.setContent(content);\n                    this.showMessage(`Opened ${file.name}`);\n                } catch (error) {\n                    console.error(\"[ViewerView] Failed to read file:\", error);\n                    this.showMessage(\"Failed to read file\");\n                }\n            }\n        };\n        input.click();\n    }\n\n    private async handleCopy(): Promise<void> {\n        try {\n            await navigator.clipboard.writeText(this.contentRef.value);\n            this.showMessage(\"Copied raw content to clipboard\");\n            this.options.onCopy?.(this.contentRef.value);\n        } catch (error) {\n            console.error(\"[ViewerView] Failed to copy:\", error);\n            this.showMessage(\"Failed to copy to clipboard\");\n        }\n    }\n\n    private handleCopyRendered(renderTarget: HTMLElement): void {\n        const text = (renderTarget?.innerText || \"\").trim();\n        if (!text) {\n            this.showMessage(\"No content to copy\");\n            return;\n        }\n        navigator.clipboard.writeText(text).then(() => {\n            this.showMessage(\"Copied rendered text to clipboard\");\n        }).catch(() => {\n            const ta = document.createElement(\"textarea\");\n            ta.value = text;\n            document.body.append(ta);\n            ta.select();\n            document.execCommand(\"copy\");\n            ta.remove();\n            this.showMessage(\"Copied rendered text to clipboard\");\n        });\n    }\n\n    private handleDownload(): void {\n        const content = this.contentRef.value;\n        const filename = this.options.filename || `document-${Date.now()}.md`;\n\n        const blob = new Blob([content], { type: \"text/markdown;charset=utf-8\" });\n        const url = URL.createObjectURL(blob);\n\n        const a = document.createElement(\"a\");\n        a.href = url;\n        a.download = filename;\n        a.click();\n\n        setTimeout(() => URL.revokeObjectURL(url), 250);\n\n        this.showMessage(`Downloaded ${filename}`);\n        this.options.onDownload?.(content, filename);\n    }\n\n    private async handleExportDocx(): Promise<void> {\n        const content = this.contentRef.value;\n        if (!content.trim()) {\n            this.showMessage(\"No content to export\");\n            return;\n        }\n        try {\n            const { downloadMarkdownAsDocx } = await import(\"../../../core/document/DocxExport\");\n            await downloadMarkdownAsDocx(content, {\n                title: this.options.filename || \"Markdown Content\",\n                filename: `document-${Date.now()}.docx`,\n            });\n            this.showMessage(\"Exported as DOCX successfully\");\n        } catch (error) {\n            console.error(\"[ViewerView] Failed to export DOCX:\", error);\n            this.showMessage(\"Failed to export as DOCX\");\n        }\n    }\n\n    private handlePrint(renderTarget: HTMLElement): void {\n        try {\n            if (renderTarget) {\n                renderTarget.setAttribute('data-print', 'true');\n                window.print();\n                setTimeout(() => {\n                    renderTarget.removeAttribute('data-print');\n                }, 1000);\n            } else {\n                window.print();\n            }\n            this.options.onPrint?.(this.contentRef.value);\n        } catch (error) {\n            console.error(\"[ViewerView] Error printing content:\", error);\n            this.showMessage(\"Failed to print\");\n        }\n    }\n\n    private handleAttachToWorkCenter(): void {\n        this.options.onAttachToWorkCenter?.(this.contentRef.value);\n        this.shellContext?.navigate(\"workcenter\");\n        this.showMessage(\"Content attached to Work Center\");\n    }\n\n    private handleFileDrop(e: DragEvent): void {\n        const file = e.dataTransfer?.files?.[0];\n        if (file && (file.type.includes(\"text\") || file.name.endsWith(\".md\"))) {\n            file.text().then(content => {\n                this.setContent(content);\n                this.showMessage(`Loaded ${file.name}`);\n            }).catch(() => {\n                this.showMessage(\"Failed to read dropped file\");\n            });\n        }\n    }\n\n    private handlePaste(e: ClipboardEvent): void {\n        const text = e.clipboardData?.getData(\"text/plain\");\n        if (text && text.trim()) {\n            const target = e.target as HTMLElement;\n            if (target.tagName !== \"INPUT\" && target.tagName !== \"TEXTAREA\") {\n                this.setContent(text);\n                this.showMessage(\"Content pasted\");\n            }\n        }\n    }\n\n    private saveState(): void {\n        this.stateManager.save({\n            content: this.contentRef.value,\n            filename: this.options.filename\n        });\n    }\n\n    private showMessage(message: string): void {\n        if (this.shellContext) {\n            this.shellContext.showMessage(message);\n        } else {\n            console.log(`[Viewer] ${message}`);\n        }\n    }\n\n    // ========================================================================\n    // LIFECYCLE METHODS\n    // ========================================================================\n\n    private onMount(): void {\n        console.log(\"[Viewer] Mounted\");\n        this._sheet ??= loadAsAdopted(style) as CSSStyleSheet;\n    }\n\n    private onUnmount(): void {\n        console.log(\"[Viewer] Unmounting\");\n        this.saveState();\n        removeAdopted(this._sheet!);\n        this.element = null;\n    }\n\n    private onShow(): void {\n        this._sheet ??= loadAsAdopted(style) as CSSStyleSheet;\n        console.log(\"[Viewer] Shown\");\n    }\n\n    private onHide(): void {\n        //removeAdopted(this._sheet);\n        this.saveState();\n        console.log(\"[Viewer] Hidden\");\n    }\n\n    private onRefresh(): void {\n        const renderTarget = this.element?.querySelector(\"[data-render-target]\") as HTMLElement | null;\n        const rawTarget = this.element?.querySelector(\"[data-raw-target]\") as HTMLPreElement | null;\n        if (renderTarget && rawTarget) {\n            this.renderMarkdown(this.contentRef.value, renderTarget, rawTarget);\n        }\n    }\n\n    // ========================================================================\n    // MESSAGE HANDLING\n    // ========================================================================\n\n    canHandleMessage(messageType: string): boolean {\n        return [\"content-view\", \"content-load\", \"markdown-content\", \"content-share\", \"share-target-input\"].includes(messageType);\n    }\n\n    async handleMessage(message: unknown): Promise<void> {\n        const msg = message as { type?: string; data?: { text?: string; content?: string; filename?: string; url?: string } };\n\n        if (msg.data?.text || msg.data?.content || msg.data?.url) {\n            const content = msg.data.text || msg.data.content || msg.data.url || \"\";\n            this.setContent(content, msg.data.filename);\n        }\n    }\n}\n\n// ============================================================================\n// TYPE EXPORTS\n// ============================================================================\n\n/**\n * Document type for viewer (content + metadata)\n */\nexport interface ViewerDocument {\n    content: string;\n    filename?: string;\n    mimeType?: string;\n    lastModified?: number;\n}\n\n// ============================================================================\n// FACTORY FUNCTION\n// ============================================================================\n\n/**\n * Create a viewer view instance\n */\nexport function createView(options?: ViewerOptions): ViewerView {\n    return new ViewerView(options);\n}\n\n/** Alias for createView */\nexport const createMarkdownView = createView;\n\nexport default createView;\n"],"file":"index9.js"}