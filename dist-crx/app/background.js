import{JSOX as e,writeFileSmart as t,getDirectoryHandle as n,getFileHandle as r,observe as o,safe as i,iterated as a,loadSettings as s,DEFAULT_SETTINGS as c,__vitePreload as l}from"../modules/Settings.js";import{canParseURL as u,showSuccess as d,showError as p}from"../modules/Toast.js";import{Promised as m}from"../modules/Env.js";import{ableToShowImage as f,removeAnyPrefix as h,encodeWithJSquash as g,crxMessaging as y,registerCrxHandler as w,broadcastToCrxTabs as b}from"../modules/CrxMessaging.js";import{CORE_IMAGE_INSTRUCTION as x,SOLVE_AND_ANSWER_INSTRUCTION as S,WRITE_CODE_INSTRUCTION as k,EXTRACT_CSS_INSTRUCTION as v,CRX_SOLVE_AND_ANSWER_INSTRUCTION as _,CRX_WRITE_CODE_INSTRUCTION as R,CRX_EXTRACT_CSS_INSTRUCTION as T}from"../modules/templates.js";import{LANGUAGE_INSTRUCTIONS as I,TRANSLATE_INSTRUCTION as $,SVG_GRAPHICS_ADDON as A,buildInstructionPrompt as N,getIntermediateRecognitionInstruction as E,getOutputFormatInstruction as C,getCustomInstructions as O}from"../modules/CustomInstructions.js";import{toText as F}from"../modules/Clipboard.js";const D=".",P="null",U="\\",z='"',j=",";function M(e){return e.replace(/\\/g,`${U}${U}`).replace(/"/g,`${U}${z}`).replace(/\n/g,`${U}n`).replace(/\r/g,`${U}r`).replace(/\t/g,`${U}t`)}function L(e){if(null===e)return null;if("string"==typeof e||"boolean"==typeof e)return e;if("number"==typeof e)return Object.is(e,-0)?0:Number.isFinite(e)?e:null;if("bigint"==typeof e)return e>=Number.MIN_SAFE_INTEGER&&e<=Number.MAX_SAFE_INTEGER?Number(e):e.toString();if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(L);if(e instanceof Set)return Array.from(e).map(L);if(e instanceof Map)return Object.fromEntries(Array.from(e,([e,t])=>[String(e),L(t)]));if(function(e){if(null===e||"object"!=typeof e)return!1;const t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}(e)){const t={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=L(e[n]));return t}return null}function W(e){return null===e||"string"==typeof e||"number"==typeof e||"boolean"==typeof e}function q(e){return Array.isArray(e)}function B(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function J(e){return 0===Object.keys(e).length}function G(e){return 0===e.length||e.every(e=>W(e))}function Y(e){return 0===e.length||e.every(e=>B(e))}function K(e,t=j){return!!e&&(e===e.trim()&&("true"!==(n=e)&&"false"!==n&&n!==P&&!function(e){return/^-?\d+(?:\.\d+)?(?:e[+-]?\d+)?$/i.test(e)||/^0\d+$/.test(e)}(e)&&(!e.includes(":")&&(!e.includes('"')&&!e.includes("\\")&&(!/[[\]{}]/.test(e)&&(!/[\n\r\t]/.test(e)&&(!e.includes(t)&&!e.startsWith("-"))))))));var n}function V(e,t,n,r,o,i,a){if("safe"!==r.keyFolding)return;if(!B(t))return;const{segments:s,tail:c,leafValue:l}=function(e,t,n){const r=[e];let o=t;for(;r.length<n&&B(o);){const e=Object.keys(o);if(1!==e.length)break;const t=e[0],n=o[t];r.push(t),o=n}return!B(o)||J(o)?{segments:r,tail:void 0,leafValue:o}:{segments:r,tail:o,leafValue:o}}(e,t,a??r.flattenDepth);if(s.length<2)return;if(!s.every(e=>function(e){return/^[A-Z_]\w*$/i.test(e)}(e)))return;const u=function(e){return e.join(D)}(s),d=i?`${i}${D}${u}`:u;return n.includes(u)||o&&o.has(d)?void 0:{foldedKey:u,remainder:c,leafValue:l,segmentCount:s.length}}function H(e,t){return null===e?P:"boolean"==typeof e||"number"==typeof e?String(e):function(e,t=j){return K(e,t)?e:`${z}${M(e)}${z}`}(e,t)}function Q(e){return function(e){return/^[A-Z_][\w.]*$/i.test(e)}(e)?e:`${z}${M(e)}${z}`}function X(e,t=j){return e.map(e=>H(e,t)).join(t)}function Z(e,t){const n=t?.key,r=t?.fields,o=t?.delimiter??",";let i="";if(n&&(i+=Q(n)),i+=`[${e}${o!==j?o:""}]`,r){i+=`{${r.map(e=>Q(e)).join(o)}}`}return i+=":",i}function*ee(e,t,n,r,o,i){const a=Object.keys(e);0!==t||r||(r=new Set(a.filter(e=>e.includes("."))));const s=i??n.flattenDepth;for(const[c,l]of Object.entries(e))yield*te(c,l,t,n,a,r,o,s)}function*te(e,t,n,r,o,i,a,s){const c=a?`${a}${D}${e}`:e,l=s??r.flattenDepth;if("safe"===r.keyFolding&&o){const s=V(e,t,o,r,i,a,l);if(s){const{foldedKey:e,remainder:t,leafValue:o,segmentCount:c}=s,u=Q(e);if(void 0===t){if(W(o))return void(yield le(n,`${u}: ${H(o,r.delimiter)}`,r.indent));if(q(o))return void(yield*ne(e,o,n,r));if(B(o)&&J(o))return void(yield le(n,`${u}:`,r.indent))}if(B(t)){yield le(n,`${u}:`,r.indent);const o=l-c,s=a?`${a}${D}${e}`:e;return void(yield*ee(t,n+1,r,i,s,o))}}}const u=Q(e);W(t)?yield le(n,`${u}: ${H(t,r.delimiter)}`,r.indent):q(t)?yield*ne(e,t,n,r):B(t)&&(yield le(n,`${u}:`,r.indent),J(t)||(yield*ee(t,n+1,r,i,c,l)))}function*ne(e,t,n,r){if(0!==t.length)if(G(t))yield le(n,re(t,r.delimiter,e),r.indent);else if(function(e){return 0===e.length||e.every(e=>q(e))}(t)&&t.every(e=>G(e)))yield*function*(e,t,n,r){yield le(n,Z(t.length,{key:e,delimiter:r.delimiter}),r.indent);for(const o of t)if(G(o)){const e=re(o,r.delimiter);yield ue(n+1,e,r.indent)}}(e,t,n,r);else{if(Y(t)){const o=oe(t);return void(o?yield*function*(e,t,n,r,o){yield le(r,Z(t.length,{key:e,fields:n,delimiter:o.delimiter}),o.indent),yield*ie(t,n,r+1,o)}(e,t,o,n,r):yield*ae(e,t,n,r))}yield*ae(e,t,n,r)}else yield le(n,Z(0,{key:e,delimiter:r.delimiter}),r.indent)}function re(e,t,n){const r=Z(e.length,{key:n,delimiter:t}),o=X(e,t);return 0===e.length?r:`${r} ${o}`}function oe(e){if(0===e.length)return;const t=e[0],n=Object.keys(t);return 0!==n.length&&function(e,t){for(const n of e){if(Object.keys(n).length!==t.length)return!1;for(const e of t){if(!(e in n))return!1;if(!W(n[e]))return!1}}return!0}(e,n)?n:void 0}function*ie(e,t,n,r){for(const o of e)yield le(n,X(t.map(e=>o[e]),r.delimiter),r.indent)}function*ae(e,t,n,r){yield le(n,Z(t.length,{key:e,delimiter:r.delimiter}),r.indent);for(const o of t)yield*ce(o,n+1,r)}function*se(e,t,n){if(J(e))return void(yield le(t,"-",n.indent));const r=Object.entries(e),[o,i]=r[0],a=Q(o);if(W(i))yield ue(t,`${a}: ${H(i,n.delimiter)}`,n.indent);else if(q(i))if(G(i))yield ue(t,re(i,n.delimiter,o),n.indent);else if(Y(i)){const e=oe(i);if(e)yield ue(t,Z(i.length,{key:o,fields:e,delimiter:n.delimiter}),n.indent),yield*ie(i,e,t+1,n);else{yield ue(t,`${a}[${i.length}]:`,n.indent);for(const e of i)yield*se(e,t+1,n)}}else{yield ue(t,`${a}[${i.length}]:`,n.indent);for(const e of i)yield*ce(e,t+1,n)}else B(i)&&(yield ue(t,`${a}:`,n.indent),J(i)||(yield*ee(i,t+2,n)));for(let s=1;s<r.length;s++){const[e,o]=r[s];yield*te(e,o,t+1,n)}}function*ce(e,t,n){if(W(e))yield ue(t,H(e,n.delimiter),n.indent);else if(q(e))if(G(e))yield ue(t,re(e,n.delimiter),n.indent);else{yield ue(t,Z(e.length,{delimiter:n.delimiter}),n.indent);for(const r of e)yield*ce(r,t+1,n)}else B(e)&&(yield*se(e,t,n))}function le(e,t,n){return" ".repeat(n*e)+t}function ue(e,t,n){return le(e,"- "+t,n)}function de(e,t){return Array.from(function(e){return function*(e,t,n){if(W(e)){const n=H(e,t.delimiter);return void(""!==n&&(yield n))}q(e)?yield*ne(void 0,e,n,t):B(e)&&(yield*ee(e,n,t))}(L(e),{indent:2,delimiter:j,keyFolding:"off",flattenDepth:Number.POSITIVE_INFINITY},0)}(e)).join("\n")}const pe={math:"input_text",url:"input_image",text:"input_text",input_text:"input_text",output_text:"input_text",image_url:"input_image",image:"input_image",input_image:"input_image",input_url:"input_image",json:"input_text",markdown:"input_text",code:"input_text",entity:"input_text",structured:"input_text",unknown:"input_text",svg:"input_text",xml:"input_text"},me=e=>{if(!e)return"input_text";const t=e.toLowerCase();return t.includes("image")?"input_image":t.includes("json")?"json":t.includes("javascript")||t.includes("typescript")?"code":t.includes("markdown")||t.includes("md")?"markdown":t.includes("url")?"input_url":t.includes("text/html")?"markdown":(t.includes("text/plain"),"input_text")},fe=e=>{const t=e?.context,n=pe?.[e?.dataKind||"input_text"],r=he(t);switch(n){case"input_image":return`${r}\n\nRecognize data from image, also preferred to orient by fonts in image.\n\nAfter recognition, do not include or remember image itself.\n\n---\n\nIn (\`recognized_data\` key), can be written phone numbers, emails, URLs, dates, times, codes, etc. Additional formatting rules:\n\nIn recognized from image data (what you seen in image), do:\n- If textual content, format as Markdown string (multiline).\n- If phone number, format as as correct phone number (in normalized format).\n  - Also, if phone numbers (for example starts with +7, format as 8), replace to correct regional code.\n  - Remove brackets, parentheses, spaces or other symbols from phone number.\n  - Trim spaces from phone number.\n- If email, format as as correct email (in normalized format), and trim spaces from email.\n- If URL, format as as correct URL (in normalized format), and unicode codes to human readable, and trim spaces from URL.\n- If date, format as as correct date (in normalized format).\n- If time, format as as correct time (in normalized format).\n- If math (expression, equation, formula), format as $KaTeX$\n- If table (or looks alike table), format as | table |\n- If image, format as [$image$]($image$)\n- If code, format as \`\`\`$code$\`\`\` (multiline) or \`$code$\` (single-line)\n- If JSON, format as correct JSON string, and trim spaces from JSON string.\n- If other, format as $text$.\n- If seen alike list, format as list (in markdown format).\n\n---\n\nSome additional actions:\n- Collect some special data tags and keywords (if has any).\n- Also, can you provide in markdown pre-formatted free-form analyzed or recognized verbose data (in \`verbose_data\` key).\n\n---\n\nCRITICAL OUTPUT FORMAT: Return ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { or [ and end with } or ].\n\nExpected output structure:\n{\n    "keywords_and_tags": ["string array"],\n    "recognized_data": ["any array"],\n    "verbose_data": "markdown string",\n    "using_ready": true,\n    "confidence": 0.95,\n    "suggested_type": "document_type"\n}\n`;case"input_text":return`${r}\n\nAnalyze text and extract specific or special data from it, also normalize data by those rules...\n\n---\n\nIn (\`recognized_data\` key), can be written phone numbers, emails, URLs, dates, times, codes, etc. Additional formatting rules:\n\nNormalize phone numbers, emails, URLs, dates, times, codes, etc for best efforts and by those rules.\n- If phone number, format as as correct phone number (in normalized format).\n  - If phone numbers (for example starts with +7, format as 8), replace to correct regional code.\n  - Trim spaces from phone numbers, emails, URLs, dates, times, codes, etc.\n  - Remove brackets, parentheses, spaces or other symbols from phone numbers.\n- If email, format as as correct email (in normalized format), and trim spaces from email.\n- If URL, format as as correct URL (in normalized format), and unicode codes to human readable, and trim spaces from URL.\n- If date, format as as correct date (in normalized format).\n- If time, format as as correct time (in normalized format).\n- If math, format as $KaTeX$\n- If table, format as | table |\n- If image, format as [$image$]($image$)\n- If code, format as \`\`\`$code$\`\`\` (multiline) or \`$code$\` (single-line)\n- If JSON, format as correct JSON string, and trim spaces from JSON string.\n- If other, format as $text$.\n- If seen alike list, format as list (in markdown format).\n\n---\n\nSome additional actions:\n- Collect some special data tags and keywords (if has any).\n- Also, can you provide in markdown pre-formatted free-form analyzed or recognized verbose data (in \`verbose_data\` key).\n- Detect entity type if applicable (task, event, person, place, service, item, etc.)\n\n---\n\nCRITICAL OUTPUT FORMAT: Return ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { or [ and end with } or ].\n\nExpected output structure:\n{\n    "keywords_and_tags": ["string array"],\n    "recognized_data": ["any array"],\n    "verbose_data": "markdown string",\n    "using_ready": true,\n    "confidence": 0.95,\n    "suggested_type": "entity_type",\n    "suggested_modifications": []\n}\n`}return r||""},he=e=>{if(!e)return"";const t=[];if(e.operation){const n={create:"Create new data entries based on provided information.",modify:"Modify existing data with provided changes while preserving structure.",merge:"Intelligently merge new data with existing data, avoiding duplicates.",analyze:"Analyze and extract structured information from the data.",extract:"Extract specific data points matching the criteria."};t.push(`Operation: ${n[e.operation]||e.operation}`)}if(e.entityType&&t.push(`Target entity type: ${e.entityType}`),e.existingData&&t.push("Existing data context provided - consider for merge/update operations."),e.filters?.length){const n=e.filters.map(e=>`${e.field} ${e.operator} ${JSON.stringify(e.value)}`).join(", ");t.push(`Apply filters: ${n}`)}return e.searchTerms?.length&&t.push(`Search terms: ${e.searchTerms.join(", ")}`),e.priority&&t.push(`Priority level: ${e.priority}`),t.length?`Context:\n${t.join("\n")}\n\n---\n`:""},ge=[/```json\s*\n?([\s\S]*?)\n?```/i,/```toon\s*\n?([\s\S]*?)\n?```/i,/```\s*\n?([\s\S]*?)\n?```/,/(\{[\s\S]*\})/,/(\[[\s\S]*\])/],ye=e=>e&&"string"==typeof e?e.replace(/^\uFEFF/,"").replace(/[\u200B-\u200D\uFEFF]/g,"").replace(/\r\n/g,"\n").replace(/\r/g,"\n").trim():"",we=e=>{let t=e;return t=t.replace(/,(\s*[}\]])/g,"$1"),t=t.replace(/:\s*"([^"]*)\n([^"]*)"/g,(e,t,n)=>`: "${t}\\n${n}"`),t=t.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,""),t},be=t=>{if(!t)return{ok:!1,error:"Empty input"};try{return{ok:!0,data:e.parse(t)}}catch{}try{return{ok:!0,data:JSON.parse(t)}}catch{}try{const n=we(t);return{ok:!0,data:e.parse(n)}}catch{}try{const n=t.match(/^[^{[]*([{\[][\s\S]*[}\]])[^}\]]*$/);if(n?.[1]){return{ok:!0,data:e.parse(n[1])}}}catch{}return{ok:!1,error:"Failed to parse JSON with all strategies"}},xe=e=>{if(null==e)return{ok:!1,error:"Response is null or undefined"};if("string"!=typeof e)return"object"==typeof e?{ok:!0,data:e,source:"direct"}:{ok:!1,error:"Expected string, got "+typeof e};const t=ye(e);if(!t)return{ok:!1,error:"Response is empty after cleaning",raw:e};const n=be(t);if(n.ok)return{ok:!0,data:n.data,raw:e,source:"direct"};for(const o of ge){const n=t.match(o);if(n?.[1]){const t=ye(n[1]),r=be(t);if(r.ok)return{ok:!0,data:r.data,raw:e,source:"markdown_block"}}}const r=t.match(/(\{[\s\S]+\}|\[[\s\S]+\])/);if(r?.[1]){const t=we(r[1]),n=be(t);if(n.ok)return{ok:!0,data:n.data,raw:e,source:"recovered"}}return{ok:!1,error:"Could not extract valid JSON from response",raw:e}},Se=(e,t="data")=>{const n=xe(e);return n.ok&&void 0!==n.data?{raw:n.raw||e,ok:!0,data:n.data,source:n.source,wasRecovered:"recovered"===n.source,error:n.error||void 0}:{raw:n.raw||e,ok:!1,data:{[t]:n.raw||String(e)},source:"fallback",wasRecovered:!1,error:n.error||void 0}},ke={low:6e4,medium:3e5,high:9e5};const ve=e=>{if(void 0!==globalThis.Buffer)return globalThis.Buffer.from(e).toString("base64");const t=1048576;if(e.length>t){let n="";for(let r=0;r<e.length;r+=t){const o=e.slice(r,r+t);let i="";for(let e=0;e<o.length;e++)i+=String.fromCharCode(o[e]);n+="function"==typeof btoa?btoa(i):""}return n}let n="";for(let r=0;r<e.length;r++)n+=String.fromCharCode(e[r]);return"function"==typeof btoa?btoa(n):""},_e=async e=>{const t=void 0!==globalThis.File?globalThis.File:void 0,n=void 0!==globalThis.Blob?globalThis.Blob:void 0;if(n&&e?.dataSource instanceof n||t&&e?.dataSource instanceof t){const t=e?.dataSource?.size||0,n=10485760;if(t>n)return console.warn(`[GPT-Responses] File too large: ${t} bytes > ${n} bytes`),{type:"input_text",text:`[File too large: ${(t/1024/1024).toFixed(1)}MB. Maximum allowed: ${(n/1024/1024).toFixed(1)}MB]`};if("input_image"===pe?.[e?.dataKind||"input_text"]||e?.dataSource?.type?.startsWith?.("image/"))try{const t=`data:${e?.dataSource?.type};base64,`,n=await(e?.dataSource?.arrayBuffer());if(!n)throw new Error("Failed to read file as ArrayBuffer");const r=new Uint8Array(n);return{type:"input_image",detail:"auto",image_url:t+ve(r)}}catch(o){return console.error("[GPT-Responses] Failed to process image file:",o),{type:"input_text",text:`[Failed to process image file: ${o}]`}}try{const t=await(e?.dataSource?.text?.());if(t)return{type:"input_text",text:t}}catch(o){return console.error("[GPT-Responses] Failed to read text file:",o),{type:"input_text",text:`[Failed to read text file: ${o}]`}}}else if("string"==typeof e?.dataSource){const t=e?.dataKind||(e=>{if(!e||"string"!=typeof e)return"input_text";const t=e.trim();if(t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]"))try{return JSON.parse(t),"json"}catch{}if(u(t))return"url";if(t.includes("<svg")&&t.includes("</svg>"))return"xml";if(t.startsWith("data:image/")&&t.includes(";base64,")&&!t.includes("\n")&&t.length<1e5)try{const e=new URL(t);if("data:"===e.protocol&&e.pathname.startsWith("image/"))return"input_image"}catch{}return/\$\$[\s\S]+\$\$|\$[^$]+\$|\\begin\{equation\}/.test(t)?"math":/```[\s\S]+```|^(function|const|let|var|class|import|export)\s/m.test(t)?"code":/^#{1,6}\s|^\*\*|^-\s|\[.+\]\(.+\)|^>\s/m.test(t)?"markdown":"input_text"})(e.dataSource);if("input_image"==pe?.[t]){const t=e?.dataSource?.trim?.()||"";if(t.startsWith("data:image/")&&t.includes(";base64,"))try{const e=new URL(t);if("data:"===e.protocol&&e.pathname.startsWith("image/"))return{type:"input_image",image_url:t,detail:"auto"}}catch{}else if(u(t))return{type:"input_image",image_url:t,detail:"auto"}}return{type:"input_text",text:e?.dataSource}}let r=e?.dataSource;try{r="object"!=typeof e?.dataSource?e?.dataSource:de(e?.dataSource)}catch(i){console.warn(i)}return{type:pe?.[e?.dataKind||"input_text"]||"text",text:r}};class Re{apiKey;apiSecret;apiUrl="https://api.proxyapi.ru/openai/v1";model="gpt-5.2";responseId=null;pending=[];messages=[];tools=new Map;context=null;responseMap=new Map;constructor(e,t,n,r){this.apiKey=e||"",this.apiUrl=t||this.apiUrl,this.apiSecret=n||"",this.model=r||this.model}setContext(e){return this.context=e,this}async useMCP(e,t,n,r){return this.tools.set(t?.trim?.(),{type:"mcp",server_label:e,server_url:t,headers:{authorization:`Bearer ${n}:${r}`},require_approval:"never"}),this.tools.get(t?.trim?.())}async convertPlainToInput(e,t=null,n=null){t??=me(e?.type)||"input_text";const r={dataSource:e,dataKind:t,context:this.context},o=await _e(r);return{type:"message",role:"user",content:[{type:"input_text",text:"What to do: "+fe(r)},n?{type:"text",text:"Additional request data: "+n}:null,{type:"input_text",text:"\n === BEGIN:ATTACHED_DATA === \n"},{...o},{type:"input_text",text:"\n === END:ATTACHED_DATA === \n"}]?.filter?.(e=>null!==e)}}async attachToRequest(e,t=null,n=null){return this.pending.push(await this.convertPlainToInput(e,t??=me(e?.type)||"input_text")),n&&this.pending.push(await this.askToDoAction(n)),this.pending[this.pending.length-1]}async attachExistingData(e,t){return this.context={...this.context,existingData:e,entityType:t||this.context?.entityType},await this.giveForRequest(`existing_data: \`${de(e)}\`\n`),this}async giveForRequest(e){if("string"!=typeof e)try{const t=me(e?.type)||"input_text",n=await _e({dataSource:e,dataKind:t,context:this.context});return this?.pending?.push?.({type:"message",role:"user",content:[{type:"input_text",text:"Additional data for request:"},{type:"input_text",text:"\n === BEGIN:ATTACHED_DATA === \n"},{...n},{type:"input_text",text:"\n === END:ATTACHED_DATA === \n"}]}),this?.pending?.[this?.pending?.length-1]}catch(t){e=String(e)}return this?.pending?.push?.({type:"message",role:"user",content:[{type:"input_text",text:"Additional data for request:"},{type:"input_text",text:String(e)}]}),this?.pending?.[this?.pending?.length-1]}async askToDoAction(e){return this?.pending?.push?.({type:"message",role:"user",content:[{type:"input_text",text:e}]}),this?.pending?.[this?.pending?.length-1]}beginFromResponseId(e=null){return this.responseId=this.responseId=e||this.responseId,this}async sendRequest(t="low",n="low",r=null,o={}){t??="low",n??="low";const i=new Map;for(const f of this.pending)if(f)try{const t="object"==typeof f?e.stringify(f):String(f);i.has(t)||i.set(t,f)}catch(m){i.set(Math.random().toString(),f)}const a=Array.from(i.values()),s="json"===o?.responseFormat?'\nCRITICAL OUTPUT FORMAT REQUIREMENTS:\n\n1. Your response MUST be ONLY valid JSON - no markdown, no explanations, no prose.\n2. Do NOT wrap the JSON in code blocks (```json or ```).\n3. Do NOT include any text before or after the JSON object.\n4. The response must start with { or [ and end with } or ].\n5. All strings must be properly escaped (newlines as \\n, quotes as \\").\n6. Use null for missing/unknown values, not undefined or empty strings.\n7. Numbers should be unquoted. Booleans should be true/false (lowercase).\n8. Arrays should not have trailing commas.\n9. The JSON must be parseable by JSON.parse() without modification.\n\nIf you cannot provide the requested data, return: {"error": "description of the issue", "ok": false}\n':void 0,c={model:this.model,tools:Array.from(this?.tools?.values?.()||[])?.filter?.(e=>!!e),input:a,reasoning:{effort:t},text:{verbosity:n},max_output_tokens:o?.maxTokens||4e5,previous_response_id:this.responseId=r||this?.responseId,instructions:s},{timeout:l,maxRetries:u}=function(e){try{const t=globalThis.runtimeSettings?.ai||require("../../config/RuntimeSettings").getRuntimeSettings?.()?.ai||require("../../config/Settings").loadSettings?.()?.ai,n=t?.requestTimeout,r=t?.maxRetries??2;return{timeout:n?.[e]??ke[e],maxRetries:r}}catch{return{timeout:ke[e],maxRetries:2}}}(t);console.log("[GPT] Making request to:",`${this?.apiUrl}/responses`),console.log("[GPT] API key present:",!!this?.apiKey),console.log("[GPT] Request timeout:",`${l}ms (${l/1e3}s) (${t} effort)`),console.log("[GPT] Max retries:",u),console.log("[GPT] Request body size:",JSON.stringify(c).length,"characters"),console.log("[GPT] Request input count:",a.length,"items");let d=null;for(let e=0;e<=u;e++){e>0&&(console.log(`[GPT] Retry attempt ${e}/${u} after 2000ms delay`),await new Promise(e=>setTimeout(e,2e3)));try{const t=new AbortController,n=setTimeout(()=>{console.warn(`[GPT] Request timeout after ${l}ms (attempt ${e+1}) - aborting request`),t.abort("timeout")},l);console.log(`[GPT] Sending request (attempt ${e+1})...`);const r=await fetch(`${this?.apiUrl}/responses`,{method:"POST",priority:"auto",signal:t.signal,headers:{"Content-Type":"application/json",...this?.apiKey?{Authorization:`Bearer ${this?.apiKey}`}:{}},body:JSON.stringify(c)});if(console.log(`[GPT] Request sent successfully (attempt ${e+1})`),clearTimeout(n),console.log("[GPT] Response status:",r.status,`(attempt ${e+1})`),200!==r.status){const e=await(r?.json?.()?.catch?.(e=>(console.error("[GPT] Failed to parse error response:",e),null))),t=e?.error?.message||e?.message||`HTTP ${r.status}`;if(d=new Error(`API error (${r.status}): ${t}`),console.error("[GPT] API error:",t),r.status>=400&&r.status<500)throw d;continue}return await this.processSuccessfulResponse(r)}catch(m){if(d=m instanceof Error?m:new Error(String(m)),console.error(`[GPT] Request failed (attempt ${e+1}):`,d.message),"AbortError"===d.name||d.message.includes("HTTP 4"))break}}const p=d?d.message:"Unknown error after all retries";throw console.error("[GPT] All retry attempts failed:",p),new Error(`Request failed after ${u+1} attempts: ${p}`)}async processSuccessfulResponse(t){const n=await(t?.json?.()?.catch?.(e=>(console.warn("[GPT] Failed to parse successful response:",e),null)));if(!n)return null;console.log("[GPT] Raw API response structure:",{type:typeof n,isArray:Array.isArray(n),keys:Object.keys(n).slice(0,10),keysLength:Object.keys(n).length,sample:JSON.stringify(n).substring(0,300)}),this.responseMap.set(this.responseId=n?.id||n?.response_id||this.responseId,n),this?.messages?.push?.(...this?.pending||[]),this?.pending?.splice?.(0,this?.pending?.length),this.messages.push(...n?.output||[]);const r=e=>{try{if(!e)return null;if("string"==typeof e){if(e.startsWith('"')&&e.endsWith('"')&&e.includes("\\n"))try{const t=JSON.parse(e);if(console.log("[GPT] Parsed JSON string response:",typeof t,t?.substring?.(0,100)||"object"),"string"==typeof t)return t;if("object"==typeof t)return r(t)}catch(t){console.log("[GPT] Failed to parse JSON string, treating as plain text")}return e}if(Array.isArray(e)){console.log("[GPT] Response is array with",e.length,"items"),console.log("[GPT] First few array items:",e.slice(0,3).map(e=>({type:typeof e,keys:"object"==typeof e?Object.keys(e||{}):"N/A",sample:"string"==typeof e?e.substring(0,50):JSON.stringify(e).substring(0,100)})));const t=[];for(const n of e)"string"==typeof n?t.push(n):n?.text?t.push(n.text):n?.content?t.push(n.content):n?.message?.content&&t.push(n.message.content);if(t.length)return t.join("\n\n")}if("object"==typeof e&&Object.keys(e).every(e=>!isNaN(Number(e)))){console.log("[GPT] Response looks like array with",Object.keys(e).length,"numeric keys");const t=[];for(const n of Object.keys(e).sort((e,t)=>Number(e)-Number(t))){const r=e[n];"string"==typeof r?t.push(r):r?.text?t.push(r.text):r?.content?t.push(r.content):r?.message?.content&&t.push(r.message.content)}if(t.length)return t.join("\n\n")}if(e.output_text&&Array.isArray(e.output_text)&&e.output_text.length)return e.output_text.join("\n\n");const n=e.output||e.choices||[],o=[];for(const e of n){const t=e?.content||e?.message?.content||[];if(t)if("string"==typeof t)o.push(t);else if(Array.isArray(t))for(const e of t)"string"==typeof e?.text?o.push(e.text):e?.text?.value&&o.push(e.text.value)}if(o.length)return o.join("\n\n")}catch(t){console.warn("[GPT] Error extracting text:",t)}return null},o=r(n);if(console.log("[GPT] Extracted text result:",o?`"${o.substring(0,100)}..."`:"null"),null!=o)return JSON.stringify({choices:[{message:{content:o}}],usage:n?.usage||{},id:this.responseId,object:"chat.completion"});try{const t=e.parse(n?.output??n);if(t)return JSON.stringify({choices:[{message:{content:"string"==typeof t?t:JSON.stringify(t)}}],usage:n?.usage||{},id:this.responseId,object:"chat.completion"})}catch{}return JSON.stringify({choices:[{message:{content:"No text content available"}}],usage:{},id:this.responseId,object:"chat.completion"})}async modifyExistingData(e,t,n=[]){try{this.setContext({operation:"modify",existingData:e}),await this.giveForRequest('\nYou are a data modification assistant. Your task is to modify existing data based on the provided instructions.\n\nRules for modification:\n1. Preserve the original data structure unless explicitly asked to change it.\n2. Apply modifications in order, one by one.\n3. Validate data types match the schema.\n4. Return the complete modified entity, not just the changes.\n5. If a modification cannot be applied, include it in the "errors" array with explanation.\n\nCRITICAL: Output ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { and end with }.\n\nExpected output structure:\n{\n    "modified_entity": { /* complete modified entity */ },\n    "changes_made": [ /* list of applied changes */ ],\n    "errors": [ /* list of failed modifications with reasons */ ],\n    "warnings": [ /* non-critical issues */ ]\n}\n'),await this.giveForRequest(`existing_entity: \`${de(e)}\`\n`),n.length&&await this.giveForRequest((e=>{if(!e?.length)return"";const t=e.map((e,t)=>{const n=e.conditions?.length?` when ${e.conditions.map(e=>`${e.field} ${e.operator} ${JSON.stringify(e.value)}`).join(" AND ")}`:"";switch(e.action){case"update":return`${t+1}. UPDATE field "${e.target}" to ${JSON.stringify(e.value)}${n}`;case"delete":return`${t+1}. DELETE field "${e.target}"${n}`;case"merge":return`${t+1}. MERGE into "${e.target}" with ${JSON.stringify(e.value)}${n}`;case"append":return`${t+1}. APPEND ${JSON.stringify(e.value)} to "${e.target}"${n}`;case"replace":return`${t+1}. REPLACE "${e.target}" with ${JSON.stringify(e.value)}${n}`;case"transform":return`${t+1}. TRANSFORM "${e.target}" using: ${e.transformFn}${n}`;default:return""}}).filter(Boolean);return t.length?`\nModification instructions:\n${t.join("\n")}\n`:""})(n)),await this.askToDoAction(t);const r=await this.sendRequest("high","medium",null,{responseFormat:"json",temperature:.2}),o=xe(r);return o.ok?{ok:!0,data:o.data?.modified_entity||o.data,responseId:this.responseId}:(console.warn("JSON extraction failed:",o.error,"Raw:",o.raw),{ok:!1,error:o.error||"Failed to parse AI response"})}catch(r){return console.error("Error in modifyExistingData:",r),{ok:!1,error:String(r)}}}async selectAndFilterData(e,t,n=[]){try{this.setContext({operation:"extract",filters:t,searchTerms:n}),await this.giveForRequest('\nYou are a data selection and filtering assistant. Your task is to find and select data matching the criteria.\n\nSelection rules:\n1. Apply all filters in order (AND logic by default).\n2. Rank results by relevance to search terms.\n3. Include confidence scores for fuzzy matches.\n4. Group similar results to avoid duplicates.\n\nCRITICAL: Output ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { and end with }.\n\nExpected output structure:\n{\n    "selected_items": [ /* items matching criteria */ ],\n    "total_matches": number,\n    "filter_stats": { /* breakdown by filter */ },\n    "suggestions": [ /* related items that might be relevant */ ]\n}\n'),await this.giveForRequest(`data_set: \`${de(e)}\`\n`);const r=t.map(e=>`Filter: ${e.field} ${e.operator} ${JSON.stringify(e.value)}`).join("\n");await this.askToDoAction(`\nSelect items from the provided data set matching these criteria:\n${r}\n${n.length?`\nSearch terms: ${n.join(", ")}`:""}\n\nReturn matching items with relevance scores.\n            `);const o=await this.sendRequest("medium","low",null,{responseFormat:"json",temperature:.1}),i=xe(o);return i.ok?{ok:!0,data:i.data?.selected_items||i.data,responseId:this.responseId}:(console.warn("JSON extraction failed:",i.error,"Raw:",i.raw),{ok:!1,error:i.error||"Failed to parse AI response"})}catch(r){return console.error("Error in selectAndFilterData:",r),{ok:!1,error:String(r)}}}async mergeEntities(e,t,n="prefer_primary"){try{this.setContext({operation:"merge",existingData:e}),await this.giveForRequest('\nYou are an entity merging assistant. Your task is to intelligently merge multiple entities or data sources.\n\nMerge rules:\n1. Prefer newer/more complete data when conflicts arise.\n2. Combine arrays without duplicates.\n3. Merge nested objects recursively.\n4. Preserve IDs and relationships.\n5. Track the source of each merged field.\n\nCRITICAL: Output ONLY valid JSON. No markdown code blocks, no explanations, no prose.\nYour response must start with { and end with }.\n\nExpected output structure:\n{\n    "merged_entity": { /* result of merge */ },\n    "conflicts_resolved": [ /* list of conflicts and how they were resolved */ ],\n    "sources_used": [ /* which source contributed what */ ],\n    "merge_confidence": number\n}\n'),await this.giveForRequest(`primary_entity: \`${de(e)}\`\n`),await this.giveForRequest(`secondary_data: \`${de(t)}\`\n`),await this.askToDoAction(`\nMerge the secondary data into the primary entity using "${n}" strategy:\n- prefer_primary: Keep primary values when conflicts occur\n- prefer_secondary: Use secondary values when conflicts occur\n- prefer_newer: Compare timestamps and use newer values\n- merge_all: Combine all unique values (arrays concatenated, objects deeply merged)\n\nReturn the merged entity with conflict resolution details.\n            `);const r=await this.sendRequest("high","medium",null,{responseFormat:"json",temperature:.2}),o=xe(r);return o.ok?{ok:!0,data:o.data?.merged_entity||o.data,responseId:this.responseId}:(console.warn("JSON extraction failed:",o.error,"Raw:",o.raw),{ok:!1,error:o.error||"Failed to parse AI response"})}catch(r){return console.error("Error in mergeEntities:",r),{ok:!1,error:String(r)}}}async searchSimilar(e,t,n=.7){try{this.setContext({operation:"analyze"}),await this.giveForRequest(`reference_entity: \`${de(e)}\`\n`),await this.giveForRequest(`candidate_set: \`${de(t)}\`\n`),await this.askToDoAction(`\nFind items in the candidate set that are similar to the reference entity.\nConsider semantic similarity, not just exact matches.\nCompare:\n- Names/titles (fuzzy match)\n- Types/kinds\n- Properties overlap\n- Relationships\n\nReturn items with similarity score >= ${n}\n\nExpected output structure:\n{\n    "similar_items": [\n        { "item": {...}, "similarity": 0.85, "match_reasons": [...] }\n    ],\n    "potential_duplicates": [...],\n    "related_but_different": [...]\n}\n            `);const r=await this.sendRequest("medium","medium",null,{responseFormat:"json",temperature:.3}),o=xe(r);return o.ok?{ok:!0,data:o.data?.similar_items||[],responseId:this.responseId}:(console.warn("JSON extraction failed:",o.error,"Raw:",o.raw),{ok:!1,error:o.error||"Failed to parse AI response"})}catch(r){return console.error("Error in searchSimilar:",r),{ok:!1,error:String(r)}}}async batchProcess(e,t,n=10){const r=[],o=[];for(let i=0;i<e.length;i+=n){const a=e.slice(i,i+n);await this.giveForRequest(`batch_items: \`${de(a)}\`\n`),await this.askToDoAction(`\nProcess this batch of ${a.length} items:\n${t}\n\nReturn processed items in same order.\nExpected output: { "processed": [...], "failed": [...] }\n            `);const s=await this.sendRequest("medium","low",null,{responseFormat:"json"});if(s){const e=xe(s);e.ok&&e.data?(r.push(...e.data?.processed||[]),e.data?.failed?.length&&o.push(...e.data.failed.map(e=>e?.error||"Unknown error"))):console.warn("Batch parsing failed:",e.error)}}return{ok:0===o.length,data:r,error:o.length?o.join("; "):void 0,responseId:this.responseId}}clearPending(){return this.pending.splice(0,this.pending.length),this}getResponseId(){return this?.responseId}getMessages(){return this?.messages}getPending(){return this?.pending}getContext(){return this?.context}getResponse(e){return this?.responseMap?.get?.(e)}}const Te=(e,t,n)=>new Re(e,t||"https://api.proxyapi.ru/openai/v1","",n||"gpt-5.2"),Ie="queue";async function $e(e=!1){const t=await new Promise((e,t)=>{const n=indexedDB.open("req-queue",3);n.onupgradeneeded=()=>{const e=n.result;e.objectStoreNames.contains(Ie)&&e.deleteObjectStore(Ie);const t=e.createObjectStore(Ie,{keyPath:"id",autoIncrement:!0});t.createIndex("byLockedId",["locked","id"],{unique:!1}),t.createIndex("byLockedAt","lockedAt",{unique:!1})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)});try{return await function(e,t,n){return new Promise((r,o)=>{const i=e.transaction(Ie,t),a=i.objectStore(Ie);let s=!1;const c=(e,t)=>{s||(s=!0,e?o(e):r(t))};Promise.resolve().then(()=>n(a)).then(e=>{i.oncomplete=()=>c(void 0,e),i.onerror=()=>c(i.error||new Error("Transaction error")),i.onabort=()=>c(i.error||new Error("Transaction aborted"))}).catch(e=>{try{i.abort()}catch{}c(e)})})}(t,"readwrite",async t=>{const n=await new Promise((e,n)=>{const r=t.getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>n(r.error)});return await new Promise((e,n)=>{const r=t.clear();r.onsuccess=()=>e(),r.onerror=()=>n(r.error)}),e?n:n.map(e=>e.payload)})}finally{t.close()}}const Ae=(e,t,n="relations",r="Location",o)=>({name:e,label:r,path:t,section:n,textarea:!0,helper:"String or JSON representation of the location"}),Ne=e=>[{name:"contacts.email",label:"Emails",path:`${e}.email`,section:"contacts",textarea:!0,helper:"One email per line",multi:!0},{name:"contacts.phone",label:"Phones",path:`${e}.phone`,section:"contacts",textarea:!0,helper:"One phone per line",multi:!0},{name:"contacts.links",label:"Links",path:`${e}.links`,section:"contacts",textarea:!0,helper:"One link per line",multi:!0}],Ee=(e,t,n,r,o="properties",i)=>{return{name:e,label:t,path:n,section:o,helper:i,options:(a=r,(a??[]).map(e=>e))};var a},Ce=["male","female","other"],Oe=(e,t,n,r="schedule")=>[{name:`${e}.date`,label:`${t} (Date)`,path:`${n}.date`,section:r,placeholder:"YYYY-MM-DD"},{name:`${e}.iso_date`,label:`${t} (ISO)`,path:`${n}.iso_date`,section:r,placeholder:"YYYY-MM-DDTHH:MM",helper:"ISO 8601 date-time"},{name:`${e}.timestamp`,label:`${t} (Timestamp)`,path:`${n}.timestamp`,section:r,numeric:!0,type:"number",helper:"Unix milliseconds"}],Fe=(e,t,n,r="relations",o)=>({name:e,label:t,path:n,section:r,textarea:!0,multi:!0,helper:o}),De=(e,t,n,r="properties",o)=>({name:e,label:t,path:n,section:r,json:!0,textarea:!0,helper:o}),Pe=(e,t,n,r="properties",o,i)=>({name:e,label:t,path:n,section:r,placeholder:o,helper:i}),Ue=(e,t,n,r="properties",o)=>({name:e,label:t,path:n,section:r,numeric:!0,type:"number",helper:o});Ee("variant","Variant","variant",["red","green","blue","yellow","orange","purple","brown","gray","black","white"],"meta","Visual accent colour");const ze={task:["job","action","other"],event:["education","lecture","conference","meeting","seminar","workshop","presentation","celebration","opening","other"],action:["thinking","imagination","remembering","speaking","learning","listening","reading","writing","moving","traveling","speech","physically","crafting","following","other"],service:["product","consultation","advice","medical","mentoring","training","item","thing","other"],item:["currency","book","electronics","furniture","medicine","tools","software","consumables","other"],skill:["skill","knowledge","ability","trait","experience","other"],vendor:["vendor","company","organization","institution","other"],place:["placement","place","school","university","service","clinic","pharmacy","hospital","library","market","location","shop","restaurant","cafe","bar","hotel","other"],factor:["weather","health","family","relationships","job","traffic","business","economy","politics","news","other"],person:["specialist","consultant","coach","mentor","dear","helper","assistant","friend","family","relative","other"],bonus:[]},je={task:{kind:ze.task,fields:[Ee("status","Status","properties.status",["under_consideration","pending","in_progress","completed","failed","delayed","canceled","other"],"properties","Task state"),...Oe("begin_time","Begin","properties.begin_time"),...Oe("end_time","End","properties.end_time"),Ae("location","properties.location"),...Ne("properties.contacts"),Fe("members","Members","properties.members","relations","Entity IDs, one per line"),Fe("events","Events","properties.events","relations","Event IDs, one per line")]},event:{kind:ze.event,fields:[...Oe("begin_time","Begin","properties.begin_time"),...Oe("end_time","End","properties.end_time"),Ae("location","properties.location"),...Ne("properties.contacts")]},action:{kind:ze.action,fields:[Pe("affect","Affect","properties.affect","properties","Describe impact or affect"),Fe("steps","Steps","properties.steps","properties","Action steps, one per line"),Fe("related","Related","properties.related","relations","Related entity IDs, one per line")]},service:{kind:ze.service,fields:[Ae("location","properties.location"),Fe("persons","Persons","properties.persons","relations","Person IDs, one per line"),Fe("specialization","Specializations","properties.specialization","properties","Specializations, one per line"),...Ne("properties.contacts"),De("prices","Prices","properties.prices","properties","JSON map: service => price")]},item:{kind:ze.item,fields:[Ue("price","Price","properties.price","properties","Price as number"),Ue("quantity","Quantity","properties.quantity"),Fe("availability","Availability","properties.availability","properties","Availability notes, one per line"),De("attributes","Attributes","properties.attributes","properties","Additional item attributes in JSON")]},skill:{kind:ze.skill,fields:[Pe("level","Level","properties.level","properties","e.g. beginner, intermediate"),Fe("category","Categories","properties.category","properties","Categories, one per line"),Fe("related","Related","properties.related","relations","Related skill or entity IDs")]},vendor:{kind:ze.vendor,fields:[Ae("location","properties.location"),...Ne("properties.contacts"),Fe("services","Services","properties.services","relations","Service IDs, one per line")]},place:{kind:ze.place,fields:[Ae("location","properties.location","properties"),Fe("services","Services","properties.services","relations","Related service IDs"),...Ne("properties.contacts")]},factor:{kind:ze.factor,fields:[Ee("affect","Affect","properties.affect",["positive","negative","neutral"],"properties","Overall impact"),Fe("actions","Actions","properties.actions","relations","Action IDs, one per line"),Ae("location","properties.location","properties")]},person:{kind:ze.person,fields:[Ae("home","properties.home","properties","Home location"),Fe("jobs","Jobs","properties.jobs","properties","Job locations, one per line"),...(Me="properties.biography",[{name:"biography.firstName",label:"First name",path:`${Me}.firstName`,section:"main"},{name:"biography.lastName",label:"Last name",path:`${Me}.lastName`,section:"main"},{name:"biography.middleName",label:"Middle name",path:`${Me}.middleName`,section:"main"},{name:"biography.nickName",label:"Nick name",path:`${Me}.nickName`,section:"main"},{name:"biography.birthdate",label:"Birth date",path:`${Me}.birthdate`,section:"meta",placeholder:"YYYY-MM-DD or ISO date"},Ee("biography.gender","Gender",`${Me}.gender`,Ce,"meta")]),Fe("tasks","Tasks","properties.tasks","relations","Task IDs, one per line"),...Ne("properties.contacts"),Fe("services","Services","properties.services","relations","Service IDs, one per line"),De("prices","Prices","properties.prices","properties","JSON map: service => price")]},bonus:{kind:ze.bonus,fields:[Pe("code","Code","properties.code","properties","Readable bonus code"),Fe("usableFor","Usable for","properties.usableFor","relations","Entity IDs, one per line"),Fe("usableIn","Usable in","properties.usableIn","relations","Location IDs, one per line"),Ue("availability.count","Availability count","properties.availability.count","properties"),Fe("availability.time","Availability time","properties.availability.time","properties","Time ranges, one per line"),Fe("availability.days","Availability days","properties.availability.days","properties","Day names, one per line"),De("requirements","Requirements","properties.requirements","properties","JSON array of requirements"),De("additionalProperties","Additional properties","properties.additionalProperties","properties","JSON map of extra properties"),De("profits","Profits","properties.profits","properties","JSON map: target => profit value")]}};var Me;function Le(e){if(null==e)return null;if(e instanceof Date)return Number.isFinite(e.getTime())?e:null;if("number"==typeof e){const t=new Date(e);return Number.isFinite(t.getTime())?t:null}if("object"==typeof e){const t=e;if(null!=t.timestamp)return Le(t.timestamp);if(null!=t.iso_date)return Le(t.iso_date);if(null!=t.date)return Le(t.date)}if("string"==typeof e){const t=e.trim();if(!t)return null;if(/^\d+$/.test(t)){const e=Number(t),n=new Date(e);if(Number.isFinite(n.getTime()))return n}const n=new Date(t);return Number.isFinite(n.getTime())?n:null}return null}const We="CODE",qe=/^[a-z0-9\-_&#\+]+$/,Be=/^[a-z0-9\-_&#\+]+(?:_CODE[0-9A-Z]*)?$/,Je=e=>e.normalize("NFKD").replace(/[\u0300-\u036f]/g,""),Ge=e=>null==e?null:"string"==typeof e&&e.trim().length>0?e:"number"==typeof e||"bigint"==typeof e?String(e):null,Ye=e=>{if(!e)return"";return Je(e).toLowerCase().replace(/[\s]+/g,"-").replace(/[^a-z0-9\-_&#\+]+/g,"-").replace(/-{2,}/g,"-").replace(/_{2,}/g,"_").replace(/^-+|-+$/g,"").replace(/^_+|_+$/g,"")},Ke=e=>{const t=Ge(e);if(!t)return"";const n=Je(t).replace(/\s+/g,"").replace(/[^A-Za-z0-9\-_&#\+]+/g,"");if(!n)return"";const r=n.toUpperCase();return r.startsWith(We)?r:`${We}${r}`},Ve=e=>{if(!e)return!1;if("bonus"===e.type)return!0;const t=e?.properties&&e.properties?.code;return"string"==typeof t&&t.trim().length>0},He=(e,t)=>{if(null==t)return;if(Array.isArray(t))return void t.forEach(t=>He(e,t));const n="object"==typeof t?(e=>{if("string"==typeof e)return e;if(e&&"object"==typeof e){const t=e.address;if("string"==typeof t)return t;if(t&&"object"==typeof t){const e=[];if(["street","house","flat","room"].forEach(n=>{const r=Ge(t[n]);r&&e.push(r)}),e.length>0)return e.join("-")}const n=e.coordinate;if(n&&"object"==typeof n){const e=Ge(n.latitude),t=Ge(n.longitude);if(e&&t)return`${e}-${t}`}const r=Ge(e.name);if(r)return r;const o=Ge(e.title);if(o)return o}return null})(t):Ge(t),r=Ye(n);r&&e.add(r)},Qe=e=>{if(e)return e instanceof Set?e:new Set(e)},Xe=(e,t,n)=>{const r=null!=n?`-${n}`:"";return t?e?`${e}_${t}${r}`:`${t}${r}`:`${e}${r}`},Ze=(e,t,n)=>{if(!e)return e;if(e.length+n<=t)return e;const r=Math.max(0,t-n);if(0===r)return"";return e.slice(0,r).replace(/[-_]+$/g,"")},et=(e,t,n,r)=>{const o=Xe(e,t);if(!n||!n.has(o))return o;let i=2;for(;i<1e4;){const r=Xe(e,t,i);if(!n.has(r))return r;i+=1}return o},tt=(e,t)=>{const n=new Set;if(!e)return[];if(t?.prefer?.forEach(e=>He(n,e)),"person"===e.type){const t=e.properties?.biography??{},r=[Ge(t?.firstName),Ge(t?.middleName),Ge(t?.lastName)].filter(Boolean);r.length>0&&He(n,r.join("-")),He(n,t?.nickName);const o=e.properties?.jobs;o&&He(n,Array.isArray(o)?o[0]:o)}if("bonus"===e.type){const t=e.properties?.usableFor,r=e.properties?.usableIn;t&&He(n,Array.isArray(t)?t[0]:t),r&&He(n,Array.isArray(r)?r[0]:r)}return He(n,e.name),He(n,e.title),He(n,e.kind),He(n,e.type),0===n.size&&He(n,t?.fallback??e.type??"entity"),He(n,e.properties?.begin_time?Le?.(e.properties?.begin_time)?.toLocaleString?.("en-GB",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hour12:!1})?.trim()?.toLowerCase?.()?.replace?.(/\s+/g,"_")?.replace?.(/[\,\-\_\:\.\\\/]/g,"-")?.replace?.(/[\"\'\(\)\[\]]/g,"")?.replace?.(/\-\-/g,"_"):null),Array.from(n).filter(e=>e.length>0)},nt=(e,t={mutate:!0,rebuild:!0})=>{const n=t.maxLength??96,r=Ve(e),o=Qe(t.existingIds),i=!0===t.rebuild;let a=((e,t,n)=>{if(!e)return"";let r=Je(e);r=r.replace(/[\s]+/g,"-");let o="";if(t){const e=r.match(/(_CODE[0-9A-Za-z]*)$/i);e&&(o=Ke(e[0].slice(1)),r=r.slice(0,e.index??0))}const i=Ye(r)||"";if(!i&&!o)return"";const a=o?o.length+(i?1:0):0,s=Ze(i,n,a);return Xe(s,o||void 0)})(Ge(e?.id)??"",r,n);if(!i&&a&&((e,t=!1)=>!!e&&(t?Be.test(e):qe.test(e)))(a,r)||(a=((e,t={})=>{const n=t.maxLength??96,r=Ve(e)?Ke(e.properties?.code):"",o=tt(e,t).join("_"),i=r?r.length+(o?1:0):0,a=Ze(o,n,i),s=Qe(t.existingIds),c=et(a,r,s);return t.mutateExistingIds&&s&&s.add(c),c})(e,{...t,existingIds:o})),o&&o.has(a)){const t=a.replace(/(?:-[0-9]+)?$/,""),n=r?t.replace(/_CODE[0-9A-Z]*$/i,""):t;a=et(n,r?Ke(e.properties?.code):"",o)}return t.mutateExistingIds&&o&&o.add(a),!1!==t.mutate&&e&&(e.id=a),a};async function rt(t){const{dirPath:n,transform:r,filter:o,indent:i=2,dryRun:a=!1,prettyStable:s=!0}=t;!function(){if(!("storage"in navigator)||"function"!=typeof navigator.storage.getDirectory)throw new Error("OPFS is not available in this browser/context. Need navigator.storage.getDirectory().")}();const c=await(navigator.storage.getDirectory()?.catch?.(console.warn.bind(console))),l=(u=n)&&"/"!==u&&"."!==u?u.split("/").filter(Boolean).join("/"):"";var u;const d=await async function(e,t){if(!t||"/"===t||"."===t)return e;const n=t.split("/").map(e=>e.trim()).filter(Boolean);let r=e;for(const o of n)r=await(r?.getDirectoryHandle?.(o,{create:!1}));return r}(c,l);let p=0,m=0,f=0;for await(const{handle:y,name:w,fullPath:b}of ot(d,l))if("file"===y.kind&&w.toLowerCase().endsWith(".json")&&(!o||o(w,b)))try{const t=await y.getFile(),n=await t.text();let o;try{o=""===n.trim()?null:e.parse(n)}catch(h){try{o=""===n.trim()?null:JSON.parse(n)}catch(g){console.warn(`JSON parse error: ${b}`,g),f++;continue}}const c=await r(o,{path:l,name:w,fullPath:b});if(void 0===c){p++;continue}const u=it(c,{indent:i,prettyStable:s});if(st(u)===st(n)){p++;continue}if(a)console.log(`[dry-run] Would update: ${b}`);else{const e=await y.createWritable();await e.truncate(0),await e.write(u),await e.close(),console.log(`Updated: ${b}`)}p++,m++}catch(g){console.error(`Failed on ${b}:`,g),f++}return{processed:p,changed:m,errors:f}}async function*ot(e,t=""){for await(const[n,r]of e.entries()){const e=t?`${t}/${n}`:n;"directory"===r.kind?yield*ot(r,e):yield{handle:r,name:n,fullPath:e}}}function it(e,{indent:t=2,prettyStable:n=!0}={}){const r=n?at:void 0;return JSON.stringify(e,r,t)+"\n"}function at(e,t){if(t&&"object"==typeof t&&!Array.isArray(t)){const e={};for(const n of Object.keys(t).sort())e[n]=t[n];return e}return t}function st(e){return e.replace(/\r\n/g,"\n")}const ct=async e=>{const t="string"==typeof e?await n(null,e):e,r=await Array.fromAsync(t?.entries?.()??[]);return Promise.all(r?.map?.(e=>(async e=>{if(Array.isArray(e)&&(e=e?.[0]),!e)return null;const t=await(e?.getFile?.());return ut(await(t?.text?.())||"{}")})(e)))},lt=async(n,r=null)=>{if(!n)return;const o=async(n,o=0)=>{if(!n)return;if(!(n=ut(n)))return;const i=n?.type??(t=>{let n="unknown";if("object"!=typeof(t="string"==typeof t?e.parse(t):t))return n;if(t.type&&t.properties&&t.kind)return t.type;let r=new Set;for(const e in ze)ze[e].includes(t.kind)&&r.add(e);const o=[...Object.entries(je)]?.filter?.(([e,t])=>r.has(e));let i=new Set;null==t?.properties?.begin_time&&null==t?.properties?.end_time||o?.forEach(([e,t])=>{null!=t.properties?.begin_time&&null!=t.properties?.end_time&&i.add(e)});let a=new Set;null!=t?.properties?.location&&o?.forEach(([e,t])=>{null!=t.properties?.location&&a.add(e)});let s=new Set;null!=t?.properties?.prices&&o?.forEach(([e,t])=>{null!=t.properties?.prices&&s.add(e)});let c=new Set;null!=t?.properties?.contacts&&o?.forEach(([e,t])=>{null!=t.properties?.contacts&&c.add(e)});const l=new Map;return[...c,...a,...s,...i].forEach(e=>{l.set(e,(l.get(e)||0)+1)}),n=0==l.size?[...r]?.[0]:[...l.entries()].reduce((e,t)=>e[1]>t[1]?e:t)[0],n||"unknown"})(n)??"unknown";var a;r||(r=(a=[i],a?.map?.(e=>"timeline"==e||"task"==e?"/timeline/":`/data/${e}/`))?.[0]),r=r?.trim?.();let s=(nt(n)||n?.name||`${Date.now()}`)?.toString?.()?.toLowerCase?.()?.replace?.(/\s+/g,"-")?.replace?.(/[^a-z0-9_\-+#&]/g,"-");return s=s?.trim?.(),s=s?.endsWith?.(".json")?s:s+".json",t(null,`${r}${s}`,new File([e.stringify(n)],s,{type:"application/json"}))?.catch?.(console.warn.bind(console))};let i=await((Array.isArray(n)?Promise.all(n.map((e,t)=>o(e,t))):o(n,0))?.catch?.(console.warn.bind(console)));return"undefined"!=typeof document&&document?.dispatchEvent?.(new CustomEvent("rs-fs-changed",{detail:i,bubbles:!0,composed:!0,cancelable:!0})),i},ut=t=>{if(!t)return null;if("string"!=typeof t)return t;try{return e.parse(t)}catch(n){try{return JSON.parse(t)}catch(r){return console.warn("Failed to parse JSON",t),t}}},dt=e=>{try{e="string"==typeof e?JSON.parse(e?.trim?.()||"[]"):e}catch(t){}return e?.recognized_data?dt(e?.recognized_data):"string"==typeof e&&e?.trim?.()?e?.trim?.():Array.isArray(e)&&e?.length&&e?.map?.(e=>dt(e))?.filter?.(e=>e&&"string"==typeof e)?.join?.("\n")||""};async function pt(){const e=await $e();return Promise.all(e.map(e=>{const{data:n,name:r,dataType:o,directory:i}=e;if("json"===o){let e=ut(n);if(!e)return;return lt(e,i?.trim?.())}return(async(e,n=null)=>{if(!e)return;n=n?.trim?.();let r=(`${Date.now()}`?.toString?.()?.toLowerCase?.()?.replace?.(/\s+/g,"-")?.replace?.(/[^a-z0-9_\-+#&]/g,"-")?.trim?.()||`${Date.now()}`)+".md";n?r=n?.split?.("/")?.pop?.()||r:n="/docs/preferences/",r=r?.endsWith?.(".md")?r:r+".md";let o=await(t(null,n,e instanceof File?e:new File([e],r,{type:"text/markdown"}))?.catch?.(console.warn.bind(console)));return"undefined"!=typeof document&&document?.dispatchEvent?.(new CustomEvent("rs-fs-changed",{detail:o,bubbles:!0,composed:!0,cancelable:!0})),o})(n,i?.trim?.()+r?.trim?.())}))}new BroadcastChannel("rs-sw").addEventListener("message",e=>{const t=e?.data;if(t&&("commit-result"===t?.type||"commit-to-clipboard"===t?.type))if("commit-result"===t?.type)pt?.()?.then?.(()=>{d("Data has been saved to the filesystem.")})?.catch?.(e=>{console.warn("Failed to save data to filesystem.",e,t),p("Failed to save data to filesystem.")});else if("commit-to-clipboard"===t?.type){const e=t?.results?.map?.(e=>dt(e?.data?.recognized_data||e?.data))?.filter?.(e=>e&&"string"==typeof e)?.join?.("\n")||"";e?.trim?.()?navigator?.clipboard?.writeText?.(e)?.then?.(()=>{d("Data has been copied to clipboard.")})?.catch?.(t=>{console.warn("Failed to copy data to clipboard.",t,e),p("Failed to copy data to clipboard. Data is not copied.")}):p("Failed to copy data to clipboard. Data is empty.")}}),"undefined"!=typeof navigator&&"storage"in navigator&&"function"==typeof navigator.storage.getDirectory&&("function"==typeof requestIdleCallback?requestIdleCallback?.(()=>{pt()}):setTimeout(()=>{pt()},1e3));try{rt({dirPath:"/data/",transform:e=>(e&&"object"==typeof e&&nt(e,{mutate:!0}),e)})?.catch?.(console.warn.bind(console))}catch(In){console.warn(In)}try{rt({dirPath:"/timeline/",transform:e=>(e&&"object"==typeof e&&nt(e,{mutate:!0}),e)})?.catch?.(console.warn.bind(console))}catch(In){console.warn(In)}const mt="cache",ft=async()=>new Promise((e,t)=>{const n=indexedDB.open(mt,1);n.onupgradeneeded=()=>n.result.createObjectStore(mt,{keyPath:"key"}),n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}),ht=async(e,t)=>{const n=await ft();return new Promise((r,o)=>{const i=n.transaction(mt,"readwrite");i.objectStore(mt).put({key:e,value:t}),i.oncomplete=()=>{r(void 0),n.close()},i.onerror=()=>{o(i.error),n.close()}})},gt=o({time:new Date,timestamp:Date.now(),coords:{},otherProps:new Map([]),cards:new Map([])}),yt=t=>(Object.defineProperty(t,"items",{get:()=>m((async()=>((t,n)=>{const r=o(n);let s;return a(r,(n,o)=>{clearTimeout(s),s=setTimeout(()=>{ht(t?.id,e.stringify(i(r)))?.catch?.(console.warn.bind(console))},100)}),r})(t,e.parse(await(async e=>{const t=await ft();return new Promise((n,r)=>{const o=t.transaction(mt,"readonly").objectStore(mt).get(e);o.onsuccess=()=>{n(o.result?.value),t.close()},o.onerror=()=>{r(o.error),t.close()}})})(t?.id)??"[]")))()),set:n=>{ht(t?.id,e.stringify(i(n)))?.catch?.(console.warn.bind(console))}}),t),wt=e=>o(yt(e));o([wt({label:"Tasks",id:"task"})]),o([wt({label:"Items",id:"item"}),wt({label:"Bonuses",id:"bonus"}),wt({label:"Services",id:"service"}),wt({label:"Locations",id:"location"}),wt({label:"Events",id:"events"}),wt({label:"Factors",id:"factor"}),wt({label:"Entertainments",id:"entertainment"}),wt({label:"Markets",id:"market"}),wt({label:"Places",id:"place"}),wt({label:"Vendors",id:"vendor"}),wt({label:"Persons",id:"person"}),wt({label:"Skills",id:"skill"}),wt({label:"Vehicles",id:"vehicle"}),wt({label:"Rewards",id:"reward"}),wt({label:"Fines",id:"fine"}),wt({label:"Actions",id:"action"}),wt({label:"Lotteries",id:"lottery"})]);new BroadcastChannel("geolocation").addEventListener("message",t=>{t.data.coords&&(gt.coords=("string"==typeof t.data.coords?e.parse(t.data.coords):t.data.coords)||{},gt.timestamp=Date.now(),gt.time=new Date)}),setInterval(()=>{gt.time=new Date},1e3);function bt(e){if(!e)return new Date;if(e instanceof Date)return new Date(e);if("object"==typeof e&&e?.timestamp)return bt(e.timestamp);if("object"==typeof e&&e?.iso_date)return bt(e.iso_date);if("object"==typeof e&&e?.date)return bt(e.date);if("number"==typeof e){if(e>=1e12)return new Date(e);const t=0|Math.pow(10,11-(String(0|e)?.length||11));return new Date(e*t)}if("string"==typeof e&&function(e){return!!e&&/^([01]\d|2[0-3]):([0-5]\d)$/.test(String(e).trim())}(e)){const t=/^([01]\d|2[0-3]):([0-5]\d)$/.exec(e.trim());if(!t)return new Date;const[,n,r]=t,o=new Date;return new Date(o.getFullYear(),o.getMonth(),o.getDate(),Number(n),Number(r),0,0)}return new Date(String(e))}const xt=e=>{if(null==e)return Number.NaN;if("number"==typeof e&&Number.isFinite(e))return e;const t=bt(e);if(t&&!Number.isNaN(t?.getTime()))return t?.getTime()??0;const n=String(e).match(/^(\d{1,2})(?::(\d{2}))?(?::(\d{2}))?/);if(n){return 1e3*(60*(60*(Number(n[1])||0)+(Number(n[2])||0))+(Number(n[3])||0))}const r=Number(e);return Number.isFinite(r)?r:Number.NaN},St=(e,t,n,r=7)=>{let o=!0;if(e&&(o&&=xt(n)<=xt(e)),t&&(o&&=xt(n)<xt(t)),r){const t=xt(n)+24*r*60*60*1e3;o&&=xt(e)<xt(t)}return o},kt=async(e=null,t=null)=>{const n=await s();if(!n||!n?.ai||!n.ai?.apiKey)return;const o=new Re(n.ai?.apiKey||"",n.ai?.baseUrl||"https://api.proxyapi.ru/openai/v1","",n.ai?.model||"gpt-5.2");console.log(o),await(o?.giveForRequest?.(`factors: \`${de(((e,t,n=7)=>e?.filter?.(e=>St(e?.properties?.begin_time,e?.properties?.end_time,t,n)))(await ct("/data/factors/"),gt?.time))}\`\n`)),await(o?.giveForRequest?.(`events: \`${de(((e,t,n=7)=>e?.filter?.(e=>St(e?.properties?.begin_time,e?.properties?.end_time,t,n)))(await ct("/data/events/"),gt?.time))}\`\n`)),e?await(o?.giveForRequest?.(`preferences: \`\`\`${de(await(async e=>{const t=await r(null,e);return t?t?.type?.startsWith?.("image/")?"":await(t?.text?.()):""})(e))}\`\`\`\n`)):t?.trim?.()&&t?.trim?.()?.length||await(o?.giveForRequest?.("preferences: Make generic working plan for next 7 days...\n")),t?.trim?.()&&t?.trim?.()?.length&&await(o?.giveForRequest?.(`speech_prompt: \`${de(t)}\`\n`)),await(o?.askToDoAction?.(["primary_request:","Analyze starting and existing data, and get be ready to make a new timeline (preferences data will be attached later)...","Also, can you provide markdown pre-formatted verbose data about what you have analyzed and what you will do?","Give ready status in JSON format: `{ ready: boolean, reason: string, verbose_data: string }`"]?.join?.("\n")));const i=Se(await(o?.sendRequest?.("high","high"))||'{ ready: false, reason: "No attached data", verbose_data: "" }');return i?.ok?i?.data:(console.error("timeline",i?.error||"Failed to parse AI response"),{timeline:[],keywords:[]})},vt="gpt-5.2",_t="https://api.proxyapi.ru/openai/v1",Rt=async e=>{const t=await s(),n=t?.ai?.apiKey;if(!n)return null;return Te(n,t?.ai?.baseUrl||_t,t?.ai?.model||vt)};function Tt(e){return e instanceof File&&e.type.startsWith("image/")||e instanceof Blob&&e.type?.startsWith("image/")||"string"==typeof e&&(e.startsWith("data:image/")||e.startsWith("http")||e.startsWith("https://"))}let It=s;const $t=async()=>{const e=(()=>{try{return"undefined"!=typeof chrome&&chrome?.runtime?.id?"crx":"undefined"!=typeof self&&"ServiceWorkerGlobalScope"in self||"undefined"!=typeof navigator&&"standalone"in navigator?"pwa":"core"}catch{return"unknown"}})();try{return"crx"===e?await s():await(async()=>{try{return await It()||c}catch{return c}})()}catch(In){return console.error(`[AI-Service] Failed to load settings for platform ${e}:`,In),null}},At=async()=>{try{const{getActiveInstructionText:e}=await l(async()=>{const{getActiveInstructionText:e}=await import("../modules/CustomInstructions.js").then(e=>e.CustomInstructions);return{getActiveInstructionText:e}},[],import.meta.url);return await e()}catch{return""}},Nt=async()=>{try{const e=await $t(),t=e?.ai?.responseLanguage||"auto",n=e?.ai?.translateResults||!1;let r=I[t]||"";return n&&"auto"!==t&&(r+=$),r}catch{return""}},Et=async()=>{try{const e=await $t();return e?.ai?.generateSvgGraphics?A:""}catch{return""}},Ct=async(e,t,n,r)=>{const{recognizeByInstructions:o}=await l(async()=>{const{recognizeByInstructions:e}=await Promise.resolve().then(()=>zt);return{recognizeByInstructions:e}},void 0,import.meta.url);return o(e,x,t,n,r)},Ot=(e,t)=>({ok:!1,recognized_data:[],keywords_and_tags:[],verbose_data:"",suggested_type:null,confidence:0,source_kind:"unknown",processing_time_ms:t,errors:e,warnings:[]}),Ft=async(e,t,n,r,o)=>{const i=await Rt();if(!i)return Ot(["AI service not available"],0);const a=Date.now();try{const s=await Nt(),c=t+s+await Et();let l="";o?.customInstruction?l=o.customInstruction:o?.useActiveInstruction&&(l=await At()),l&&await i.askToDoAction(l),await i.askToDoAction(c),await i.giveForRequest(e);const u=await i.sendRequest("high","medium"),d=Date.now()-a;return u?{ok:!0,recognized_data:[u],keywords_and_tags:n,verbose_data:u,suggested_type:r,confidence:.9,source_kind:"text",processing_time_ms:d,errors:[],warnings:[]}:Ot([`Failed to get ${r} response`],d)}catch(In){return Ot([String(In)],Date.now()-a)}};const Dt=new class{cache=new Map;maxEntries=100;ttl=864e5;generateDataHash(e){return e instanceof File?`${e.name}-${e.size}-${e.lastModified}`:"string"==typeof e?btoa(e).substring(0,32):JSON.stringify(e).substring(0,32)}get(e,t){const n=this.generateDataHash(e),r=this.cache.get(n);return r?Date.now()-r.timestamp>this.ttl?(this.cache.delete(n),null):t&&r.recognizedAs!==t?null:r:null}set(e,t,n,r,o){const i=this.generateDataHash(e);if(this.cache.size>=this.maxEntries){const e=Array.from(this.cache.entries()).sort(([,e],[,t])=>e.timestamp-t.timestamp)[0][0];this.cache.delete(e)}this.cache.set(i,{dataHash:i,recognizedData:t,recognizedAs:n,timestamp:Date.now(),responseId:r,metadata:o})}clear(){this.cache.clear()}getStats(){return{entries:this.cache.size,maxEntries:this.maxEntries,ttl:this.ttl}}},Pt=async(e,t={},n)=>{const r=(await s())?.ai,{instruction:o="",outputFormat:i="auto",outputLanguage:a="auto",enableSVGImageGeneration:c="auto",intermediateRecognition:l,processingEffort:u="low",processingVerbosity:d="low",customInstruction:p,useActiveInstruction:m=!1,includeImageRecognition:f,dataType:h}=t,g=r?.apiKey;if(!g){const e={ok:!1,error:"No API key available"};return n?.(e),e}if(!e){const e={ok:!1,error:"No input provided"};return n?.(e),e}let y=o;if(p)y=N(y,p);else if(m){const e=await At();e&&(y=N(y,e))}const w=await Nt();w&&(y+=w);if(!0===c||"auto"===c&&"html"===i){const e=await Et();e&&(y+=e)}if("auto"!==i){const e=C(i);e&&(y+=e)}const b=Te(g,r?.baseUrl||_t,r?.model||vt);b.clearPending();let x=1,S=!1;const k=[];if(Array.isArray(e)&&("message"===e?.[0]?.type||e?.[0]?.role))await(b.getPending()?.push(...e));else{const t=Array.isArray(e)?e:[e];for(const e of t){let t=e;if("string"==typeof e&&"svg"===h||"string"==typeof e&&e.trim().startsWith("<svg"))t=e;else if(Tt(e)){S=!0;if(!1!==l?.enabled&&(l?.enabled||f)){x=2;const n=l?.forceRefresh?null:Dt.get(e,l?.outputFormat);let o,i;if(n)o=n.recognizedData,i=n.responseId;else{const t=l?.dataPriorityInstruction||E(l?.outputFormat||"markdown"),n=await Ut(e,t,void 0,{baseUrl:r?.baseUrl,model:r?.model},{customInstruction:void 0,useActiveInstruction:!1});if(n.ok&&n.data){if(o=n.data,i=n.responseId||"",!1!==l?.cacheResults){const t=l?.outputFormat||"markdown";Dt.set(e,o,t,i)}}else o="",i=""}k.push({originalData:e,recognizedData:o,recognizedAs:l?.outputFormat||"markdown",responseId:i}),o&&(t=o)}}null!=t&&await(b?.attachToRequest?.(t))}}let v,_;await b.askToDoAction(y);try{v=await(b?.sendRequest?.(u,d,null,{responseFormat:(R=i,["json","xml","yaml"].includes(R)?"json":"text"),temperature:.3}))}catch(In){_=String(In)}var R;let T=v;if("string"==typeof v)try{T=JSON.parse(v)}catch{T=null}const I=T?.choices?.[0]?.message?.content;let $=I?function(e){if(!e)return e;const t=e.trim().match(/^```(?:katex|md|markdown|html|xml|json|text)?\n([\s\S]*?)\n```$/);if(t){const n=t[1].trim(),r=n.split("\n");return 1===r.length||n.includes("<math")||n.includes('<span class="katex')||n.includes("<content")||n.startsWith("<")&&n.endsWith(">")||/^\s*<[^>]+>/.test(n)?n:r.length>3||r.some(e=>e.match(/^\s{4,}/)||e.includes("function")||e.includes("const ")||e.includes("let "))?e:n}return e}(I.trim()):null,A=$;if($&&o?.includes("Recognize data from image"))try{const e=JSON.parse($);A=e?.recognized_data?Array.isArray(e.recognized_data)?e.recognized_data.join("\n"):"string"==typeof e.recognized_data?e.recognized_data:JSON.stringify(e.recognized_data):!1===e?.ok?null:$}catch{A=$}const O={ok:!!A&&!_,data:A||void 0,error:_||(A?void 0:"No data recognized"),responseId:T?.id||b?.getResponseId?.(),processingStages:x,recognizedImages:S,intermediateRecognizedData:k.length>0?k:void 0};return n?.(O),O},Ut=async(e,t,n,r,o)=>{const i=await Pt(e,{instruction:t,customInstruction:o?.customInstruction,useActiveInstruction:o?.useActiveInstruction,processingEffort:o?.recognitionEffort||"low",processingVerbosity:o?.recognitionVerbosity||"low",outputFormat:"auto",outputLanguage:"auto",enableSVGImageGeneration:"auto"}),a={ok:i.ok,data:i.data,error:i.error,responseId:i.responseId};return n?.(a),a},zt=Object.freeze(Object.defineProperty({__proto__:null,processDataWithInstruction:Pt,recognizeByInstructions:Ut},Symbol.toStringTag,{value:"Module"})),jt=/\.(?:md|markdown|mdown|mkd|mkdn|mdtxt|mdtext)(?:$|[?#])/i,Mt=e=>{try{return Boolean(new URL(e))}catch{return!1}},Lt=e=>{if(e instanceof Error){const t=e.stack?.split?.("\n")?.[1]?.trim?.();return t?`${e.name}: ${e.message} @ ${t}`:`${e.name}: ${e.message}`}return String(e)},Wt=async(e,t="snip.png")=>{try{const n=await fetch(e),r=await n.blob();try{return new File([r],t,{type:r.type||"image/png",lastModified:Date.now()})}catch{return r}}catch{return new Blob([e],{type:"text/plain"})}},qt="undefined"!=typeof requestAnimationFrame?requestAnimationFrame:"undefined"!=typeof setTimeout?e=>setTimeout(e,0):e=>e(),Bt=async e=>{const t={format:"png",scale:e?.scale??1};e?.rect&&e.rect.width>0&&e.rect.height>0&&(t.rect=e.rect);const n=await new Promise((e,n)=>{chrome.tabs.captureVisibleTab(t,t=>{chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e(t)})});let r=await(async e=>{if(e.length<=2097152)return e;try{const t=Uint8Array.fromBase64(h(e),{alphabet:"base64"}),n=new Blob([t],{type:"image/png"}),r=await createImageBitmap(n),o=await g(r);if(r?.close?.(),o)return`data:image/jpeg;base64,${new Uint8Array(o).toBase64({alphabet:"base64"})}`}catch(In){console.warn("[api] compression failed:",In)}return e})(n);return r&&await f(r)||(r=n),r},Jt={recognize:Ct,solve:async(e,t)=>Ft(e,S,["solution","answer"],"solution",t),code:async(e,t)=>Ft(e,k,["code","programming"],"code",t),css:async(e,t)=>Ft(e,v,["css","styles","stylesheet"],"css",t)},Gt=async(e,t,n="recognize",r)=>{const o=await Bt({rect:t}),i=await Wt(o,"snip.png");let a;if("custom"===n&&r?.instructionId){const e=(await O().catch(()=>[])).find(e=>e.id===r.instructionId);if(!e)return{ok:!1,error:"Custom instruction not found"};const t=[{type:"message",role:"user",content:[{type:"input_image",image_url:o}]}],n=await Ut(t,e.instruction),i=(e=>{if("string"==typeof e)return e;if(!e?.ok)return"";let t=e.data;if(t&&"string"!=typeof t)try{t=JSON.stringify(t)}catch{t=String(t)}if(!t)return"";if(t.trim().startsWith("{")||t.trim().startsWith("["))try{const e=JSON.parse(t),n=e?.recognized_data??e?.data??e?.text;if("string"==typeof n)return n.trim();if(null!=n)return JSON.stringify(n)}catch{}return("string"==typeof t?t:String(t)).trim()})(n);a={ok:n?.ok??!!i,data:i,error:n?.error||(i?void 0:`${e.label} failed`)}}else{const e=Jt[n]??Jt.recognize;a=await e(i)}return a.ok&&a.data&&await Vt(e,a,r?.sender?.tab?.id).catch(console.warn),a},Yt=e=>{const t=(e||"").trimStart().toLowerCase();return t.startsWith("<!doctype html")||t.startsWith("<html")||t.startsWith("<head")||t.startsWith("<body")},Kt=async e=>{let t,n="";try{t=(e=>{try{const t=new URL(e);if("github.com"===t.hostname){const e=t.pathname.split("/").filter(Boolean),n=2===e.indexOf("blob")||2===e.indexOf("raw")?2:-1;if(e.length>=5&&2===n)return`https://raw.githubusercontent.com/${e[0]}/${e[1]}/${e[3]}/${e.slice(4).join("/")}`}if(t.hostname.endsWith("gitlab.com")){const e=t.pathname.split("/").filter(Boolean),n=e.indexOf("-");if(n>=0&&"blob"===e[n+1])return`https://${t.hostname}/${e.slice(0,n).join("/")}/-/raw/${e[n+2]||""}/${e.slice(n+3).join("/")}`}return"bitbucket.org"===t.hostname?(t.searchParams.has("raw")||t.searchParams.set("raw","1"),t.toString()):t.toString()}catch{return e}})(e);const r=new URL(t),o=await fetch(r.href,{credentials:"include",cache:"no-store",headers:{accept:"text/markdown,text/plain,*/*"}});if(!o.ok)return{error:`Failed to load: ${o.status}`};if(n=await o.text(),!Yt(n)){const e=(o.headers.get("content-type")||"").toLowerCase(),t=jt.test(r.pathname)||e.includes("text/markdown")||(e=>{const t=(e||"").trim();if(!t||Yt(t))return!1;let n=0;return/^#{1,6}\s+.+$/m.test(t)&&n++,/^\s*[-*+]\s+\S+/m.test(t)&&n++,/^\s*\d+\.\s+\S+/m.test(t)&&n++,/```[\s\S]*?```/.test(t)&&n++,/\[([^\]]+)\]\(([^)]+)\)/.test(t)&&n++,n>=2})(n);if(!t){n=`\`\`\`${{ts:"ts",tsx:"tsx",js:"js",jsx:"jsx",json:"json",css:"css",scss:"scss",html:"html",htm:"html",xml:"xml",yml:"yaml",yaml:"yaml",py:"py",sh:"sh",go:"go",rs:"rs",java:"java"}[((r.pathname.split("/").pop()||"").split(".").pop()||"").toLowerCase()]||""}\n${n.replace(/\r\n/g,"\n")}\n\`\`\`\n`}}}catch{n=e}const r=`md_${Date.now()}_${Math.random().toString(36).slice(2,11)}`;return await chrome.storage.session.set({[r]:n}),{key:r,src:Mt(t||e)?t||e:void 0}},Vt=async(e,t,n)=>{const r=F(t?.data).trim();return r?new Promise(t=>{qt(async()=>{if(n&&n>0)try{if(await e.tabs.get(n).catch(()=>null)){await e.scripting.executeScript({target:{tabId:n},files:["content/main.ts"]}).catch(()=>{});const o=await e.tabs.sendMessage(n,{type:"COPY_HACK",data:r});if(o?.ok)return t({ok:!0})}}catch{}try{const n="offscreen/copy.html",o=await(e.runtime.getContexts?.({contextTypes:[e.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e.runtime.getURL(n)]})?.catch?.(()=>[]));o?.length||(await e.offscreen.createDocument({url:n,reasons:[e.offscreen.Reason.CLIPBOARD],justification:"Clipboard access for copied text"}),await new Promise(e=>setTimeout(e,500)));const i=await e.runtime.sendMessage({target:"offscreen",type:"COPY_HACK",data:r});if(i?.ok)return t({ok:!0})}catch{}try{const o=await e.tabs.query({}).catch(()=>[]);for(const i of o||[])if(i?.id&&i.id!==n)try{await e.scripting.executeScript({target:{tabId:i.id},files:["content/main.ts"]}).catch(()=>{});const n=await e.tabs.sendMessage(i.id,{type:"COPY_HACK",data:r});if(n?.ok)return t({ok:!0})}catch{}}catch{}try{if("undefined"!=typeof navigator&&navigator.clipboard?.writeText)return await navigator.clipboard.writeText(r),t({ok:!0})}catch{}t({ok:!1,error:"All clipboard methods failed"})})}):{ok:!1,error:"Empty content"}};const Ht=new class{state;storageKey="rs-action-history";constructor(e=500,t=!0){this.state={entries:[],maxEntries:e,autoSave:t,filters:{}},this.loadHistory()}addEntry(e){const t={...e,id:this.generateId(),timestamp:Date.now()};return this.state.entries.unshift(t),this.state.entries.length>this.state.maxEntries&&(this.state.entries=this.state.entries.slice(0,this.state.maxEntries)),t}updateEntry(e,t){const n=this.state.entries.findIndex(t=>t.id===e);return-1!==n&&(Object.assign(this.state.entries[n],t),!0)}getEntry(e){return this.state.entries.find(t=>t.id===e)}getEntries(e){let t=[...this.state.entries];return e?.source&&(t=t.filter(t=>t.context.source===e.source)),e?.action&&(t=t.filter(t=>t.action===e.action)),e?.status&&(t=t.filter(t=>t.status===e.status)),e?.dateRange&&(t=t.filter(t=>t.timestamp>=e.dateRange.start&&t.timestamp<=e.dateRange.end)),t}getRecentEntries(e=50){return this.state.entries.slice(0,e)}removeEntry(e){const t=this.state.entries.findIndex(t=>t.id===e);return-1!==t&&(this.state.entries.splice(t,1),!0)}clearEntries(){this.state.entries=[]}setFilters(e){Object.assign(this.state.filters,e)}getStats(){const e=this.state.entries,t=e.length,n=e.filter(e=>"completed"===e.status).length;return{total:t,completed:n,failed:e.filter(e=>"failed"===e.status).length,pending:e.filter(e=>"pending"===e.status||"processing"===e.status).length,successRate:t>0?n/t*100:0,bySource:e.reduce((e,t)=>(e[t.context.source]=(e[t.context.source]||0)+1,e),{}),byAction:e.reduce((e,t)=>(e[t.action]=(e[t.action]||0)+1,e),{})}}exportEntries(e="json",t){const n=this.getEntries(t);if("csv"===e){return[["ID","Timestamp","Source","Action","Status","Input Type","Result Type","Processing Time"],...n.map(e=>[e.id,new Date(e.timestamp).toISOString(),e.context.source,e.action,e.status,e.input.type,e.result?.type||"",e.result?.processingTime||""])].map(e=>e.map(e=>`"${e}"`).join(",")).join("\n")}return JSON.stringify(n,null,2)}importEntries(e,t="json"){let n=[];if("json"!==t)throw new Error("CSV import not implemented yet");try{n=JSON.parse(e)}catch(In){throw new Error("Invalid JSON format")}const r=n.filter(e=>e.id&&e.timestamp&&e.context&&e.action);return r.forEach(e=>{this.getEntry(e.id)||this.state.entries.push(e)}),this.state.entries.sort((e,t)=>t.timestamp-e.timestamp),this.state.entries.length>this.state.maxEntries&&(this.state.entries=this.state.entries.slice(0,this.state.maxEntries)),this.saveHistory(),r.length}generateId(){return`action_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}loadHistory(){try{if("undefined"==typeof localStorage)return;const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);Array.isArray(t)&&(this.state.entries=t.map(e=>({...e,context:e.context||{source:"unknown"},input:e.input||{type:"unknown"},status:e.status||"completed"})))}}catch(In){console.warn("Failed to load action history:",In),this.state.entries=[]}}saveHistory(){if(this.state.autoSave)try{if("undefined"==typeof localStorage)return;localStorage.setItem(this.storageKey,JSON.stringify(this.state.entries))}catch(In){console.warn("Failed to save action history:",In)}}};const Qt=new class{rules=[];ruleSets=new Map;constructor(e){this.initializeDefaultRules(e??{recognitionFormat:"markdown",processingFormat:"markdown"})}registerRule(e){this.rules.push(e),this.rules.sort((e,t)=>t.priority-e.priority)}registerRuleSet(e,t){this.ruleSets.set(e,t)}async execute(e,t,n={}){const r=`exec_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,o={context:t,action:n.forceAction||"auto",input:e,status:"processing",ruleSet:n.ruleSet,executionId:r},i=Ht.addEntry(o);try{const r=this.findMatchingRule(e,t,n);if(!r)throw new Error("No matching execution rule found");Ht.updateEntry(i.id,{action:r.action});const o=Date.now(),a=await r.processor(e,t,n),s=Date.now()-o,c={...a,processingTime:s,autoCopied:r.autoCopy};return Ht.updateEntry(i.id,{result:c,status:"completed",dataCategory:c.dataCategory}),r.autoCopy&&"error"!==c.type&&await this.autoCopyResult(c,t),c}catch(a){const e=a instanceof Error?a.message:String(a);return Ht.updateEntry(i.id,{status:"failed",error:e}),{type:"error",content:e}}}findMatchingRule(e,t,n){if(n.forceAction){const r=this.rules.find(r=>r.action===n.forceAction&&r.source===t.source&&r.inputTypes.includes(e.type));if(r)return r}if(n.ruleSet){const r=this.ruleSets.get(n.ruleSet);if(r){const n=r.find(n=>n.source===t.source&&n.inputTypes.includes(e.type)&&n.condition(e,t));if(n)return n}}return this.rules.find(n=>n.source===t.source&&n.inputTypes.includes(e.type)&&n.condition(e,t))||null}async autoCopyResult(e,t){try{let n="";switch(e.type){case"markdown":case"text":n=e.content;break;case"json":try{const t=JSON.parse(e.content);n="string"==typeof t?t:t.recognized_data?Array.isArray(t.recognized_data)?t.recognized_data.join("\n\n"):String(t.recognized_data):e.content}catch{n=e.content}break;case"html":n=e.content.replace(/<[^>]*>/g,"");break;default:return}if(n.trim()){if("chrome-extension"===t.source){if("undefined"!=typeof chrome&&chrome.runtime)return}else if("undefined"!=typeof navigator&&navigator.clipboard)await navigator.clipboard.writeText(n.trim());else{if("undefined"==typeof document||!document.body)return void console.log("[ExecutionCore] Cannot auto-copy in service worker context - DOM not available");{const e=document.createElement("textarea");e.value=n.trim(),document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}}this.notifyCopySuccess(t)}}catch(n){console.warn("Failed to auto-copy result:",n)}}notifyCopySuccess(e){const t={type:"copy-success",context:e};if("chrome-extension"===e.source)"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.sendMessage(t);else try{const e=new BroadcastChannel("rs-clipboard");e.postMessage(t),e.close()}catch(In){console.warn("Failed to broadcast copy success:",In)}}initializeDefaultRules(e){this.registerRule({id:"workcenter-text-files-source",name:"Work Center Text File Source",description:"Process text/markdown files as source data",source:"workcenter",inputTypes:["files"],action:"source",condition:e=>e.files?.some(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"))??!1,processor:async e=>{const t=e.files.filter(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"));let n="";for(const o of t)try{n+=await o.text()+"\n\n"}catch(r){console.warn(`Failed to read text file ${o.name}:`,r)}return{type:"markdown",content:n.trim(),dataCategory:"recognized",responseId:`source_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}},autoCopy:!1,autoSave:!0,priority:11}),this.registerRule({id:"workcenter-files-recognize",name:"Work Center File Recognition",description:"Recognize content from uploaded files",source:"workcenter",inputTypes:["files","image"],action:"recognize",condition:e=>Boolean((e?.files?.length??0)>0),processor:async(e,t,n)=>{let r;const o=this.getRecognitionFormatInstruction(n?.recognitionFormat);if(e.files.length>1){const t=[{type:"message",role:"user",content:[{type:"input_text",text:`Analyze and recognize content from the following ${e.files.length} files. ${o}`},...(await Promise.all(e.files.map(async(e,t)=>{const n=globalThis.File,r=n&&e instanceof n,o={type:"input_text",text:`\n--- File ${t+1}: ${e.name} ---\n`};if(r&&e.type.startsWith("image/"))try{const t=await e.arrayBuffer(),n=new Uint8Array(t),r=ve(n);return[o,{type:"input_image",detail:"auto",image_url:`data:${e.type};base64,${r}`}]}catch(i){return console.warn(`Failed to process image ${e.name}:`,i),[o,{type:"input_text",text:`[Failed to process image: ${e.name}]`}]}else try{return[o,{type:"input_text",text:await e.text()}]}catch(i){return console.warn(`Failed to read file ${e.name}:`,i),[o,{type:"input_text",text:`[Failed to read file: ${e.name}]`}]}}))).flat()].filter(e=>null!==e)}];r=await Pt(t,{instruction:`Analyze and recognize content from the provided files. ${o}`,outputFormat:n?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}else{const t=e.files[0],a=globalThis.File;if(a&&t instanceof a&&t.type.startsWith("image/"))try{const e=await t.arrayBuffer(),i=new Uint8Array(e),a=ve(i),s=`data:${t.type};base64,${a}`;r=await Pt(s,{instruction:`Analyze and recognize content from the provided image. ${o}`,outputFormat:n?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}catch(i){console.warn(`Failed to process image ${t.name}:`,i),r=await Pt(t,{instruction:`Analyze and recognize content from the provided file. ${o}`,outputFormat:n?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}else r=await Pt(t,{instruction:"Analyze and recognize content from the provided file",outputFormat:n?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}return{type:this.detectResultFormat(r),content:this.formatAIResult(r),rawData:r,responseId:r.responseId,dataCategory:"recognized"}},autoCopy:!1,autoSave:!0,priority:10}),this.registerRule({id:"workcenter-text-analyze",name:"Work Center Text Analysis",description:"Analyze provided text content",source:"workcenter",inputTypes:["text","markdown"],action:"analyze",condition:e=>Boolean(e.text||e.recognizedContent),processor:async(e,t,n)=>{const r=e.recognizedContent||e.recognizedData?.content||e.text||"",o=e.files?.some(e=>e.type.startsWith("image/")||"image/svg+xml"===e.type)||!1,i="string"==typeof r&&r.includes("<svg"),a=e.text&&e.text.trim()&&"Analyze and process the provided content intelligently"!==e.text.trim()?e?.text?.trim?.():`Analyze the provided content. ${this.getProcessingFormatInstruction(n?.processingFormat)}`,s=await Pt(o||i?[r,...e.files||[]]:r,{instruction:a,outputFormat:n?.processingFormat||"auto",outputLanguage:"auto",enableSVGImageGeneration:"auto",intermediateRecognition:{enabled:o,outputFormat:n?.recognitionFormat||"markdown",dataPriorityInstruction:void 0,cacheResults:!0},dataType:i?"svg":o?"image":"text",processingEffort:"medium",processingVerbosity:"medium"});return{type:this.detectResultFormat(s),content:this.formatAIResult(s),rawData:s,responseId:s.responseId,dataCategory:"processed"}},autoCopy:!1,autoSave:!0,priority:9}),this.registerRule({id:"share-target-text-files-source",name:"Share Target Text File Source",description:"Process shared text/markdown files as source data",source:"share-target",inputTypes:["files"],action:"source",condition:e=>e.files?.some(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"))??!1,processor:async e=>{const t=e.files.filter(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"));let n="";for(const o of t)try{n+=await o.text()+"\n\n"}catch(r){console.warn(`Failed to read text file ${o.name}:`,r)}return{type:"markdown",content:n.trim(),dataCategory:"recognized",responseId:`share_source_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}},autoCopy:!1,autoSave:!0,priority:16}),this.registerRule({id:"share-target-images-recognize",name:"Share Target Image Recognition",description:"Recognize content from shared images",source:"share-target",inputTypes:["image","files"],action:"recognize",condition:e=>e.files?.some(e=>e.type.startsWith("image/"))||!1,processor:async t=>{const n=t.files.filter(e=>e.type.startsWith("image/"));let r;if(n.length>1){const t=[{type:"message",role:"user",content:[{type:"input_text",text:`Recognize and extract text/content from the following ${n.length} shared images:`},...(await Promise.all(n.map(async(e,t)=>{try{const n=await e.arrayBuffer(),r=new Uint8Array(n),o=btoa(String.fromCharCode(...r));return[{type:"input_text",text:`\n--- Image ${t+1}: ${e.name} ---\n`},{type:"input_image",detail:"auto",image_url:`data:${e.type};base64,${o}`}]}catch(n){return console.warn(`Failed to process image ${e.name}:`,n),[{type:"input_text",text:`\n--- Image ${t+1}: ${e.name} ---\n`},{type:"input_text",text:`[Failed to process image: ${e.name}]`}]}}))).flat()]}];r=await Pt(t,{instruction:"Recognize and extract text/content from the shared images",outputFormat:e?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}else r=await Pt(n[0],{instruction:"Recognize and extract text/content from the shared image",outputFormat:e?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}});return{type:this.detectResultFormat(r),content:this.formatAIResult(r),rawData:r,responseId:r.responseId,dataCategory:"recognized"}},autoCopy:!0,autoSave:!0,priority:15}),this.registerRule({id:"share-target-markdown-view",name:"Share Target Markdown View",description:"View shared markdown content",source:"share-target",inputTypes:["text","markdown"],action:"view",condition:e=>this.isMarkdownContent(e.text||""),processor:async e=>({type:"markdown",content:e.text||""}),autoCopy:!1,autoSave:!0,priority:14}),this.registerRule({id:"share-target-url-analyze",name:"Share Target URL Analysis",description:"Analyze shared URL content",source:"share-target",inputTypes:["url"],action:"analyze",condition:()=>!0,processor:async(e,t,n)=>{const r=`Analyze the content from this URL and provide insights. ${this.getProcessingFormatInstruction(n?.processingFormat)}`,o=await Pt(e.url,{instruction:r,outputFormat:n?.processingFormat||"auto",outputLanguage:"auto",enableSVGImageGeneration:"auto",intermediateRecognition:{enabled:!1},dataType:"text"});return{type:this.detectResultFormat(o),content:this.formatAIResult(o),rawData:o,responseId:o.responseId,dataCategory:"recognized"}},autoCopy:!0,autoSave:!0,priority:13}),this.registerRule({id:"chrome-extension-text-files-source",name:"Chrome Extension Text File Source",description:"Process Chrome extension text/markdown files as source data",source:"chrome-extension",inputTypes:["files"],action:"source",condition:e=>e.files?.some(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"))??!1,processor:async e=>{const t=e.files.filter(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"));let n="";for(const o of t)try{n+=await o.text()+"\n\n"}catch(r){console.warn(`Failed to read text file ${o.name}:`,r)}return{type:"markdown",content:n.trim(),dataCategory:"recognized",responseId:`crx_source_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}},autoCopy:!0,autoSave:!0,priority:26}),this.registerRule({id:"chrome-extension-screenshot-recognize",name:"Chrome Extension Screenshot Recognition",description:"Recognize content from screenshot",source:"chrome-extension",inputTypes:["image"],action:"recognize",condition:()=>!0,processor:async t=>{let n;if(t.files.length>1){const r=[{type:"message",role:"user",content:[{type:"input_text",text:`Analyze the following ${t.files.length} screenshots and extract any visible text or content:`},...(await Promise.all(t.files.map(async(e,t)=>{try{const n=await e.arrayBuffer(),r=new Uint8Array(n),o=ve(r);return[{type:"input_text",text:`\n--- Screenshot ${t+1}: ${e.name} ---\n`},{type:"input_image",detail:"auto",image_url:`data:${e.type};base64,${o}`}]}catch(n){return console.warn(`Failed to process screenshot ${e.name}:`,n),[{type:"input_text",text:`\n--- Screenshot ${t+1}: ${e.name} ---\n`},{type:"input_text",text:`[Failed to process screenshot: ${e.name}]`}]}}))).flat()]}];n=await Pt(r,{instruction:"Analyze the screenshots and extract any visible text or content",outputFormat:e?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}else{const o=t.files[0],i=globalThis.File;if(i&&o instanceof i&&o.type.startsWith("image/"))try{const t=await o.arrayBuffer(),r=new Uint8Array(t),i=ve(r),a=`data:${o.type};base64,${i}`;n=await Pt(a,{instruction:"Analyze the screenshot and extract any visible text or content",outputFormat:e?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}catch(r){console.warn(`Failed to process screenshot ${o.name}:`,r),n=await Pt(o,{instruction:"Analyze the screenshot and extract any visible text or content",outputFormat:e?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}else n=await Pt(o,{instruction:"Analyze the screenshot and extract any visible text or content",outputFormat:e?.recognitionFormat||"auto",intermediateRecognition:{enabled:!1}})}return{type:this.detectResultFormat(n),content:this.formatAIResult(n),rawData:n,responseId:n.responseId,dataCategory:"recognized"}},autoCopy:!0,autoSave:!0,priority:20}),this.registerRule({id:"launch-queue-text-files-source",name:"Launch Queue Text File Source",description:"Process launch queue text/markdown files as source data",source:"launch-queue",inputTypes:["files"],action:"source",condition:e=>e.files?.some(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"))??!1,processor:async e=>{const t=e.files.filter(e=>e.type.startsWith("text/")||"application/markdown"===e.type||e.name?.endsWith(".md")||e.name?.endsWith(".txt"));let n="";for(const o of t)try{n+=await o.text()+"\n\n"}catch(r){console.warn(`Failed to read text file ${o.name}:`,r)}return{type:"markdown",content:n.trim(),dataCategory:"recognized",responseId:`launch_source_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}},autoCopy:!0,autoSave:!0,priority:21}),this.registerRule({id:"launch-queue-files-process",name:"Launch Queue File Processing",description:"Process files from launch queue",source:"launch-queue",inputTypes:["files","mixed"],action:"process",condition:()=>!0,processor:async t=>{let n;if(t.files.length>1){const r=[{type:"message",role:"user",content:[{type:"input_text",text:`Process the following ${t.files.length} files:`},...(await Promise.all(t.files.map(async(e,t)=>{const n=globalThis.File,r=n&&e instanceof n,o={type:"input_text",text:`\n--- File ${t+1}: ${e.name} ---\n`};if(r&&e.type.startsWith("image/"))try{const t=await e.arrayBuffer(),n=new Uint8Array(t),r=ve(n);return[o,{type:"input_image",detail:"auto",image_url:`data:${e.type};base64,${r}`}]}catch(i){return console.warn(`Failed to process file ${e.name}:`,i),[o,{type:"input_text",text:`[Failed to process file: ${e.name}]`}]}else try{return[o,{type:"input_text",text:await e.text()}]}catch(i){return console.warn(`Failed to read file ${e.name}:`,i),[o,{type:"input_text",text:`[Failed to read file: ${e.name}]`}]}}))).flat()]}];n=await Pt(r,{instruction:"Process the provided content",outputFormat:e?.processingFormat||"auto",intermediateRecognition:{enabled:!1}})}else{const o=t.files[0],i=globalThis.File;if(i&&o instanceof i&&o.type.startsWith("image/"))try{const t=await o.arrayBuffer(),r=new Uint8Array(t),i=ve(r),a=`data:${o.type};base64,${i}`;n=await Pt(a,{instruction:"Process the provided image content",outputFormat:e?.processingFormat||"auto",intermediateRecognition:{enabled:!1}})}catch(r){console.warn(`Failed to process image ${o.name}:`,r),n=await Pt(o,{instruction:"Process the provided content",outputFormat:e?.processingFormat||"auto",intermediateRecognition:{enabled:!1}})}else n=await Pt(o,{instruction:"Process the provided content",outputFormat:e?.processingFormat||"auto",intermediateRecognition:{enabled:!1}})}return{type:this.detectResultFormat(n),content:this.formatAIResult(n),rawData:n,responseId:n.responseId,dataCategory:"recognized"}},autoCopy:!0,autoSave:!0,priority:12})}isMarkdownContent(e){if(!e||"string"!=typeof e)return!1;const t=e.trim();if(t.startsWith("<")&&t.endsWith(">"))return!1;if(/<[a-zA-Z][^>]*>/.test(t))return!1;return[/^---[\s\S]+?---/,/^#{1,6}\s+.+$/m,/^\s*[-*+]\s+\S+/m,/^\s*\d+\.\s+\S+/m,/`{1,3}[^`]*`{1,3}/,/\[([^\]]+)\]\(([^)]+)\)/,/!\[([^\]]+)\]\(([^)]+)\)/].some(t=>t.test(e))}detectResultFormat(e){if(!e)return"text";try{const t=e.data||e;if(t&&"object"==typeof t){return["recognized_data","verbose_data","keywords_and_tags","confidence","suggested_type","using_ready"].some(e=>e in t)?"json":t.content||t.text||t.message?"markdown":"json"}return"string"==typeof t?t.includes("\n")||t.includes("#")||t.includes("*")||t.includes("`")?"markdown":"text":"json"}catch(t){return console.warn("Failed to detect result format:",t),"text"}}formatAIResult(e){if(!e)return"No result";try{let t="";if(e.data)if("string"==typeof e.data)t=e.data;else if(e.data.recognized_data){const n=e.data.recognized_data;t=Array.isArray(n)?n.join("\n\n"):String(n)}else t=JSON.stringify(e.data,null,2);else t="string"==typeof e?e:JSON.stringify(e,null,2);return t=this.unwrapUnwantedCodeBlocks(t),t}catch(t){return console.warn("Failed to format AI result:",t),String(e)}}unwrapUnwantedCodeBlocks(e){if(!e)return e;const t=e.trim().match(/^```(?:katex|md|markdown|html|xml|json|text)?\n([\s\S]*?)\n```$/);if(t){const n=t[1].trim(),r=n.split("\n");return 1===r.length||n.includes("<math")||n.includes('<span class="katex')||n.includes("<content")||n.startsWith("<")&&n.endsWith(">")||/^\s*<[^>]+>/.test(n)?(console.log("[AI Response] Unwrapped unwanted code block formatting"),n):r.length>3||r.some(e=>e.match(/^\s{4,}/)||e.includes("function")||e.includes("const ")||e.includes("let "))?e:(console.log("[AI Response] Unwrapped unwanted code block formatting"),n)}return e}getRecognitionFormatInstruction(e){if(!e||"auto"===e)return"Output the content in the most appropriate format (markdown is preferred for structured content).";switch(e){case"most-suitable":return"Analyze the content and output it in the most suitable format for its type and structure. Choose the format that best represents the content's nature and purpose.";case"most-optimized":return"Output the content in the most optimized format for storage and transmission efficiency. Prefer compact representations while maintaining essential information.";case"most-legibility":return"Output the content in the most human-readable and legible format. Prioritize clarity, readability, and ease of understanding over compactness.";case"markdown":return"Output the recognized content in Markdown format.";case"html":return"Output the recognized content in HTML format.";case"text":return"Output the recognized content as plain text.";case"json":return"Output the recognized content as structured JSON data.";default:return"Output the content in the most appropriate format (markdown is preferred for structured content)."}}getProcessingFormatInstruction(e){if(!e||"markdown"===e)return"Output the processed result in Markdown format.";switch(e){case"html":return"Output the processed result in HTML format.";case"json":return"Output the processed result as structured JSON data.";case"text":return"Output the processed result as plain text.";case"typescript":return"Output the processed result as TypeScript code.";case"javascript":return"Output the processed result as JavaScript code.";case"python":return"Output the processed result as Python code.";case"java":return"Output the processed result as Java code.";case"cpp":return"Output the processed result as C++ code.";case"csharp":return"Output the processed result as C# code.";case"php":return"Output the processed result as PHP code.";case"ruby":return"Output the processed result as Ruby code.";case"go":return"Output the processed result as Go code.";case"rust":return"Output the processed result as Rust code.";case"xml":return"Output the processed result in XML format.";case"yaml":return"Output the processed result in YAML format.";case"css":return"Output the processed result as CSS code.";case"scss":return"Output the processed result as SCSS code.";default:return"Output the processed result in Markdown format."}}},Xt=y.isCrxEnvironment(),Zt="rs-ai-recognition",en=(e,t)=>{try{const n=new BroadcastChannel(e);n.postMessage(t),n.close()}catch{}},tn=(e,t="info")=>en("rs-toast",{type:"show-toast",options:{message:e,kind:t,duration:3e3}}),nn=async(e,t=!0,n)=>{try{let r=n;if((!r||r<=0)&&t){const e=await chrome.tabs.query({active:!0,currentWindow:!0}).catch(()=>[]);r=e?.[0]?.id}await Vt(chrome,{ok:!0,data:e},r)}catch(In){console.warn("[SW] clipboard copy failed:",In)}},rn=async()=>{try{return await O()}catch{return[]}},on=async(e,t)=>{try{const n={source:"chrome-extension",sessionId:t||`crx_${Date.now()}_${Math.random().toString(36).slice(2,11)}`},r=await Qt.execute(e,n);return"error"===r.type?{success:!1,error:r.content||r.error||"Processing failed",result:r}:{success:!0,result:r}}catch(n){return{success:!1,error:n instanceof Error?n.message:String(n)}}};Xt&&chrome.runtime?.onMessage&&chrome.runtime.onMessage.addListener((e,t,n)=>!!e?.type&&("processCapture"===e.type?((async()=>{try{const t=e.data?.rect,r={format:"png",scale:1};t?.width>0&&t?.height>0&&(r.rect=t);const o=await new Promise((e,t)=>{chrome.tabs.captureVisibleTab(r,n=>{chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(n)})}),i=await(await fetch(o)).blob(),a=await Ct(i);n({success:!0,result:a})}catch(t){n({success:!1,error:t instanceof Error?t.message:String(t)})}})(),!0):"processText"===e.type&&(n({success:!0,result:{type:"text",content:e.data?.content,processed:!0}}),!1))),Xt&&(w("processImage",async e=>{const t=await on({type:"recognize",data:e.imageData,mode:e.mode,customInstructionId:e.customInstructionId});return y.sendRuntimeMessage({type:"processingComplete",data:{result:t},metadata:{progress:100}}).catch(()=>{}),t}),w("processCapture",async e=>on({type:"capture",data:e,mode:e.type?.toLowerCase().replace("capture_","")||"recognize"})),w("processText",async e=>on({type:"process",data:e.content,contentType:e.contentType})),w("getProcessingStatus",async e=>({status:"completed",operationId:e.operationId})),w("cancelProcessing",async e=>({cancelled:!0,operationId:e.operationId}))),w("getSettings",async()=>{try{return await s()}catch(In){throw In}}),w("updateSettings",async e=>({success:!0})),w("ping",async()=>({status:"ok",context:"service-worker",timestamp:Date.now()})),w("broadcastResult",async e=>(await b({type:"ai-result",data:e.result,metadata:{source:"service-worker"}}),en(Zt,{type:e.type,result:e.result,timestamp:Date.now(),source:"crx-service-worker"}),{broadcasted:!0}));const an=new class{resultQueue=[];maxQueueSize=50;maxRetries=3;interval=null;constructor(){this.interval=globalThis.setInterval(()=>this.processQueue(),1e3)}async enqueue(e,t){const n={id:crypto.randomUUID(),result:e,destinations:t,status:"pending",attempts:0,createdAt:Date.now()};return this.resultQueue.push(n),this.resultQueue.length>this.maxQueueSize&&this.resultQueue.shift(),n.id}getStatus(){const e={pending:0,processing:0,completed:0,failed:0};for(const t of this.resultQueue)e[t.status]++;return{queueSize:this.resultQueue.length,...e}}getPending(e){return this.resultQueue.filter(t=>"pending"===t.status&&(!e||t.destinations.some(t=>t.type===e)))}clearCompleted(){const e=this.resultQueue.filter(e=>"completed"===e.status).length;return this.resultQueue=this.resultQueue.filter(e=>"completed"!==e.status),e}destroy(){this.interval&&clearInterval(this.interval),this.interval=null,this.resultQueue=[]}async processQueue(){for(const e of this.resultQueue.filter(e=>"pending"===e.status)){e.status="processing",e.attempts++;let t=!1;for(const n of e.destinations)try{await this.deliver(e.result,n),t=!0}catch{}t?(e.status="completed",e.completedAt=Date.now()):e.attempts>=this.maxRetries?(e.status="failed",e.error="All destinations failed"):e.status="pending"}}async deliver(e,t){const n="string"==typeof e.content?e.content:`[Binary ${e.content.byteLength} bytes]`;switch(t.type){case"clipboard":await nn(n,!1!==t.options?.showFeedback,t.tabId);break;case"content-script":{const n={type:"crx-result-delivered",result:e,destination:t.type,timestamp:Date.now()};t.tabId?await chrome.tabs.sendMessage(t.tabId,n,{frameId:t.frameId}):await b(n);break}case"popup":en("rs-popup",{type:"crx-result-delivered",result:e,destination:t.type,timestamp:Date.now()});break;case"workcenter":try{const{unifiedMessaging:t}=await l(async()=>{const{unifiedMessaging:e}=await import("../modules/UnifiedMessaging.js").then(e=>e.UnifiedMessaging);return{unifiedMessaging:e}},[],import.meta.url);await t.sendMessage({id:e.id,type:"content-share",source:"crx-snip",destination:"workcenter",contentType:e.type,data:{text:n,processed:!0,source:e.source,metadata:e.metadata},metadata:{title:`CRX-Snip ${e.type} Result`,timestamp:e.timestamp,source:e.source}})}catch{throw new Error("WorkCenter delivery failed")}break;case"notification":await chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:`CrossWord ${e.source}`,message:n.length>100?n.slice(0,100)+"...":n})}}};self.addEventListener("beforeunload",()=>an.destroy());const sn=async(e,t="text",n=[])=>{try{let r=e,o=t;if(("image"===t||e instanceof ArrayBuffer)&&e instanceof ArrayBuffer){const t=new Blob([e],{type:"image/png"});r=(await Ct(t)).text||"",o="text"}const i={type:"process",content:r,contentType:o,metadata:{source:"crx-snip",timestamp:Date.now(),background:!0,originalType:t}},a=await on(i);if(a.success&&a.result){const e={id:crypto.randomUUID(),type:"processed",content:"string"==typeof a.result?a.result:String(a.result),source:"crx-snip",timestamp:Date.now()},t=[{type:"clipboard",options:{showFeedback:!0}},{type:"content-script"},{type:"workcenter"},{type:"notification"},...n];return{success:!0,resultId:await an.enqueue(e,t)}}return{success:!1,error:a.error}}catch(r){return{success:!1,error:r instanceof Error?r.message:String(r)}}},cn=chrome.runtime.getURL(""),ln=chrome.runtime.getURL("markdown/viewer.html"),un=/\.(?:md|markdown|mdown|mkd|mkdn|mdtxt|mdtext)(?:$|[?#])/i,dn="crossword:markdown-view",pn=e=>{if(!e||"string"!=typeof e)return!1;try{const t=new URL(e);if("chrome-extension:"===t.protocol)return!1;if(!["http:","https:","file:","ftp:"].includes(t.protocol))return!1;if(un.test(t.pathname))return!0;if("raw.githubusercontent.com"===t.hostname||"gist.githubusercontent.com"===t.hostname){if(un.test(t.pathname))return!0;if(/(^|\/)readme(\.md)?($|[?#])/i.test(t.pathname))return!0}return!1}catch{return!1}},mn=e=>{try{const t=new URL(e);if("github.com"===t.hostname){const e=t.pathname.split("/").filter(Boolean);if(e.length>=5&&"blob"===e[2])return`https://raw.githubusercontent.com/${e[0]}/${e[1]}/${e[3]}/${e.slice(4).join("/")}`}if(t.hostname.endsWith("gitlab.com")){const e=t.pathname.split("/").filter(Boolean),n=e.indexOf("-");if(n>=0&&"blob"===e[n+1])return`https://${t.hostname}/${e.slice(0,n).join("/")}/-/raw/${e[n+2]||""}/${e.slice(n+3).join("/")}`}return"bitbucket.org"===t.hostname?(t.searchParams.has("raw")||t.searchParams.set("raw","1"),t.toString()):t.toString()}catch{return e}},fn=(e,t,n)=>{const r=((e,t)=>{if(!e)return ln;const n=new URLSearchParams;return n.set("src",e),t&&n.set("mdk",t),`${ln}?${n}`})(e??void 0,n);"number"==typeof t?chrome.tabs.update(t,{url:r})?.catch?.(console.warn):chrome.tabs.create({url:r})?.catch?.(console.warn)},hn=async e=>{const t=(()=>{try{return`md:${crypto.randomUUID()}`}catch{return`md:${Date.now()}:${Math.random().toString(16).slice(2)}`}})();try{return await(chrome.storage?.session?.set?.({[t]:e})),t}catch{return null}},gn=async e=>{const t=mn(e),n=await fetch(t,{credentials:"include",cache:"no-store"}),r=await n.text().catch(()=>"");return{ok:n.ok,status:n.status,src:t,text:r}},yn=async(e,t)=>{if(e.startsWith("file:"))return void fn(e,t,null);const n=await gn(e).catch(()=>null);if(!n)return void fn(mn(e),t,null);const r=n.ok&&n.text?await hn(n.text):null;fn(n.src,t,r)},wn=["all","page","frame","selection","link","editable","image","video","audio","action"],bn=[{id:"copy-as-latex",title:"Copy as LaTeX"},{id:"copy-as-mathml",title:"Copy as MathML"},{id:"copy-as-markdown",title:"Copy as Markdown"},{id:"copy-as-html",title:"Copy as HTML"},{id:"START_SNIP",title:"Snip and Recognize (AI)"},{id:"SOLVE_AND_ANSWER",title:"Solve / Answer (AI)"},{id:"WRITE_CODE",title:"Write Code (AI)"},{id:"EXTRACT_CSS",title:"Extract CSS Styles (AI)"}],xn="CUSTOM_INSTRUCTION:";let Sn=[];const kn=async()=>{for(const n of Sn)try{await chrome.contextMenus.remove(n)}catch{}Sn=[];const e=(await rn().catch(()=>[])).filter(e=>e.enabled);if(!e.length)return;const t="CUSTOM_SEP";try{chrome.contextMenus.create({id:t,type:"separator",contexts:wn}),Sn.push(t)}catch{}for(const n of e){const e=`${xn}${n.id}`;try{chrome.contextMenus.create({id:e,title:` ${n.label}`,contexts:wn}),Sn.push(e)}catch{}}};chrome.storage.onChanged.addListener((e,t)=>{"local"===t&&e["rs-settings"]&&kn().catch(()=>{})}),chrome.runtime.onInstalled.addListener(()=>{for(const e of bn)try{chrome.contextMenus.create({id:e.id,title:e.title,visible:!0,contexts:wn})}catch{}try{chrome.contextMenus.create({id:dn,title:"Open in Markdown Viewer",contexts:["link","page"],targetUrlPatterns:["*://*/*.md","*://*/*.markdown","file://*/*.md","file://*/*.markdown"]})}catch{}try{chrome.contextMenus.create({id:"crx-snip-text",title:"Process Text with CrossWord (CRX-Snip)",contexts:["selection"]})}catch{}try{chrome.contextMenus.create({id:"crx-snip-screen",title:"Capture & Process Screen Area (CRX-Snip)",contexts:["page","frame","editable"]})}catch{}kn().catch(()=>{})});const vn=async(e,t)=>{if(null!=e&&e>=0)return chrome.tabs.sendMessage(e,t)?.catch?.(console.warn);const n=await(chrome.tabs.query({currentWindow:!0,active:!0})?.catch?.(()=>[]));for(const r of n||[])if(null!=r?.id&&r.id>=0)return chrome.tabs.sendMessage(r.id,t)?.catch?.(console.warn)};chrome.contextMenus.onClicked.addListener((e,t)=>{const n=t?.id,r=String(e.menuItemId),o={START_SNIP:"START_SNIP",SOLVE_AND_ANSWER:"SOLVE_AND_ANSWER",WRITE_CODE:"WRITE_CODE",EXTRACT_CSS:"EXTRACT_CSS"};if(r in o)vn(n,{type:o[r]});else if(r.startsWith(xn))vn(n,{type:"CUSTOM_INSTRUCTION",instructionId:r.slice(19)});else{if(r===dn){const t=e.linkUrl||e.pageUrl;return t&&pn(t)?void yn(t,n??0):void fn(t,n)}"crx-snip-text"===r&&e.selectionText?sn(e.selectionText,"text").then(e=>{chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:e.success?"Text processed and copied!":`Failed: ${e.error||"Unknown"}`})}):"crx-snip-screen"!==r?vn(n,{type:r}):(async()=>{try{const e=await _n();if(!e)return void chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:"Capture cancelled"});const t=await sn(e,"image");chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:t.success?"Captured and processed!":`Failed: ${t.error||"Unknown"}`})}catch{chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:"Capture failed"})}})()}}),chrome.commands.onCommand.addListener(async e=>{if("crx-snip-text"===e){const e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e[0]?.id)return;try{const t=await chrome.scripting.executeScript({target:{tabId:e[0].id},func:()=>("undefined"!=typeof window?window:globalThis)?.getSelection()?.toString()||""}),n=t[0]?.result||"";if(n){const e=await sn(n,"text");chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:e.success?"Text processed!":`Failed: ${e.error}`})}else chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:"Select text first, then Ctrl+Shift+X"})}catch{}}else if("crx-snip-screen"===e)try{const e=await _n();if(e){const t=await sn(e,"image");chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:t.success?"Captured and processed!":`Failed: ${t.error}`})}else chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:"Capture cancelled"})}catch{chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord CRX-Snip",message:"Capture failed"})}});const _n=async e=>{try{const t=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t[0]?.id)throw new Error("No active tab");const n={format:"png",quality:100,scale:e?.scale??1};e?.rect&&(n.rect=e.rect);const r=(await chrome.tabs.captureVisibleTab(t[0].windowId,n)).split(",")[1],o=atob(r),i=new Uint8Array(o.length);for(let e=0;e<o.length;e++)i[e]=o.charCodeAt(e);return i.buffer}catch{try{const e=await new Promise((e,t)=>{chrome.desktopCapture.chooseDesktopMedia(["screen","window"],{frameRate:1},n=>n?e(n):t(new Error("Cancelled")))}),t=chrome.runtime.getURL("offscreen/capture.html");(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT]})).length||await chrome.offscreen.createDocument({url:t,reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Screen capture"});const n=await chrome.runtime.sendMessage({type:"capture-desktop",streamId:e});return n?.success&&n?.imageData?n.imageData:null}catch{return null}}},Rn=async(e,t,n,r,o)=>{const i=`${r}_${Date.now()}`;en(Zt,{type:r,requestId:i,status:"processing"});try{const a=await Rt();if(!a){const e={ok:!1,error:"AI service not available"};return en(Zt,{type:"result",requestId:i,mode:r,...e}),void o(e)}a.getPending?.()?.push?.({type:"message",role:"user",content:[{type:"input_text",text:e},{type:"input_text",text:t||""}]});const s=await a.sendRequest("high","medium"),c={ok:!!s,data:s||"",error:s?void 0:"Failed"};en(Zt,{type:"result",requestId:i,mode:r,...c}),c.ok&&c.data&&await nn(c.data,!0,n?.tab?.id),o(c)}catch(In){const t={ok:!1,error:String(In)};en(Zt,{type:"result",requestId:i,mode:r,...t}),tn(`${r} failed: ${In}`,"error"),o(t)}};var Tn;chrome.runtime.onMessage.addListener((e,t,n)=>{if(!e?.type)return!1;if("MAKE_TIMELINE"===e.type)return kt(e.source||null,e.speechPrompt||null).then(async e=>{n(await((async(e,t=null)=>{if(!e)return{timeline:[],keywords:[]};t&&await(e?.giveForRequest?.(`current_timeline: \`${de(t)}\`\n`));const n=Intl?.DateTimeFormat?.()?.resolvedOptions?.()?.timeZone||"UTC",r=(new Date)?.getTimezoneOffset?.()||0,o=de({time:gt.time?.toISOString?.(),timestamp:gt.timestamp,coords:gt.coords?.toJSON?.(),otherProps:gt.otherProps,cards:gt.cards,language:navigator?.language||"ru-RU",timezone:n,timezoneOffset:r});await(e?.giveForRequest?.(`current_states: \`${o}\`\n`)),await(e?.giveForRequest?.('# Entities Spec V2\n\nFor understanding and for AI generation.\n\n## Output Format\n\n`{ "entities": ENTITY[], "keywords"?: STRING[], "short_description"?: MARKDOWN }`\n\n---\n\n## Entity Structure\n\n```\nENTITY={\n    "type": ENUM:TYPE,\n    "id": UNIQUE[ID],\n    "kind": ENUM:KIND[OF:TYPE],\n    "name"?: STRING,\n    "title"?: STRING,\n    "icon"?: PHOSPHOR_ICON_ID,\n    "properties": PROPERTIES[OF:TYPE]|{},\n    "description": MARKDOWN,\n    "image": URL,\n    "variant": ENUM:COLOR\n}\n```\n\n---\n\n## Data Types\n\n- `MARKDOWN=STRING|STRING[]`\n- `URL=STRING|{"url": STRING, "type": ENUM:URL_TYPE}`\n- `DATE={"timestamp"?: NUMBER, "iso_date"?: STRING}`\n- `CONTACT={"email"?: STRING[], "phone"?: STRING[], "links"?: STRING[]}`\n- `LOCATION=STRING|{ "coordinate"?: COORDINATE, "address"?: ADDRESS }`\n- `COORDINATE={ "latitude": NUMBER, "longitude": NUMBER }`\n- `ADDRESS={ "street"?: STRING, "house"?: STRING, "flat"?: STRING, "floor"?: NUMBER, "room"?: NUMBER, "square"?: NUMBER, "price"?: NUMBER }`\n- `ID=KEY[STRING|NUMBER]`\n- `BIOGRAPHY={ "firstName"?: STRING, "lastName"?: STRING, "middleName"?: STRING, "nickName"?: STRING, "birthdate"?: DATE, "gender"?: ENUM:GENDER }`\n\n---\n\n## Enums\n\n- `TYPE="task"|"event"|"action"|"service"|"item"|"skill"|"vendor"|"place"|"factor"|"person"|"bonus"`\n- `COLOR="red"|"green"|"blue"|"yellow"|"orange"|"purple"|"brown"|"gray"|"black"|"white"`\n- `TASK_STATUS="under_consideration"|"pending"|"in_progress"|"completed"|"failed"|"delayed"|"canceled"|"other"`\n- `AFFECT="positive"|"negative"|"neutral"`\n- `GENDER="male"|"female"|"other"`\n- `URL_TYPE="website"|"email"|"phone"|"social"|"other"`\n\n### Kinds\n\n```\nKIND=MAPPED_BY[TYPE][\n    ["task", ENUM="job"|"action"|"other"],\n    ["event", ENUM="education"|"lecture"|"conference"|"meeting"|"seminar"|"workshop"|"presentation"|"celebration"|"opening"|"other"],\n    ["action", ENUM="thinking"|"imagination"|"remembering"|"speaking"|"learning"|"listening"|"reading"|"writing"|"moving"|"traveling"|"speech"|"physically"|"crafting"|"following"|"other"],\n    ["service", ENUM="product"|"consultation"|"advice"|"medical"|"mentoring"|"training"|"item"|"thing"|"other"],\n    ["item", ENUM="currency"|"book"|"electronics"|"furniture"|"medicine"|"tools"|"software"|"consumables"|"other"],\n    ["skill", ENUM="skill"|"knowledge"|"ability"|"trait"|"experience"|"other"],\n    ["vendor", ENUM="vendor"|"company"|"organization"|"institution"|"other"],\n    ["place", ENUM="placement"|"place"|"school"|"university"|"service"|"clinic"|"pharmacy"|"hospital"|"library"|"market"|"location"|"shop"|"restaurant"|"cafe"|"bar"|"hotel"|"other"],\n    ["factor", ENUM="weather"|"health"|"family"|"relationships"|"job"|"traffic"|"business"|"economy"|"politics"|"news"|"other"],\n    ["person", ENUM="specialist"|"consultant"|"coach"|"mentor"|"dear"|"helper"|"assistant"|"friend"|"family"|"relative"|"other"]\n]\n```\n\n---\n\n## Data Maps\n\n```\nPROPERTIES=MAPPED_BY[TYPE][\n    ["task", TASK_STRUCTURE],\n    ["event", EVENT_STRUCTURE],\n    ["action", ACTION_STRUCTURE],\n    ["service", SERVICE_STRUCTURE],\n    ["item", ITEM_STRUCTURE],\n    ["skill", SKILL_STRUCTURE],\n    ["vendor", VENDOR_STRUCTURE],\n    ["place", PLACE_STRUCTURE],\n    ["factor", FACTOR_STRUCTURE],\n    ["person", PERSON_STRUCTURE]\n]\n```\n\n---\n\n## Properties Structures\n\n### Task\n\nImportant: Task can\'t be recognized directly from data source, but can be created by preference or user/prompt desire.\n\n```\nTASK_STRUCTURE={\n    "status": ENUM:TASK_STATUS,\n    "begin_time": DATE,\n    "end_time": DATE,\n    "location"?: LOCATION,\n    "contacts"?: CONTACT,\n    "members"?: ID[],\n    "events"?: ID[],\n}\n```\n\n### Event\n\n```\nEVENT_STRUCTURE={\n    "begin_time": DATE,\n    "end_time": DATE,\n    "location": LOCATION,\n    "contacts": CONTACT\n}\n```\n\n### Person\n\n```\nPERSON_STRUCTURE={\n    "home": LOCATION,\n    "jobs": LOCATION[],\n    "biography": BIOGRAPHY,\n    "tasks": ID[],\n    "contacts": CONTACT,\n    "services": ID[],\n    "prices": MAP<STRING,NUMBER>\n}\n```\n\n### Service\n\n```\nSERVICE_STRUCTURE={\n    "location": LOCATION,\n    "persons": ID[],\n    "specialization": STRING[],\n    "contacts": CONTACT,\n    "prices": MAP<STRING,NUMBER>\n}\n```\n\n### Factor\n\n```\nFACTOR_STRUCTURE={\n    "affect": ENUM:AFFECT,\n    "actions": ID[],\n    "location": LOCATION,\n}\n```\n\n### Bonus\n\n```\nBONUS_STRUCTURE={\n    "code"?: STRING,\n    "usableFor"?: ID[],\n    "usableIn"?: ID[],\n    "availability"?: {\n        "count: NUMBER,\n        "time": STRING[],\n        "days": STRING[]\n    },\n    "requirements"?: ANY[],\n    "additionalProperties"?: MAP<STRING,UNKNOWN>,\n    "profits"?: MAP<STRING,NUMBER>\n}\n```\n\n### OTHER\n\nTODO: Planned to explain later.\n\n---\n\n## Other types\n\nTODO: Planned to explain later.\n\n---\n\n## Appendix: Name Generation\n\n```\n"Give potential IDs for entities in following rules:",\n\nRules for generating entity IDs (\'id\' fields, ID type):\n- Letters or numbers (only in lowercase)\n- Allowed symbols, such as \'-\', \'_\', \'&\', \'#\', \'+\'\n- Whitespace not allowed\n- No emojis or special symbols\n- No Cyrillic or Latin letters\n- Only promo-codes or codes may has uppercase letters\n\nHow generates entity IDs:\n- If known person names (biography), use formatted their names, location or job also can be used.\n- Prefixed by service, market or vendor (if bonus entity, such as promo, discount, bonus, etc.)\n- Name, type or kind (if no name declared) of entity encodes into ID by conversion spaces into \'-\', etc.\n- CODE suffix is used for unique code of entity, such as promo-code, discount-code, etc.\n\nFor example:\n\n/*\n   - [in bonuses list] zdravia-clinic_therapist_CODE123 - promo-code for therapist of zdravia-clinic\n   - [in persons list] alena-victorovna_additional-identifier - person of Alena Viktorovna, for additional identifier may be used service, skill, email or phone number\n   - [in items list] book_the-best-book - book of the best book\n*/\n\nSuch idea used for make simpler search, filtering and sorting of entities.\n```\n')),await(e?.askToDoAction?.(["Make timeline plan in JSON format, according to given schema. Follow by our preferences is was presented...",'Write in JSON format, `[ array of entity of "task" type ]`, according to given schema.'].join?.("\n")));const i=e?.getResponseId?.(),a=await(e?.sendRequest?.()?.catch?.(console.warn.bind(console))),s=a?Se(a):'{ ready: false, reason: "No attached data", keywords: [] }';return e?.beginFromResponseId?.(i),s?.forEach?.(e=>nt(e)),console.log("timeline",s),s})(e)||[]))}).catch(e=>n({error:e.message})),!0;if("gpt:recognize"===e.type){const t=e.requestId||`rec_${Date.now()}`;return en(Zt,{type:"recognize",requestId:t,status:"processing"}),Ct(e.input,async r=>{const o={ok:r?.ok,data:r?.raw,error:r?.error};if(en(Zt,{type:"result",requestId:t,...o}),r?.ok&&r?.raw&&!1!==e.autoCopy){const e="string"==typeof r.raw?r.raw:r.raw?.latex||r.raw?.text||JSON.stringify(r.raw);await nn(e,!0)}n(o)})?.catch?.(e=>{const r={ok:!1,error:String(e)};en(Zt,{type:"result",requestId:t,...r}),tn(`Recognition failed: ${e}`,"error"),n(r)}),!0}if("gpt:solve"===e.type||"gpt:answer"===e.type||"gpt:solve-answer"===e.type)return Rn(_,e.input,t,"solve-answer",n),!0;if("gpt:code"===e.type)return Rn(R,e.input,t,"code",n),!0;if("gpt:css"===e.type)return Rn(T,e.input,t,"css",n),!0;if("gpt:custom"===e.type)return(async()=>{let r=e.instruction,o="Custom";if(!r&&e.instructionId){const t=(await rn().catch(()=>[])).find(t=>t.id===e.instructionId);t&&(r=t.instruction,o=t.label)}if(!r)return void n({ok:!1,error:"No instruction found"});const i=e.requestId||`custom_${Date.now()}`;en(Zt,{type:"custom",requestId:i,label:o,status:"processing"}),Pt(e.input,{instruction:r,outputFormat:"auto",intermediateRecognition:{enabled:!1}}).then(async r=>{const a={ok:r?.ok,data:r?.data,error:r?.error};en(Zt,{type:"result",requestId:i,mode:"custom",label:o,...a}),r?.ok&&r?.data&&!1!==e.autoCopy&&await nn(r.data,!0,t?.tab?.id),n(a)}).catch(e=>{const t={ok:!1,error:String(e)};en(Zt,{type:"result",requestId:i,mode:"custom",label:o,...t}),tn(`${o} failed: ${e}`,"error"),n(t)})})(),!0;if("gpt:translate"===e.type)return(async()=>{const t=e.input,r=e.targetLanguage||"English";if(!t?.trim())return void n({ok:!1,error:"No text"});const o=`Translate the following text to ${r}.\nPreserve formatting (Markdown, KaTeX, code blocks, etc.).\nOnly translate natural language, keep technical notation unchanged.\nReturn ONLY the translated text.`;try{const e=await s(),r=(await e)?.ai;if(!r?.apiKey)return void n({ok:!1,error:"No API key configured"});const i=r.baseUrl||"https://api.proxyapi.ru/openai/v1",a=r.model||"gpt-5.2",c=await fetch(`${i}/responses`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},body:JSON.stringify({model:a,input:t,instructions:o,reasoning:{effort:"low"},text:{verbosity:"low"}})});if(!c.ok)throw new Error(`Translation API: ${c.status}`);const l=await c.json();n({ok:!0,data:l?.output?.at?.(-1)?.content?.[0]?.text||t})}catch(In){n({ok:!1,error:String(In),data:t})}})(),!0;if("share-target"===e.type){const{title:t,text:r,url:o,files:i}=e.data||{};return chrome.storage?.local?.set?.({"rs-share-target-data":{title:t,text:r,url:o,files:i?.map?.(e=>e.name)||[],timestamp:Date.now()}}).catch(()=>{}),en("rs-share-target",{type:"share-received",data:{title:t,text:r,url:o,timestamp:Date.now()}}),tn("Content received","info"),n({ok:!0}),!0}return!1}),chrome.webNavigation?.onCommitted?.addListener?.(e=>{if(0!==e.frameId)return;const{tabId:t,url:n}=e;!pn(n)||n.startsWith(cn)||n.startsWith("file:")||yn(n,t)}),chrome.webNavigation?.onCompleted?.addListener?.(e=>{(async()=>{if(0!==e.frameId)return;const{tabId:t,url:n}=e;if(!pn(n)||n.startsWith(cn)||!n.startsWith("file:"))return;const r=await(async(e,t)=>{try{const n=await chrome.scripting.executeScript({target:{tabId:e},func:e=>{if(e.includes("github.com")){const e=document.querySelector("a[href*='raw']");if(e?.href)return`__RAW_URL__${e.href}`;const t=document.querySelector(".markdown-body");if(t?.textContent?.trim())return t.textContent.trim()}return document?.body?.innerText?.trim()||""},args:[t||""]}),r=n?.[0]?.result;if("string"==typeof r&&r.startsWith("__RAW_URL__"))try{const e=await fetch(r.replace("__RAW_URL__",""));if(e.ok)return await e.text()}catch{}return"string"==typeof r?r:""}catch{return""}})(t,n),o=r?await hn(r):null;fn(n,t,o)})().catch(console.warn)}),chrome.runtime.onMessage.addListener((e,t,n)=>((async()=>{if("crx-snip"===e?.type)return e.content?void n(await sn(e.content,e.contentType||"text")):void n({success:!1,error:"missing content"});if("crx-snip-screen-capture"===e?.type){try{const t=await _n(e.rect?{rect:e.rect,scale:e.scale||1}:void 0);n(t?await sn(t,"image"):{success:!1,error:"Capture cancelled"})}catch(In){n({success:!1,error:In instanceof Error?In.message:String(In)})}return}if("crx-pipeline-status"===e?.type)return void n({success:!0,status:an.getStatus()});if("crx-pipeline-pending"===e?.type)return void n({success:!0,pending:an.getPending(e.destinationType)});if("crx-pipeline-clear-completed"===e?.type)return void n({success:!0,clearedCount:an.clearCompleted()});if("crx-result-send-to-destination"===e?.type){const t=an.resultQueue.find(t=>t.id===e.resultId);return t&&e.destination?(t.destinations.push(e.destination),"completed"===t.status&&(t.status="pending"),void n({success:!0,resultId:e.resultId})):void n({success:!1,error:"Not found"})}if("md:load"!==e?.type)return;const t="string"==typeof e.src?e.src:"";if(!t)return void n({ok:!1,error:"missing src"});const r=await gn(t),o=r.ok&&r.text?await hn(r.text):null;n({ok:r.ok,status:r.status,src:r.src,key:o})})().catch(e=>n({ok:!1,error:String(e)})),!0)),(Tn=chrome).runtime.onMessage.addListener((e,t,n)=>{if(e?.id?.startsWith("crx_")&&e?.type&&e?.data)return(async()=>{try{const r={capture:()=>((e,t,n)=>Gt(e,t.rect,t.mode||"recognize",{sender:n}))(Tn,e.data,t),captureScreenshot:()=>(async(e,t)=>{const n=await Bt({rect:t.rect});return{ok:!0,data:n,imageData:n}})(0,e.data),processImage:()=>(async(e,t,n)=>{const r=t.imageData,o=t.mode||"recognize",i="string"==typeof r?await Wt(r):r,a=Jt[o]??Jt.recognize,s=await a(i);return s.ok&&s.data&&await Vt(e,s,n?.tab?.id).catch(console.warn),s})(Tn,e.data,t),processText:()=>(async(e,t)=>Ct(new Blob([t.content],{type:"text/plain"})))(0,e.data),doCopy:()=>(async(e,t)=>{const n=await Vt(e,t.data,t.tabId);return{success:n?.ok||!1}})(Tn,e.data),loadMarkdown:()=>Kt(e.data),captureWithRect:()=>(async e=>({status:"rect_selection_required",mode:e.mode}))(e.data)},o=r[e.type];n(o?await o():{ok:!1,error:`Unknown method: ${e.type}`})}catch(In){n({ok:!1,error:Lt(In)})}})(),!0;const r={CAPTURE:"recognize",CAPTURE_SOLVE:"solve",CAPTURE_ANSWER:"solve",CAPTURE_CODE:"code",CAPTURE_CSS:"css",CAPTURE_CUSTOM:"custom"};if(e?.type&&e.type in r){const o=r[e.type];return(async()=>{try{const r=await Gt(Tn,e.rect,o,{instructionId:e.instructionId,sender:t});n(r)}catch(In){n({ok:!1,error:Lt(In)})}})(),!0}return!("DOWNLOAD"!==e?.type||!e.dataUrl||(chrome.downloads.download({url:e.dataUrl,filename:"snip.png",saveAs:!0},t=>{chrome.runtime.lastError?n({ok:!1,error:chrome.runtime.lastError.message,dataUrl:e.dataUrl}):n({ok:!0,id:t})}),0))});
