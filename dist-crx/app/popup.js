import{createRuntimeChannelModule as e}from"../modules/runtime.js";import"../modules/Env.js";const t="undefined"!=typeof chrome&&chrome.runtime?.id;let n=null;const a="rs-settings",c=async()=>{try{return(await chrome.storage.local.get([a]))[a]||{}}catch{return{}}},r=(e,t)=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0,currentWindow:!0},n=>{const a=n[0]?.id;null!=a&&chrome.tabs.sendMessage(a,{type:e,...t})?.catch?.(console.warn),globalThis?.close?.()})};(()=>{const a=document.getElementById("snip-action-select"),c=document.getElementById("snip-do");c?.addEventListener("click",async()=>{const c=a?.value;if(c){if("CRX_SNIP_TEXT"===c){const a=await chrome.tabs.query({active:!0,currentWindow:!0});if(!a[0]?.id)return;const c=await chrome.scripting.executeScript({target:{tabId:a[0].id},func:()=>("undefined"!=typeof window?window:globalThis)?.getSelection()?.toString()||""}),r=c[0]?.result||"";if(!r.trim())return void chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord",message:"Select text first!"});try{const a=await(async()=>(!n&&t&&(n=await e("crx-popup")),n))();if(!a)throw new Error("Module unavailable");const c=await a.processText(r);chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord",message:!1!==c?.ok?"Text processed!":`Failed: ${c?.error||"Unknown"}`})}catch(o){chrome.notifications.create({type:"basic",iconUrl:"icons/icon.png",title:"CrossWord",message:`Failed: ${o instanceof Error?o.message:String(o)}`})}return void globalThis?.close?.()}if("CRX_SNIP_SCREEN"===c){const e=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e[0]?.id)return;return globalThis?.close?.(),void setTimeout(()=>{chrome.tabs.sendMessage(e[0].id,{type:"crx-snip-select-rect"},e=>{!chrome.runtime.lastError&&e?.rect&&chrome.runtime.sendMessage({type:"crx-snip-screen-capture",rect:e.rect,scale:1}).catch(console.warn)})},100)}r(c)}})})(),document.querySelectorAll("[data-copy]").forEach(e=>{e.addEventListener("click",()=>r(e.dataset.copy))}),(()=>{const e=document.getElementById("md-url"),t=document.getElementById("md-open"),n=()=>{const t=e?.value?.trim();if(!t)return;const n=chrome.runtime.getURL("markdown/viewer.html");chrome.tabs.create({url:`${n}?src=${encodeURIComponent(t)}`}),globalThis?.close?.()};t?.addEventListener("click",n),e?.addEventListener("keydown",e=>{"Enter"===e.key&&n()})})(),(()=>{const e=document.getElementById("api-key"),t=document.getElementById("api-url"),n=document.getElementById("save-settings"),r=document.getElementById("show-api-key"),o=document.getElementById("response-language"),s=document.getElementById("translate-results"),i=document.getElementById("generate-svg");c().then(n=>{t&&(t.value=(n.ai?.baseUrl||"").trim()),e&&(e.value=(n.ai?.apiKey||"").trim()),o&&(o.value=n.ai?.responseLanguage||"auto"),s&&(s.checked=n.ai?.translateResults||!1),i&&(i.checked=n.ai?.generateSvgGraphics||!1)}).catch(console.warn),n?.addEventListener("click",async()=>{if(await(async e=>{try{const t=await c();return await chrome.storage.local.set({[a]:{...t,ai:{...t.ai||{},...e.ai||{}}}}),!0}catch{return!1}})({ai:{apiKey:e?.value?.trim()||"",baseUrl:t?.value?.trim()||"",responseLanguage:o?.value||"auto",translateResults:s?.checked||!1,generateSvgGraphics:i?.checked||!1}})){const e=n.textContent;n.textContent="Saved!",n.disabled=!0,setTimeout(()=>{n.textContent=e,n.disabled=!1},1e3)}}),t?.addEventListener("change",()=>{t.value=t.value.trim()}),e?.addEventListener("change",()=>{e.value=e.value.trim()}),r?.addEventListener("click",()=>{e&&(e.type=r.checked?"text":"password")})})();
