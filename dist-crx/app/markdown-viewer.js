import{crxFrontend as e}from"../modules/crx-entry.js";import"../modules/Settings.js";import"../modules/Env.js";import"../modules/UnifiedMessaging.js";import"../modules/templates.js";const t=document.getElementById("raw-md"),r=document.getElementById("app"),n=async e=>{try{const t=await(chrome.storage?.session?.get?.(e)),r=t?.[e];if("string"==typeof r&&r.trim())return r}catch(t){console.warn("[Viewer] session storage read failed:",t)}return null},i=async(e,t)=>{if(t){const e=await n(t);if(e)return e}const r=await(e=>new Promise(t=>{chrome.runtime.sendMessage({type:"md:load",src:e},e=>{if(chrome.runtime.lastError)return console.warn("[Viewer] SW fetch failed:",chrome.runtime.lastError),void t({ok:!1});t(e||{ok:!1})})}))(e);if(r.ok&&r.key){const e=await n(r.key);if(e)return e}const i=await(async e=>{try{const t=await fetch(e,{credentials:"include",cache:"no-store"});return t.ok?await t.text():null}catch{return null}})(e);return i||`> Failed to load markdown from:\n> ${e}`},a=e=>{const t=(e||"").trim().toLowerCase();return!t||"${view}"===t||"view"===t||"current"===t||"active"===t},o=e=>/\.(?:md|markdown|mdown|mkd|mkdn|mdtxt|mdtext)(?:$|[?#])/i.test(e),s=async e=>{const t=e.get("src");if(t&&!a(t))return t;const r=e.get("view-src")||e.get("view");return r&&!a(r)?r:(async()=>{try{const e=await chrome.tabs.getCurrent(),t=e?.id,r=(await chrome.tabs.query({lastFocusedWindow:!0})).filter(e=>"number"==typeof e.id&&e.id!==t).map(e=>e.url).filter(e=>Boolean(e&&(e=>!!e&&!(e.startsWith("chrome-extension:")||e.startsWith("chrome://")||e.startsWith("about:")||e.startsWith("edge://")))(e)));return r.find(o)||r[0]||null}catch{return null}})()},c=e=>{const t=e.get("launch-view")||e.get("view")||"viewer";return a(t)?"viewer":t},m=e=>{const t={};for(const[r,n]of e.entries())t[r]=n;return t},d=e=>{t&&(t.style.display="",t.hidden=!1,t.textContent=e)};(async()=>{if(!r)throw new Error("Missing #app mount element");d("Loading...");const a=new URLSearchParams(location.search),o=a.get("mdk"),l=a.get("filename")||void 0,u=a.get("append")||a.get("extra")||"",w=a.get("content")||a.get("text"),g=await s(a);let f="";w?f=w:g?f=await i(g,o):o&&(f=await n(o)||""),u&&(f=f?`${f}\n\n${u}`:u),f.trim()||(f="# No content\n\nOpen a markdown file or navigate to a `.md` URL."),await e(r,{initialView:c(a),viewParams:m(a),viewPayload:{text:f,content:f,filename:l,source:g||void 0,args:m(a)}}),t&&(t.style.display="none")})().catch(e=>{console.error("[Viewer] init failed:",e),d(`Failed to initialize viewer: ${e}`)});
