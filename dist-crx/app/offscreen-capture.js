const e=document.getElementById("capture-canvas"),t=e.getContext("2d");chrome.runtime.onMessage.addListener(async(a,o,r)=>{if("capture-desktop"===a.type&&a.streamId)try{console.log("[Offscreen] Starting desktop capture...");const o=await navigator.mediaDevices.getUserMedia({video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a.streamId,maxWidth:4096,maxHeight:2160}}}),s=document.createElement("video");s.srcObject=o,await new Promise(e=>{s.onloadedmetadata=()=>e()}),s.play(),e.width=s.videoWidth,e.height=s.videoHeight,t?.drawImage(s,0,0),o.getTracks().forEach(e=>e.stop());const c=await new Promise(t=>e.toBlob(t,"image/png",1)),i=await c.arrayBuffer();console.log("[Offscreen] Desktop capture completed, size:",i.byteLength),r({success:!0,imageData:i})}catch(s){console.error("[Offscreen] Desktop capture failed:",s),r({success:!1,error:s instanceof Error?s.message:String(s)})}return!0});
