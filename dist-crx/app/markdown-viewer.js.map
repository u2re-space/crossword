{"version":3,"file":"markdown-viewer.js","sources":["../../src/crx/markdown/viewer.ts"],"sourcesContent":["import crxFrontend from \"../../frontend/main/crx-entry\";\nimport type { ViewId } from \"../../frontend/shells/types\";\n\nconst rawPre = document.getElementById(\"raw-md\") as HTMLPreElement | null;\nconst appDiv = document.getElementById(\"app\") as HTMLDivElement | null;\n\nconst VIRTUAL_VIEW_TOKEN = \"${view}\";\n\nconst loadFromSessionKey = async (key: string): Promise<string | null> => {\n    try {\n        const data = await chrome.storage?.session?.get?.(key);\n        const text = data?.[key];\n        if (typeof text === \"string\" && text.trim()) return text;\n    } catch (e) {\n        console.warn(\"[Viewer] session storage read failed:\", e);\n    }\n    return null;\n};\n\nconst fetchViaServiceWorker = (src: string): Promise<{ ok: boolean; key?: string; src?: string }> => {\n    return new Promise((resolve) => {\n        chrome.runtime.sendMessage({ type: \"md:load\", src }, (response) => {\n            if (chrome.runtime.lastError) {\n                console.warn(\"[Viewer] SW fetch failed:\", chrome.runtime.lastError);\n                resolve({ ok: false });\n                return;\n            }\n            resolve(response || { ok: false });\n        });\n    });\n};\n\nconst fetchDirect = async (src: string): Promise<string | null> => {\n    try {\n        const res = await fetch(src, { credentials: \"include\", cache: \"no-store\" });\n        if (!res.ok) return null;\n        return await res.text();\n    } catch {\n        return null;\n    }\n};\n\nconst loadMarkdown = async (src: string, sessionKey?: string | null): Promise<string> => {\n    if (sessionKey) {\n        const text = await loadFromSessionKey(sessionKey);\n        if (text) return text;\n    }\n\n    const swResult = await fetchViaServiceWorker(src);\n    if (swResult.ok && swResult.key) {\n        const text = await loadFromSessionKey(swResult.key);\n        if (text) return text;\n    }\n\n    const text = await fetchDirect(src);\n    if (text) return text;\n\n    return `> Failed to load markdown from:\\n> ${src}`;\n};\n\nconst isVirtualViewValue = (value?: string | null): boolean => {\n    const normalized = (value || \"\").trim().toLowerCase();\n    return !normalized || normalized === VIRTUAL_VIEW_TOKEN || normalized === \"view\" || normalized === \"current\" || normalized === \"active\";\n};\n\nconst isBrowsableUrl = (url?: string): boolean => {\n    if (!url) return false;\n    return !url.startsWith(\"chrome-extension:\")\n        && !url.startsWith(\"chrome://\")\n        && !url.startsWith(\"about:\")\n        && !url.startsWith(\"edge://\");\n};\n\nconst looksLikeMarkdownSourceUrl = (url: string): boolean =>\n    /\\.(?:md|markdown|mdown|mkd|mkdn|mdtxt|mdtext)(?:$|[?#])/i.test(url);\n\nconst resolveSourceFromOpenTabs = async (): Promise<string | null> => {\n    try {\n        const currentTab = await chrome.tabs.getCurrent();\n        const currentTabId = currentTab?.id;\n        const tabs = await chrome.tabs.query({ lastFocusedWindow: true });\n        const candidates = tabs\n            .filter((tab) => typeof tab.id === \"number\" && tab.id !== currentTabId)\n            .map((tab) => tab.url)\n            .filter((url): url is string => Boolean(url && isBrowsableUrl(url)));\n\n        const markdownCandidate = candidates.find(looksLikeMarkdownSourceUrl);\n        return markdownCandidate || candidates[0] || null;\n    } catch {\n        return null;\n    }\n};\n\nconst resolveSource = async (params: URLSearchParams): Promise<string | null> => {\n    const explicitSource = params.get(\"src\");\n    if (explicitSource && !isVirtualViewValue(explicitSource)) {\n        return explicitSource;\n    }\n\n    const sourceFromView = params.get(\"view-src\") || params.get(\"view\");\n    if (sourceFromView && !isVirtualViewValue(sourceFromView)) {\n        return sourceFromView;\n    }\n\n    return resolveSourceFromOpenTabs();\n};\n\nconst resolveTargetView = (params: URLSearchParams): ViewId | \"markdown\" | \"markdown-viewer\" => {\n    const requestedView = params.get(\"launch-view\") || params.get(\"view\") || \"viewer\";\n    if (isVirtualViewValue(requestedView)) {\n        return \"viewer\";\n    }\n    return requestedView as ViewId;\n};\n\nconst collectViewParams = (params: URLSearchParams): Record<string, string> => {\n    const collected: Record<string, string> = {};\n    for (const [key, value] of params.entries()) {\n        collected[key] = value;\n    }\n    return collected;\n};\n\nconst hideRawLayer = (): void => {\n    if (rawPre) rawPre.style.display = \"none\";\n};\n\nconst showRawState = (message: string): void => {\n    if (!rawPre) return;\n    rawPre.style.display = \"\";\n    rawPre.hidden = false;\n    rawPre.textContent = message;\n};\n\nconst init = async () => {\n    if (!appDiv) {\n        throw new Error(\"Missing #app mount element\");\n    }\n\n    showRawState(\"Loading...\");\n\n    const params = new URLSearchParams(location.search);\n    const mdk = params.get(\"mdk\");\n    const filename = params.get(\"filename\") || undefined;\n    const appendContent = params.get(\"append\") || params.get(\"extra\") || \"\";\n    const directContent = params.get(\"content\") || params.get(\"text\");\n    const source = await resolveSource(params);\n\n    let markdown = \"\";\n    if (directContent) {\n        markdown = directContent;\n    } else if (source) {\n        markdown = await loadMarkdown(source, mdk);\n    } else if (mdk) {\n        markdown = (await loadFromSessionKey(mdk)) || \"\";\n    }\n\n    if (appendContent) {\n        markdown = markdown ? `${markdown}\\n\\n${appendContent}` : appendContent;\n    }\n\n    if (!markdown.trim()) {\n        markdown = \"# No content\\n\\nOpen a markdown file or navigate to a `.md` URL.\";\n    }\n\n    await crxFrontend(appDiv, {\n        initialView: resolveTargetView(params),\n        viewParams: collectViewParams(params),\n        viewPayload: {\n            text: markdown,\n            content: markdown,\n            filename,\n            source: source || undefined,\n            args: collectViewParams(params)\n        }\n    });\n\n    hideRawLayer();\n};\n\nvoid init().catch((e) => {\n    console.error(\"[Viewer] init failed:\", e);\n    showRawState(`Failed to initialize viewer: ${e}`);\n});\n"],"names":["text"],"mappings":"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"}